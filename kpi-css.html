<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard KPI CSS - Sistem Terintegrasi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="global.css">
<link rel="stylesheet" href="stylemobile.css">
<link rel="stylesheet" href="stylekpi.css">
<script src="global-time.js"></script>
    <style>
    </style>
</head>
<body>
    <div id="sidebar-container"></div>
    <button class="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
    <div class="main-content">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Dashboard KPI CSS</h1>
            <div class="header-actions">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Cari data KPI...">
                </div>
                
                <div class="user-profile">
                    <img class="profile-img" src="https://iili.io/Fpiva7S.png" alt="Profile">
                    <div class="user-info">
                        <h4>Nama Masing Masing</h4>
                        <p>Customer Service Support</p>
                    </div>
                </div>
            </div>
        </div>
            
            <div class="dashboard active" id="dashboard-kpi">
                <div class="summary-container">
                    <div class="summary-card fade-in">
                        <div class="summary-header">
                            <span class="summary-title">KPI Bulan Ini</span>
                            <div class="summary-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                        </div>
                        <div class="summary-content">
                            <h3 id="total-kpi">0.00%</h3>
                            <p>Dari target minimal 70%</p>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-45" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="summary-card fade-in">
                        <div class="summary-header">
                            <span class="summary-title">Ideas & Suggestions</span>
                            <div class="summary-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                        </div>
                        <div class="summary-content">
                            <h3 id="ideas-points">0.00%</h3>
                            <p>Mencapai target minimal</p>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-70" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="summary-card fade-in">
                        <div class="summary-header">
                            <span class="summary-title">Research</span>
                            <div class="summary-icon">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                        <div class="summary-content">
                            <h3 id="research-points">0.00%</h3>
                            <p>Mencapai target minimal</p>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-70" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="summary-card fade-in">
                        <div class="summary-header">
                            <span class="summary-title">Chat Response</span>
                            <div class="summary-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                        </div>
                        <div class="summary-content">
                            <h3 id="chat-points">0.00%</h3>
                            <p>Mencapai target minimal</p>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-70" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
<div class="kpi-container fade-in">
    <div class="kpi-header-container">
        <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-chart-line"></i> Data KPI Performance
        </h2>
        <div class="action-buttons">
              <button class="btn btn-secondary" id="back-to-all-users" style="display: none;">
        <i class="fas fa-arrow-left"></i> Kembali ke Semua User
    </button>
    <button class="btn btn-primary" id="edit-all-btn">
        <i class="fas fa-edit"></i> Edit All
    </button>
    <button class="btn btn-danger" id="reset-data-btn">
        <i class="fas fa-redo"></i> Reset Data
    </button>
        </div>
    </div>
                    
                    <table class="kpi-table">
                        <thead>
                            <tr>
                                <th rowspan="2">No.</th>
                                <th rowspan="2">Area Kinerja Utama</th>
                                <th rowspan="2">Target</th>
                                <th rowspan="2">Bobot</th>
                                <th colspan="2">Indikator</th>
                                <th>Skor Akhir</th>
                                <th>Bulan</th>
                                <th id="current-month-header"></th>
                                <th rowspan="2">Action</th>
                            </tr>
                            <tr>
                                <th>Deskripsi KPI</th>
                                <th>Keterangan</th>
                                <th></th>
                                <th>Realisasi</th>
                                <th>Skor Akhir</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td class="text-left">B2B & B2C (Count.)</td>
                                <td>3</td>
                                <td>25.00%</td>
                                <td class="text-left">Pembukaan WLB / Agent baru</td>
                                <td class="text-left">Semakin Besar Semakin Bagus</td>
                                <td class="target-missed">0.00%</td>
                                <td class="realization-cell">0</td>
                                <td class="target-missed">0.00%</td>
                                <td>
                                </td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td class="text-left">Problem Solving (Count.)</td>
                                <td>6</td>
                                <td>20.00%</td>
                                <td class="text-left">Kemampuan dalam menyelesaikan setiap masalah</td>
                                <td class="text-left">Semakin Besar Semakin Bagus</td>
                                <td class="target-missed">0.00%</td>
                                <td class="realization-cell">0</td>
                                <td class="target-missed">0.00%</td>
                                <td>
                                </td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td class="text-left">Idea (Count.)</td>
                                <td>3</td>
                                <td>20.00%</td>
                                <td class="text-left">Aktif memberikan ide, Saran & Masukan</td>
                                <td class="text-left">Semakin Besar Semakin Bagus</td>
                                <td class="target-missed" id="ideas-score">0.00%</td>
                                <td class="realization-cell" id="ideas-realization">0</td>
                                <td class="target-missed">0.00%</td>
                                <td>
                                </td>
                            </tr>
                            <tr>
                                <td>4</td>
                                <td class="text-left">Response Chat (Count.)</td>
                                <td>4</td>
                                <td>10.00%</td>
                                <td class="text-left">Kecepatan dan ketepatan dalam Merespon Chat (Max 3 Menit)</td>
                                <td class="text-left">Semakin Kecil Semakin Bagus</td>
                                <td class="target-missed" id="chat-score">0.00%</td>
                                <td class="realization-cell" id="chat-realization">0</td>
                                <td class="target-missed">0.00%</td>
                                <td>
                                </td>
                            </tr>
                            <tr>
                                <td>5</td>
                                <td class="text-left">Research (Count.)</td>
                                <td>28</td>
                                <td>10.00%</td>
                                <td class="text-left">Research keunggulan Platform / Agent Lain</td>
                                <td class="text-left">Semakin Besar Semakin Bagus</td>
                                <td class="target-missed" id="research-score">0.00%</td>
                                <td class="realization-cell" id="research-realization">0</td>
                                <td class="target-missed">0.00%</td>
                                <td>
                                </td>
                            </tr>
                            <tr>
                                <td>6</td>
                                <td class="text-left">Attitude (Skor.)</td>
                                <td>8</td>
                                <td>10.00%</td>
                                <td class="text-left">Attitude dalam mengikuti SOP / Arahan</td>
                                <td class="text-left">Semakin Besar Semakin Bagus</td>
                                <td class="target-missed">0.00%</td>
                                <td class="realization-cell">0</td>
                                <td class="target-missed">0.00%</td>
                                <td>
                                </td>
                            </tr>
                            <tr>
                                <td>7</td>
                                <td class="text-left">Disiplin (Day.)</td>
                                <td>28</td>
                                <td>5.00%</td>
                                <td class="text-left">Jumlah kedisiplinan setiap bulan</td>
                                <td class="text-left">Semakin Besar Semakin Bagus</td>
                                <td class="target-missed">0.00%</td>
                                <td class="realization-cell">0</td>
                                <td class="target-missed">0.00%</td>
                                <td>
                                </td>
                            </tr>
                            <tr class="result-row">
                                <td colspan="3">Total</td>
                                <td>100.00%</td>
                                <td colspan="3">Total Skor Akhir</td>
                                <td id="total-realization">0</td>
                                <td id="total-score" class="target-missed">0.00%</td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="dashboard" id="dashboard-ideas">
                <div class="submenu-container fade-in">
                    <div class="submenu-header">
                        <h2 class="submenu-title"><i class="fas fa-lightbulb"></i> Ideas & Suggestions</h2>
                        <button class="btn-edit-all">
                            <i class="fas fa-edit"></i>
                            Edit All
                        </button>
                    </div>
                    <div class="criteria-list">
                        <div class="criteria-item">
                            <div class="criteria-info">
                                <div class="criteria-name">Ideas & Suggestions</div>
                                <div class="criteria-desc">Jumlah ide yang diberikan per bulan</div>
                            </div>
                            <div class="criteria-points">
                                <span class="points-value">0</span>
                                <button class="btn btn-primary">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="dashboard" id="dashboard-research">
                <div class="submenu-container fade-in">
                    <div class="submenu-header">
                        <h2 class="submenu-title"><i class="fas fa-search"></i> Research</h2>
                        <button class="btn-edit-all">
                            <i class="fas fa-edit"></i>
                            Edit All
                        </button>
                    </div>
                    <div class="criteria-list">
                        <div class="criteria-item">
                            <div class="criteria-info">
                                <div class="criteria-name">Research</div>
                                <div class="criteria-desc">Jumlah research yang dilakukan per bulan</div>
                            </div>
                            <div class="criteria-points">
                                <span class="points-value">0</span>
                                <button class="btn btn-primary">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="dashboard" id="dashboard-chat">
                <div class="submenu-container fade-in">
                    <div class="submenu-header">
                        <h2 class="submenu-title"><i class="fas fa-comments"></i> Chat Response</h2>
                        <button class="btn-edit-all">
                            <i class="fas fa-edit"></i>
                            Edit All
                        </button>
                    </div>
                    <div class="criteria-list">
                        <div class="criteria-item">
                            <div class="criteria-info">
                                <div class="criteria-name">Chat Response</div>
                                <div class="criteria-desc">Rata-rata waktu respons chat dalam menit</div>
                            </div>
                            <div class="criteria-points">
                                <span class="points-value">0</span>
                                <button class="btn btn-primary">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer-note">
                <p><strong>Catatan:</strong> Untuk Lepas training / masa probation Minimal KPI yang harus di Raih = 70%.</p>
            </div>
        </div>
    </div>

    <div class="notification-container" id="notificationContainer"></div>
    
    <script src="sidebar-loader.js"></script>
    <script src="translation-kpi.js"></script>
    <script src="user-profile.js"></script>

 <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
    // ========== KONFIGURASI & INISIALISASI ==========

    // Konfigurasi Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDUZka4FZyLi_cv6X_5D4zeRsfkpqOlBpY",
        authDomain: "dashboard-css.firebaseapp.com",
        databaseURL: "https://dashboard-css-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "dashboard-css",
        storageBucket: "dashboard-css.appspot.com",
        messagingSenderId: "771131792881",
        appId: "1:771131792881:web:ad634424225bd7de847850",
        measurementId: "G-3CYBC5B101"
    };

    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);

    // Data KPI
    const kpiData = [
        { id: 1, area: "B2B & B2C (Count.)", target: 3, weight: 25, description: "Pembukaan WLB / Agent baru", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 },
        { id: 2, area: "Problem Solving (Count.)", target: 6, weight: 20, description: "Kemampuan dalam menyelesaikan setiap masalah", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 },
        { id: 3, area: "Idea (Count.)", target: 3, weight: 20, description: "Aktif memberikan ide, Saran & Masukan", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 },
        { id: 4, area: "Response Chat (Count.)", target: 4, weight: 10, description: "Kecepatan dan ketepatan dalam Merespon Chat (Max 3 Menit)", note: "Semakin Kecil Semakin Bagus", realization: 0, score: 0 },
        { id: 5, area: "Research (Count.)", target: 28, weight: 10, description: "Research keunggulan Platform / Agent Lain", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 },
        { id: 6, area: "Attitude (Skor.)", target: 8, weight: 10, description: "Attitude dalam mengikuti SOP / Arahan", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 },
        { id: 7, area: "Disiplin (Day.)", target: 28, weight: 5, description: "Jumlah kedisiplinan setiap bulan", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 }
    ];

    // Variabel Global
let isEditMode = false;
let isEditingMode = false;
let preventRealTimeUpdate = false;
let unsubscribeFunctions = [];
let currentFilter = 'current';
let isSuperAdminUser = false;
let isLocalChange = false;
let lastLocalChangeTime = 0;
let currentPeriod = getCurrentMonthYear();
// üî• TAMBAHKAN VARIABEL UNTUK TOMBOL KEMBALI
let isViewingUserDetail = false;

    // Elemen DOM
const editAllBtn = document.getElementById('edit-all-btn');
const resetBtn = document.getElementById('reset-data-btn');
// üî• TAMBAHKAN TOMBOL KEMBALI
const backToAllBtn = document.getElementById('back-to-all-users');
const notificationContainer = document.getElementById('notificationContainer');
const menuItems = document.querySelectorAll('.menu-item');
const dashboards = document.querySelectorAll('.dashboard');

    // ========== FUNGSI AUTENTIKASI & ROLE MANAGEMENT ==========

    async function checkAndSetupSuperAdmin() {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                console.log('No user logged in');
                setupAdminUI(false);
                return false;
            }
            
            console.log('üîÑ Checking admin role for user:', currentUser.uid, currentUser.email);
            
            const db = firebase.firestore();
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            
            if (userDoc.exists) {
                const userData = userDoc.data();
                console.log('üìä User data from Firestore:', userData);
                
                const isAdmin = userData.role === 'super_admin' || userData.isSuperAdmin === true;
                console.log('üëë Is user admin?', isAdmin);
                
                setupAdminUI(isAdmin);
                
                if (!userData.name || userData.name === 'User') {
                    await db.collection('users').doc(currentUser.uid).update({
                        name: currentUser.displayName || currentUser.email.split('@')[0],
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                return isAdmin;
            } else {
                console.log('üìù Creating user document with proper name');
                await db.collection('users').doc(currentUser.uid).set({
                    email: currentUser.email,
                    name: currentUser.displayName || currentUser.email.split('@')[0],
                    role: 'user',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                setupAdminUI(false);
                return false;
            }
        } catch (error) {
            console.error('‚ùå Error checking super admin:', error);
            setupAdminUI(false);
            return false;
        }
    }

    function setupAdminUI(isAdmin) {
    console.log('Setting up admin UI, isAdmin:', isAdmin);
    
    const headerActions = document.querySelector('.header-actions');
    if (!headerActions) {
        console.error('Header actions element not found');
        return;
    }
    
    // Hapus filter yang sudah ada
    const existingFilter = document.getElementById('userFilterContainer');
    if (existingFilter) existingFilter.remove();
    
    const editAllBtn = document.getElementById('edit-all-btn');
    const resetBtn = document.getElementById('reset-data-btn');
    const backToAllBtn = document.getElementById('back-to-all-users');

    // ‚úÖ Toggle class agar tombol "Edit All" hanya terlihat untuk Super Admin
    document.querySelectorAll('.btn-edit-all').forEach(btn => {
        btn.classList.toggle('admin-visible', !!isAdmin);
    });
    if (editAllBtn) editAllBtn.classList.toggle('admin-visible', !!isAdmin);
    
    if (isAdmin) {
        console.log('üõ† Setting up Super Admin UI');
        
        // TAMPILKAN tombol Edit All dan Reset
        if (editAllBtn) {
            editAllBtn.style.display = 'inline-flex';
            editAllBtn.style.visibility = 'visible';
        }
        if (resetBtn) {
            resetBtn.style.display = 'inline-flex';
            resetBtn.style.visibility = 'visible';
        }
        if (backToAllBtn) {
            backToAllBtn.style.display = 'none'; // üî• SEMBUNYIKAN AWALNYA
        }

            
            // Tambahkan filter user di header
            const filterHTML = `
                <div class="user-filter" id="userFilterContainer">
                    <select id="userFilter" class="filter-select">
                        <option value="current">Data Saya</option>
                        <option value="all">Semua User</option>
                    </select>
                </div>
            `;
            
            const userProfile = headerActions.querySelector('.user-profile');
            if (userProfile) {
                userProfile.insertAdjacentHTML('beforebegin', filterHTML);
                
                // Event listener untuk filter user
                document.getElementById('userFilter').addEventListener('change', function() {
                    currentFilter = this.value;
                    console.log('User filter changed to:', currentFilter);
                    
                    // Dapatkan bulan yang sedang dipilih
                    const monthFilter = document.getElementById('monthFilter');
                    const selectedMonth = monthFilter ? monthFilter.value : getCurrentMonthYear().display;
                    
                    loadKpiData(currentFilter, null, selectedMonth);
                });
            }
            
            // TAMBAHKAN FILTER BULAN - hanya sekali saja
            setTimeout(() => {
                addMonthFilterToKpiContainer();
            }, 100);
            
            isSuperAdminUser = true;
        } else {
            console.log('üë§ Setting up Regular User UI');
            
            // SEMBUNYIKAN tombol untuk non-admin
            if (editAllBtn) {
                editAllBtn.style.display = 'none';
            }
            if (resetBtn) {
                resetBtn.style.display = 'none';
            }
            
            isSuperAdminUser = false;
        }
        
        console.log('‚úÖ Admin UI setup completed');
    }
// ========== FUNGSI KEMBALI KE SEMUA USER ==========

function backToAllUsers() {
    console.log('üîô Back to all users clicked');
    
    // Reset state
    window.currentViewingUserId = null;
    isViewingUserDetail = false;
    
    // üî• SEMBUNYIKAN TOMBOL KEMBALI
    if (backToAllBtn) {
        backToAllBtn.style.display = 'none';
    }
    
    // Reset header
    displayUserNameInHeader(null);
    
    // Tampilkan semua user lagi
    const monthFilter = document.getElementById('monthFilter');
    const selectedMonth = monthFilter ? monthFilter.value : getCurrentMonthYear().display;
    
    loadAllUsersData(selectedMonth);
    
    // Update filter dropdown
    const userFilter = document.getElementById('userFilter');
    if (userFilter) {
        userFilter.value = 'all';
    }
    
    showNotification('Kembali ke tampilan semua user', 'info');
}
function getMonthRange(periodDisplay) {
  // Contoh periodDisplay: "02-2026" (sesuaikan format monthFilter kamu)
  const [m, y] = periodDisplay.split('-').map(n => parseInt(n, 10));
  const start = new Date(y, m - 1, 1, 0, 0, 0);
  const end   = new Date(y, m, 1, 0, 0, 0); // awal bulan berikutnya
  return { start, end };
}

    // ========== FUNGSI DATA MODULES ==========

    async function getIdeasData(userId = null) {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return { count: 0, totalPoints: 0, data: [] };
            
            const db = firebase.firestore();
            let query = db.collection('ideas');
            
            if (userId) query = query.where('userId', '==', userId);
            else query = query.where('userId', '==', currentUser.uid);
            
            const snapshot = await query.get();
            const ideasData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            return {
                count: ideasData.length,
                totalPoints: ideasData.reduce((sum, idea) => sum + (parseInt(idea.points) || 0), 0),
                data: ideasData
            };
        } catch (error) {
            console.error('Error getting ideas data:', error);
            return { count: 0, totalPoints: 0, data: [] };
        }
    }

    async function getResearchData(userId = null) {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return { count: 0, totalPoints: 0, data: [] };
            
            const db = firebase.firestore();
            let query = db.collection('research');
            
            if (userId) query = query.where('userId', '==', userId);
            else query = query.where('userId', '==', currentUser.uid);
            
            const snapshot = await query.get();
            const researchData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            return {
                count: researchData.length,
                totalPoints: researchData.reduce((sum, research) => sum + (parseInt(research.points) || 0), 0),
                data: researchData
            };
        } catch (error) {
            console.error('Error getting research data:', error);
            return { count: 0, totalPoints: 0, data: [] };
        }
    }

    async function getChatData(userId = null) {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return { 
                count: 0, 
                missedChats: 0, 
                averageResponseTime: 0, 
                data: [],
                totalPenalty: 0
            };
            
            const db = firebase.firestore();
            let query = db.collection('chats');
            
            if (userId) query = query.where('userId', '==', userId);
            else query = query.where('userId', '==', currentUser.uid);
            
            const snapshot = await query.get();
            const chatData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const missedChats = chatData.filter(chat => {
                const responseTime = parseFloat(chat.responseTime) || 0;
                return responseTime > 3; // Chat dengan response time > 3 menit
            }).length;
            
            const averageResponseTime = chatData.length > 0 ? 
                chatData.reduce((sum, chat) => sum + parseFloat(chat.responseTime || 0), 0) / chatData.length : 0;
            
            return { 
                count: chatData.length, 
                missedChats, 
                averageResponseTime, 
                data: chatData,
                totalPenalty: missedChats * 25
            };
        } catch (error) {
            console.error('Error getting chat data:', error);
            return { 
                count: 0, 
                missedChats: 0, 
                averageResponseTime: 0, 
                data: [],
                totalPenalty: 0
            };
        }
    }

    async function getProblemSolvingData(userId = null) {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return { count: 0, totalPoints: 0, data: [] };
            
            const db = firebase.firestore();
            let query = db.collection('problems');
            
            if (userId) query = query.where('userId', '==', userId);
            else query = query.where('userId', '==', currentUser.uid);
            
            const snapshot = await query.get();
            const problemData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            return {
                count: problemData.length,
                totalPoints: problemData.reduce((sum, problem) => sum + (parseInt(problem.points) || 0), 0),
                data: problemData
            };
        } catch (error) {
            console.error('Error getting problem solving data:', error);
            return { count: 0, totalPoints: 0, data: [] };
        }
    }

    async function getB2BData(userId = null) {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return { count: 0, totalPoints: 0, data: [] };
            
            const db = firebase.firestore();
            let query = db.collection('b2b');
            
            if (userId) query = query.where('userId', '==', userId);
            else query = query.where('userId', '==', currentUser.uid);
            
            const snapshot = await query.get();
            const b2bData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            return {
                count: b2bData.length,
                totalPoints: b2bData.reduce((sum, b2b) => sum + (parseInt(b2b.points) || 0), 0),
                data: b2bData
            };
        } catch (error) {
            console.error('Error getting B2B data:', error);
            return { count: 0, totalPoints: 0, data: [] };
        }
    }

    async function getAttitudeData(userId = null) {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return { count: 0, totalPoints: 0, averageScore: 0, data: [] };
            
            const db = firebase.firestore();
            let query = db.collection('attitude');
            
            if (userId) query = query.where('userId', '==', userId);
            else query = query.where('userId', '==', currentUser.uid);
            
            const snapshot = await query.get();
            const attitudeData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const averageScore = attitudeData.length > 0 ? 
                attitudeData.reduce((sum, attitude) => sum + (parseInt(attitude.score) || 0), 0) / attitudeData.length : 0;
            
            return {
                count: attitudeData.length,
                totalPoints: attitudeData.reduce((sum, attitude) => sum + (parseInt(attitude.points) || 0), 0),
                averageScore,
                data: attitudeData
            };
        } catch (error) {
            console.error('Error getting attitude data:', error);
            return { count: 0, totalPoints: 0, averageScore: 0, data: [] };
        }
    }

    async function getDisciplineData(userId = null) {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return { count: 0, totalPoints: 0, data: [] };
            
            const db = firebase.firestore();
            let query = db.collection('discipline');
            
            if (userId) query = query.where('userId', '==', userId);
            else query = query.where('userId', '==', currentUser.uid);
            
            const snapshot = await query.get();
            const disciplineData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            return {
                count: disciplineData.length,
                totalPoints: disciplineData.reduce((sum, discipline) => sum + (parseInt(discipline.points) || 0), 0),
                data: disciplineData
            };
        } catch (error) {
            console.error('Error getting discipline data:', error);
            return { count: 0, totalPoints: 0, data: [] };
        }
    }

    // ========== FUNGSI UTAMA KPI ==========
function calculateScore(target, realization, isSmallerBetter = false, index = -1, id = -1) {
    // Gunakan id atau index untuk identifikasi
    const isChatResponse = index === 3 || id === 4;
    
    // LOGIKA KHUSUS UNTUK CHAT RESPONSE
    if (isChatResponse) {
        // Default score untuk chat adalah 100%
        let baseScore = 100;
        
        // Setiap chat response yang diinput mengurangi 25% dari base score
        const penalty = realization * 25; // 100% / target 4 = 25% per chat
        
        // Score akhir = baseScore - penalty
        const finalScore = Math.max(0, baseScore - penalty);
        
        console.log(`üìä Chat Score Calculation: 
            Base: ${baseScore}% 
            Realization: ${realization} 
            Penalty: ${penalty}% 
            Final: ${finalScore}%`);
        
        return finalScore;
    }

        // LOGIKA UNTUK YANG LAIN
        else if (isSmallerBetter) {
            // Logika untuk yang "Semakin Kecil Semakin Bagus"
            if (realization >= target) return 0;
            if (realization <= 0) return 100;
            return ((target - realization) / target) * 100;
        } 
        else {
            // Logika untuk yang "Semakin Besar Semakin Bagus"
            if (realization >= target) return 100;
            if (realization <= 0) return 0;
            return (realization / target) * 100;
        }
    }

    // ========== FUNGSI UPDATE KPI ==========

    async function updateAllKpiData(userId = null, forceUpdate = false) {
        // üî• JANGAN UPDATE JIKA SEDANG EDIT
        if (isEditingMode && !forceUpdate) {
            console.log('‚ö†Ô∏è Skipping auto-update: Editing mode active');
            return;
        }
        
        try {
            const targetUserId = userId || getCurrentViewingUserId();
            
            // üî• SIMPAN DATA SEBELUM UPDATE UNTUK COMPARE
            const originalData = JSON.parse(JSON.stringify(kpiData));
            
            // üî• BANDINGKAN DATA SEBELUM DAN SESUDAH
            const hasSignificantChanges = kpiData.some((item, index) => {
                const original = originalData[index];
                return Math.abs(item.realization - original.realization) > 0.1 ||
                       Math.abs(item.score - original.score) > 0.1;
            });
            
            // üî• HANYA SAVE JIKA ADA PERUBAHAN SIGNIFIKAN DAN BUKAN DARI EDIT MANUAL
            if (hasSignificantChanges && !preventRealTimeUpdate) {
                await saveKpiDataToFirestore();
                updateKPI();
                
                // üî• HANYA TAMPILKAN NOTIF JIKA BUKAN DARI EDIT MANUAL
                if (!isEditingMode) {
                    showNotification('‚úÖ Data KPI berhasil diperbarui dari modules', 'success');
                }
            }
            
        } catch (error) {
            console.error('Error updating KPI data:', error);
            if (!isEditingMode) {
                showNotification('Error memperbarui data KPI', 'error');
            }
        }
    }

    function setupModulesRealTimeListeners() {
        console.log('üîî Setting up modules real-time listeners');
        
        const db = firebase.firestore();
        const currentUser = firebase.auth().currentUser;
        
        if (currentUser) {
            const userId = getCurrentViewingUserId() || currentUser.uid;
            
            // Listener untuk chat collection
            const chatUnsubscribe = db.collection('chats')
                .where('userId', '==', userId)
                .onSnapshot((snapshot) => {
                    // üî• SKIP JIKA SEDANG EDIT
                    if (preventRealTimeUpdate || isEditingMode) {
                        console.log('‚ö†Ô∏è Skipping chat listener: Editing mode active');
                        return;
                    }
                    
                    console.log('üîÑ Chat Response data updated from Firestore:', snapshot.size);
                    // Update realization chat response
                    kpiData[3].realization = snapshot.size;
                    
                    // Hitung ulang score chat response
                    kpiData[3].score = calculateScore(
                        kpiData[3].target, 
                        kpiData[3].realization, 
                        false, // isSmallerBetter
                        3 // Index khusus untuk chat
                    );
                    
                    console.log(`üìä Real-time Chat Update: 
                        Count: ${snapshot.size}
                        New Score: ${kpiData[3].score}%`);
                    
                    // Update display dan simpan ke Firestore
                    updateDisplay();
                    saveKpiDataToFirestore();
                    
                    // Update summary card
                    updateElementText('chat-score', kpiData[3].score.toFixed(2) + '%');
                    updateElementText('chat-realization', kpiData[3].realization);
                    updateElementText('chat-points', kpiData[3].score.toFixed(2) + '%');
                    updateProgressBar('.summary-card:nth-child(4) .progress-fill', Math.min(kpiData[3].score, 100));
                    
                });
            
            unsubscribeFunctions.push(chatUnsubscribe);
            
            // Listener untuk data lainnya
            const ideasUnsubscribe = db.collection('ideas')
                .where('userId', '==', userId)
                .onSnapshot((snapshot) => {
                    console.log('üîÑ Ideas data updated from Firestore');
                    updateAllKpiData();
                });
            
            unsubscribeFunctions.push(ideasUnsubscribe);
        }
    }

    // ========== FUNGSI UNTUK MEMASTIKAN INISIALISASI CHAT RESPONSE ==========

    function initializeChatResponse() {
        // Pastikan data chat response diinisialisasi dengan benar
        const chatKpi = kpiData.find(item => item.id === 4);
        
        if (chatKpi) {
            console.log('üîÑ Initializing Chat Response KPI:', {
                target: chatKpi.target,
                currentRealization: chatKpi.realization,
                currentScore: chatKpi.score
            });
            
            // Jika belum ada score, set ke 100%
            if (chatKpi.score === 0 && chatKpi.realization === 0) {
                chatKpi.score = 100;
                console.log('‚úÖ Chat Response initialized with 100% score');
            }
        }
    }

    // ========== UPDATE FUNGSI INISIALISASI ==========

    async function initializeKpiData() {
    try {
        const currentUser = firebase.auth().currentUser;
if (currentUser) {
  updateMonthDisplay(getCurrentMonthYear().display);
  await checkAndResetForNewMonthForUser(currentUser.uid);
}
        
        const firestoreLoaded = await loadKpiDataFromFirestore();
        
        if (!firestoreLoaded) {
            await updateAllKpiData();
            await saveKpiDataToFirestore();
        }
        
        // Pastikan fungsi ini dipanggil
        initializeChatResponse();
        
        updateDisplay();
        
    } catch (error) {
        console.error('Error initializing KPI data:', error);
    }
}

    function updateKPI() {
        let totalScore = 0;
        let totalRealization = 0;
        
        kpiData.forEach((item, index) => {
            const row = document.querySelector(`.kpi-table tbody tr:nth-child(${index + 1})`);
            const isSmallerBetter = item.note.includes("Semakin Kecil");
            
            item.score = calculateScore(item.target, item.realization, isSmallerBetter, index);
            
            if (row) {
                const realizationCell = row.querySelector('.realization-cell');
                if (realizationCell) realizationCell.textContent = item.realization;
                
                const scoreCell = row.querySelector('td:nth-child(9)');
                if (scoreCell) {
                    scoreCell.textContent = item.score.toFixed(2) + '%';
                    scoreCell.className = '';
                    
                    if (item.score >= 100) scoreCell.classList.add('target-achieved');
                    else if (item.score >= 70) scoreCell.classList.add('target-partial');
                    else scoreCell.classList.add('target-missed');
                }
            }
            
            totalScore += (item.score * item.weight) / 100;
            totalRealization += item.realization;
            
            if (index === 2) {
                updateElementText('ideas-score', item.score.toFixed(2) + '%');
                updateElementText('ideas-realization', item.realization);
                updateElementText('ideas-points', item.score.toFixed(2) + '%');
                updateProgressBar('.summary-card:nth-child(2) .progress-fill', Math.min(item.score, 100));
            } else if (index === 3) {
                updateElementText('chat-score', item.score.toFixed(2) + '%');
                updateElementText('chat-realization', item.realization);
                updateElementText('chat-points', item.score.toFixed(2) + '%');
                updateProgressBar('.summary-card:nth-child(4) .progress-fill', Math.min(item.score, 100));
            } else if (index === 4) {
                updateElementText('research-score', item.score.toFixed(2) + '%');
                updateElementText('research-realization', item.realization);
                updateElementText('research-points', item.score.toFixed(2) + '%');
                updateProgressBar('.summary-card:nth-child(3) .progress-fill', Math.min(item.score, 100));
            }
        });
        
        updateElementText('total-score', totalScore.toFixed(2) + '%');
        updateElementText('total-realization', totalRealization);
        updateElementText('total-kpi', totalScore.toFixed(2) + '%');
        updateProgressBar('.summary-card:first-child .progress-fill', Math.min(totalScore, 100));
        
        const totalScoreCell = document.getElementById('total-score');
        if (totalScoreCell) {
            totalScoreCell.className = '';
            if (totalScore >= 70) totalScoreCell.classList.add('target-achieved');
            else if (totalScore >= 50) totalScoreCell.classList.add('target-partial');
            else totalScoreCell.classList.add('target-missed');
        }
    }

    function updateElementText(id, text) {
        const element = document.getElementById(id);
        if (element) element.textContent = text;
    }

    function updateProgressBar(selector, percentage) {
        const progressBar = document.querySelector(selector);
        if (progressBar) progressBar.style.width = percentage + '%';
    }

    // ========== FUNGSI FIRESTORE ==========

    async function loadKpiDataFromFirestore(userId = null) {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return false;
            
            // Tentukan user ID target dengan benar
            const targetUserId = userId || getCurrentViewingUserId() || currentUser.uid;
            
            console.log('üì• Loading KPI data from Firestore for TARGET user:', targetUserId);
            
            const db = firebase.firestore();
            const doc = await db.collection('kpiData').doc(targetUserId).get();
            
            if (doc.exists) {
                const savedData = doc.data();
                console.log('‚úÖ Data loaded from Firestore for user:', targetUserId, savedData);
                
                if (savedData.kpiData && Array.isArray(savedData.kpiData)) {
                    // Clear existing data
                    kpiData.length = 0;
                    
                    // Load new data
                    savedData.kpiData.forEach(savedItem => {
                        kpiData.push({
                            id: savedItem.id || 0,
                            area: savedItem.area || '',
                            target: savedItem.target || 0,
                            weight: savedItem.weight || 0,
                            description: savedItem.description || '',
                            note: savedItem.note || '',
                            realization: savedItem.realization || 0,
                            score: savedItem.score || 0
                        });
                    });
                    
                    console.log('‚úÖ kpiData completely replaced with Firestore data for user:', targetUserId);
                    return true;
                }
            } else {
                console.log('üì≠ No data found in kpiData collection for user:', targetUserId);
            }
            
            return false;
        } catch (error) {
            console.error('‚ùå Error loading from Firestore:', error);
            return false;
        }
    }

    async function saveKpiDataToFirestore() {
        const currentPeriod = getCurrentMonthYear().display;
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                console.error('‚ùå No user logged in');
                return false;
            }

            const db = firebase.firestore();
            
            // TENTUKAN TARGET USER ID DENGAN LOGIKA YANG JELAS
            let targetUserId = currentUser.uid;
            let targetUserName = currentUser.displayName || currentUser.email;
            
            // LOGIKA UNTUK SUPER ADMIN
            if (isSuperAdminUser) {
                // Prioritas 1: User ID dari window.currentViewingUserId
                if (window.currentViewingUserId && window.currentViewingUserId !== currentUser.uid) {
                    targetUserId = window.currentViewingUserId;
                    // Dapatkan nama user target
                    const userDoc = await db.collection('users').doc(targetUserId).get();
                    if (userDoc.exists) {
                        targetUserName = userDoc.data().name || userDoc.data().email || 'Unknown User';
                    }
                    console.log('üéØ Super Admin saving to TARGET user:', targetUserId, targetUserName);
                }
                // Prioritas 2: Jika ada specificUserId di URL atau state lain
                else if (currentFilter === 'all') {
                    console.log('‚ö†Ô∏è Super Admin in "all" mode but no target user selected, saving to own data');
                    // Tetap ke data sendiri
                }
            }
            
            console.log('üíæ FINAL SAVE TARGET:', {
                targetUserId: targetUserId,
                targetUserName: targetUserName,
                isSuperAdmin: isSuperAdminUser,
                currentViewing: window.currentViewingUserId
            });

            isLocalChange = true;
            lastLocalChangeTime = Date.now();

            const kpiDoc = {
    kpiData: kpiData.map(item => ({
        id: item.id,
        area: item.area,
        target: item.target,
        weight: item.weight,
        description: item.description,
        note: item.note,
        realization: item.realization,
        score: item.score
    })),
    userId: targetUserId,
    userName: targetUserName,
    userEmail: currentUser.email,

    period: currentPeriod, // üî• INI WAJIB

    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    totalScore: calculateTotalScore(kpiData),
    lastUpdatedBy: currentUser.uid,
    updatedByAdmin: isSuperAdminUser
};


            console.log('üì§ Saving to Firestore document:', targetUserId);
            await db.collection('kpiData').doc(targetUserId).set(kpiDoc, { merge: true });
            
            console.log('‚úÖ SUCCESS: Data saved to Firestore for user:', targetUserId);
            
            // Update module collections untuk user yang benar
            await updateModuleCollections(targetUserId);
            
            setTimeout(() => { isLocalChange = false; }, 5000);
            return true;
        } catch (error) {
            console.error('‚ùå ERROR saving to Firestore:', error);
            isLocalChange = false;
            showNotification('Gagal menyimpan data: ' + error.message, 'error');
            return false;
        }
    }

    function calculateTotalScore(kpiDataArray) {
        if (!kpiDataArray || !Array.isArray(kpiDataArray)) {
            console.warn('‚ö†Ô∏è Invalid KPI data for calculation');
            return 0;
        }
        
        try {
            const total = kpiDataArray.reduce((sum, item) => {
                const score = parseFloat(item.score) || 0;
                const weight = parseFloat(item.weight) || 0;
                return sum + (score * weight) / 100;
            }, 0);
            
            return parseFloat(total.toFixed(2));
        } catch (error) {
            console.error('‚ùå Error calculating total score:', error);
            return 0;
        }
    }
let __refreshRunning = false;

async function refreshAllUsersKpiFromModules(selectedMonth) {
  if (__refreshRunning) return;
  __refreshRunning = true;

  const btn = document.getElementById('refresh-all-data');
  const originalText = btn ? btn.innerHTML : null;
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Refreshing...';
  }

  try {
    const current = getCurrentMonthYear().display;
    const isCurrentMonth = selectedMonth === current;

    // Kalau bukan bulan berjalan, jangan recompute (historical)
    if (!isCurrentMonth) {
      await loadAllUsersData(selectedMonth);
      return;
    }

    const db = firebase.firestore();
    const usersSnapshot = await db.collection('users').get();

    // Loop semua user, hitung modul dari koleksi aslinya, lalu simpan ke kpiData/{userId}
    for (const u of usersSnapshot.docs) {
      const userId = u.id;

      // 1) AMBIL data dari modul asli (contoh minimal: ideas, research, chats)
      const [ideasSnap, researchSnap, chatsSnap] = await Promise.all([
        db.collection('ideas').where('userId', '==', userId).get(),
        db.collection('research').where('userId', '==', userId).get(),
        db.collection('chats').where('userId', '==', userId).get(),
      ]);

      const ideasCount = ideasSnap.size;
      const researchCount = researchSnap.size;
      const chatsCount = chatsSnap.size;

      // 2) SIMPAN hasil perhitungan ke dokumen KPI user (cache)
      // (ini ‚Äúmembangunkan‚Äù data user supaya muncul di tabel semua user)
      await db.collection('kpiData').doc(userId).set({
        // simpan angka modul yang kamu butuhkan
        modules: {
          ideasCount,
          researchCount,
          chatsCount,
        },
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedByAdmin: true,
        period: current
      }, { merge: true });
    }

    // 3) Setelah semua selesai, reload tabel
    await loadAllUsersData(current);

    showNotification('‚úÖ Refresh semua user selesai', 'success');
  } catch (err) {
    console.error('refreshAllUsersKpiFromModules error:', err);
    showNotification('‚ùå Refresh gagal: ' + (err?.message || err), 'error');
  } finally {
    __refreshRunning = false;
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = originalText || 'Refresh Data';
    }
  }
}

    // ========== FUNGSI FILTER & USER MANAGEMENT ==========

    async function loadKpiData(filter = 'current', specificUserId = null, selectedMonth = null) {
  try {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) return;

    const targetMonth = selectedMonth || getCurrentMonthYear().display;

    // ‚úÖ TAMBAHKAN INI (WAJIB)
    const isCurrentMonth = targetMonth === getCurrentMonthYear().display;

    updateMonthDisplay(targetMonth);

    if (filter === 'current' || specificUserId) {
      const userId = specificUserId || currentUser.uid;

      if (specificUserId && specificUserId !== currentUser.uid) {
        window.currentViewingUserId = specificUserId;
      }

      if (isCurrentMonth) {
        await checkAndResetForNewMonthForUser(userId);
        await loadRealTimeUserData(userId);
      } else {
        await loadHistoricalData(userId, targetMonth);
      }

    } else if (filter === 'all' && isSuperAdminUser) {
      await loadAllUsersData(targetMonth);
    }
  } catch (error) {
    console.error('‚ùå Error loading KPI data:', error);
    showNotification('Error memuat data KPI: ' + error.message, 'error');
  }
}


    async function loadAllUsersData(selectedMonth = null) {
        try {
            const targetMonth = selectedMonth || getCurrentMonthYear().display;
            const isCurrentMonth = targetMonth === getCurrentMonthYear().display;
            
            console.log('üì• Loading all users data for month:', targetMonth);
            const db = firebase.firestore();
            const usersSnapshot = await db.collection('users').get();
            console.log(`üë• Found ${usersSnapshot.size} users`);
            
            const usersData = [];
            
            for (const userDoc of usersSnapshot.docs) {
                const userData = userDoc.data();
                const userId = userDoc.id;
                
                console.log(`üîç Processing user: ${userData.name || userData.email} for month: ${targetMonth}`);
                
                let userKpiData = null;
                let ideasData = null;
                
                if (isCurrentMonth) {
                    // Load data bulan berjalan dari kpiData collection
                    const kpiDoc = await db.collection('kpiData').doc(userId).get();
                    if (kpiDoc.exists) {
                        userKpiData = kpiDoc.data();
                    }
                    
                    // Load data ideas dari collection ideas
                    const ideasSnapshot = await db.collection('ideas')
                        .where('userId', '==', userId)
                        .get();
                    ideasData = {
                        count: ideasSnapshot.size,
                        data: ideasSnapshot.docs.map(doc => doc.data())
                    };
                    
                } else {
                    // Load data historical
                    const safeMonthYear = targetMonth.replace('/', '_');
                    const historyDoc = await db.collection('kpiHistory')
                        .doc(userId)
                        .collection('monthlyData')
                        .doc(safeMonthYear)
                        .get();
                    if (historyDoc.exists) {
                        userKpiData = historyDoc.data();
                    }
                }
                
                // Hitung ideasScore dari data ideas yang sebenarnya
                let ideasScore = 0;
                if (ideasData && ideasData.count > 0) {
                    ideasScore = calculateIdeasScore(ideasData);
                } else if (userKpiData && userKpiData.kpiData) {
                    // Fallback ke data kpiData jika tidak ada data ideas
                    ideasScore = getIndividualScore(userKpiData.kpiData, 3);
                }
                
                if (userKpiData && userKpiData.kpiData) {
                    const totalScore = userKpiData.totalScore || calculateTotalScoreFromKpiData(userKpiData.kpiData);
                    const researchScore = getIndividualScore(userKpiData.kpiData, 5);
                    const chatScore = getIndividualScore(userKpiData.kpiData, 4);
                    const problemScore = getIndividualScore(userKpiData.kpiData, 2);
                    
                    const lastUpdated = userKpiData.updatedAt ? 
                        new Date(userKpiData.updatedAt.toDate()).toLocaleDateString('id-ID') : '-';
                    
                    usersData.push({
                        userId: userId,
                        userName: userData.name || userData.email || 'Unknown User',
                        userEmail: userData.email || userId,
                        totalScore: totalScore.toFixed(2),
                        ideasScore: ideasScore.toFixed(2),
                        researchScore: researchScore.toFixed(2),
                        chatScore: chatScore.toFixed(2),
                        problemScore: problemScore.toFixed(2),
                        ideasCount: ideasData ? ideasData.count : 0,
                        lastUpdated: lastUpdated,
                        period: targetMonth,
                        isHistorical: !isCurrentMonth
                    });
                    
                    console.log(`‚úÖ User ${userData.name}: Ideas=${ideasScore.toFixed(2)}% (${ideasData ? ideasData.count : 0} ideas)`);
                } else {
                    // Data tidak ditemukan untuk bulan ini
                    usersData.push({
                        userId: userId,
                        userName: userData.name || userData.email || 'Unknown User',
                        userEmail: userData.email || userId,
                        totalScore: '0.00',
                        ideasScore: '0.00',
                        researchScore: '0.00',
                        chatScore: '0.00',
                        problemScore: '0.00',
                        ideasCount: 0,
                        lastUpdated: '-',
                        period: targetMonth,
                        isHistorical: !isCurrentMonth,
                        noData: true
                    });
                    
                    console.log(`üì≠ No data for user ${userData.name} in ${targetMonth}`);
                }
            }
            
            console.log('‚úÖ Final processed users data:', usersData);
            displayAllUsersData(usersData, targetMonth);
            
        } catch (error) {
            console.error('‚ùå Error loading all users data:', error);
            showNotification('Error memuat data semua user: ' + error.message, 'error');
        }
    }

    // Fungsi bantu untuk menghitung score individual dari kpiData
    function getIndividualScore(kpiDataArray, itemId) {
        if (!kpiDataArray || !Array.isArray(kpiDataArray)) return 0;
        
        const item = kpiDataArray.find(kpi => kpi.id === itemId);
        return item ? (item.score || 0) : 0;
    }

    // Fungsi untuk menghitung total score dari kpiData
    function calculateTotalScoreFromKpiData(kpiDataArray) {
        if (!kpiDataArray || !Array.isArray(kpiDataArray)) return 0;
        
        try {
            const total = kpiDataArray.reduce((sum, item) => {
                const score = parseFloat(item.score) || 0;
                const weight = parseFloat(item.weight) || 0;
                return sum + (score * weight) / 100;
            }, 0);
            
            return parseFloat(total.toFixed(2));
        } catch (error) {
            console.error('Error calculating total score from kpiData:', error);
            return 0;
        }
    }

    function displayAllUsersData(usersData, selectedMonth = null) {
        const container = document.querySelector('.kpi-container');
        if (!container) {
            console.error('KPI container not found');
            return;
        }
        
        const targetMonth = selectedMonth || getCurrentMonthYear().display;
        const isCurrentMonth = targetMonth === getCurrentMonthYear().display;
        
        console.log('üîÑ Displaying ALL users data:', usersData.length, 'users for month:', targetMonth);
        
        // Hapus tabel semua user yang sudah ada
        const existingTable = container.querySelector('.all-users-table');
        if (existingTable) existingTable.remove();

            if (backToAllBtn) {
        backToAllBtn.style.display = 'none';
    }
    isViewingUserDetail = false;
        
        // SEMBUNYIKAN tabel reguler
        const regularTable = container.querySelector('.kpi-table');
        if (regularTable) regularTable.style.display = 'none';
        
        // TAMPILKAN action buttons (Edit All & Reset)
        const actionButtons = container.querySelector('.action-buttons');
        if (actionButtons) actionButtons.style.display = 'flex';
        
        // Hapus warning historical jika ada
        const existingWarning = document.querySelector('.historical-data-warning');
        if (existingWarning) existingWarning.remove();
        
        // Tampilkan warning untuk data historical
        if (!isCurrentMonth) {
            
            const warningHtml = `
                <div class="historical-data-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>
                        <strong>Data Historical:</strong> 
                        Menampilkan data KPI untuk periode ${targetMonth}. 
                        Data ini bersifat read-only.
                    </p>
                </div>
            `;
            container.insertAdjacentHTML('afterbegin', warningHtml);
        }
        
        // PASTIKAN FILTER BULAN ADA
        if (!container.querySelector('.month-filter-container')) {
            addMonthFilterToKpiContainer();
        }
        
        // Update nilai filter bulan jika sudah ada
        const monthFilter = document.getElementById('monthFilter');
        if (monthFilter) {
            monthFilter.value = targetMonth;
        }
        
        // Buat tabel semua user
        const tableHtml = `
    <div class="all-users-table">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-users"></i> 
                Data KPI Semua User (${usersData.length} users)
                <span class="current-month-badge">${targetMonth}</span>
                ${!isCurrentMonth ? '<span style="color: #f39c12; margin-left: 8px;">(Historical Data)</span>' : ''}
            </h3>
            
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="btn-refresh-all" id="refresh-all-data">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
                <small style="color: #666;">Terakhir update: ${new Date().toLocaleTimeString()}</small>
            </div>
        </div>
                
                <table class="kpi-table">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>User</th>
                            <th>Email</th>
                            <th>Total KPI</th>
                            <th>Ideas</th>
                            <th>Research</th>
                            <th>Chat Response</th>
                            <th>Problem Solving</th>
                            <th>Status Data</th>
                            <th>Terakhir Update</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${usersData.map((user, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${user.userName}</td>
                                <td>${user.userEmail}</td>
                                <td class="${user.totalScore >= 70 ? 'target-achieved' : user.totalScore >= 50 ? 'target-partial' : 'target-missed'}">
                                    ${user.totalScore}%
                                </td>
                                <td>${user.ideasScore}%</td>
                                <td>${user.researchScore}%</td>
                                <td>${user.chatScore}%</td>
                                <td>${user.problemScore}%</td>
                                <td>
                                    ${user.noData ? 
                                        '<span style="color: #dc3545; font-style: italic;">No Data</span>' : 
                                        user.isHistorical ? 
                                        '<span style="color: #f39c12;">Historical</span>' : 
                                        '<span style="color: #28a745;">Current</span>'
                                    }
                                </td>
                                <td>${user.lastUpdated}</td>
                                <td>
                                    ${!user.noData ? `
                                        <button class="btn-view-user" data-uid="${user.userId}" data-name="${user.userName}" data-month="${targetMonth}">
                                            <i class="fas fa-eye"></i> Lihat Detail
                                        </button>
                                    ` : '<span style="color: #6c757d; font-style: italic;">-</span>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', tableHtml);
        
        // Event listeners
document.getElementById('refresh-all-data').addEventListener('click', async function() {
  const monthFilter = document.getElementById('monthFilter');
  const selectedMonth = monthFilter ? monthFilter.value : getCurrentMonthYear().display;

  await refreshAllUsersKpiAndTotals(selectedMonth);
});

        container.querySelectorAll('.btn-view-user').forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.dataset.uid;
                const userName = this.dataset.name;
                const month = this.dataset.month;
                
                console.log('üîç Viewing detail for user:', userName, 'month:', month);
                displayUserNameInHeader(userName);
                viewUserDetail(userId, month);
            });
        });
        
        showNotification(`Menampilkan data ${usersData.length} user untuk periode ${targetMonth}`, 'info');
    }

    async function viewUserDetail(userId, month = null) {
  console.log('üîç VIEW USER DETAIL:', userId, 'Month:', month);

  window.currentViewingUserId = userId;
  isViewingUserDetail = true;

  if (backToAllBtn && isSuperAdminUser) {
    backToAllBtn.style.display = 'inline-flex';
  }

  const regularTable = document.querySelector('.kpi-table');
  if (regularTable) regularTable.style.display = '';

  const allUsersTable = document.querySelector('.all-users-table');
  if (allUsersTable) allUsersTable.remove();

  const userName = await getUserNameById(userId);
  displayUserNameInHeader(userName);

  // ‚úÖ Pakai month yang dipilih
  const targetMonth = month || getCurrentMonthYear().display;
  const isCurrentMonth = targetMonth === getCurrentMonthYear().display;

  updateMonthDisplay(targetMonth);

  if (isCurrentMonth) {
    await checkAndResetForNewMonthForUser(userId);
    await loadRealTimeUserData(userId);
  } else {
    await loadHistoricalData(userId, targetMonth);
  }

  const userFilter = document.getElementById('userFilter');
  if (userFilter) userFilter.value = 'current';

  showNotification(`Memuat data user: ${userName}`, 'info');
}


    async function loadRealTimeUserData(userId) {
        try {
            console.log('üîÑ Loading real-time data for user:', userId);
            
            const db = firebase.firestore();
            
            // 1. PERTAMA, LOAD DATA YANG SUDAH ADA DI KPI DATA
            const kpiDoc = await db.collection('kpiData').doc(userId).get();
            let existingKpiData = null;
            
            if (kpiDoc.exists) {
                existingKpiData = kpiDoc.data();
                console.log('üìÅ Existing kpiData found:', existingKpiData);
                
                // Load existing data ke kpiData array
                if (existingKpiData.kpiData && Array.isArray(existingKpiData.kpiData)) {
                    kpiData.length = 0; // Clear existing data
                    existingKpiData.kpiData.forEach(savedItem => {
                        kpiData.push({
                            id: savedItem.id || 0,
                            area: savedItem.area || '',
                            target: savedItem.target || 0,
                            weight: savedItem.weight || 0,
                            description: savedItem.description || '',
                            note: savedItem.note || '',
                            realization: savedItem.realization || 0,
                            score: savedItem.score || 0
                        });
                    });
                }
            }
            
            // 2. KEDUA, UPDATE DENGAN DATA REAL-TIME DARI COLLECTIONS (JIKA ADA)
            console.log('üîÑ Checking real-time data from collections...');
            
            // Ideas - update jika ada data baru
            const ideasSnapshot = await db.collection('ideas')
                .where('userId', '==', userId)
                .get();
            if (ideasSnapshot.size > 0) {
                kpiData[2].realization = ideasSnapshot.size;
                console.log('‚úÖ Updated Ideas realization:', ideasSnapshot.size);
            }
            
            // Research - update jika ada data baru
            const researchSnapshot = await db.collection('research')
                .where('userId', '==', userId)
                .get();
            if (researchSnapshot.size > 0) {
                kpiData[4].realization = researchSnapshot.size;
                console.log('‚úÖ Updated Research realization:', researchSnapshot.size);
            }
            
            // Chat Response - update jika ada data baru
            const chatSnapshot = await db.collection('chats')
                .where('userId', '==', userId)
                .get();
            if (chatSnapshot.size > 0) {
                kpiData[3].realization = chatSnapshot.size;
                console.log('‚úÖ Updated Chat realization:', chatSnapshot.size);
            }
            
            // Problem Solving - update jika ada data baru
            const problemSnapshot = await db.collection('problems')
                .where('userId', '==', userId)
                .get();
            if (problemSnapshot.size > 0) {
                kpiData[1].realization = problemSnapshot.size;
                console.log('‚úÖ Updated Problem Solving realization:', problemSnapshot.size);
            }
            
            // B2B & B2C - update jika ada data baru
            const b2bSnapshot = await db.collection('b2b')
                .where('userId', '==', userId)
                .get();
            if (b2bSnapshot.size > 0) {
                kpiData[0].realization = b2bSnapshot.size;
                console.log('‚úÖ Updated B2B realization:', b2bSnapshot.size);
            }
            
            // Attitude - update jika ada data baru
            const attitudeSnapshot = await db.collection('attitude')
                .where('userId', '==', userId)
                .get();
            if (attitudeSnapshot.size > 0) {
                const attitudeScores = attitudeSnapshot.docs.map(doc => parseFloat(doc.data().score) || 0);
                const attitudeAverage = attitudeScores.length > 0 ? 
                    attitudeScores.reduce((a, b) => a + b, 0) / attitudeScores.length : 0;
                kpiData[5].realization = attitudeAverage;
                console.log('‚úÖ Updated Attitude realization:', attitudeAverage);
            }
            
            // Discipline - update jika ada data baru
            const disciplineSnapshot = await db.collection('discipline')
                .where('userId', '==', userId)
                .get();
            if (disciplineSnapshot.size > 0) {
                kpiData[6].realization = disciplineSnapshot.size;
                console.log('‚úÖ Updated Discipline realization:', disciplineSnapshot.size);
            }
            
            console.log('üìä Final kpiData after real-time update:', kpiData);
            
            // 3. HITUNG ULANG SEMUA SCORE
            kpiData.forEach((item, index) => {
                const isSmallerBetter = item.note.includes("Semakin Kecil");
                item.score = calculateScore(item.target, item.realization, isSmallerBetter, index);
            });
            
            // 4. UPDATE DISPLAY DAN SIMPAN KE FIRESTORE
            updateDisplay();
            await saveKpiDataToFirestore();
            
            showNotification('‚úÖ Data user berhasil dimuat', 'success');
            
        } catch (error) {
            console.error('‚ùå Error loading real-time user data:', error);
            showNotification('Error memuat data user: ' + error.message, 'error');
        }
    }

    async function loadHistoricalData(userId, monthYear) {
        try {
            console.log('üìö Loading historical data for user:', userId, 'month:', monthYear);
            
            // PERBAIKAN: Gunakan format yang valid untuk ID dokumen
            const safeMonthYear = monthYear.replace('/', '_'); // Ubah "11/2025" menjadi "11_2025"
            
            const db = firebase.firestore();
            const historyDoc = await db.collection('kpiHistory')
                .doc(userId)
                .collection('monthlyData')
                .doc(safeMonthYear)
                .get();
                
            if (historyDoc.exists) {
                const historicalData = historyDoc.data();
                console.log('‚úÖ Historical data found:', historicalData);
                
                // Update kpiData dengan data historical
                if (historicalData.kpiData && Array.isArray(historicalData.kpiData)) {
                    kpiData.length = 0;
                    historicalData.kpiData.forEach(savedItem => {
                        kpiData.push({
                            id: savedItem.id || 0,
                            area: savedItem.area || '',
                            target: savedItem.target || 0,
                            weight: savedItem.weight || 0,
                            description: savedItem.description || '',
                            note: savedItem.note || '',
                            realization: savedItem.realization || 0,
                            score: savedItem.score || 0
                        });
                    });
                    
                    updateDisplay();
                    showHistoricalDataWarning(monthYear);
                    return true;
                }
            } else {
                console.log('üì≠ No historical data found for:', monthYear);
                showNotification(`Tidak ada data historical untuk periode ${monthYear}`, 'warning');
                
                // Reset ke data default
                kpiData.forEach(item => {
                    item.realization = 0;
                    item.score = 0;
                });
                updateDisplay();
            }
            
            return false;
        } catch (error) {
            console.error('‚ùå Error loading historical data:', error);
            showNotification('Error memuat data historical', 'error');
            return false;
        }
    }

    function showHistoricalDataWarning(monthYear) {
        // Hapus warning sebelumnya jika ada
        const existingWarning = document.querySelector('.historical-data-warning');
        if (existingWarning) existingWarning.remove();
        
        const warningHtml = `
            <div class="historical-data-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <p>
                    <strong>Data Historical:</strong> 
                    Menampilkan data KPI untuk periode ${monthYear}. 
                    Data ini bersifat read-only dan tidak dapat diubah.
                </p>
            </div>
        `;
        
        const kpiContainer = document.querySelector('.kpi-container');
        if (kpiContainer) {
            const headerContainer = kpiContainer.querySelector('.kpi-header-container');
            if (headerContainer) {
                headerContainer.insertAdjacentHTML('afterend', warningHtml);
            }
        }
    }

    async function getUserNameById(userId) {
        try {
            const db = firebase.firestore();
            const userDoc = await db.collection('users').doc(userId).get();
            
            if (userDoc.exists) {
                const userData = userDoc.data();
                if (userData.name && userData.name !== 'User') return userData.name;
                else if (userData.email) return userData.email.split('@')[0];
            }
            return 'Loading...';
        } catch (error) {
            console.error('Error getting user name:', error);
            return 'Loading...';
        }
    }

    function displayUserNameInHeader(userName = null) {
        const kpiHeader = document.querySelector('.kpi-container h2');
        if (!kpiHeader) return;
        
        const existingUserBadge = document.querySelector('.user-name-badge');
        if (existingUserBadge) existingUserBadge.remove();
        
        const viewingUserId = getCurrentViewingUserId();
        
        if (!userName || viewingUserId === firebase.auth().currentUser?.uid) {
            kpiHeader.textContent = 'Data KPI Performance';
            return;
        }
        
        const userBadge = document.createElement('span');
        userBadge.className = 'user-name-badge';
        userBadge.dataset.userId = viewingUserId;
        userBadge.innerHTML = `<i class="fas fa-user"></i> ${userName}`;
        userBadge.style.cssText = `
            background: var(--primary-gradient);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-left: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            vertical-align: middle;
        `;
        
        kpiHeader.textContent = 'Data KPI Performance ';
        kpiHeader.appendChild(userBadge);
    }

    // ========== PERBAIKAN FUNGSI GET CURRENT VIEWING USER ==========

function getCurrentViewingUserId() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
        console.log('‚ùå No current user');
        return null;
    }
    
    console.log('üîç Getting viewing user ID:', {
        currentUser: currentUser.uid,
        currentUserEmail: currentUser.email,
        isSuperAdmin: isSuperAdminUser,
        currentFilter: currentFilter,
        windowCurrentViewing: window.currentViewingUserId,
        isViewingUserDetail: isViewingUserDetail
    });
    
    // 1. Jika Super Admin sedang melihat detail user tertentu
    if (isSuperAdminUser && window.currentViewingUserId && window.currentViewingUserId !== currentUser.uid) {
        console.log('‚úÖ Super Admin viewing specific user:', window.currentViewingUserId);
        return window.currentViewingUserId;
    }
    
    // 2. Jika Super Admin di mode "Semua User" tapi belum pilih user spesifik
    if (isSuperAdminUser && currentFilter === 'all' && !window.currentViewingUserId) {
        console.log('‚ö†Ô∏è Super Admin in "all" mode, using own data');
        return currentUser.uid; // Tetap ke data sendiri
    }
    
    // 3. Default: current user sendiri
    console.log('‚úÖ Using current user data:', currentUser.uid);
    return currentUser.uid;
}

    // ========== FUNGSI EDIT SYSTEM ==========

    function enableEditMode() {
        if (!isSuperAdminUser) {
            showNotification('Hanya Super Admin yang dapat mengedit data', 'error');
            return;
        }
        
        isEditingMode = true;
        preventRealTimeUpdate = true; // üî• NONAKTIFKAN REAL-TIME UPDATE
        showEditOptionsModal();
    }

    function enableRealisasiEditMode() {
        if (!isSuperAdminUser) {
            showNotification('Hanya Super Admin yang dapat mengedit realisasi', 'error');
            return;
        }
        
        isEditMode = true;
        document.querySelector('.kpi-container').classList.add('edit-mode');
        
        editAllBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Semua';
        editAllBtn.classList.add('btn-success');
        editAllBtn.classList.remove('btn-primary');
        
        const rows = document.querySelectorAll('.kpi-table tbody tr:not(.result-row)');
        rows.forEach((row, index) => {
            if (index < kpiData.length) {
                const data = kpiData[index];
                
                const realizationCell = row.querySelector('.realization-cell');
                if (realizationCell) {
                    realizationCell.innerHTML = `
                        <input type="number" 
                               class="edit-input realization-input" 
                               value="${data.realization}" 
                               min="0" 
                               data-field="realization" 
                               data-index="${index}"
                               placeholder="Realisasi">
                    `;
                }
                
                const actionCell = row.querySelector('td:last-child');
                if (actionCell && actionCell.innerHTML.trim() === '') {
                    actionCell.innerHTML = `
                        <button class="btn-edit-cell" onclick="editSingleRow(${index})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    `;
                }
            }
        });
        
        addRealisasiEditListeners();
        showNotification('Mode edit realisasi diaktifkan. Hanya Super Admin yang dapat mengubah data.', 'info');
    }

    function enableFullEditMode() {
        isEditMode = true;
        document.querySelector('.kpi-container').classList.add('edit-mode');
        
        editAllBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Semua';
        editAllBtn.classList.add('btn-success');
        editAllBtn.classList.remove('btn-primary');
        
        const rows = document.querySelectorAll('.kpi-table tbody tr:not(.result-row)');
        rows.forEach((row, index) => {
            if (index < kpiData.length) {
                const data = kpiData[index];
                
                const areaCell = row.querySelector('td:nth-child(2)');
                areaCell.innerHTML = `<input type="text" class="edit-input" value="${data.area}" data-field="area" data-index="${index}">`;
                
                const targetCell = row.querySelector('td:nth-child(3)');
                targetCell.innerHTML = `<input type="number" class="edit-input" value="${data.target}" min="0" data-field="target" data-index="${index}">`;
                
                const weightCell = row.querySelector('td:nth-child(4)');
                weightCell.innerHTML = `<input type="number" class="edit-input" value="${data.weight}" min="0" max="100" data-field="weight" data-index="${index}">`;
                
                const descCell = row.querySelector('td:nth-child(5)');
                descCell.innerHTML = `<input type="text" class="edit-input" value="${data.description}" data-field="description" data-index="${index}">`;
                
                const noteCell = row.querySelector('td:nth-child(6)');
                noteCell.innerHTML = `<input type="text" class="edit-input" value="${data.note}" data-field="note" data-index="${index}">`;
                
                const realizationCell = row.querySelector('.realization-cell');
                if (realizationCell) {
                    realizationCell.innerHTML = `<input type="number" class="edit-input realization-input" value="${data.realization}" min="0" data-field="realization" data-index="${index}">`;
                }
                
                const actionCell = row.querySelector('td:last-child');
                if (actionCell && actionCell.innerHTML.trim() === '') {
                    actionCell.innerHTML = `
                        <button class="btn-edit-cell" onclick="editSingleRow(${index})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    `;
                }
            }
        });
        
        addEditInputListeners();
        showNotification('Mode edit penuh diaktifkan. Semua data dapat diubah.', 'info');
    }

    function editSingleRow(index) {
        if (!isSuperAdminUser) {
            showNotification('Hanya Super Admin yang dapat mengedit data', 'error');
            return;
        }
        
        const row = document.querySelector(`.kpi-table tbody tr:nth-child(${index + 1})`);
        const data = kpiData[index];
        
        if (row) {
            const areaCell = row.querySelector('td:nth-child(2)');
            areaCell.innerHTML = `<input type="text" class="edit-input" value="${data.area}" data-field="area" data-index="${index}">`;
            
            const targetCell = row.querySelector('td:nth-child(3)');
            targetCell.innerHTML = `<input type="number" class="edit-input" value="${data.target}" min="0" data-field="target" data-index="${index}">`;
            
            const weightCell = row.querySelector('td:nth-child(4)');
            weightCell.innerHTML = `<input type="number" class="edit-input" value="${data.weight}" min="0" max="100" data-field="weight" data-index="${index}">`;
            
            const descCell = row.querySelector('td:nth-child(5)');
            descCell.innerHTML = `<input type="text" class="edit-input" value="${data.description}" data-field="description" data-index="${index}">`;
            
            const noteCell = row.querySelector('td:nth-child(6)');
            noteCell.innerHTML = `<input type="text" class="edit-input" value="${data.note}" data-field="note" data-index="${index}">`;
            
            const realizationCell = row.querySelector('.realization-cell');
            if (realizationCell) {
                realizationCell.innerHTML = `<input type="number" class="edit-input realization-input" value="${data.realization}" min="0" data-field="realization" data-index="${index}">`;
            }
            
            const actionCell = row.querySelector('td:last-child');
            if (actionCell) {
                actionCell.innerHTML = `
                    <button class="btn-save-cell" onclick="saveSingleRow(${index})">
                        <i class="fas fa-check"></i> Simpan
                    </button>
                    <button class="btn-cancel-cell" onclick="cancelSingleRow(${index})">
                        <i class="fas fa-times"></i> Batal
                    </button>
                `;
            }
            
            addEditInputListeners();
        }
    }

    async function saveSingleRow(index) {
        try {
            const row = document.querySelector(`.kpi-table tbody tr:nth-child(${index + 1})`);
            const inputs = row.querySelectorAll('.edit-input');
            
            inputs.forEach(input => {
                const field = input.dataset.field;
                let value = input.value;
                
                if (field === 'target' || field === 'weight' || field === 'realization') {
                    value = parseFloat(value) || 0;
                }
                
                kpiData[index][field] = value;
            });
            
            const data = kpiData[index];
            const isSmallerBetter = data.note.includes("Semakin Kecil");
            data.score = calculateScore(data.target, data.realization, isSmallerBetter, index);
            
            updateDisplayWithoutReload();
            
            const saveResult = await saveKpiDataToFirestore();
            
            if (saveResult) {
                showNotification(`Data ${data.area} berhasil diperbarui dan disimpan ke database!`, 'success');
                
                // üîÑ AUTO-REFRESH TABLE SEMUA USER JIKA SEDANG DI MODE ITU
                if (currentFilter === 'all' && isSuperAdminUser) {
                    console.log('üîÑ Auto-refreshing all users table after single row edit...');
                    setTimeout(() => {
                        loadAllUsersData();
                    }, 1000);
                }
                
                const actionCell = row.querySelector('td:last-child');
                if (actionCell) {
                    actionCell.innerHTML = `
                        <button class="btn-edit-cell" onclick="editSingleRow(${index})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    `;
                }
            } else {
                showNotification('Gagal menyimpan perubahan ke database', 'error');
            }
        } catch (error) {
            console.error('Error saving single row:', error);
            showNotification('Error: ' + error.message, 'error');
        }
    }

    function cancelSingleRow(index) {
        try {
            const row = document.querySelector(`.kpi-table tbody tr:nth-child(${index + 1})`);
            const data = kpiData[index];
            
            row.querySelector('td:nth-child(2)').textContent = data.area || '';
            row.querySelector('td:nth-child(3)').textContent = data.target || 0;
            row.querySelector('td:nth-child(4)').textContent = (data.weight || 0).toFixed(2) + '%';
            row.querySelector('td:nth-child(5)').textContent = data.description || '';
            row.querySelector('td:nth-child(6)').textContent = data.note || '';
            
            const realizationCell = row.querySelector('.realization-cell');
            if (realizationCell) realizationCell.textContent = data.realization || 0;
            
            const actionCell = row.querySelector('td:last-child');
            if (actionCell && isSuperAdminUser) {
                actionCell.innerHTML = `
                    <button class="btn-edit-cell" onclick="editSingleRow(${index})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                `;
            }
            
            showNotification('Edit dibatalkan', 'info');
        } catch (error) {
            console.error('Error in cancelSingleRow:', error);
            showNotification('Error membatalkan edit', 'error');
        }
    }

    async function disableEditMode() {
        try {
            console.log('üîÑ Disabling edit mode...');
            
            isEditingMode = false;
            preventRealTimeUpdate = true; // üî• TETAP NONAKTIFKAN SELAMA PROSES SAVE
            
            isEditMode = false;
            document.querySelector('.kpi-container').classList.remove('edit-mode');
            
            editAllBtn.innerHTML = '<i class="fas fa-edit"></i> Edit All';
            editAllBtn.classList.remove('btn-success');
            editAllBtn.classList.add('btn-primary');
            
            const inputs = document.querySelectorAll('.edit-input');
            let hasChanges = false;
            
            console.log('üìù Processing', inputs.length, 'input fields...');
            
            inputs.forEach(input => {
                const index = parseInt(input.dataset.index);
                const field = input.dataset.field;
                let value = input.value;
                
                if (field === 'target' || field === 'weight' || field === 'realization') {
                    value = parseFloat(value) || 0;
                }
                
                const oldValue = kpiData[index][field];
                if (oldValue != value) {
                    hasChanges = true;
                    console.log(`üîÑ Changing ${field} from ${oldValue} to ${value}`);
                    kpiData[index][field] = value;
                    
                    if (field === 'realization') {
                        const data = kpiData[index];
                        const isSmallerBetter = data.note.includes("Semakin Kecil");
                        data.score = calculateScore(data.target, data.realization, isSmallerBetter, index);
                        console.log(`üìä Recalculated score: ${data.score}`);
                    }
                }
            });
            
            if (hasChanges) {
                console.log('üíæ Changes detected, saving to Firestore...');
                updateDisplayWithoutReload();
                
                // üî• MATIKAN REAL-TIME LISTENERS SEBENTAR
                unsubscribeFunctions.forEach(unsub => unsub());
                unsubscribeFunctions = [];
                
                const saveResult = await saveKpiDataToFirestore();
                
                if (saveResult) {
                    showNotification('‚úÖ Perubahan berhasil disimpan ke database!', 'success');
                    console.log('‚úÖ Save successful');
                    
                    // üîÑ AUTO-REFRESH TABLE SEMUA USER JIKA SEDANG DI MODE ITU
                    if (currentFilter === 'all' && isSuperAdminUser) {
                        console.log('üîÑ Auto-refreshing all users table...');
                        setTimeout(() => {
                            loadAllUsersData();
                        }, 1000);
                    }
                } else {
                    showNotification('‚ùå Gagal menyimpan perubahan ke database', 'error');
                    console.error('‚ùå Save failed');
                }
                
                // üî• HIDUPKAN KEMBALI SETELAH 5 DETIK
                setTimeout(() => {
                    preventRealTimeUpdate = false;
                    setupRealTimeListeners();
                    setupModulesRealTimeListeners();
                }, 5000);
            } else {
                console.log('‚ÑπÔ∏è No changes to save');
                showNotification('Tidak ada perubahan yang disimpan', 'info');
                preventRealTimeUpdate = false;
            }
        } catch (error) {
            console.error('‚ùå Error in disableEditMode:', error);
            showNotification('Error: ' + error.message, 'error');
            preventRealTimeUpdate = false;
        }
    }

    function addEditInputListeners() {
        const inputs = document.querySelectorAll('.edit-input');
        inputs.forEach(input => {
            input.addEventListener('change', function() {
                const index = parseInt(this.dataset.index);
                const field = this.dataset.field;
                let value = this.value;
                
                if (field === 'target' || field === 'weight' || field === 'realization') {
                    value = parseFloat(value) || 0;
                }
                
                kpiData[index][field] = value;
            });
        });
    }

    function addRealisasiEditListeners() {
        const inputs = document.querySelectorAll('.realization-input');
        inputs.forEach(input => {
            input.addEventListener('change', function() {
                const index = parseInt(this.dataset.index);
                const value = parseFloat(this.value) || 0;
                kpiData[index].realization = value;
            });
        });
    }

    // ========== FUNGSI MODAL EDIT OPTIONS ==========

    function showEditOptionsModal() {
        const modalHtml = `
            <div class="reset-modal" id="edit-options-modal" style="display: flex;">
                <div class="reset-modal-content">
                    <div class="reset-modal-header">
                        <div class="reset-modal-icon">
                            <i class="fas fa-edit"></i>
                        </div>
                        <h3 class="reset-modal-title">Pilihan Edit</h3>
                    </div>
                    <div class="reset-modal-body">
                        <p class="reset-modal-text">Pilih jenis edit yang ingin dilakukan:</p>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
                            <button class="edit-option-btn" data-type="realisasi">
  <i class="fas fa-chart-bar"></i>
  <div class="edit-option-text">
    <strong>Edit Realisasi Saja</strong>
    <small>Hanya mengubah nilai realisasi</small>
  </div>
</button>
                            <button class="edit-option-btn" data-type="full">
                                <i class="fas fa-cogs"></i>
                                <div>
                                    <strong>Edit Semua Data</strong>
                                    <small>Edit target, bobot, deskripsi, dll</small>
                                </div>
                            </button>
                        </div>
                    </div>
                    <div class="reset-modal-actions">
                        <button class="reset-modal-btn reset-modal-btn-cancel" id="edit-options-cancel">
                            <i class="fas fa-times"></i> Batal
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const existingModal = document.getElementById('edit-options-modal');
        if (existingModal) existingModal.remove();
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        setTimeout(() => {
            setupEditOptionsModalEvents();
        }, 100);
    }

    function setupEditOptionsModalEvents() {
        const cancelBtn = document.getElementById('edit-options-cancel');
        const modal = document.getElementById('edit-options-modal');
        
        if (cancelBtn && modal) {
            cancelBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Tombol batal diklik');
                modal.remove();
                showNotification('Edit dibatalkan', 'info');
            });
            
            const optionButtons = document.querySelectorAll('.edit-option-btn');
            optionButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const editType = this.dataset.type;
                    console.log('Pilihan edit:', editType);
                    modal.remove();
                    
                    if (editType === 'realisasi') enableRealisasiEditMode();
                    else if (editType === 'full') enableFullEditMode();
                });
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                    showNotification('Edit dibatalkan', 'info');
                }
            });
            
            document.addEventListener('keydown', function closeModalOnEsc(e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    showNotification('Edit dibatalkan', 'info');
                    document.removeEventListener('keydown', closeModalOnEsc);
                }
            });
            
            console.log('Event listeners untuk modal edit options berhasil dipasang');
        } else {
            console.error('Element modal tidak ditemukan untuk setup events');
        }
    }

    // ========== FUNGSI RESET DATA ==========

    async function resetKpiData() {
        if (!isSuperAdminUser && currentFilter !== 'current') {
            showNotification('Hanya bisa mereset data sendiri', 'error');
            return;
        }
        
        const userConfirmed = confirm('Apakah Anda yakin ingin mereset semua data KPI ke nilai default?');
        
        if (!userConfirmed) {
            showNotification('Reset data dibatalkan', 'info');
            return;
        }
        
        try {
            console.log('üîÑ Resetting KPI data to defaults...');
            
            const defaults = [
                { area: "B2B & B2C (Count.)", target: 3, weight: 25, description: "Pembukaan WLB / Agent baru", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 },
                { area: "Problem Solving (Count.)", target: 6, weight: 20, description: "Kemampuan dalam menyelesaikan setiap masalah", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 },
                { area: "Idea (Count.)", target: 3, weight: 20, description: "Aktif memberikan ide, Saran & Masukan", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 },
                { area: "Response Chat (Count.)", target: 4, weight: 10, description: "Kecepatan dan ketepatan dalam Merespon Chat (Max 3 Menit)", note: "Semakin Kecil Semakin Bagus", realization: 0, score: 0 },
                { area: "Research (Count.)", target: 28, weight: 10, description: "Research keunggulan Platform / Agent Lain", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 },
                { area: "Attitude (Skor.)", target: 8, weight: 10, description: "Attitude dalam mengikuti SOP / Arahan", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 },
                { area: "Disiplin (Day.)", target: 28, weight: 5, description: "Jumlah kedisiplinan setiap bulan", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 }
            ];
            
            kpiData.forEach((item, index) => {
                if (defaults[index]) Object.assign(item, defaults[index]);
            });
            
            await saveKpiDataToFirestore();
            updateDisplay();
            await resetFirestoreData();
            
            showNotification('‚úÖ Data KPI berhasil direset ke nilai default!', 'success');
            console.log('‚úÖ KPI data reset successfully');
        } catch (error) {
            console.error('‚ùå Error resetting KPI data:', error);
            showNotification('‚ùå Gagal mereset data KPI: ' + error.message, 'error');
        }
    }

    async function resetFirestoreData() {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return;
            
            const db = firebase.firestore();
            const userId = currentFilter === 'all' && isSuperAdminUser ? null : currentUser.uid;
            
            const collections = ['ideas', 'research', 'chats', 'problems', 'b2b', 'attitude', 'discipline'];
            
            for (const collectionName of collections) {
                let query = db.collection(collectionName);
                
                if (userId) query = query.where('userId', '==', userId);
                
                const snapshot = await query.get();
                const deletePromises = snapshot.docs.map(doc => doc.ref.delete());
                await Promise.all(deletePromises);
                
                console.log(`‚úÖ Reset ${collectionName}: ${snapshot.size} documents deleted`);
            }
        } catch (error) {
            console.error('Error resetting Firestore data:', error);
        }
    }

    // ========== FUNGSI UPDATE DISPLAY ==========

    function updateDisplay() {
    console.log('üîÑ Updating display (protected mode)');
    
    // Simpan semua teks yang sudah diterjemahkan
    const translationBackup = new Map();
    
    // Backup teks pada elemen yang sudah diterjemahkan
    document.querySelectorAll('.kpi-table th, .kpi-table td.text-left, .summary-title').forEach(el => {
        const text = el.textContent;
        if (text && text.trim()) {
            translationBackup.set(el, text);
        }
    });
    
    // Update data seperti biasa
    const rows = document.querySelectorAll('.kpi-table tbody tr:not(.result-row)');
    rows.forEach((row, index) => {
        if (index < kpiData.length) {
            const data = kpiData[index];
            
            // ... kode update angka/nilai ...
            
            // JANGAN ubah teks yang sudah ada di backup
            const areaCell = row.querySelector('td:nth-child(2)');
            if (areaCell && translationBackup.has(areaCell)) {
                // Biarkan teks terjemahan asli
            } else {
                // Update jika tidak ada backup
                areaCell.textContent = data.area || '';
            }
            
            // ... sisa update ...
        }
    });
    
    updateKPI();
    console.log('‚úÖ Display updated (translations preserved)');
}

    function updateDisplayWithoutReload() {
        console.log('üîÑ Updating display without reload...');
        
        const rows = document.querySelectorAll('.kpi-table tbody tr:not(.result-row)');
        rows.forEach((row, index) => {
            if (index < kpiData.length) {
                const data = kpiData[index];
                
                const safeTarget = data.target || 0;
                const safeWeight = data.weight || 0;
                const safeRealization = data.realization || 0;
                const safeScore = data.score || 0;
                
                if (!isEditMode) {
                    row.querySelector('td:nth-child(2)').textContent = data.area || '';
                    row.querySelector('td:nth-child(3)').textContent = safeTarget;
                    row.querySelector('td:nth-child(4)').textContent = safeWeight.toFixed(2) + '%';
                    row.querySelector('td:nth-child(5)').textContent = data.description || '';
                    row.querySelector('td:nth-child(6)').textContent = data.note || '';
                }
                
                const realizationCell = row.querySelector('.realization-cell');
                if (realizationCell && !realizationCell.querySelector('input')) {
                    realizationCell.textContent = safeRealization;
                }
                
                const scoreCell = row.querySelector('td:nth-child(9)');
                if (scoreCell) {
                    scoreCell.textContent = safeScore.toFixed(2) + '%';
                    scoreCell.className = '';
                    
                    if (safeScore >= 100) scoreCell.classList.add('target-achieved');
                    else if (safeScore >= 70) scoreCell.classList.add('target-partial');
                    else scoreCell.classList.add('target-missed');
                }
            }
        });
        
        updateKPITotalsOnly();
        console.log('‚úÖ Display updated without reload');
    }

    function updateKPITotalsOnly() {
        let totalScore = 0;
        let totalRealization = 0;
        
        kpiData.forEach((item, index) => {
            totalScore += (item.score * item.weight) / 100;
            totalRealization += item.realization;
        });
        
        updateElementText('total-score', totalScore.toFixed(2) + '%');
        updateElementText('total-realization', totalRealization);
        updateElementText('total-kpi', totalScore.toFixed(2) + '%');
        updateProgressBar('.summary-card:first-child .progress-fill', Math.min(totalScore, 100));
        
        const totalScoreCell = document.getElementById('total-score');
        if (totalScoreCell) {
            totalScoreCell.className = '';
            if (totalScore >= 70) totalScoreCell.classList.add('target-achieved');
            else if (totalScore >= 50) totalScoreCell.classList.add('target-partial');
            else totalScoreCell.classList.add('target-missed');
        }
    }

    function initializeActionButtons() {
        const rows = document.querySelectorAll('.kpi-table tbody tr:not(.result-row)');
        rows.forEach((row, index) => {
            if (index < kpiData.length) {
                const actionCell = row.querySelector('td:last-child');
                if (actionCell) {
                    if (isSuperAdminUser) {
                        actionCell.innerHTML = `
                            <button class="btn-edit-cell" onclick="editSingleRow(${index})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        `;
                    } else {
                        actionCell.innerHTML = `<span class="no-action">-</span>`;
                    }
                }
            }
        });
    }

    // ========== FUNGSI REAL-TIME LISTENERS ==========

    function setupRealTimeListeners() {
    console.log('üîî Setting up real-time listeners');
    
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
        console.log('‚ùå No user for real-time listeners');
        return;
    }
    
    // Hentikan semua listener sebelumnya
    unsubscribeFunctions.forEach(unsub => unsub());
    unsubscribeFunctions = [];
    
    // Tentukan target user dengan benar
    const targetUserId = getCurrentViewingUserId();
    
    console.log('üéØ Setting up real-time listeners for user:', targetUserId);
    
    // JANGAN setup listener jika tidak ada target user
    if (!targetUserId) {
        console.log('‚ö†Ô∏è No target user for listeners, skipping');
        return;
    }
    
    const db = firebase.firestore();
    
    // Listener untuk kpiData
    const kpiUnsubscribe = db.collection('kpiData')
        .doc(targetUserId)
        .onSnapshot((doc) => {
            // SKIP jika perubahan dari edit lokal
            if (isLocalChange && (Date.now() - lastLocalChangeTime < 5000)) {
                console.log('üîÑ Skipping real-time update (local change)');
                return;
            }
            
            // SKIP jika sedang dalam mode edit
            if (isEditingMode || preventRealTimeUpdate) {
                console.log('‚ö†Ô∏è Skipping real-time update (edit mode)');
                return;
            }
            
            if (doc.exists) {
                const savedData = doc.data();
                console.log('üì• Real-time update from Firestore for user:', targetUserId);
                
                // CEK apakah data ini untuk user yang sedang dilihat
                const currentViewing = getCurrentViewingUserId();
                if (savedData.userId !== currentViewing) {
                    console.log('üö´ Ignoring update - data is for different user:', savedData.userId);
                    return;
                }
                
                updateKpiFromFirestore(savedData);
            }
        }, (error) => {
            console.error('‚ùå Real-time listener error:', error);
        });
    
    unsubscribeFunctions.push(kpiUnsubscribe);
    
    console.log('‚úÖ Real-time listeners setup complete for user:', targetUserId);
}

    // ========== FUNGSI PERIODE & BULAN ==========

    function getCurrentMonthYear() {
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const monthsID = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        
        const now = new Date();
        const currentMonthIndex = now.getMonth();
        const currentYear = now.getFullYear();
        
        const currentLanguage = localStorage.getItem('language') || 'id';
        const monthName = currentLanguage === 'id' ? monthsID[currentMonthIndex] : months[currentMonthIndex];
        
        return {
            month: (currentMonthIndex + 1).toString().padStart(2, '0'),
            year: currentYear,
            display: `${(currentMonthIndex + 1).toString().padStart(2, '0')}/${currentYear}`,
            fullDisplay: `${monthName} ${currentYear}`
        };
    }
async function checkAndResetForNewMonthForUser(userId) {
  try {
    const db = firebase.firestore();
    const currentPeriod = getCurrentMonthYear().display;

    const kpiDoc = await db.collection('kpiData').doc(userId).get();
    if (!kpiDoc.exists) return;

    const data = kpiDoc.data();
    const firestorePeriod = data.period || null;

    if (firestorePeriod !== currentPeriod) {
      if (firestorePeriod) await saveCurrentMonthToHistoryForUser(userId, firestorePeriod);
      await resetKpiDataForNewMonthForUser(userId, data);
    }
  } catch (e) {
    console.error('checkAndResetForNewMonthForUser error:', e);
  }
}

async function saveCurrentMonthToHistoryForUser(userId, period) {
  const db = firebase.firestore();
  const safePeriod = period.replace('/', '_');
  const currentKpiDoc = await db.collection('kpiData').doc(userId).get();
  if (!currentKpiDoc.exists) return;

  await db.collection('kpiHistory')
    .doc(userId)
    .collection('monthlyData')
    .doc(safePeriod)
    .set({
      ...currentKpiDoc.data(),
      period,
      savedAt: firebase.firestore.FieldValue.serverTimestamp(),
      isHistorical: true
    });
}

async function resetKpiDataForNewMonthForUser(userId, existingData) {
  const db = firebase.firestore();
  const currentPeriod = getCurrentMonthYear().display;

  if (existingData.kpiData && Array.isArray(existingData.kpiData)) {
    existingData.kpiData.forEach(item => {
      item.realization = 0;
      item.score = 0;
    });
  }

  await db.collection('kpiData').doc(userId).set({
    ...existingData,
    period: currentPeriod,
    lastReset: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });

  // kalau yang sedang dilihat = user ini, sinkronkan UI lokal
  if (window.currentViewingUserId === userId || firebase.auth().currentUser?.uid === userId) {
    kpiData.length = 0;
    existingData.kpiData.forEach(item => kpiData.push(item));
    updateDisplay();
  }
}

    function generateMonthOptions() {
        const monthsID = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth();
        
        const options = [];
        
        // Tambahkan 12 bulan terakhir termasuk bulan berjalan
        for (let i = 0; i < 12; i++) {
            const date = new Date(currentYear, currentMonth - i, 1);
            const monthIndex = date.getMonth();
            const year = date.getFullYear();
            const monthYear = `${(monthIndex + 1).toString().padStart(2, '0')}/${year}`;
            const displayText = `${monthsID[monthIndex]} ${year}`;
            
            options.push({
                value: monthYear,
                text: displayText,
                isCurrent: i === 0
            });
        }
        
        return options;
    }

    function addMonthFilterToKpiContainer() {
    const kpiContainer = document.querySelector('.kpi-container');
    if (!kpiContainer) {
        console.error('KPI container not found');
        return;
    }
    
    // Hapus filter bulan yang sudah ada
    const existingMonthFilter = kpiContainer.querySelector('.month-filter-container');
    if (existingMonthFilter) {
        existingMonthFilter.remove();
    }
    
    // Update HTML untuk filter bulan yang mendukung dark mode
    const monthFilterHTML = `
    <div class="month-filter-container">
        <span class="month-filter-label">
            <i class="fas fa-calendar-alt"></i> Pilih Periode:
        </span>
        <select class="month-filter-select" id="monthFilter">
            ${generateMonthOptions().map(option => `
                <option value="${option.value}" ${option.isCurrent ? 'selected' : ''}>
                    ${option.text} ${option.isCurrent ? '‚úì' : ''}
                </option>
            `).join('')}
        </select>
        ${generateMonthOptions()[0].isCurrent ? 
            `<span class="current-month-badge">
                <i class="fas fa-star"></i> Bulan Berjalan
            </span>` : 
            `<span class="historical-month-badge">
                <i class="fas fa-history"></i> Data Historis
            </span>`
        }
        <div class="filter-info">
            <i class="fas fa-info-circle"></i>
            Pilih bulan untuk melihat data KPI periode tertentu
        </div>
    </div>
`;
    
    // Temukan header container dan tambahkan filter bulan DI BAWAH JUDUL
    const headerContainer = kpiContainer.querySelector('.kpi-header-container');
    if (headerContainer) {
        // Tambahkan filter bulan SETELAH headerContainer (bukan di dalamnya)
        headerContainer.insertAdjacentHTML('afterend', monthFilterHTML);
        
        // Event listener untuk filter bulan
        document.getElementById('monthFilter').addEventListener('change', function() {
            const selectedMonth = this.value;
            console.log('Month filter changed to:', selectedMonth);
            
            // Update tampilan bulan
            updateMonthDisplay(selectedMonth);
            
            // Load data sesuai dengan filter yang aktif
            if (currentFilter === 'all') {
                loadAllUsersData(selectedMonth);
            } else {
                const targetUserId = getCurrentViewingUserId();
                loadKpiData(currentFilter, targetUserId, selectedMonth);
            }
        });
    }
    
    console.log('‚úÖ Month filter added to KPI container');
}
let __refreshKpiRunning = false;

async function refreshAllUsersKpiAndTotals(selectedMonth) {
  if (__refreshKpiRunning) return;
  __refreshKpiRunning = true;

  const btn = document.getElementById('refresh-all-data');
  const originalText = btn?.innerHTML;
  if (btn) { btn.disabled = true; btn.innerHTML = '‚è≥ Refresh KPI...'; }

  try {
    const currentPeriod = getCurrentMonthYear().display;
    const isCurrentMonth = selectedMonth === currentPeriod;

    // historical: jangan recompute (cukup reload)
    if (!isCurrentMonth) {
      await loadAllUsersData(selectedMonth);
      return;
    }

    const db = firebase.firestore();
    const usersSnapshot = await db.collection('users').get();

    for (const u of usersSnapshot.docs) {
      const userId = u.id;

      // 1) Ambil ulang data real dari modul
      const [ideasSnap, researchSnap, chatsSnap] = await Promise.all([
        db.collection('ideas').where('userId', '==', userId).get(),
        db.collection('research').where('userId', '==', userId).get(),
        db.collection('chats').where('userId', '==', userId).get(),
      ]);

      const ideasCount = ideasSnap.size;
      const researchCount = researchSnap.size;
      const chatsCount = chatsSnap.size;

      // 2) Siapkan array KPI item untuk dihitung ulang
      const kpiDocRef = db.collection('kpiData').doc(userId);
      const kpiDocSnap = await kpiDocRef.get();
      const existing = kpiDocSnap.exists ? kpiDocSnap.data() : null;

      // Kalau user belum punya kpiData, pakai template dari variabel kpiData (default KPI kamu)
      let items = (existing?.kpiData && Array.isArray(existing.kpiData))
        ? existing.kpiData
        : kpiData.map(x => ({
            id: x.id,
            area: x.area,
            target: x.target,
            weight: x.weight,
            description: x.description,
            note: x.note,
            realization: 0,
            score: 0
          }));

      // helper: set realization + hitung score item
      function setRealization(id, realization) {
        const idx = items.findIndex(it => it.id === id);
        if (idx === -1) return;

        items[idx].realization = realization;

        // kamu sudah pakai konsep ‚ÄúSemakin Kecil‚Äù di note untuk menentukan arah scoring :contentReference[oaicite:3]{index=3}
        const smallerBetter = (items[idx].note || '').includes('Semakin Kecil');
        items[idx].score = calculateScore(items[idx].target, realization, smallerBetter, idx);
      }

      // 3) Mapping ID KPI ‚Üí realization (SESUAIKAN ID kamu)
      // Dari file kpi-css, ideas sering dianggap id=3 :contentReference[oaicite:4]{index=4}
      setRealization(3, ideasCount);       // Ideas
      setRealization(5, researchCount);    // Research (sesuaikan jika id beda)
      setRealization(4, chatsCount);       // Chat (sesuaikan jika id beda)

      // 4) Hitung total dan simpan balik
      const totalScore = calculateTotalScore(items);

      await kpiDocRef.set({
        kpiData: items,
        totalScore: totalScore,
        period: currentPeriod,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedByAdmin: true
      }, { merge: true });
    }

    // 5) Reload tabel supaya angka total yang baru langsung tampil
    await loadAllUsersData(currentPeriod);
    showNotification('‚úÖ Total KPI semua user berhasil diupdate', 'success');

  } catch (err) {
    console.error('refreshAllUsersKpiAndTotals error:', err);
    showNotification('‚ùå Gagal refresh total KPI: ' + (err?.message || err), 'error');
  } finally {
    __refreshKpiRunning = false;
    if (btn) { btn.disabled = false; btn.innerHTML = originalText || 'Refresh Data'; }
  }
}

    function getMonthNameFromPeriod(period) {
        if (!period) return 'Loading...';
        
        const monthsID = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                         'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        
        try {
            const [month, year] = period.split('/');
            const monthIndex = parseInt(month) - 1;
            
            if (monthIndex >= 0 && monthIndex < 12) {
                return `${monthsID[monthIndex]} ${year}`;
            }
        } catch (error) {
            console.error('Error parsing period:', error);
        }
        
        return period;
    }

    function updateMonthDisplay(monthYear) {
    try {
        console.log('üîÑ Updating month display to:', monthYear);
        
        // Update header tabel
        const monthHeader = document.getElementById('current-month-header');
        if (monthHeader) {
            monthHeader.textContent = getMonthNameFromPeriod(monthYear);
        }
        
        // üî• UPDATE TOMBOL KEMBALI JIKA SEDANG MELIHAT DETAIL USER
        if (backToAllBtn && isSuperAdminUser && isViewingUserDetail) {
            backToAllBtn.style.display = 'inline-flex';
        }
        
        console.log('‚úÖ Month display updated successfully');
    } catch (error) {
        console.error('‚ùå Error updating month display:', error);
    }
}

    // ========== FUNGSI NOTIFICATION ==========

    function showNotification(message, type = 'info') {
        if (!notificationContainer) {
            console.error('Notification container not found');
            return;
        }
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
            <button class="notification-close">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        notificationContainer.appendChild(notification);
        
        const closeBtn = notification.querySelector('.notification-close');
        closeBtn.addEventListener('click', function() {
            closeNotification(notification);
        });
        
        const timeoutId = setTimeout(() => {
            closeNotification(notification);
        }, 5000);
        
        notification.dataset.timeoutId = timeoutId;
    }

    function closeNotification(notification) {
        if (notification.dataset.timeoutId) {
            clearTimeout(parseInt(notification.dataset.timeoutId));
        }
        
        notification.classList.add('hiding');
        
        setTimeout(() => {
            if (notification.parentElement) notification.remove();
        }, 300);
    }

    // ========== FUNGSI MODULE COLLECTIONS ==========

    async function updateModuleCollections(userId) {
        try {
            const db = firebase.firestore();
            
            const ideasData = kpiData.find(item => item.id === 3);
            if (ideasData) await updateIdeasCollection(userId, ideasData.realization);
            
            const researchData = kpiData.find(item => item.id === 5);
            if (researchData) await updateResearchCollection(userId, researchData.realization);
            
            const chatData = kpiData.find(item => item.id === 4);
            if (chatData) await updateChatCollection(userId, chatData.realization);
            
            console.log('‚úÖ Module collections updated');
        } catch (error) {
            console.error('Error updating module collections:', error);
        }
    }

    async function updateIdeasCollection(userId, realization) {
        const db = firebase.firestore();
        
        const oldIdeas = await db.collection('ideas').where('userId', '==', userId).get();
        const deletePromises = oldIdeas.docs.map(doc => doc.ref.delete());
        await Promise.all(deletePromises);
        
        for (let i = 0; i < realization; i++) {
            await db.collection('ideas').add({
                userId: userId,
                title: `Idea ${i + 1}`,
                points: 1,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    }

    async function updateResearchCollection(userId, realization) {
        const db = firebase.firestore();
        
        const oldResearch = await db.collection('research').where('userId', '==', userId).get();
        const deletePromises = oldResearch.docs.map(doc => doc.ref.delete());
        await Promise.all(deletePromises);
        
        for (let i = 0; i < realization; i++) {
            await db.collection('research').add({
                userId: userId,
                title: `Research ${i + 1}`,
                points: 1,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    }

    async function updateChatCollection(userId, realization) {
        const db = firebase.firestore();
        
        const oldChats = await db.collection('chats').where('userId', '==', userId).get();
        const deletePromises = oldChats.docs.map(doc => doc.ref.delete());
        await Promise.all(deletePromises);
        
        for (let i = 0; i < realization; i++) {
            await db.collection('chats').add({
                userId: userId,
                responseTime: 2.5,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    }

async function initializeKpiDocument() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) return;

    const db = firebase.firestore();
    const currentPeriod = getCurrentMonthYear();

    await db.collection('kpiData').doc(currentUser.uid).set({
        kpiData: kpiData, // data default yang sudah kamu set di atas
        userId: currentUser.uid,
        userName: currentUser.displayName || currentUser.email,
        period: currentPeriod.display, // ‚úÖ penting untuk reset bulanan
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
}

    // ========== EVENT LISTENERS ==========

    document.addEventListener('DOMContentLoaded', async function() {
        console.log('üöÄ KPI Integration initialized');
        
        if (typeof firebase !== 'undefined' && firebase.auth()) {
            let isInitialized = false;
            if (backToAllBtn) {
        backToAllBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (!isSuperAdminUser) {
                showNotification('Hanya Super Admin yang dapat menggunakan fitur ini', 'error');
                return;
            }
            
            backToAllUsers();
        });
    }

            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    if (!isInitialized) {
                        isInitialized = true;
                        
                        await checkAndSetupSuperAdmin();
                        await initializeKpiData();
                        
                        setupRealTimeListeners();
                        setupModulesRealTimeListeners();
                        
                        console.log('‚úÖ KPI Dashboard initialized successfully');
                    }
                } else {
                    console.log('‚ùå User not authenticated');
                    isInitialized = false;
                    unsubscribeFunctions.forEach(unsub => unsub());
                    unsubscribeFunctions = [];
                    setupAdminUI(false);
                }
            });
        }
    });

    if (editAllBtn) {
        editAllBtn.addEventListener('click', (e) => {
            if (!isSuperAdminUser) {
                e.preventDefault();
                e.stopPropagation();
                showNotification('Hanya Super Admin yang dapat mengedit data', 'error');
                return;
            }
            
            if (!isEditMode) enableEditMode();
            else disableEditMode();
        });
    }

    if (resetBtn) {
        resetBtn.addEventListener('click', (e) => {
            if (!isSuperAdminUser && currentFilter !== 'current') {
                e.preventDefault();
                e.stopPropagation();
                showNotification('Hanya bisa mereset data sendiri', 'error');
                return;
            }
            
            resetKpiData();
        });
    }

    document.addEventListener('click', function(e) {
        if (e.target.closest('.submenu-container .btn-edit-all') || 
            e.target.closest('.criteria-list .btn-primary')) {
            if (!isSuperAdminUser) {
                e.preventDefault();
                e.stopPropagation();
                showNotification('Hanya Super Admin yang dapat mengedit data', 'error');
            }
        }
    });

    // ========== FUNGSI BANTU ==========

    function calculateIdeasScore(ideasData) {
        const target = 3;
        if (ideasData.count >= target) return 100;
        return (ideasData.count / target) * 100;
    }

    function calculateResearchScore(researchData) {
        const target = 28;
        if (researchData.count >= target) return 100;
        return (researchData.count / target) * 100;
    }

    function calculateChatScore(chatData) {
        const penalty = chatData.missedChats * 25;
        return Math.max(0, 100 - penalty);
    }

    function calculateProblemScore(problemData) {
        const target = 6;
        if (problemData.count >= target) return 100;
        return (problemData.count / target) * 100;
    }

    function calculateB2BScore(b2bData) {
        const target = 3;
        if (b2bData.count >= target) return 100;
        return (b2bData.count / target) * 100;
    }

    function calculateAttitudeScore(attitudeData) {
        const target = 8;
        if (attitudeData.averageScore >= target) return 100;
        return (attitudeData.averageScore / target) * 100;
    }

    function calculateDisciplineScore(disciplineData) {
        const target = 28;
        if (disciplineData.count >= target) return 100;
        return (disciplineData.count / target) * 100;
    }

    // ========== FUNGSI DEBUG ==========

    window.debugKPI = function() {
        console.log('=== DEBUG KPI DASHBOARD ===');
        console.log('Current User:', firebase.auth().currentUser);
        console.log('Is Super Admin:', isSuperAdminUser);
        console.log('Current Filter:', currentFilter);
        console.log('KPI Data:', kpiData);
        console.log('Firestore Config:', firebaseConfig);
        
        const db = firebase.firestore();
        db.collection('kpiData').get().then(snapshot => {
            console.log('Total KPI Documents:', snapshot.size);
            snapshot.forEach(doc => console.log('KPI Doc:', doc.id, doc.data()));
        });
        
        db.collection('users').get().then(snapshot => {
            console.log('Total User Documents:', snapshot.size);
            snapshot.forEach(doc => console.log('User Doc:', doc.id, doc.data()));
        });
    };

    window.debugSaveIssue = function() {
        console.log('=== DEBUG SAVE ISSUE ===');
        console.log('Current User:', firebase.auth().currentUser?.uid);
        console.log('isSuperAdminUser:', isSuperAdminUser);
        console.log('currentFilter:', currentFilter);
        console.log('Viewing User ID:', getCurrentViewingUserId());
        console.log('kpiData:', kpiData);
        
        const db = firebase.firestore();
        const targetUserId = getCurrentViewingUserId();
        
        if (targetUserId) {
            db.collection('kpiData').doc(targetUserId).get().then(doc => {
                if (doc.exists) console.log('Firestore data for target user:', doc.data());
                else console.log('No data in Firestore for target user');
            });
        }
    };

    window.forceSuperAdmin = function() {
        isSuperAdminUser = true;
        setupAdminUI(true);
        console.log('üîì Super admin forced enabled');
        showNotification('Super Admin mode diaktifkan secara manual', 'info');
        loadKpiData('all');
    };

    window.debugChatResponse = function() {
        console.log('=== DEBUG CHAT RESPONSE ===');
        const chatKpi = kpiData.find(item => item.id === 4);
        console.log('Chat Response KPI:', chatKpi);
        
        console.log('Calculation Test:');
        console.log('Target:', chatKpi.target);
        console.log('Current Realization:', chatKpi.realization);
        console.log('Current Score:', chatKpi.score);
        
        // Test calculation
        for (let i = 0; i <= 4; i++) {
            const testScore = calculateScore(chatKpi.target, i, false, 3);
            console.log(`Test: ${i} chats = ${testScore}%`);
        }
    };

    console.log('‚úÖ Enhanced KPI System loaded successfully');
</script>
<script>
(function forceShowSaveAll() {
function force(el) {
  if (!el) return;

  // ‚úÖ HANYA IZINKAN JIKA SUPER ADMIN
  // (tombol harus punya class admin-visible)
  if (!el.classList.contains("admin-visible")) return;

  el.style.setProperty("display", "inline-flex", "important");
  el.style.setProperty("visibility", "visible", "important");
  el.style.setProperty("opacity", "1", "important");


    // Paksa bentuk tombol biar gak putih polos
    el.style.setProperty("align-items", "center", "important");
    el.style.setProperty("gap", "8px", "important");
    el.style.setProperty("padding", "10px 14px", "important");
    el.style.setProperty("border-radius", "10px", "important");
    el.style.setProperty("border", "none", "important");

    // Kalau class btn-success ada ‚Üí hijau, kalau tidak ‚Üí fallback biru
    const isSuccess = el.classList.contains("btn-success") || /simpan/i.test(el.textContent || "");
    el.style.setProperty("background-color", isSuccess ? "#2ecc71" : "#4f46e5", "important");
    el.style.setProperty("color", "#fff", "important");
    el.style.setProperty("cursor", "pointer", "important");
  }

  function run() {
    // 1) tombol header (biasanya id ini)
    force(document.querySelector("#edit-all-btn"));

    // 2) tombol simpan/edit yang di submenu/card (yang sering jadi kotak putih)
    document.querySelectorAll(".submenu-container .btn-edit-all, .btn-edit-all").forEach(force);
  }

  // Jalankan sekali saat load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", run);
  } else {
    run();
  }

  // Pantau perubahan DOM (kalau tombol dibuat ulang / teks berubah)
  const obs = new MutationObserver(() => run());
  obs.observe(document.documentElement, { childList: true, subtree: true, attributes: true });

  // Jaga-jaga: interval pendek beberapa detik pertama
  let count = 0;
  const t = setInterval(() => {
    run();
    if (++count > 20) clearInterval(t); // stop setelah ~10 detik
  }, 500);
})();
</script>
<script>
// SIMPLE KPI LANGUAGE INITIALIZER
(function initKpiLanguageSystem() {
    console.log('üîß Setting up KPI language system');
    
    let isApplyingTranslation = false;
    let languageChangeTimeout = null;
    
    function applyTranslation(language) {
        if (isApplyingTranslation || !window.applyKpiTranslations) return;
        
        isApplyingTranslation = true;
        console.log('üåê Applying KPI translation for:', language);
        
        // Beri tanda pada elemen yang akan diterjemahkan
        document.querySelectorAll('.kpi-table th, .kpi-table td, .summary-title, .summary-content p')
            .forEach(el => el.classList.add('translating'));
        
        window.applyKpiTranslations(language);
        
        // Hapus tanda setelah selesai
        setTimeout(() => {
            document.querySelectorAll('.translating').forEach(el => el.classList.remove('translating'));
            isApplyingTranslation = false;
        }, 1000);
    }
    
    // Inisialisasi awal
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            const lang = localStorage.getItem('language') || 'id';
            applyTranslation(lang);
        }, 800); // Delay cukup panjang
    });
    
    // Handle language change (only once)
    if (!window.kpiLangHandler) {
        window.addEventListener('languageChanged', (e) => {
            if (languageChangeTimeout) clearTimeout(languageChangeTimeout);
            
            languageChangeTimeout = setTimeout(() => {
                applyTranslation(e.detail.language);
            }, 500);
        });
        
        window.kpiLangHandler = true;
    }
    
    console.log('‚úÖ KPI language system ready');
})();
function updateKpiFromFirestore(firestoreData) {
    // CEK: apakah data ini menyebabkan perubahan bahasa?
    console.log('üîÑ Firestore update received for:', firestoreData.userId);
    
    // Skip jika data tidak valid
    if (!firestoreData.kpiData || !Array.isArray(firestoreData.kpiData)) {
        console.log('‚ö†Ô∏è Invalid firestore data, skipping');
        return;
    }
    
    // Simpan bahasa saat ini sebelum update
    const currentLang = localStorage.getItem('language') || 'id';
    const wasTranslated = document.querySelectorAll('.translated-element').length > 0;
    
    console.log('üìä Before update - Language:', currentLang, 'Translated:', wasTranslated);
    
    // Update data
    firestoreData.kpiData.forEach((savedItem, index) => {
        if (index < kpiData.length) {
            if (JSON.stringify(kpiData[index]) !== JSON.stringify(savedItem)) {
                Object.assign(kpiData[index], savedItem);
            }
        }
    });
    
    // Update display TANPA mengubah bahasa
    updateDisplay();
    
    // RESTORE bahasa jika diperlukan
    setTimeout(() => {
        const newLang = localStorage.getItem('language') || 'id';
        if (newLang !== currentLang && window.applyKpiTranslations) {
            console.log('üåê Restoring language after firestore update:', newLang);
            window.applyKpiTranslations(newLang);
        }
    }, 100);
    
    console.log('‚úÖ Data updated from Firestore (language protected)');
}
</script>
<script>
// ========== LANGUAGE PROTECTION SYSTEM ==========
(function protectKpiTranslations() {
    console.log('üõ°Ô∏è Activating KPI translation protection');
    
    let currentLanguage = localStorage.getItem('language') || 'id';
    let protectionActive = false;
    let restoreTimeout = null;
    
    // Function to restore translations
    function restoreTranslations() {
        if (protectionActive || !window.applyKpiTranslations) return;
        
        protectionActive = true;
        console.log('üîÑ Restoring KPI translations:', currentLanguage);
        
        // Beri tanda pada elemen yang sedang dipulihkan
        document.querySelectorAll('.kpi-table, .summary-container, .kpi-container')
            .forEach(el => el.classList.add('translating'));
        
        window.applyKpiTranslations(currentLanguage);
        
        // Hapus tanda setelah selesai
        setTimeout(() => {
            document.querySelectorAll('.translating').forEach(el => el.classList.remove('translating'));
            protectionActive = false;
            
            // Tambahkan class untuk menandai elemen yang sudah diterjemahkan
            document.querySelectorAll('.kpi-table th, .kpi-table td.text-left, .summary-title, .summary-content p')
                .forEach(el => el.classList.add('translated-element'));
        }, 500);
    }
    
    // Monitor untuk perubahan tak terduga
    const translationObserver = new MutationObserver((mutations) => {
        let needsRestore = false;
        
        mutations.forEach(mutation => {
            // Cek jika ada perubahan teks pada elemen terjemahan
            if (mutation.type === 'characterData' || 
               (mutation.type === 'childList' && mutation.target.nodeType === Node.TEXT_NODE)) {
                
                const parent = mutation.target.parentElement;
                if (parent && parent.classList.contains('translated-element')) {
                    console.log('‚ö†Ô∏è Unexpected translation change detected');
                    needsRestore = true;
                }
            }
        });
        
        if (needsRestore && !protectionActive) {
            if (restoreTimeout) clearTimeout(restoreTimeout);
            restoreTimeout = setTimeout(restoreTranslations, 300);
        }
    });
    
    // Mulai observer setelah delay
    setTimeout(() => {
        translationObserver.observe(document.body, {
            childList: true,
            subtree: true,
            characterData: true
        });
        
        // Tandai elemen awal sebagai terjemahan
        document.querySelectorAll('.kpi-table th, .kpi-table td.text-left, .summary-title, .summary-content p')
            .forEach(el => el.classList.add('translated-element'));
        
        console.log('‚úÖ Translation protection active');
    }, 1000);
    
    // Update saat bahasa berubah
    window.addEventListener('languageChanged', (e) => {
        currentLanguage = e.detail.language;
        if (restoreTimeout) clearTimeout(restoreTimeout);
        restoreTimeout = setTimeout(restoreTranslations, 200);
    });
    
    // Initial restore
    setTimeout(restoreTranslations, 1500);
})();
// QUICK FIX untuk terjemahan yang missing
function fixMissingTranslations() {
    const lang = localStorage.getItem('language') || 'id';
    
    if (lang === 'ja') {
        // Fix header tabel
        const thElements = document.querySelectorAll('.kpi-table th');
        thElements.forEach(th => {
            const text = th.textContent.trim();
            
            if (text === 'Indikator') th.textContent = 'ÊåáÊ®ô';
            if (text === 'Skor Akhir') th.textContent = 'ÊúÄÁµÇ„Çπ„Ç≥„Ç¢';
            if (text === 'Action') th.textContent = 'Êìç‰Ωú';
        });
        
        // Fix filter
        const periodLabel = document.querySelector('.month-filter-label');
        if (periodLabel && periodLabel.textContent.includes('Pilih Periode')) {
            periodLabel.textContent = 'ÊúüÈñì„ÇíÈÅ∏Êäû:';
        }
        
        // Fix filter info
        const filterInfo = document.querySelector('.filter-info');
        if (filterInfo) {
            filterInfo.textContent = 'ÁâπÂÆöÊúüÈñì„ÅÆKPI„Éá„Éº„Çø„ÇíË°®Á§∫„Åô„ÇãÊúà„ÇíÈÅ∏Êäû';
        }
        
        // Fix chat response note
        const chatNote = document.querySelector('.kpi-table tbody tr:nth-child(4) td:nth-child(6)');
        if (chatNote && chatNote.textContent.includes('Â∞è„Åï„ÅÑ„Åª„Å©')) {
            chatNote.textContent = 'Â∞è„Åï„Åè„Å™„ÅÑ„Åª„Å©ËâØ„ÅÑ';
        }
    }
}

// Jalankan setelah halaman dimuat
setTimeout(fixMissingTranslations, 2000);

// Jalankan lagi saat bahasa berubah
window.addEventListener('languageChanged', () => {
    setTimeout(fixMissingTranslations, 500);
});
</script>


</body>

</html>
