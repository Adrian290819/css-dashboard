<!DOCTYPE html>
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard KPI CSS - Sistem Terintegrasi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="global.css">
<link rel="stylesheet" href="stylemobile.css">
<link rel="stylesheet" href="stylekpi.css">
<script src="global-time.js"></script>
    <style>
       /* TAMBAHKAN CSS INI */
.btn-edit-cell, .btn-save-cell, .btn-cancel-cell {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s ease;
    margin: 2px;
    font-weight: 500;
}

.btn-edit-cell {
    background: #5D3FD3; /* Contoh warna ungu */
    color: white;
}

.btn-save-cell {
    background: #28a745;
    color: white;
}

.btn-cancel-cell {
    background: #dc3545;
    color: white;
}

.btn-edit-cell:hover, .btn-save-cell:hover, .btn-cancel-cell:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

.no-action {
    color: #6c757d;
    font-style: italic;
}

.kpi-table td:last-child {
    min-width: 120px;
    text-align: center;
}

/* Style untuk input edit */
.edit-input {
    width: 100%;
    padding: 4px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.edit-input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.realization-input {
    background: #fff3cd !important;
    border: 2px solid #ffc107 !important;
    font-weight: bold;
}
/* PERBAIKAN CSS UNTUK TOMBOL EDIT ALL & RESET ALL */
.btn-edit-all, .btn-reset {
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-left: 10px;
}

.btn-edit-all {
    background: #5D3FD3;
    color: white;
}

.btn-edit-all:hover {
    background: #4a2fc1;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.btn-reset {
    background: #dc3545;
    color: white;
}

.btn-reset:hover {
    background: #c82333;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.btn-edit-all:active, .btn-reset:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

/* Pastikan container header benar */
.kpi-container > div:first-child {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 10px;
}

.kpi-container h2 {
    margin: 0;
    flex-grow: 1;
}

/* Style untuk action buttons container */
.action-buttons {
    display: flex;
    gap: 10px;
    align-items: center;
}

/* Responsive design */
@media (max-width: 768px) {
    .kpi-container > div:first-child {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .action-buttons {
        align-self: flex-end;
        margin-top: 10px;
    }
    
    .btn-edit-all, .btn-reset {
        margin-left: 0;
    }
}
.kpi-header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 10px;
}

.kpi-header-container h2 {
    margin: 0;
    flex-grow: 1;
}
.btn-reset {
    background: #dc3545 !important;
    color: white !important;
    padding: 10px 16px !important;
    border: none !important;
    border-radius: 8px !important;
    font-size: 14px !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 6px !important;
    font-weight: 500 !important;
}
    </style>
</head>
<body>
    <div id="sidebar-container"></div>
    <button class="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
    <div class="main-content">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Dashboard KPI CSS</h1>
            <div class="header-actions">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Cari data KPI...">
                </div>
                
                <div class="user-profile">
                    <img class="profile-img" src="https://iili.io/Fpiva7S.png" alt="Profile">
                    <div class="user-info">
                        <h4>Nama Masing Masing</h4>
                        <p>Customer Service Support</p>
                    </div>
                </div>
            </div>
        </div>
            
            <div class="dashboard active" id="dashboard-kpi">
                <div class="summary-container">
                    <div class="summary-card fade-in">
                        <div class="summary-header">
                            <span class="summary-title">KPI Bulan Ini</span>
                            <div class="summary-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                        </div>
                        <div class="summary-content">
                            <h3 id="total-kpi">0.00%</h3>
                            <p>Dari target minimal 70%</p>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-45" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="summary-card fade-in">
                        <div class="summary-header">
                            <span class="summary-title">Ideas & Suggestions</span>
                            <div class="summary-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                        </div>
                        <div class="summary-content">
                            <h3 id="ideas-points">0.00%</h3>
                            <p>Mencapai target minimal</p>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-70" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="summary-card fade-in">
                        <div class="summary-header">
                            <span class="summary-title">Research</span>
                            <div class="summary-icon">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                        <div class="summary-content">
                            <h3 id="research-points">0.00%</h3>
                            <p>Mencapai target minimal</p>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-70" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="summary-card fade-in">
                        <div class="summary-header">
                            <span class="summary-title">Chat Response</span>
                            <div class="summary-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                        </div>
                        <div class="summary-content">
                            <h3 id="chat-points">0.00%</h3>
                            <p>Mencapai target minimal</p>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-70" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="kpi-header-container">
    <h2>Data KPI Performance</h2>
    <div class="action-buttons">
        <button class="btn-edit-all" id="edit-all-btn">
            <i class="fas fa-edit"></i>
            Edit All
        </button>
        <button class="btn-reset" id="reset-data-btn" title="Reset Data KPI">
            <i class="fas fa-sync-alt"></i>
            Reset All
        </button>
    </div>
</div>
                    
                    <table class="kpi-table">
                        <thead>
                            <tr>
                                <th rowspan="2">No.</th>
                                <th rowspan="2">Area Kinerja Utama</th>
                                <th rowspan="2">Target</th>
                                <th rowspan="2">Bobot</th>
                                <th colspan="2">Indikator</th>
                                <th>Skor Akhir</th>
                                <th>Bulan</th>
                                <th id="current-month-header">October</th>
                                <th rowspan="2">Action</th>
                            </tr>
                            <tr>
                                <th>Deskripsi KPI</th>
                                <th>Keterangan</th>
                                <th></th>
                                <th>Realisasi</th>
                                <th>Skor Akhir</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td class="text-left">B2B & B2C (Count.)</td>
                                <td>3</td>
                                <td>25.00%</td>
                                <td class="text-left">Pembukaan WLB / Agent baru</td>
                                <td class="text-left">Semakin Besar Semakin Bagus</td>
                                <td class="target-missed">0.00%</td>
                                <td class="realization-cell">0</td>
                                <td class="target-missed">0.00%</td>
                                <td>
                                </td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td class="text-left">Problem Solving (Count.)</td>
                                <td>6</td>
                                <td>20.00%</td>
                                <td class="text-left">Kemampuan dalam menyelesaikan setiap masalah</td>
                                <td class="text-left">Semakin Besar Semakin Bagus</td>
                                <td class="target-missed">0.00%</td>
                                <td class="realization-cell">0</td>
                                <td class="target-missed">0.00%</td>
                                <td>
                                </td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td class="text-left">Idea (Count.)</td>
                                <td>3</td>
                                <td>20.00%</td>
                                <td class="text-left">Aktif memberikan ide, Saran & Masukan</td>
                                <td class="text-left">Semakin Besar Semakin Bagus</td>
                                <td class="target-missed" id="ideas-score">0.00%</td>
                                <td class="realization-cell" id="ideas-realization">0</td>
                                <td class="target-missed">0.00%</td>
                                <td>
                                </td>
                            </tr>
                            <tr>
                                <td>4</td>
                                <td class="text-left">Response Chat (Count.)</td>
                                <td>4</td>
                                <td>10.00%</td>
                                <td class="text-left">Kecepatan dan ketepatan dalam Merespon Chat (Max 3 Menit)</td>
                                <td class="text-left">Semakin Kecil Semakin Bagus</td>
                                <td class="target-missed" id="chat-score">0.00%</td>
                                <td class="realization-cell" id="chat-realization">0</td>
                                <td class="target-missed">0.00%</td>
                                <td>
                                </td>
                            </tr>
                            <tr>
                                <td>5</td>
                                <td class="text-left">Research (Count.)</td>
                                <td>28</td>
                                <td>10.00%</td>
                                <td class="text-left">Research keunggulan Platform / Agent Lain</td>
                                <td class="text-left">Semakin Besar Semakin Bagus</td>
                                <td class="target-missed" id="research-score">0.00%</td>
                                <td class="realization-cell" id="research-realization">0</td>
                                <td class="target-missed">0.00%</td>
                                <td>
                                </td>
                            </tr>
                            <tr>
                                <td>6</td>
                                <td class="text-left">Attitude (Skor.)</td>
                                <td>8</td>
                                <td>10.00%</td>
                                <td class="text-left">Attitude dalam mengikuti SOP / Arahan</td>
                                <td class="text-left">Semakin Besar Semakin Bagus</td>
                                <td class="target-missed">0.00%</td>
                                <td class="realization-cell">0</td>
                                <td class="target-missed">0.00%</td>
                                <td>
                                </td>
                            </tr>
                            <tr>
                                <td>7</td>
                                <td class="text-left">Disiplin (Day.)</td>
                                <td>28</td>
                                <td>5.00%</td>
                                <td class="text-left">Jumlah kedisiplinan setiap bulan</td>
                                <td class="text-left">Semakin Besar Semakin Bagus</td>
                                <td class="target-missed">0.00%</td>
                                <td class="realization-cell">0</td>
                                <td class="target-missed">0.00%</td>
                                <td>
                                </td>
                            </tr>
                            <tr class="result-row">
                                <td colspan="3">Total</td>
                                <td>100.00%</td>
                                <td colspan="3">Total Skor Akhir</td>
                                <td id="total-realization">0</td>
                                <td id="total-score" class="target-missed">0.00%</td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="dashboard" id="dashboard-ideas">
                <div class="submenu-container fade-in">
                    <div class="submenu-header">
                        <h2 class="submenu-title"><i class="fas fa-lightbulb"></i> Ideas & Suggestions</h2>
                        <button class="btn-edit-all">
                            <i class="fas fa-edit"></i>
                            Edit All
                        </button>
                    </div>
                    <div class="criteria-list">
                        <div class="criteria-item">
                            <div class="criteria-info">
                                <div class="criteria-name">Ideas & Suggestions</div>
                                <div class="criteria-desc">Jumlah ide yang diberikan per bulan</div>
                            </div>
                            <div class="criteria-points">
                                <span class="points-value">0</span>
                                <button class="btn btn-primary">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="dashboard" id="dashboard-research">
                <div class="submenu-container fade-in">
                    <div class="submenu-header">
                        <h2 class="submenu-title"><i class="fas fa-search"></i> Research</h2>
                        <button class="btn-edit-all">
                            <i class="fas fa-edit"></i>
                            Edit All
                        </button>
                    </div>
                    <div class="criteria-list">
                        <div class="criteria-item">
                            <div class="criteria-info">
                                <div class="criteria-name">Research</div>
                                <div class="criteria-desc">Jumlah research yang dilakukan per bulan</div>
                            </div>
                            <div class="criteria-points">
                                <span class="points-value">0</span>
                                <button class="btn btn-primary">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="dashboard" id="dashboard-chat">
                <div class="submenu-container fade-in">
                    <div class="submenu-header">
                        <h2 class="submenu-title"><i class="fas fa-comments"></i> Chat Response</h2>
                        <button class="btn-edit-all">
                            <i class="fas fa-edit"></i>
                            Edit All
                        </button>
                    </div>
                    <div class="criteria-list">
                        <div class="criteria-item">
                            <div class="criteria-info">
                                <div class="criteria-name">Chat Response</div>
                                <div class="criteria-desc">Rata-rata waktu respons chat dalam menit</div>
                            </div>
                            <div class="criteria-points">
                                <span class="points-value">0</span>
                                <button class="btn btn-primary">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer-note">
                <p><strong>Catatan:</strong> Untuk Lepas training / masa probation Minimal KPI yang harus di Raih = 70%.</p>
            </div>
        </div>
    </div>

    <div class="notification-container" id="notificationContainer"></div>
    
    <script src="sidebar-loader.js"></script>
    <script src="user-profile.js"></script>

 <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
    // Konfigurasi Firebase
    // Konfigurasi Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDUZka4FZyLi_cv6X_5D4zeRsfkpqOlBpY",
        authDomain: "dashboard-css.firebaseapp.com",
        databaseURL: "https://dashboard-css-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "dashboard-css",
        storageBucket: "dashboard-css.appspot.com",
        messagingSenderId: "771131792881",
        appId: "1:771131792881:web:ad634424225bd7de847850",
        measurementId: "G-3CYBC5B101"
    };

    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);

    // Data KPI
    const kpiData = [
        { 
            id: 1, 
            area: "B2B & B2C (Count.)",
            target: 3, 
            weight: 25, 
            description: "Pembukaan WLB / Agent baru",
            note: "Semakin Besar Semakin Bagus",
            realization: 0, 
            score: 0 
        },
        { 
            id: 2, 
            area: "Problem Solving (Count.)",
            target: 6, 
            weight: 20, 
            description: "Kemampuan dalam menyelesaikan setiap masalah",
            note: "Semakin Besar Semakin Bagus",
            realization: 0, 
            score: 0 
        },
        { 
            id: 3, 
            area: "Idea (Count.)",
            target: 3, 
            weight: 20, 
            description: "Aktif memberikan ide, Saran & Masukan",
            note: "Semakin Besar Semakin Bagus",
            realization: 0, 
            score: 0 
        },
        { 
            id: 4, 
            area: "Response Chat (Count.)",
            target: 4, 
            weight: 10, 
            description: "Kecepatan dan ketepatan dalam Merespon Chat (Max 3 Menit)",
            note: "Semakin Kecil Semakin Bagus",
            realization: 0, 
            score: 0
        },
        { 
            id: 5, 
            area: "Research (Count.)",
            target: 28, 
            weight: 10, 
            description: "Research keunggulan Platform / Agent Lain",
            note: "Semakin Besar Semakin Bagus",
            realization: 0, 
            score: 0 
        },
        { 
            id: 6, 
            area: "Attitude (Skor.)",
            target: 8, 
            weight: 10, 
            description: "Attitude dalam mengikuti SOP / Arahan",
            note: "Semakin Besar Semakin Bagus",
            realization: 0, 
            score: 0 
        },
        { 
            id: 7, 
            area: "Disiplin (Day.)",
            target: 28, 
            weight: 5, 
            description: "Jumlah kedisiplinan setiap bulan",
            note: "Semakin Besar Semakin Bagus",
            realization: 0, 
            score: 0 
        }
    ];
let isEditMode = false;
let unsubscribeFunctions = [];
let currentFilter = 'current';
let isSuperAdminUser = false;
let isLocalChange = false; // TAMBAHKAN INI
let lastLocalChangeTime = 0; // TAMBAHKAN INI

// ========== REAL-TIME LISTENER YANG DIPERBAIKI ==========
function setupRealTimeListeners() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) return;
    
    const targetUserId = currentUser.uid;
    
    console.log('üîî Setting up listener for user:', targetUserId);
    
    const db = firebase.firestore();
    const kpiUnsubscribe = db.collection('kpiData')
        .doc(targetUserId)
        .onSnapshot((doc) => {
            // SEKARANG isLocalChange SUDAH TERDEFINISI
            if (isLocalChange && (Date.now() - lastLocalChangeTime < 3000)) {
                return; // Skip jika perubahan lokal
            }
            
            if (doc.exists) {
                const savedData = doc.data();
                if (savedData.userId === targetUserId) {
                    console.log('‚úÖ Safe update for user:', targetUserId);
                    updateKpiFromFirestore(savedData);
                }
            }
        });
    
    unsubscribeFunctions.push(kpiUnsubscribe);
}
    // Elemen DOM
    const editAllBtn = document.getElementById('edit-all-btn');
    const resetBtn = document.getElementById('reset-data-btn');
    const resetCancel = document.getElementById('reset-cancel');
    const resetConfirm = document.getElementById('reset-confirm');
    const resetPassword = document.getElementById('reset-password');
    const notificationContainer = document.getElementById('notificationContainer');
    const menuItems = document.querySelectorAll('.menu-item');
    const dashboards = document.querySelectorAll('.dashboard');


    async function checkAndSetupSuperAdmin() {
    try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) {
            console.log('No user logged in');
            setupAdminUI(false);
            return false;
        }
        
        console.log('üîÑ Checking admin role for user:', currentUser.uid, currentUser.email);
        
        const db = firebase.firestore();
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            console.log('üìä User data from Firestore:', userData);
            
            // PERBAIKAN: Check role user
            const isAdmin = userData.role === 'super_admin' || userData.isSuperAdmin === true;
            console.log('üëë Is user admin?', isAdmin);
            
            // Setup UI berdasarkan role
            setupAdminUI(isAdmin);
            
            // Update nama user di header jika perlu
            if (!userData.name || userData.name === 'User') {
                await db.collection('users').doc(currentUser.uid).update({
                    name: currentUser.displayName || currentUser.email.split('@')[0],
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            return isAdmin;
            
        } else {
            // Buat dokumen user baru dengan role default 'user'
            console.log('üìù Creating user document with proper name');
            await db.collection('users').doc(currentUser.uid).set({
                email: currentUser.email,
                name: currentUser.displayName || currentUser.email.split('@')[0],
                role: 'user', // Default role
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            setupAdminUI(false);
            return false;
        }
        
    } catch (error) {
        console.error('‚ùå Error checking super admin:', error);
        setupAdminUI(false);
        return false;
    }
}

    // Fungsi untuk setup UI admin
    // Fungsi untuk setup UI admin
    function setupAdminUI(isAdmin) {
        console.log('Setting up admin UI, isAdmin:', isAdmin);
        
        const headerActions = document.querySelector('.header-actions');
        if (!headerActions) {
            console.error('Header actions element not found');
            return;
        }
        
        // Hapus filter yang sudah ada jika ada
        const existingFilter = document.getElementById('userFilterContainer');
        if (existingFilter) {
            existingFilter.remove();
        }
        
        // Dapatkan semua tombol yang perlu diatur visibility-nya
        const editAllBtn = document.getElementById('edit-all-btn');
        const resetBtn = document.getElementById('reset-data-btn');
        const submenuEditButtons = document.querySelectorAll('.submenu-container .btn-edit-all');
        const criteriaEditButtons = document.querySelectorAll('.criteria-list .btn-primary');
        
        if (isAdmin) {
            // Tampilkan semua tombol untuk super admin
            if (editAllBtn) editAllBtn.classList.add('admin-visible');
            if (resetBtn) resetBtn.classList.add('admin-visible');
            submenuEditButtons.forEach(btn => btn.classList.add('admin-visible'));
            criteriaEditButtons.forEach(btn => btn.classList.add('admin-visible'));
            
            // Tambahkan filter dropdown untuk super admin
            const filterHTML = `
                <div class="user-filter" id="userFilterContainer">
                    <select id="userFilter" class="filter-select">
                        <option value="current">Data Saya</option>
                        <option value="all">Semua User</option>
                    </select>
                </div>
            `;
            
            // Sisipkan sebelum user profile
            const userProfile = headerActions.querySelector('.user-profile');
            if (userProfile) {
                userProfile.insertAdjacentHTML('beforebegin', filterHTML);
                
                // Event listener untuk filter
                document.getElementById('userFilter').addEventListener('change', function() {
                    currentFilter = this.value;
                    console.log('Filter changed to:', currentFilter);
                    loadKpiData(currentFilter);
                });
                
                isSuperAdminUser = true;
                console.log('Admin UI setup completed - Buttons visible');
            }
        } else {
            // Sembunyikan semua tombol untuk user biasa
            if (editAllBtn) editAllBtn.classList.remove('admin-visible');
            if (resetBtn) resetBtn.classList.remove('admin-visible');
            submenuEditButtons.forEach(btn => btn.classList.remove('admin-visible'));
            criteriaEditButtons.forEach(btn => btn.classList.remove('admin-visible'));
            
            isSuperAdminUser = false;
            console.log('Regular user UI setup completed - Buttons hidden');
        }
    }

    // ========== FUNGSI UNTUK MENGAMBIL DATA DARI FIRESTORE ==========

    // Fungsi untuk mengambil data Ideas dari Firestore
    async function getIdeasData(userId = null) {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                console.log('User not authenticated for ideas data');
                return { count: 0, totalPoints: 0, data: [] };
            }
            
            const db = firebase.firestore();
            let query = db.collection('ideas');
            
            if (userId) {
                query = query.where('userId', '==', userId);
            } else {
                query = query.where('userId', '==', currentUser.uid);
            }
            
            const snapshot = await query.get();
            
            const ideasData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            return {
                count: ideasData.length,
                totalPoints: ideasData.reduce((sum, idea) => sum + (parseInt(idea.points) || 0), 0),
                data: ideasData
            };
        } catch (error) {
            console.error('Error getting ideas data from Firestore:', error);
            return { count: 0, totalPoints: 0, data: [] };
        }
    }

    // Fungsi untuk mengambil data Research dari Firestore
    async function getResearchData(userId = null) {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                console.log('User not authenticated for research data');
                return { count: 0, totalPoints: 0, data: [] };
            }
            
            const db = firebase.firestore();
            let query = db.collection('research');
            
            if (userId) {
                query = query.where('userId', '==', userId);
            } else {
                query = query.where('userId', '==', currentUser.uid);
            }
            
            const snapshot = await query.get();
            
            const researchData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            return {
                count: researchData.length,
                totalPoints: researchData.reduce((sum, research) => sum + (parseInt(research.points) || 0), 0),
                data: researchData
            };
        } catch (error) {
            console.error('Error getting research data from Firestore:', error);
            return { count: 0, totalPoints: 0, data: [] };
        }
    }

    // Fungsi untuk mengambil data Chat Response dari Firestore
    async function getChatData(userId = null) {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                console.log('User not authenticated for chat data');
                return { count: 0, missedChats: 0, averageResponseTime: 0, data: [] };
            }
            
            const db = firebase.firestore();
            let query = db.collection('chats');
            
            if (userId) {
                query = query.where('userId', '==', userId);
            } else {
                query = query.where('userId', '==', currentUser.uid);
            }
            
            const snapshot = await query.get();
            
            const chatData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            const missedChats = chatData.filter(chat => parseFloat(chat.responseTime) > 3).length;
            const averageResponseTime = chatData.length > 0 ? 
                chatData.reduce((sum, chat) => sum + parseFloat(chat.responseTime), 0) / chatData.length : 0;
            
            return {
                count: chatData.length,
                missedChats: missedChats,
                averageResponseTime: averageResponseTime,
                data: chatData
            };
        } catch (error) {
            console.error('Error getting chat data from Firestore:', error);
            return { count: 0, missedChats: 0, averageResponseTime: 0, data: [] };
        }
    }

    // Fungsi untuk mengambil data Problem Solving dari Firestore
    async function getProblemSolvingData(userId = null) {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                console.log('User not authenticated for problem solving data');
                return { count: 0, totalPoints: 0, data: [] };
            }
            
            const db = firebase.firestore();
            let query = db.collection('problems');
            
            if (userId) {
                query = query.where('userId', '==', userId);
            } else {
                query = query.where('userId', '==', currentUser.uid);
            }
            
            const snapshot = await query.get();
            
            const problemData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            return {
                count: problemData.length,
                totalPoints: problemData.reduce((sum, problem) => sum + (parseInt(problem.points) || 0), 0),
                data: problemData
            };
        } catch (error) {
            console.error('Error getting problem solving data from Firestore:', error);
            return { count: 0, totalPoints: 0, data: [] };
        }
    }

    // Fungsi untuk mengambil data B2B & B2C dari Firestore
    async function getB2BData(userId = null) {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                console.log('User not authenticated for B2B data');
                return { count: 0, totalPoints: 0, data: [] };
            }
            
            const db = firebase.firestore();
            let query = db.collection('b2b');
            
            if (userId) {
                query = query.where('userId', '==', userId);
            } else {
                query = query.where('userId', '==', currentUser.uid);
            }
            
            const snapshot = await query.get();
            
            const b2bData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            return {
                count: b2bData.length,
                totalPoints: b2bData.reduce((sum, b2b) => sum + (parseInt(b2b.points) || 0), 0),
                data: b2bData
            };
        } catch (error) {
            console.error('Error getting B2B data from Firestore:', error);
            return { count: 0, totalPoints: 0, data: [] };
        }
    }

    // Fungsi untuk mengambil data Attitude dari Firestore
    async function getAttitudeData(userId = null) {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                console.log('User not authenticated for attitude data');
                return { count: 0, totalPoints: 0, averageScore: 0, data: [] };
            }
            
            const db = firebase.firestore();
            let query = db.collection('attitude');
            
            if (userId) {
                query = query.where('userId', '==', userId);
            } else {
                query = query.where('userId', '==', currentUser.uid);
            }
            
            const snapshot = await query.get();
            
            const attitudeData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            const averageScore = attitudeData.length > 0 ? 
                attitudeData.reduce((sum, attitude) => sum + (parseInt(attitude.score) || 0), 0) / attitudeData.length : 0;
            
            return {
                count: attitudeData.length,
                totalPoints: attitudeData.reduce((sum, attitude) => sum + (parseInt(attitude.points) || 0), 0),
                averageScore: averageScore,
                data: attitudeData
            };
        } catch (error) {
            console.error('Error getting attitude data from Firestore:', error);
            return { count: 0, totalPoints: 0, averageScore: 0, data: [] };
        }
    }

    // Fungsi untuk mengambil data Disiplin dari Firestore
    async function getDisciplineData(userId = null) {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                console.log('User not authenticated for discipline data');
                return { count: 0, totalPoints: 0, data: [] };
            }
            
            const db = firebase.firestore();
            let query = db.collection('discipline');
            
            if (userId) {
                query = query.where('userId', '==', userId);
            } else {
                query = query.where('userId', '==', currentUser.uid);
            }
            
            const snapshot = await query.get();
            
            const disciplineData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            return {
                count: disciplineData.length,
                totalPoints: disciplineData.reduce((sum, discipline) => sum + (parseInt(discipline.points) || 0), 0),
                data: disciplineData
            };
        } catch (error) {
            console.error('Error getting discipline data from Firestore:', error);
            return { count: 0, totalPoints: 0, data: [] };
        }
    }

    // ========== FUNGSI UTAMA PERHITUNGAN KPI ==========

    // Fungsi untuk menghitung skor
    function calculateScore(target, realization, isSmallerBetter = false, index = -1) {
        if (isSmallerBetter && index === 3) {
            // Untuk metrik "Semakin Kecil Semakin Bagus" (Chat Response)
            const chatData = getChatDataSync();
            const missedChats = chatData.missedChats;
            const penalty = missedChats * 25;
            return Math.max(0, 100 - penalty);
        } else {
            // Untuk metrik "Semakin Besar Semakin Bagus"
            if (realization >= target) return 100;
            if (realization <= 0) return 0;
            return (realization / target) * 100;
        }
    }

    // Fungsi synchronous untuk mendapatkan data chat (untuk perhitungan)
    function getChatDataSync() {
        return window.chatDataForCalculation || { missedChats: 0, count: 0 };
    }

    // Fungsi untuk memperbarui semua data KPI dari Firestore
    // MODIFIKASI fungsi updateAllKpiData untuk tidak menimpa data dari kpiData:
async function updateAllKpiData(userId = null) {
    try {
        // Hanya ambil data realisasi dari collections terpisah
        const ideasData = await getIdeasData(userId);
        const researchData = await getResearchData(userId);
        const chatData = await getChatData(userId);
        const problemData = await getProblemSolvingData(userId);
        const b2bData = await getB2BData(userId);
        const attitudeData = await getAttitudeData(userId);
        const disciplineData = await getDisciplineData(userId);

        // PERBAIKAN: Update HANYA realisasi, bukan semua data
        kpiData[0].realization = b2bData.count;
        kpiData[1].realization = problemData.count;
        kpiData[2].realization = ideasData.count;
        kpiData[3].realization = chatData.count;
        kpiData[4].realization = researchData.count;
        kpiData[5].realization = attitudeData.averageScore;
        kpiData[6].realization = disciplineData.count;

        // Simpan data chat untuk perhitungan synchronous
        window.chatDataForCalculation = chatData;

        // Hitung ulang semua skor berdasarkan realisasi baru
        updateKPI();
        
        console.log('KPI realization data updated from modules for user:', userId || 'current');
    } catch (error) {
        console.error('Error updating KPI realization data:', error);
        showNotification('Gagal memperbarui data realisasi dari modules', 'error');
    }
}

    // Fungsi untuk memperbarui tampilan KPI
    function updateKPI() {
        let totalScore = 0;
        let totalRealization = 0;
        
        kpiData.forEach((item, index) => {
            const row = document.querySelector(`.kpi-table tbody tr:nth-child(${index + 1})`);
            const isSmallerBetter = item.note.includes("Semakin Kecil");
            
            // Hitung skor
            item.score = calculateScore(item.target, item.realization, isSmallerBetter, index);
            
            // Perbarui tampilan
            if (row) {
                const realizationCell = row.querySelector('.realization-cell');
                if (realizationCell) {
                    realizationCell.textContent = item.realization;
                }
                
                const scoreCell = row.querySelector('td:nth-child(9)');
                if (scoreCell) {
                    scoreCell.textContent = item.score.toFixed(2) + '%';
                    scoreCell.className = '';
                    
                    if (item.score >= 100) {
                        scoreCell.classList.add('target-achieved');
                    } else if (item.score >= 70) {
                        scoreCell.classList.add('target-partial');
                    } else {
                        scoreCell.classList.add('target-missed');
                    }
                }
            }
            
            // Hitung total
            totalScore += (item.score * item.weight) / 100;
            totalRealization += item.realization;
            
            // Update untuk dashboard tertentu
            if (index === 2) {
                updateElementText('ideas-score', item.score.toFixed(2) + '%');
                updateElementText('ideas-realization', item.realization);
                updateElementText('ideas-points', item.score.toFixed(2) + '%');
                updateProgressBar('.summary-card:nth-child(2) .progress-fill', Math.min(item.score, 100));
            } else if (index === 3) {
                updateElementText('chat-score', item.score.toFixed(2) + '%');
                updateElementText('chat-realization', item.realization);
                updateElementText('chat-points', item.score.toFixed(2) + '%');
                updateProgressBar('.summary-card:nth-child(4) .progress-fill', Math.min(item.score, 100));
            } else if (index === 4) {
                updateElementText('research-score', item.score.toFixed(2) + '%');
                updateElementText('research-realization', item.realization);
                updateElementText('research-points', item.score.toFixed(2) + '%');
                updateProgressBar('.summary-card:nth-child(3) .progress-fill', Math.min(item.score, 100));
            }
        });
        
        // Update total
        updateElementText('total-score', totalScore.toFixed(2) + '%');
        updateElementText('total-realization', totalRealization);
        updateElementText('total-kpi', totalScore.toFixed(2) + '%');
        updateProgressBar('.summary-card:first-child .progress-fill', Math.min(totalScore, 100));
        
        // Update class untuk total score
        const totalScoreCell = document.getElementById('total-score');
        if (totalScoreCell) {
            totalScoreCell.className = '';
            if (totalScore >= 70) {
                totalScoreCell.classList.add('target-achieved');
            } else if (totalScore >= 50) {
                totalScoreCell.classList.add('target-partial');
            } else {
                totalScoreCell.classList.add('target-missed');
            }
        }
    }

    // Fungsi helper untuk update teks elemen
    function updateElementText(id, text) {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = text;
        }
    }

    // Fungsi helper untuk update progress bar
    function updateProgressBar(selector, percentage) {
        const progressBar = document.querySelector(selector);
        if (progressBar) {
            progressBar.style.width = percentage + '%';
        }
    }

    // ========== SISTEM FILTER BERDASARKAN USER ==========

    // Fungsi untuk memuat data KPI berdasarkan filter
    // Fungsi untuk memuat data KPI berdasarkan filter
    async function loadKpiData(filter = 'current', specificUserId = null) {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                console.log('No user logged in');
                return;
            }
            
            console.log('üîÑ Loading KPI data with filter:', filter, 'specificUserId:', specificUserId);
            
            if (filter === 'current' || specificUserId) {
                const userId = specificUserId || currentUser.uid;
                console.log('üë§ Loading data for user:', userId);
                await updateAllKpiData(userId);
                
            } else if (filter === 'all' && isSuperAdminUser) {
                console.log('üë• Loading ALL users data as super admin');
                await loadAllUsersData(); // PASTIKAN ini dipanggil
            } else {
                console.log('‚ùå Cannot load all data - not super admin');
                showNotification('Hanya Super Admin yang dapat melihat semua data', 'error');
            }
            
        } catch (error) {
            console.error('‚ùå Error loading KPI data:', error);
            showNotification('Error memuat data KPI: ' + error.message, 'error');
        }
    }

    // Fungsi untuk load data semua user - VERSI DIPERBAIKI
    async function loadAllUsersData() {
        try {
            console.log('üì• Loading all users data from Firestore...');
            const db = firebase.firestore();
            
            // Ambil semua data user
            const usersSnapshot = await db.collection('users').get();
            console.log(`üë• Found ${usersSnapshot.size} users`);
            
            const usersData = [];
            
            // Untuk setiap user, ambil data KPI-nya
            for (const userDoc of usersSnapshot.docs) {
                const userData = userDoc.data();
                const userId = userDoc.id;
                
                console.log(`üîç Processing user: ${userData.name || userData.email}`);
                
                // Ambil data dari semua koleksi untuk user ini
                const [
                    ideasData,
                    researchData, 
                    chatData,
                    problemData,
                    b2bData,
                    attitudeData,
                    disciplineData,
                    kpiDoc
                ] = await Promise.all([
                    getIdeasData(userId),
                    getResearchData(userId),
                    getChatData(userId),
                    getProblemSolvingData(userId),
                    getB2BData(userId),
                    getAttitudeData(userId),
                    getDisciplineData(userId),
                    db.collection('kpiData').doc(userId).get()
                ]);
                
                // Hitung scores berdasarkan data aktual
                const ideasScore = calculateIdeasScore(ideasData);
                const researchScore = calculateResearchScore(researchData);
                const chatScore = calculateChatScore(chatData);
                const problemScore = calculateProblemScore(problemData);
                const b2bScore = calculateB2BScore(b2bData);
                const attitudeScore = calculateAttitudeScore(attitudeData);
                const disciplineScore = calculateDisciplineScore(disciplineData);
                
                // Hitung total score
                const totalScore = (
                    (ideasScore * 0.20) +
                    (researchScore * 0.10) +
                    (chatScore * 0.10) +
                    (problemScore * 0.20) +
                    (b2bScore * 0.25) +
                    (attitudeScore * 0.10) +
                    (disciplineScore * 0.05)
                );
                
                // Format last updated
                const lastUpdated = kpiDoc.exists && kpiDoc.data().updatedAt ? 
                    new Date(kpiDoc.data().updatedAt.toDate()).toLocaleDateString('id-ID') : 
                    '-';
                
                usersData.push({
                    userId: userId,
                    userName: userData.name || userData.email || 'Unknown User',
                    userEmail: userData.email || userId,
                    totalScore: totalScore.toFixed(2),
                    ideasScore: ideasScore.toFixed(2),
                    researchScore: researchScore.toFixed(2),
                    chatScore: chatScore.toFixed(2),
                    problemScore: problemScore.toFixed(2),
                    lastUpdated: lastUpdated
                });
            }
            
            console.log('‚úÖ Final processed users data:', usersData);
            
            if (usersData.length === 0) {
                showNotification('Tidak ada data user yang ditemukan', 'warning');
            }
            
            displayAllUsersData(usersData);
            
        } catch (error) {
            console.error('‚ùå Error loading all users data:', error);
            showNotification('Error memuat data semua user: ' + error.message, 'error');
        }
    }
    // Fungsi helper untuk menghitung score masing-masing kategori
    function calculateIdeasScore(ideasData) {
        const target = 3; // Target ideas per bulan
        if (ideasData.count >= target) return 100;
        return (ideasData.count / target) * 100;
    }

    function calculateResearchScore(researchData) {
        const target = 28; // Target research per bulan
        if (researchData.count >= target) return 100;
        return (researchData.count / target) * 100;
    }

    function calculateChatScore(chatData) {
        // Untuk chat response, semakin kecil response time semakin baik
        const maxAllowedTime = 3; // 3 menit
        const penalty = chatData.missedChats * 25; // 25% penalty per chat yang missed
        return Math.max(0, 100 - penalty);
    }

    function calculateProblemScore(problemData) {
        const target = 6; // Target problem solving per bulan
        if (problemData.count >= target) return 100;
        return (problemData.count / target) * 100;
    }

    function calculateB2BScore(b2bData) {
        const target = 3; // Target B2B per bulan
        if (b2bData.count >= target) return 100;
        return (b2bData.count / target) * 100;
    }

    function calculateAttitudeScore(attitudeData) {
        const target = 8; // Target attitude score
        if (attitudeData.averageScore >= target) return 100;
        return (attitudeData.averageScore / target) * 100;
    }

    function calculateDisciplineScore(disciplineData) {
        const target = 28; // Target days per bulan
        if (disciplineData.count >= target) return 100;
        return (disciplineData.count / target) * 100;
    }
    // Fungsi untuk menampilkan data semua user
    function displayAllUsersData(usersData) {
        const container = document.querySelector('.kpi-container');
        if (!container) {
            console.error('KPI container not found');
            return;
        }
        
        console.log('Displaying data for', usersData.length, 'users');
        
        const existingTable = container.querySelector('.all-users-table');
        if (existingTable) {
            existingTable.remove();
        }
        
        const regularTable = container.querySelector('.kpi-table');
        if (regularTable) {
            regularTable.style.display = 'none';
        }
        
        const actionButtons = container.querySelector('.kpi-actions');
        if (actionButtons) {
            actionButtons.style.display = 'none';
        }
        
        const tableHtml = `
            <div class="all-users-table">
                <h3><i class="fas fa-users"></i> Data KPI Semua User (${usersData.length} users)</h3>
                <table class="kpi-table">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>User</th>
                            <th>Email</th>
                            <th>Total KPI</th>
                            <th>Ideas</th>
                            <th>Research</th>
                            <th>Chat Response</th>
                            <th>Problem Solving</th>
                            <th>Terakhir Update</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${usersData.map((user, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${user.userName}</td>
                                <td>${user.userEmail}</td>
                                <td class="${user.totalScore >= 70 ? 'target-achieved' : user.totalScore >= 50 ? 'target-partial' : 'target-missed'}">
                                    ${user.totalScore}%
                                </td>
                                <td>${user.ideasScore}%</td>
                                <td>${user.researchScore}%</td>
                                <td>${user.chatScore}%</td>
                                <td>${user.problemScore}%</td>
                                <td>${user.lastUpdated}</td>
                                <td>
                                    <button class="btn-view-user" data-uid="${user.userId}">
                                        <i class="fas fa-eye"></i> Lihat Detail
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', tableHtml);
        
        container.querySelectorAll('.btn-view-user').forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.dataset.uid;
                console.log('Viewing detail for user:', userId);
                viewUserDetail(userId);
            });
        });
        
        showNotification(`Menampilkan data ${usersData.length} user`, 'info');
    }

    // Fungsi untuk melihat detail user tertentu
    function viewUserDetail(userId) {
        const regularTable = document.querySelector('.kpi-table');
        if (regularTable) {
            regularTable.style.display = '';
        }
        
        const actionButtons = document.querySelector('.kpi-actions');
        if (actionButtons) {
            actionButtons.style.display = 'flex';
        }
        
        const allUsersTable = document.querySelector('.all-users-table');
        if (allUsersTable) {
            allUsersTable.remove();
        }
        
        loadKpiData('current', userId);
        
        const userFilter = document.getElementById('userFilter');
        if (userFilter) {
            userFilter.value = 'current';
        }
        
        showNotification('Memuat data user...', 'info');
    }

    // Fungsi untuk menghitung total score - VERSI DIPERBAIKI
    function calculateTotalScore(kpiDataArray) {
        if (!kpiDataArray || !Array.isArray(kpiDataArray)) {
            console.warn('‚ö†Ô∏è Invalid KPI data for calculation:', kpiDataArray);
            return 0;
        }
        
        try {
            const total = kpiDataArray.reduce((sum, item) => {
                const score = parseFloat(item.score) || 0;
                const weight = parseFloat(item.weight) || 0;
                return sum + (score * weight) / 100;
            }, 0);
            
            return parseFloat(total.toFixed(2));
        } catch (error) {
            console.error('‚ùå Error calculating total score:', error);
            return 0;
        }
    }

    // ========== FUNGSI EDIT MODE ==========

    // Fungsi untuk mengaktifkan mode edit
    function enableEditMode() {
        if (!isSuperAdminUser && currentFilter !== 'current') {
            showNotification('Hanya bisa mengedit data sendiri', 'error');
            return;
        }
        
        isEditMode = true;
        document.querySelector('.kpi-container').classList.add('edit-mode');
        
        editAllBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Semua';
        editAllBtn.classList.add('btn-success');
        editAllBtn.classList.remove('btn-primary');
        
        const rows = document.querySelectorAll('.kpi-table tbody tr:not(.result-row)');
        rows.forEach((row, index) => {
            if (index < kpiData.length) {
                const data = kpiData[index];
                
                const areaCell = row.querySelector('td:nth-child(2)');
                areaCell.innerHTML = `<input type="text" class="edit-input" value="${data.area}" data-field="area" data-index="${index}">`;
                
                const targetCell = row.querySelector('td:nth-child(3)');
                targetCell.innerHTML = `<input type="number" class="edit-input" value="${data.target}" min="0" data-field="target" data-index="${index}">`;
                
                const weightCell = row.querySelector('td:nth-child(4)');
                weightCell.innerHTML = `<input type="number" class="edit-input" value="${data.weight}" min="0" max="100" data-field="weight" data-index="${index}">`;
                
                const descCell = row.querySelector('td:nth-child(5)');
                descCell.innerHTML = `<input type="text" class="edit-input" value="${data.description}" data-field="description" data-index="${index}">`;
                
                const noteCell = row.querySelector('td:nth-child(6)');
                noteCell.innerHTML = `<input type="text" class="edit-input" value="${data.note}" data-field="note" data-index="${index}">`;
                
                const realizationCell = row.querySelector('td.realization-cell');
                if (realizationCell) {
                    realizationCell.innerHTML = `<span>${data.realization}</span>`;
                }
            }
        });
        
        addEditInputListeners();
        showNotification('Mode edit diaktifkan. Anda dapat mengubah target dan bobot KPI.', 'info');
    }

    // Fungsi untuk menambahkan event listener pada input edit
    function addEditInputListeners() {
        const inputs = document.querySelectorAll('.edit-input');
        inputs.forEach(input => {
            input.addEventListener('change', function() {
                const index = parseInt(this.dataset.index);
                const field = this.dataset.field;
                let value = this.value;
                
                if (field === 'target' || field === 'weight') {
                    value = parseFloat(value) || 0;
                }
                
                kpiData[index][field] = value;
            });
        });
    }

    // Fungsi untuk menonaktifkan mode edit
    function disableEditMode() {
        isEditMode = false;
        document.querySelector('.kpi-container').classList.remove('edit-mode');
        
        editAllBtn.innerHTML = '<i class="fas fa-edit"></i> Edit All';
        editAllBtn.classList.remove('btn-success');
        editAllBtn.classList.add('btn-primary');
        
        const inputs = document.querySelectorAll('.edit-input');
        inputs.forEach(input => {
            const index = parseInt(input.dataset.index);
            const field = input.dataset.field;
            let value = input.value;
            
            if (field === 'target' || field === 'weight') {
                value = parseFloat(value) || 0;
            }
            
            kpiData[index][field] = value;
        });
        
        saveKpiDataToFirestore();
        updateDisplay();
        showNotification('Perubahan KPI berhasil disimpan.', 'success');
    }

    // Fungsi untuk memperbarui tampilan dengan data terbaru
    // Fungsi untuk memperbarui tampilan dengan data terbaru - VERSI DIPERBAIKI
// PERBAIKAN FUNGSI updateDisplay - VERSI DIPERBAIKI
function updateDisplay() {
    console.log('üîÑ Updating display with current data...');
    
    const rows = document.querySelectorAll('.kpi-table tbody tr:not(.result-row)');
    rows.forEach((row, index) => {
        if (index < kpiData.length) {
            const data = kpiData[index];
            
            // Pastikan semua nilai ada
            const safeTarget = data.target || 0;
            const safeWeight = data.weight || 0;
            const safeRealization = data.realization || 0;
            const safeScore = data.score || 0;
            
            row.querySelector('td:nth-child(2)').textContent = data.area || '';
            row.querySelector('td:nth-child(3)').textContent = safeTarget;
            row.querySelector('td:nth-child(4)').textContent = safeWeight.toFixed(2) + '%';
            row.querySelector('td:nth-child(5)').textContent = data.description || '';
            row.querySelector('td:nth-child(6)').textContent = data.note || '';
            
            const realizationCell = row.querySelector('.realization-cell');
            if (realizationCell) {
                realizationCell.textContent = safeRealization;
            }
            
            const scoreCell = row.querySelector('td:nth-child(9)');
            if (scoreCell) {
                scoreCell.textContent = safeScore.toFixed(2) + '%';
                scoreCell.className = '';
                
                if (safeScore >= 100) {
                    scoreCell.classList.add('target-achieved');
                } else if (safeScore >= 70) {
                    scoreCell.classList.add('target-partial');
                } else {
                    scoreCell.classList.add('target-missed');
                }
            }
            
            // PERBAIKAN: JANGAN hapus tombol action, tapi update sesuai role
            const actionCell = row.querySelector('td:last-child');
            if (actionCell) {
                if (isSuperAdminUser) {
                    // Untuk Super Admin, tampilkan tombol edit
                    actionCell.innerHTML = `
                        <button class="btn-edit-cell" onclick="editSingleRow(${index})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    `;
                } else {
                    // Untuk user biasa, kosongkan atau tampilkan pesan
                    actionCell.innerHTML = `<span class="no-action">-</span>`;
                }
            }
        }
    });
    
    // Update total
    updateKPI();
    
    console.log('‚úÖ Display updated successfully');
}
    // ========== FUNGSI NOTIFICATION ==========

    // Fungsi untuk menampilkan notifikasi
    function showNotification(message, type = 'info') {
        if (!notificationContainer) {
            console.error('Notification container not found');
            return;
        }
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
            <button class="notification-close">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        notificationContainer.appendChild(notification);
        
        const closeBtn = notification.querySelector('.notification-close');
        closeBtn.addEventListener('click', function() {
            closeNotification(notification);
        });
        
        const timeoutId = setTimeout(() => {
            closeNotification(notification);
        }, 5000);
        
        notification.dataset.timeoutId = timeoutId;
    }

    // Fungsi untuk menutup notifikasi
    function closeNotification(notification) {
        if (notification.dataset.timeoutId) {
            clearTimeout(parseInt(notification.dataset.timeoutId));
        }
        
        notification.classList.add('hiding');
        
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 300);
    }

    // ========== FUNGSI RESET DATA ==========

    // Fungsi untuk reset data KPI
    function resetKpiData() {
        if (!isSuperAdminUser && currentFilter !== 'current') {
            showNotification('Hanya bisa mereset data sendiri', 'error');
            return;
        }
        
        const defaults = [
            { area: "B2B & B2C (Count.)", target: 3, weight: 25, description: "Pembukaan WLB / Agent baru", note: "Semakin Besar Semakin Bagus", realization: 0 },
            { area: "Problem Solving (Count.)", target: 6, weight: 20, description: "Kemampuan dalam menyelesaikan setiap masalah", note: "Semakin Besar Semakin Bagus", realization: 0 },
            { area: "Idea (Count.)", target: 3, weight: 20, description: "Aktif memberikan ide, Saran & Masukan", note: "Semakin Besar Semakin Bagus", realization: 0 },
            { area: "Response Chat (Count.)", target: 4, weight: 10, description: "Kecepatan dan ketepatan dalam Merespon Chat (Max 3 Menit)", note: "Semakin Kecil Semakin Bagus", realization: 0 },
            { area: "Research (Count.)", target: 28, weight: 10, description: "Research keunggulan Platform / Agent Lain", note: "Semakin Besar Semakin Bagus", realization: 0 },
            { area: "Attitude (Skor.)", target: 8, weight: 10, description: "Attitude dalam mengikuti SOP / Arahan", note: "Semakin Besar Semakin Bagus", realization: 0 },
            { area: "Disiplin (Day.)", target: 28, weight: 5, description: "Jumlah kedisiplinan setiap bulan", note: "Semakin Besar Semakin Bagus", realization: 0 }
        ];
        
        kpiData.forEach((item, index) => {
            Object.assign(item, defaults[index]);
        });
        
        saveKpiDataToFirestore();
        updateDisplay();
        showNotification('Data KPI berhasil direset ke nilai default.', 'success');
    }

// ========== FUNGSI SAVE YANG DIPERBAIKI ==========
async function saveKpiDataToFirestore() {
    try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) {
            console.error('‚ùå No user logged in');
            return false;
        }

        const db = firebase.firestore();
        
        // Tentukan user ID target
        let targetUserId = currentUser.uid;
        
        // Jika Super Admin sedang melihat user lain, simpan ke user tersebut
        if (isSuperAdminUser && currentFilter !== 'current') {
            // Dapatkan user ID dari data yang sedang dilihat
            const viewingUserId = getCurrentViewingUserId();
            if (viewingUserId && viewingUserId !== currentUser.uid) {
                targetUserId = viewingUserId;
            }
        }
        
        console.log('üíæ SAVING to Firestore for user:', targetUserId);
        console.log('üìä Data to save:', kpiData);

        // Format data sesuai dengan struktur Firestore
        const kpiDoc = {
            kpiData: kpiData.map(item => ({
                id: item.id,
                area: item.area,
                target: item.target,
                weight: item.weight,
                description: item.description,
                note: item.note,
                realization: item.realization,
                score: item.score
            })),
            userId: targetUserId,
            userName: currentUser.displayName || currentUser.email,
            userEmail: currentUser.email,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            totalScore: calculateTotalScore(kpiData),
            lastUpdatedBy: currentUser.uid // Track siapa yang mengedit
        };

        // Gunakan set() dengan merge: true untuk update/create
        await db.collection('kpiData').doc(targetUserId).set(kpiDoc, { merge: true });
        
        console.log('‚úÖ SUCCESS: Data saved to Firestore for user:', targetUserId);
        
        // Juga update data di collections terpisah (ideas, research, dll)
        await updateModuleCollections(targetUserId);
        
        return true;
        
    } catch (error) {
        console.error('‚ùå ERROR saving to Firestore:', error);
        showNotification('Gagal menyimpan data: ' + error.message, 'error');
        return false;
    }
}

// Fungsi untuk mendapatkan user ID yang sedang dilihat
function getCurrentViewingUserId() {
    // Cek dari URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('userId')) {
        return urlParams.get('userId');
    }
    
    // Cek dari state aplikasi
    if (window.currentViewingUserId) {
        return window.currentViewingUserId;
    }
    
    // Fallback ke current user
    const currentUser = firebase.auth().currentUser;
    return currentUser ? currentUser.uid : null;
}

// Fungsi untuk update collections terpisah
async function updateModuleCollections(userId) {
    try {
        const db = firebase.firestore();
        
        // Update ideas collection
        const ideasData = kpiData.find(item => item.id === 3);
        if (ideasData) {
            await updateIdeasCollection(userId, ideasData.realization);
        }
        
        // Update research collection  
        const researchData = kpiData.find(item => item.id === 5);
        if (researchData) {
            await updateResearchCollection(userId, researchData.realization);
        }
        
        // Update chat collection
        const chatData = kpiData.find(item => item.id === 4);
        if (chatData) {
            await updateChatCollection(userId, chatData.realization);
        }
        
        console.log('‚úÖ Module collections updated');
        
    } catch (error) {
        console.error('Error updating module collections:', error);
    }
}

// Update Ideas Collection
async function updateIdeasCollection(userId, realization) {
    const db = firebase.firestore();
    
    // Hapus data lama
    const oldIdeas = await db.collection('ideas')
        .where('userId', '==', userId)
        .get();
    
    const deletePromises = oldIdeas.docs.map(doc => doc.ref.delete());
    await Promise.all(deletePromises);
    
    // Buat data baru sesuai realization
    for (let i = 0; i < realization; i++) {
        await db.collection('ideas').add({
            userId: userId,
            title: `Idea ${i + 1}`,
            points: 1,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
}

// Update Research Collection  
async function updateResearchCollection(userId, realization) {
    const db = firebase.firestore();
    
    const oldResearch = await db.collection('research')
        .where('userId', '==', userId)
        .get();
    
    const deletePromises = oldResearch.docs.map(doc => doc.ref.delete());
    await Promise.all(deletePromises);
    
    for (let i = 0; i < realization; i++) {
        await db.collection('research').add({
            userId: userId,
            title: `Research ${i + 1}`,
            points: 1,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
}

// Update Chat Collection
async function updateChatCollection(userId, realization) {
    const db = firebase.firestore();
    
    const oldChats = await db.collection('chats')
        .where('userId', '==', userId)
        .get();
    
    const deletePromises = oldChats.docs.map(doc => doc.ref.delete());
    await Promise.all(deletePromises);
    
    for (let i = 0; i < realization; i++) {
        await db.collection('chats').add({
            userId: userId,
            responseTime: 2.5, // Default value
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
}
// Fungsi untuk mendapatkan user ID yang sedang dilihat
function getCurrentViewingUserId() {
    // Coba dapatkan dari berbagai sumber
    const userBadge = document.querySelector('.user-name-badge');
    if (userBadge) {
        // Jika ada data attribute di badge
        return userBadge.dataset.userId;
    }
    
    // Cek dari URL parameter atau state
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('userId')) {
        return urlParams.get('userId');
    }
    
    // Fallback: return current user ID
    const currentUser = firebase.auth().currentUser;
    return currentUser ? currentUser.uid : null;
}
// BUAT fungsi baru untuk mengatur urutan loading yang benar:
async function initializeKpiData() {
    try {
        // 1. Coba load dari kpiData collection di Firestore
        const firestoreLoaded = await loadKpiDataFromFirestore();
        
        if (!firestoreLoaded) {
            // 2. Jika tidak ada data di Firestore, ambil dari collections terpisah
            await updateAllKpiData();
            // 3. Simpan ke kpiData collection
            await saveKpiDataToFirestore();
        }
        
        // 4. Update tampilan
        updateDisplay();
        
    } catch (error) {
        console.error('Error initializing KPI data:', error);
    }
}
// PERBAIKI fungsi loadKpiDataFromFirestore untuk benar-benar menggunakan data Firestore:
async function loadKpiDataFromFirestore(userId = null) {
    try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) {
            console.log('User not authenticated');
            return false;
        }
        
        const targetUserId = userId || currentUser.uid;
        const db = firebase.firestore();
        
        console.log('üì• Loading KPI data from Firestore kpiData collection for user:', targetUserId);
        
        const doc = await db.collection('kpiData').doc(targetUserId).get();
        
        if (doc.exists) {
            const savedData = doc.data();
            console.log('‚úÖ Data loaded from Firestore kpiData:', savedData);
            
            if (savedData.kpiData && Array.isArray(savedData.kpiData)) {
                // PERBAIKAN PENTING: Gunakan SEMUA data dari Firestore, bukan hanya realisasi
                kpiData.length = 0; // Clear existing data
                
                savedData.kpiData.forEach(savedItem => {
                    kpiData.push({
                        id: savedItem.id || 0,
                        area: savedItem.area || '',
                        target: savedItem.target || 0,
                        weight: savedItem.weight || 0,
                        description: savedItem.description || '',
                        note: savedItem.note || '',
                        realization: savedItem.realization || 0,
                        score: savedItem.score || 0
                    });
                });
                
                console.log('‚úÖ kpiData completely replaced with Firestore data');
                return true;
            }
        } else {
            console.log('üì≠ No data found in kpiData collection');
        }
        
        return false;
        
    } catch (error) {
        console.error('‚ùå Error loading from Firestore kpiData:', error);
        return false;
    }
}

    // Setup real-time listeners untuk semua koleksi - VERSI DIPERBAIKI
// MODIFIKASI real-time listener untuk benar-benar menggunakan data dari Firestore:
function setupRealTimeListeners() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) return;
    
    // PERBAIKAN: Gunakan currentUser.uid, bukan currentUser.ui4
    const targetUserId = currentUser.uid;
    
    console.log('üîî Setting up listener for user:', targetUserId);
    
    const db = firebase.firestore();
    const kpiUnsubscribe = db.collection('kpiData')
        .doc(targetUserId)
        .onSnapshot((doc) => {
            if (isLocalChange && (Date.now() - lastLocalChangeTime < 3000)) {
                return; // Skip jika perubahan lokal
            }
            
            if (doc.exists) {
                const savedData = doc.data();
                // VERIFIKASI user ID sebelum update
                if (savedData.userId === targetUserId) {
                    console.log('‚úÖ Safe update for user:', targetUserId);
                    updateKpiFromFirestore(savedData);
                }
            }
        });
    
    // Simpan fungsi unsubscribe
    unsubscribeFunctions.push(kpiUnsubscribe);
}

    // PERBAIKAN EVENT LISTENER UNTUK EDIT ALL
if (editAllBtn) {
    editAllBtn.addEventListener('click', (e) => {
        if (!isSuperAdminUser) {
            e.preventDefault();
            e.stopPropagation();
            showNotification('Hanya Super Admin yang dapat mengedit data', 'error');
            return;
        }
        
        if (!isEditMode) {
            enableEditMode(); // Tampilkan modal pilihan edit
        } else {
            disableEditMode(); // Simpan perubahan
        }
    });
}

    // Event Listeners untuk reset modal dengan protection
    if (resetBtn) {
        resetBtn.addEventListener('click', (e) => {
            if (!isSuperAdminUser) {
                e.preventDefault();
                e.stopPropagation();
                showNotification('Hanya Super Admin yang dapat mereset data', 'error');
                return;
            }
            resetModal.style.display = 'flex';
        });
    }

    // Protection untuk tombol edit di submenu
    document.addEventListener('click', function(e) {
        if (e.target.closest('.submenu-container .btn-edit-all') || 
            e.target.closest('.criteria-list .btn-primary')) {
            if (!isSuperAdminUser) {
                e.preventDefault();
                e.stopPropagation();
                showNotification('Hanya Super Admin yang dapat mengedit data', 'error');
            }
        }
    });

    // ========== INISIALISASI SAAT HALAMAN DIMUAT ==========
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ KPI Integration initialized');
    
    if (typeof firebase !== 'undefined' && firebase.auth()) {
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                console.log('‚úÖ User authenticated:', user.email);
                
                // Setup admin UI
                await checkAndSetupSuperAdmin();
                
                // PERBAIKAN: Hanya load dari kpiData collection, jangan panggil updateAllKpiData
                const firestoreDataLoaded = await loadKpiDataFromFirestore();
                
                if (firestoreDataLoaded) {
                    console.log('‚úÖ Data loaded successfully from Firestore kpiData collection');
                    updateDisplay();
                } else {
                    console.log('‚ÑπÔ∏è No data in kpiData collection, will initialize with module data');
                    // Hanya inisialisasi jika benar-benar kosong
                    await initializeWithModuleData();
                }
                
                // Setup real-time listeners
                setupRealTimeListeners();
                
                console.log('‚úÖ KPI Dashboard initialized successfully');
                
            } else {
                console.log('‚ùå User not authenticated');
                setupAdminUI(false);
            }
        });
    }
});
// FUNGSI BARU: Hanya untuk inisialisasi pertama kali
async function initializeWithModuleData() {
    try {
        console.log('üîÑ Initializing with module data for the first time...');
        
        // Ambil data dari modules
        const ideasData = await getIdeasData();
        const researchData = await getResearchData();
        const chatData = await getChatData();
        const problemData = await getProblemSolvingData();
        const b2bData = await getB2BData();
        const attitudeData = await getAttitudeData();
        const disciplineData = await getDisciplineData();

        // Update realisasi saja
        kpiData[0].realization = b2bData.count;
        kpiData[1].realization = problemData.count;
        kpiData[2].realization = ideasData.count;
        kpiData[3].realization = chatData.count;
        kpiData[4].realization = researchData.count;
        kpiData[5].realization = attitudeData.averageScore;
        kpiData[6].realization = disciplineData.count;

        // Hitung skor
        updateKPI();
        
        // Simpan ke kpiData collection
        await saveKpiDataToFirestore();
        
        console.log('‚úÖ Initialized with module data and saved to kpiData collection');
        
    } catch (error) {
        console.error('Error initializing with module data:', error);
    }
}
    // ========== FUNGSI TAMBAHAN UNTUK INTEGRASI ==========

    // Fungsi untuk mendapatkan ringkasan performa KPI
    function getKpiSummary() {
        const totalScore = kpiData.reduce((sum, item) => sum + (item.score * item.weight) / 100, 0);
        const totalRealization = kpiData.reduce((sum, item) => sum + item.realization, 0);
        
        return {
            totalScore: totalScore.toFixed(2),
            totalRealization: totalRealization,
            status: totalScore >= 70 ? 'Excellent' : totalScore >= 50 ? 'Good' : 'Need Improvement',
            details: kpiData.map(item => ({
                area: item.area,
                score: item.score.toFixed(2),
                realization: item.realization,
                target: item.target,
                weight: item.weight
            }))
        };
    }

    // Export fungsi untuk digunakan di modul lain
    window.KPIDashboard = {
        getSummary: getKpiSummary,
        updateData: updateAllKpiData,
        getKpiData: () => kpiData,
        setupRealTimeListeners: setupRealTimeListeners,
        isSuperAdmin: () => isSuperAdminUser
    };

    // Fungsi untuk setup super admin (jalankan di console browser)
    window.setupSuperAdmin = async function(email) {
        const db = firebase.firestore();
        const users = await db.collection('users').get();
        
        let targetUser = null;
        users.forEach(doc => {
            if (doc.data().email === email) {
                targetUser = doc;
            }
        });
        
        if (targetUser) {
            await db.collection('users').doc(targetUser.id).update({
                role: 'super_admin',
                isSuperAdmin: true
            });
            console.log('Super admin berhasil di setup untuk email:', email);
            return true;
        } else {
            console.log('User dengan email tersebut tidak ditemukan');
            return false;
        }
    };
    // ========== FUNGSI DEBUG ==========

    // Fungsi untuk debug manual di console browser
    window.debugKPI = function() {
        console.log('=== DEBUG KPI DASHBOARD ===');
        console.log('Current User:', firebase.auth().currentUser);
        console.log('Is Super Admin:', isSuperAdminUser);
        console.log('Current Filter:', currentFilter);
        console.log('KPI Data:', kpiData);
        console.log('Firestore Config:', firebaseConfig);
        
        // Check Firestore data
        const db = firebase.firestore();
        db.collection('kpiData').get().then(snapshot => {
            console.log('Total KPI Documents:', snapshot.size);
            snapshot.forEach(doc => {
                console.log('KPI Doc:', doc.id, doc.data());
            });
        });
        
        db.collection('users').get().then(snapshot => {
            console.log('Total User Documents:', snapshot.size);
            snapshot.forEach(doc => {
                console.log('User Doc:', doc.id, doc.data());
            });
        });
    };

    // Force enable super admin untuk testing
    window.forceSuperAdmin = function() {
        isSuperAdminUser = true;
        setupAdminUI(true);
        console.log('üîì Super admin forced enabled');
        showNotification('Super Admin mode diaktifkan secara manual', 'info');
        
        // Refresh data dengan filter all
        loadKpiData('all');
    };

    // Test load all data
    window.testLoadAll = function() {
        console.log('üß™ Testing load all data');
        loadKpiData('all');
    };
    // Fungsi untuk debug detail koleksi
    window.debugCollections = async function() {
        console.log('=== DEBUG COLLECTIONS ===');
        const db = firebase.firestore();
        
        try {
            const [kpiSnapshot, usersSnapshot] = await Promise.all([
                db.collection('kpiData').get(),
                db.collection('users').get()
            ]);
            
            console.log(`üìÅ KPI Documents (${kpiSnapshot.size}):`);
            kpiSnapshot.forEach(doc => {
                console.log(`  üìÑ ${doc.id}:`, doc.data());
            });
            
            console.log(`üìÅ User Documents (${usersSnapshot.size}):`);
            usersSnapshot.forEach(doc => {
                console.log(`  üë§ ${doc.id}:`, doc.data());
            });
            
            // Check if user IDs match
            const kpiUserIds = [];
            kpiSnapshot.forEach(doc => kpiUserIds.push(doc.id));
            
            const userUserIds = [];
            usersSnapshot.forEach(doc => userUserIds.push(doc.id));
            
            console.log('üîó User ID Matching:');
            console.log('  KPI User IDs:', kpiUserIds);
            console.log('  User User IDs:', userUserIds);
            console.log('  Matching IDs:', kpiUserIds.filter(id => userUserIds.includes(id)));
            
        } catch (error) {
            console.error('‚ùå Debug error:', error);
        }
    };
    // ========== FUNGSI RESET DATA TANPA PASSWORD ==========

    // Fungsi untuk reset data KPI
    async function resetKpiData() {
        if (!isSuperAdminUser && currentFilter !== 'current') {
            showNotification('Hanya bisa mereset data sendiri', 'error');
            return;
        }
        
        // Konfirmasi sederhana sebelum reset
        const userConfirmed = confirm('Apakah Anda yakin ingin mereset semua data KPI ke nilai default?');
        
        if (!userConfirmed) {
            showNotification('Reset data dibatalkan', 'info');
            return;
        }
        
        try {
            console.log('üîÑ Resetting KPI data to defaults...');
            
            // Data default
            const defaults = [
                { area: "B2B & B2C (Count.)", target: 3, weight: 25, description: "Pembukaan WLB / Agent baru", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 },
                { area: "Problem Solving (Count.)", target: 6, weight: 20, description: "Kemampuan dalam menyelesaikan setiap masalah", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 },
                { area: "Idea (Count.)", target: 3, weight: 20, description: "Aktif memberikan ide, Saran & Masukan", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 },
                { area: "Response Chat (Count.)", target: 4, weight: 10, description: "Kecepatan dan ketepatan dalam Merespon Chat (Max 3 Menit)", note: "Semakin Kecil Semakin Bagus", realization: 0, score: 0 },
                { area: "Research (Count.)", target: 28, weight: 10, description: "Research keunggulan Platform / Agent Lain", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 },
                { area: "Attitude (Skor.)", target: 8, weight: 10, description: "Attitude dalam mengikuti SOP / Arahan", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 },
                { area: "Disiplin (Day.)", target: 28, weight: 5, description: "Jumlah kedisiplinan setiap bulan", note: "Semakin Besar Semakin Bagus", realization: 0, score: 0 }
            ];
            
            // Reset data KPI
            kpiData.forEach((item, index) => {
                if (defaults[index]) {
                    Object.assign(item, defaults[index]);
                }
            });
            
            // Simpan ke Firestore
            await saveKpiDataToFirestore();
            
            // Update tampilan
            updateDisplay();
            
            // Reset data real-time dari Firestore (ideas, research, chat, dll)
            await resetFirestoreData();
            
            showNotification('‚úÖ Data KPI berhasil direset ke nilai default!', 'success');
            
            console.log('‚úÖ KPI data reset successfully');
            
        } catch (error) {
            console.error('‚ùå Error resetting KPI data:', error);
            showNotification('‚ùå Gagal mereset data KPI: ' + error.message, 'error');
        }
    }

    // Fungsi untuk reset data di Firestore collections
    async function resetFirestoreData() {
        try {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return;
            
            const db = firebase.firestore();
            const userId = currentFilter === 'all' && isSuperAdminUser ? null : currentUser.uid;
            
            // Daftar collections yang perlu direset
            const collections = ['ideas', 'research', 'chats', 'problems', 'b2b', 'attitude', 'discipline'];
            
            for (const collectionName of collections) {
                let query = db.collection(collectionName);
                
                // Jika bukan super admin atau filter current, reset hanya data user sendiri
                if (userId) {
                    query = query.where('userId', '==', userId);
                }
                
                const snapshot = await query.get();
                
                // Hapus semua dokumen dalam collection
                const deletePromises = snapshot.docs.map(doc => doc.ref.delete());
                await Promise.all(deletePromises);
                
                console.log(`‚úÖ Reset ${collectionName}: ${snapshot.size} documents deleted`);
            }
            
        } catch (error) {
            console.error('Error resetting Firestore data:', error);
            // Tidak perlu show notification di sini, karena reset KPI utama sudah berhasil
        }
    }

    // ========== EVENT LISTENERS YANG DIPERBAIKI ==========

    // Event Listener untuk tombol reset
    if (resetBtn) {
        resetBtn.addEventListener('click', (e) => {
            if (!isSuperAdminUser && currentFilter !== 'current') {
                e.preventDefault();
                e.stopPropagation();
                showNotification('Hanya bisa mereset data sendiri', 'error');
                return;
            }
            
            // Langsung jalankan reset tanpa modal konfirmasi password
            resetKpiData();
        });
    }

    // HAPUS event listeners untuk modal reset yang sudah tidak ada
    // resetCancel, resetConfirm, dll.
    // ========== FUNGSI UNTUK MENAMPILKAN NAMA USER ==========

// Fungsi untuk menampilkan nama user di header
function displayUserNameInHeader(userName = null) {
    const kpiHeader = document.querySelector('.kpi-container h2');
    if (!kpiHeader) return;
    
    // Hapus elemen nama user yang sudah ada
    const existingUserBadge = document.querySelector('.user-name-badge');
    if (existingUserBadge) {
        existingUserBadge.remove();
    }
    
    // Jika tidak ada nama user atau melihat data sendiri, tampilkan default
    if (!userName || currentFilter === 'current') {
        kpiHeader.textContent = 'Data KPI Performance';
        return;
    }
    
    // Tambahkan badge nama user di samping judul
    const userBadge = document.createElement('span');
    userBadge.className = 'user-name-badge';
    userBadge.innerHTML = `<i class="fas fa-user"></i> ${userName}`;
    userBadge.style.cssText = `
        background: var(--primary-gradient);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        margin-left: 12px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        vertical-align: middle;
    `;
    
    kpiHeader.textContent = 'Data KPI Performance ';
    kpiHeader.appendChild(userBadge);
}

// ========== MODIFIKASI FUNGSI YANG SUDAH ADA ==========

// Modifikasi fungsi viewUserDetail untuk menampilkan nama user
function viewUserDetail(userId) {
    const regularTable = document.querySelector('.kpi-table');
    if (regularTable) {
        regularTable.style.display = '';
    }
    
    const actionButtons = document.querySelector('.kpi-actions');
    if (actionButtons) {
        actionButtons.style.display = 'flex';
    }
    
    const allUsersTable = document.querySelector('.all-users-table');
    if (allUsersTable) {
        allUsersTable.remove();
    }
    
    // Dapatkan nama user sebelum memuat data
    getUserNameById(userId).then(userName => {
        displayUserNameInHeader(userName);
        loadKpiData('current', userId);
    });
    
    const userFilter = document.getElementById('userFilter');
    if (userFilter) {
        userFilter.value = 'current';
    }
    
    showNotification('Memuat data user...', 'info');
}

// Fungsi untuk mendapatkan nama user berdasarkan ID
async function getUserNameById(userId) {
    try {
        const db = firebase.firestore();
        const userDoc = await db.collection('users').doc(userId).get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            // Prioritaskan name, lalu email, baru fallback
            if (userData.name && userData.name !== 'User') {
                return userData.name;
            } else if (userData.email) {
                return userData.email.split('@')[0]; // Ambil username dari email
            }
        }
        return 'Loading...'; // Jangan langsung kasih 'Unknown User'
    } catch (error) {
        console.error('Error getting user name:', error);
        return 'Loading...';
    }
}

// Modifikasi fungsi displayAllUsersData untuk menyimpan informasi user
function displayAllUsersData(usersData) {
    const container = document.querySelector('.kpi-container');
    if (!container) {
        console.error('KPI container not found');
        return;
    }
    
    console.log('Displaying data for', usersData.length, 'users');
    
    const existingTable = container.querySelector('.all-users-table');
    if (existingTable) {
        existingTable.remove();
    }
    
    const regularTable = container.querySelector('.kpi-table');
    if (regularTable) {
        regularTable.style.display = 'none';
    }
    
    const actionButtons = container.querySelector('.kpi-actions');
    if (actionButtons) {
        actionButtons.style.display = 'none';
    }
    
    // Reset header ke default saat melihat semua user
    displayUserNameInHeader();
    
    const tableHtml = `
        <div class="all-users-table">
            <h3><i class="fas fa-users"></i> Data KPI Semua User (${usersData.length} users)</h3>
            <table class="kpi-table">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>User</th>
                        <th>Email</th>
                        <th>Total KPI</th>
                        <th>Ideas</th>
                        <th>Research</th>
                        <th>Chat Response</th>
                        <th>Problem Solving</th>
                        <th>Terakhir Update</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    ${usersData.map((user, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${user.userName}</td>
                            <td>${user.userEmail}</td>
                            <td class="${user.totalScore >= 70 ? 'target-achieved' : user.totalScore >= 50 ? 'target-partial' : 'target-missed'}">
                                ${user.totalScore}%
                            </td>
                            <td>${user.ideasScore}%</td>
                            <td>${user.researchScore}%</td>
                            <td>${user.chatScore}%</td>
                            <td>${user.problemScore}%</td>
                            <td>${user.lastUpdated}</td>
                            <td>
                                <button class="btn-view-user" data-uid="${user.userId}" data-name="${user.userName}">
                                    <i class="fas fa-eye"></i> Lihat Detail
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', tableHtml);
    
    container.querySelectorAll('.btn-view-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.uid;
            const userName = this.dataset.name;
            console.log('Viewing detail for user:', userName);
            
            // Tampilkan nama user di header
            displayUserNameInHeader(userName);
            viewUserDetail(userId);
        });
    });
    
    showNotification(`Menampilkan data ${usersData.length} user`, 'info');
}

// Modifikasi fungsi loadKpiData untuk menangani tampilan nama user
async function loadKpiData(filter = 'current', specificUserId = null) {
    try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) return;
        
        console.log('üë§ Current user:', currentUser.uid, currentUser.email);
        
        let targetUserId = currentUser.uid;
        let targetUserName = 'Loading...'; // Default temporary
        
        if (filter === 'all' && isSuperAdminUser) {
            await loadAllUsersData();
            return;
        }
        
        if (specificUserId && specificUserId !== currentUser.uid) {
            targetUserId = specificUserId;
            targetUserName = await getUserNameById(specificUserId);
        } else {
            // Untuk user sendiri, coba dapatkan nama dari berbagai sumber
            targetUserName = await getUserNameById(currentUser.uid);
        }
        
        console.log('üéØ Loading data for:', targetUserId, targetUserName);
        
        displayUserNameInHeader(targetUserName);
        await updateAllKpiData(targetUserId);
        
    } catch (error) {
        console.error('‚ùå Error loading KPI data:', error);
    }
}

// ========== CSS UNTUK STYLING BADGE NAMA USER ==========

// Tambahkan CSS ini ke dalam tag <style> yang sudah ada
const additionalCSS = `
    .user-name-badge {
        background: var(--primary-gradient);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        margin-left: 12px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        vertical-align: middle;
        animation: fadeIn 0.3s ease;
    }
    
    .kpi-container h2 {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    @media (max-width: 768px) {
        .kpi-container h2 {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        
        .user-name-badge {
            margin-left: 0;
            align-self: flex-start;
        }
    }
`;

// Inject CSS tambahan
const style = document.createElement('style');
style.textContent = additionalCSS;
document.head.appendChild(style);

// ========== INISIALISASI ==========

// Pastikan header direset saat kembali ke dashboard utama
document.addEventListener('DOMContentLoaded', function() {
    // Reset header saat berpindah dashboard
    const menuItems = document.querySelectorAll('.menu-item');
    menuItems.forEach(item => {
        item.addEventListener('click', function() {
            if (this.dataset.target === 'dashboard-kpi') {
                // Kembali ke data sendiri, reset header
                displayUserNameInHeader();
                const userFilter = document.getElementById('userFilter');
                if (userFilter) {
                    userFilter.value = 'current';
                }
                currentFilter = 'current';
                loadKpiData('current');
            }
        });
    });
});
// ========== FUNGSI EDIT REALISASI UNTUK SUPER ADMIN ==========

// Fungsi untuk mengaktifkan mode edit realisasi
// ========== FUNGSI EDIT ACTION UNTUK SUPER ADMIN ==========

// Fungsi untuk mengaktifkan mode edit realisasi saja
function enableRealisasiEditMode() {
    if (!isSuperAdminUser) {
        showNotification('Hanya Super Admin yang dapat mengedit realisasi', 'error');
        return;
    }
    
    isEditMode = true;
    document.querySelector('.kpi-container').classList.add('edit-mode');
    
    editAllBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Semua';
    editAllBtn.classList.add('btn-success');
    editAllBtn.classList.remove('btn-primary');
    
    const rows = document.querySelectorAll('.kpi-table tbody tr:not(.result-row)');
    rows.forEach((row, index) => {
        if (index < kpiData.length) {
            const data = kpiData[index];
            
            // Hanya edit realisasi (kolom ke-8)
            const realizationCell = row.querySelector('.realization-cell');
            if (realizationCell) {
                realizationCell.innerHTML = `
                    <input type="number" 
                           class="edit-input realization-input" 
                           value="${data.realization}" 
                           min="0" 
                           data-field="realization" 
                           data-index="${index}"
                           placeholder="Realisasi">
                `;
            }
            
            // Tambahkan tombol edit untuk kolom lain
            const actionCell = row.querySelector('td:last-child');
            if (actionCell && actionCell.innerHTML.trim() === '') {
                actionCell.innerHTML = `
                    <button class="btn-edit-cell" onclick="editSingleRow(${index})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                `;
            }
        }
    });
    
    addRealisasiEditListeners();
    showNotification('Mode edit realisasi diaktifkan. Hanya Super Admin yang dapat mengubah data.', 'info');
}

// Fungsi untuk edit satu baris (full edit untuk super admin)
function editSingleRow(index) {
    if (!isSuperAdminUser) {
        showNotification('Hanya Super Admin yang dapat mengedit data', 'error');
        return;
    }
    
    const row = document.querySelector(`.kpi-table tbody tr:nth-child(${index + 1})`);
    const data = kpiData[index];
    
    if (row) {
        // Edit semua field untuk baris ini
        const areaCell = row.querySelector('td:nth-child(2)');
        areaCell.innerHTML = `<input type="text" class="edit-input" value="${data.area}" data-field="area" data-index="${index}">`;
        
        const targetCell = row.querySelector('td:nth-child(3)');
        targetCell.innerHTML = `<input type="number" class="edit-input" value="${data.target}" min="0" data-field="target" data-index="${index}">`;
        
        const weightCell = row.querySelector('td:nth-child(4)');
        weightCell.innerHTML = `<input type="number" class="edit-input" value="${data.weight}" min="0" max="100" data-field="weight" data-index="${index}">`;
        
        const descCell = row.querySelector('td:nth-child(5)');
        descCell.innerHTML = `<input type="text" class="edit-input" value="${data.description}" data-field="description" data-index="${index}">`;
        
        const noteCell = row.querySelector('td:nth-child(6)');
        noteCell.innerHTML = `<input type="text" class="edit-input" value="${data.note}" data-field="note" data-index="${index}">`;
        
        const realizationCell = row.querySelector('.realization-cell');
        if (realizationCell) {
            realizationCell.innerHTML = `<input type="number" class="edit-input realization-input" value="${data.realization}" min="0" data-field="realization" data-index="${index}">`;
        }
        
        // Update tombol action
        const actionCell = row.querySelector('td:last-child');
        if (actionCell) {
            actionCell.innerHTML = `
                <button class="btn-save-cell" onclick="saveSingleRow(${index})">
                    <i class="fas fa-check"></i> Simpan
                </button>
                <button class="btn-cancel-cell" onclick="cancelSingleRow(${index})">
                    <i class="fas fa-times"></i> Batal
                </button>
            `;
        }
        
        addEditInputListeners();
    }
}

// Fungsi untuk menyimpan satu baris
async function saveSingleRow(index) {
    try {
        const row = document.querySelector(`.kpi-table tbody tr:nth-child(${index + 1})`);
        const inputs = row.querySelectorAll('.edit-input');
        
        inputs.forEach(input => {
            const field = input.dataset.field;
            let value = input.value;
            
            if (field === 'target' || field === 'weight' || field === 'realization') {
                value = parseFloat(value) || 0;
            }
            
            kpiData[index][field] = value;
        });
        
        // Hitung ulang skor untuk baris ini
        const data = kpiData[index];
        const isSmallerBetter = data.note.includes("Semakin Kecil");
        data.score = calculateScore(data.target, data.realization, isSmallerBetter, index);
        
        // Simpan ke Firestore
        const saveResult = await saveKpiDataToFirestore();
        
        if (saveResult) {
            updateDisplay();
            showNotification(`Data ${data.area} berhasil diperbarui dan disimpan ke database!`, 'success');
        } else {
            showNotification('Gagal menyimpan perubahan ke database', 'error');
        }
        
    } catch (error) {
        console.error('Error saving single row:', error);
        showNotification('Error: ' + error.message, 'error');
    }
}

// Fungsi untuk membatalkan edit satu baris
// PERBAIKAN FUNGSI cancelSingleRow
function cancelSingleRow(index) {
    try {
        const row = document.querySelector(`.kpi-table tbody tr:nth-child(${index + 1})`);
        
        // Kembalikan ke tampilan normal
        const data = kpiData[index];
        
        row.querySelector('td:nth-child(2)').textContent = data.area || '';
        row.querySelector('td:nth-child(3)').textContent = data.target || 0;
        row.querySelector('td:nth-child(4)').textContent = (data.weight || 0).toFixed(2) + '%';
        row.querySelector('td:nth-child(5)').textContent = data.description || '';
        row.querySelector('td:nth-child(6)').textContent = data.note || '';
        
        const realizationCell = row.querySelector('.realization-cell');
        if (realizationCell) {
            realizationCell.textContent = data.realization || 0;
        }
        
        // Kembalikan tombol action
        const actionCell = row.querySelector('td:last-child');
        if (actionCell && isSuperAdminUser) {
            actionCell.innerHTML = `
                <button class="btn-edit-cell" onclick="editSingleRow(${index})">
                    <i class="fas fa-edit"></i> Edit
                </button>
            `;
        }
        
        showNotification('Edit dibatalkan', 'info');
        
    } catch (error) {
        console.error('Error in cancelSingleRow:', error);
        showNotification('Error membatalkan edit', 'error');
    }
}

// Fungsi untuk edit semua data (full edit mode)
function enableFullEditMode() {
    isEditMode = true;
    document.querySelector('.kpi-container').classList.add('edit-mode');
    
    editAllBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Semua';
    editAllBtn.classList.add('btn-success');
    editAllBtn.classList.remove('btn-primary');
    
    const rows = document.querySelectorAll('.kpi-table tbody tr:not(.result-row)');
    rows.forEach((row, index) => {
        if (index < kpiData.length) {
            const data = kpiData[index];
            
            const areaCell = row.querySelector('td:nth-child(2)');
            areaCell.innerHTML = `<input type="text" class="edit-input" value="${data.area}" data-field="area" data-index="${index}">`;
            
            const targetCell = row.querySelector('td:nth-child(3)');
            targetCell.innerHTML = `<input type="number" class="edit-input" value="${data.target}" min="0" data-field="target" data-index="${index}">`;
            
            const weightCell = row.querySelector('td:nth-child(4)');
            weightCell.innerHTML = `<input type="number" class="edit-input" value="${data.weight}" min="0" max="100" data-field="weight" data-index="${index}">`;
            
            const descCell = row.querySelector('td:nth-child(5)');
            descCell.innerHTML = `<input type="text" class="edit-input" value="${data.description}" data-field="description" data-index="${index}">`;
            
            const noteCell = row.querySelector('td:nth-child(6)');
            noteCell.innerHTML = `<input type="text" class="edit-input" value="${data.note}" data-field="note" data-index="${index}">`;
            
            const realizationCell = row.querySelector('.realization-cell');
            if (realizationCell) {
                realizationCell.innerHTML = `<input type="number" class="edit-input realization-input" value="${data.realization}" min="0" data-field="realization" data-index="${index}">`;
            }
            
            const actionCell = row.querySelector('td:last-child');
            if (actionCell && actionCell.innerHTML.trim() === '') {
                actionCell.innerHTML = `
                    <button class="btn-edit-cell" onclick="editSingleRow(${index})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                `;
            }
        }
    });
    
    addEditInputListeners();
    showNotification('Mode edit penuh diaktifkan. Semua data dapat diubah.', 'info');
}
// FUNGSI PERBAIKAN UNTUK MODAL EDIT OPTIONS
function showEditOptionsModal() {
    const modalHtml = `
        <div class="reset-modal" id="edit-options-modal" style="display: flex;">
            <div class="reset-modal-content">
                <div class="reset-modal-header">
                    <div class="reset-modal-icon">
                        <i class="fas fa-edit"></i>
                    </div>
                    <h3 class="reset-modal-title">Pilihan Edit</h3>
                </div>
                <div class="reset-modal-body">
                    <p class="reset-modal-text">Pilih jenis edit yang ingin dilakukan:</p>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
                        <button class="edit-option-btn" data-type="realisasi">
                            <i class="fas fa-chart-bar"></i>
                            <div>
                                <strong>Edit Realisasi Saja</strong>
                                <small>Hanya mengubah nilai realisasi</small>
                            </div>
                        </button>
                        <button class="edit-option-btn" data-type="full">
                            <i class="fas fa-cogs"></i>
                            <div>
                                <strong>Edit Semua Data</strong>
                                <small>Edit target, bobot, deskripsi, dll</small>
                            </div>
                        </button>
                    </div>
                </div>
                <div class="reset-modal-actions">
                    <button class="reset-modal-btn reset-modal-btn-cancel" id="edit-options-cancel">
                        <i class="fas fa-times"></i> Batal
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Hapus modal yang sudah ada jika ada
    const existingModal = document.getElementById('edit-options-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // TUNGGU SEBENTAR SEBELUM MENAMBAHKAN EVENT LISTENER
    setTimeout(() => {
        setupEditOptionsModalEvents();
    }, 100);
}

// FUNGSI BARU UNTUK SETUP EVENT LISTENER MODAL
function setupEditOptionsModalEvents() {
    const cancelBtn = document.getElementById('edit-options-cancel');
    const modal = document.getElementById('edit-options-modal');
    
    if (cancelBtn && modal) {
        // Event listener untuk tombol batal
        cancelBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Tombol batal diklik');
            modal.remove();
            showNotification('Edit dibatalkan', 'info');
        });
        
        // Event listener untuk tombol pilihan edit
        const optionButtons = document.querySelectorAll('.edit-option-btn');
        optionButtons.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const editType = this.dataset.type;
                console.log('Pilihan edit:', editType);
                modal.remove();
                
                if (editType === 'realisasi') {
                    enableRealisasiEditMode();
                } else if (editType === 'full') {
                    enableFullEditMode();
                }
            });
        });
        
        // Event listener untuk klik di luar modal
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
                showNotification('Edit dibatalkan', 'info');
            }
        });
        
        // Event listener untuk ESC key
        document.addEventListener('keydown', function closeModalOnEsc(e) {
            if (e.key === 'Escape') {
                modal.remove();
                showNotification('Edit dibatalkan', 'info');
                document.removeEventListener('keydown', closeModalOnEsc);
            }
        });
        
        console.log('Event listeners untuk modal edit options berhasil dipasang');
    } else {
        console.error('Element modal tidak ditemukan untuk setup events');
    }
}

// CSS TAMBAHAN UNTUK MODAL
const modalFixCSS = `

  :root {
    /* Default Light Theme (light mode) */
    --modal-bg: #ffffff;
    --modal-border: #e2e8f0;
    --text-primary: #1a1a1a;
    --text-secondary: #4a5568;
    --button-bg: #f7fafc;
    --button-bg-hover: #e2e8f0;
    --button-text: #1a1a1a;
    --card-hover-bg: #f1f5f9;
    --primary: #4f46e5;
  }

  [data-theme="dark"] {
    /* Dark Theme overrides */
    --modal-bg: #1e2a38;
    --modal-border: #374151;
    --text-primary: #ffffff;
    --text-secondary: #b0b8c1;
    --button-bg: #2d3748;
    --button-bg-hover: #4a5568;
    --button-text: #ffffff;
    --card-hover-bg: #273142;
    --primary: #4f46e5;
  }

  .reset-modal-content {
    background: var(--modal-bg);
    color: var(--text-primary);
    border-radius: 12px;
    padding: 24px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }

  .edit-option-btn {
    background: transparent;
    color: var(--text-primary);
    border: 1px solid var(--modal-border);
    border-radius: 8px;
    padding: 16px;
    width: 100%;
    display: flex;
    gap: 12px;
    transition: all 0.2s ease;
  }

  .edit-option-btn:hover {
    background: var(--card-hover-bg);
    border-color: var(--primary);
  }

  .edit-option-btn i {
    font-size: 20px;
    color: var(--primary);
    margin-top: 2px;
  }

  .edit-option-btn strong {
    font-size: 14px;
    font-weight: 600;
  }

  .edit-option-btn small {
    font-size: 12px;
    color: var(--text-secondary);
  }

  .reset-modal-btn-cancel {
    background: var(--button-bg);
    color: var(--button-text);
    border: 1px solid var(--modal-border);
    border-radius: 6px;
    padding: 10px 20px;
    transition: background 0.2s ease;
  }

  .reset-modal-btn-cancel:hover {
    background: var(--button-bg-hover);
  }
`;



// Inject CSS tambahan
const modalStyle = document.createElement('style');
modalStyle.textContent = modalFixCSS;
document.head.appendChild(modalStyle);

// ========== FUNGSI SAVE KE FIRESTORE ==========

// Fungsi untuk menyimpan data ke Firestore - VERSI DIPERBAIKI
async function saveKpiDataToFirestore() {
    try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) {
            console.error('‚ùå No user logged in');
            return false;
        }

        const db = firebase.firestore();
        
        // Tentukan user ID target
        let targetUserId = currentUser.uid;
        
        // Jika Super Admin sedang melihat user lain, simpan ke user tersebut
        if (isSuperAdminUser && currentFilter !== 'current') {
            const viewingUserId = getCurrentViewingUserId();
            if (viewingUserId && viewingUserId !== currentUser.uid) {
                targetUserId = viewingUserId;
            }
        }
        
        console.log('üíæ SAVING to Firestore for user:', targetUserId);
        console.log('üìä Data to save:', kpiData);

        // Format data untuk Firestore
        const kpiDoc = {
            kpiData: kpiData.map(item => ({
                id: item.id,
                area: item.area,
                target: item.target,
                weight: item.weight,
                description: item.description,
                note: item.note,
                realization: item.realization,
                score: item.score
            })),
            userId: targetUserId,
            userName: currentUser.displayName || currentUser.email,
            userEmail: currentUser.email,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            totalScore: calculateTotalScore(kpiData),
            lastUpdatedBy: currentUser.uid
        };

        // Simpan ke Firestore
        await db.collection('kpiData').doc(targetUserId).set(kpiDoc, { merge: true });
        
        console.log('‚úÖ SUCCESS: Data saved to Firestore for user:', targetUserId);
        
        // Juga update data di collections terpisah
        await updateModuleCollections(targetUserId);
        
        return true;
        
    } catch (error) {
        console.error('‚ùå ERROR saving to Firestore:', error);
        showNotification('Gagal menyimpan data: ' + error.message, 'error');
        return false;
    }
}

// Fungsi untuk update collections terpisah
async function updateModuleCollections(userId) {
    try {
        const db = firebase.firestore();
        
        // Update ideas collection
        const ideasData = kpiData.find(item => item.id === 3);
        if (ideasData) {
            await updateIdeasCollection(userId, ideasData.realization);
        }
        
        // Update research collection  
        const researchData = kpiData.find(item => item.id === 5);
        if (researchData) {
            await updateResearchCollection(userId, researchData.realization);
        }
        
        // Update chat collection
        const chatData = kpiData.find(item => item.id === 4);
        if (chatData) {
            await updateChatCollection(userId, chatData.realization);
        }
        
        console.log('‚úÖ Module collections updated');
        
    } catch (error) {
        console.error('Error updating module collections:', error);
    }
}

// Update Ideas Collection
async function updateIdeasCollection(userId, realization) {
    const db = firebase.firestore();
    
    // Hapus data lama
    const oldIdeas = await db.collection('ideas')
        .where('userId', '==', userId)
        .get();
    
    const deletePromises = oldIdeas.docs.map(doc => doc.ref.delete());
    await Promise.all(deletePromises);
    
    // Buat data baru sesuai realization
    for (let i = 0; i < realization; i++) {
        await db.collection('ideas').add({
            userId: userId,
            title: `Idea ${i + 1}`,
            points: 1,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
}

// Update Research Collection  
async function updateResearchCollection(userId, realization) {
    const db = firebase.firestore();
    
    const oldResearch = await db.collection('research')
        .where('userId', '==', userId)
        .get();
    
    const deletePromises = oldResearch.docs.map(doc => doc.ref.delete());
    await Promise.all(deletePromises);
    
    for (let i = 0; i < realization; i++) {
        await db.collection('research').add({
            userId: userId,
            title: `Research ${i + 1}`,
            points: 1,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
}

// Update Chat Collection
async function updateChatCollection(userId, realization) {
    const db = firebase.firestore();
    
    const oldChats = await db.collection('chats')
        .where('userId', '==', userId)
        .get();
    
    const deletePromises = oldChats.docs.map(doc => doc.ref.delete());
    await Promise.all(deletePromises);
    
    for (let i = 0; i < realization; i++) {
        await db.collection('chats').add({
            userId: userId,
            responseTime: 2.5, // Default value
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
}

// ========== FUNGSI DISABLE EDIT MODE ==========

// Fungsi untuk menonaktifkan mode edit
async function disableEditMode() {
    try {
        console.log('üîÑ Disabling edit mode...');
        
        isEditMode = false;
        document.querySelector('.kpi-container').classList.remove('edit-mode');
        
        // Update tombol
        editAllBtn.innerHTML = '<i class="fas fa-edit"></i> Edit All';
        editAllBtn.classList.remove('btn-success');
        editAllBtn.classList.add('btn-primary');
        
        // Kumpulkan dan simpan semua perubahan
        const inputs = document.querySelectorAll('.edit-input');
        let hasChanges = false;
        
        console.log('üìù Processing', inputs.length, 'input fields...');
        
        inputs.forEach(input => {
            const index = parseInt(input.dataset.index);
            const field = input.dataset.field;
            let value = input.value;
            
            if (field === 'target' || field === 'weight' || field === 'realization') {
                value = parseFloat(value) || 0;
            }
            
            // Simpan perubahan ke kpiData
            const oldValue = kpiData[index][field];
            if (oldValue != value) {
                hasChanges = true;
                console.log(`üîÑ Changing ${field} from ${oldValue} to ${value}`);
                kpiData[index][field] = value;
                
                // Hitung ulang score jika realisasi berubah
                if (field === 'realization') {
                    const data = kpiData[index];
                    const isSmallerBetter = data.note.includes("Semakin Kecil");
                    data.score = calculateScore(data.target, data.realization, isSmallerBetter, index);
                    console.log(`üìä Recalculated score: ${data.score}`);
                }
            }
        });
        
        if (hasChanges) {
            console.log('üíæ Changes detected, saving to Firestore...');
            
            // Update tampilan sementara
            updateKPI();
            
            // SIMPAN KE FIRESTORE
            const saveResult = await saveKpiDataToFirestore();
            
            if (saveResult) {
                showNotification('‚úÖ Perubahan berhasil disimpan ke database!', 'success');
                console.log('‚úÖ Save successful');
                
                // Verifikasi dengan load ulang data
                setTimeout(async () => {
                    await loadKpiDataFromFirestore();
                    updateDisplay();
                }, 500);
                
            } else {
                showNotification('‚ùå Gagal menyimpan perubahan ke database', 'error');
                console.error('‚ùå Save failed');
            }
        } else {
            console.log('‚ÑπÔ∏è No changes to save');
            showNotification('Tidak ada perubahan yang disimpan', 'info');
        }
        
    } catch (error) {
        console.error('‚ùå Error in disableEditMode:', error);
        showNotification('Error: ' + error.message, 'error');
    }
}

// ========== FUNGSI UTAMA EDIT ==========

// Fungsi utama untuk mengaktifkan mode edit
function enableEditMode() {
    if (!isSuperAdminUser) {
        showNotification('Hanya Super Admin yang dapat mengedit data', 'error');
        return;
    }
    
    // Tampilkan modal pilihan edit
    showEditOptionsModal();
}

// ========== CSS TAMBAHAN ==========
if (editAllBtn) {
    editAllBtn.addEventListener('click', (e) => { // perbaiki parameter dari 'c' ke 'e'
        if (!isSuperAdminUser) { // PERBAIKI: jsonmeAdminUser -> isSuperAdminUser
            e.preventDefault();
            e.stopPropagation();
            showNotification('Hanya Super Admin yang dapat mengedit data', 'error');
            return;
        }
        
        if (!isEditMode) {
            enableEditMode();
        } else {
            disableEditMode();
        }
    });
}

// ========== FUNGSI HELPER ==========

// Fungsi untuk mendapatkan user ID yang sedang dilihat
function getCurrentViewingUserId() {
    // Cek dari URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('userId')) {
        return urlParams.get('userId');
    }
    
    // Cek dari state aplikasi
    if (window.currentViewingUserId) {
        return window.currentViewingUserId;
    }
    
    // Fallback ke current user
    const currentUser = firebase.auth().currentUser;
    return currentUser ? currentUser.uid : null;
}

// Fungsi untuk menambahkan event listener pada input edit
function addEditInputListeners() {
    const inputs = document.querySelectorAll('.edit-input');
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            const index = parseInt(this.dataset.index);
            const field = this.dataset.field;
            let value = this.value;
            
            if (field === 'target' || field === 'weight' || field === 'realization') {
                value = parseFloat(value) || 0;
            }
            
            kpiData[index][field] = value;
        });
    });
}

// ========== INISIALISASI TOMBOL ACTION ==========

// Fungsi untuk menginisialisasi tombol action di setiap baris
// FUNGSI UNTUK INISIALISASI TOMBOL ACTION
function initializeActionButtons() {
    const rows = document.querySelectorAll('.kpi-table tbody tr:not(.result-row)');
    rows.forEach((row, index) => {
        if (index < kpiData.length) {
            const actionCell = row.querySelector('td:last-child');
            if (actionCell) {
                if (isSuperAdminUser) {
                    actionCell.innerHTML = `
                        <button class="btn-edit-cell" onclick="editSingleRow(${index})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    `;
                } else {
                    actionCell.innerHTML = `<span class="no-action">-</span>`;
                }
            }
        }
    });
}

// Panggil inisialisasi saat halaman dimuat dan saat status admin berubah
document.addEventListener('DOMContentLoaded', function() {
    initializeActionButtons();
});

// Panggil inisialisasi saat halaman dimuat
document.addEventListener('DOMContentLoaded', function() {
    initializeActionButtons();
});

// ========== FUNGSI DEBUG ==========

// Fungsi untuk debug edit functionality
window.debugEditFunction = function() {
    console.log('=== DEBUG EDIT FUNCTION ===');
    console.log('isSuperAdminUser:', isSuperAdminUser);
    console.log('isEditMode:', isEditMode);
    console.log('currentFilter:', currentFilter);
    console.log('kpiData:', kpiData);
    
    // Test Firestore connection
    const db = firebase.firestore();
    const currentUser = firebase.auth().currentUser;
    
    if (currentUser) {
        db.collection('kpiData').doc(currentUser.uid).get().then(doc => {
            if (doc.exists) {
                console.log('Current Firestore data:', doc.data());
            } else {
                console.log('No data in Firestore');
            }
        });
    }
};

console.log('‚úÖ Edit Action Script loaded successfully');



// ========== MODIFIKASI FUNGSI SAVE ==========

// Fungsi untuk menyimpan data ke Firestore - DENGAN TRACKING
async function saveKpiDataToFirestore() {
    try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) {
            console.error('‚ùå No user logged in');
            return false;
        }

        const db = firebase.firestore();
        
        // Tentukan user ID target
        let targetUserId = currentUser.uid;
        
        // Jika Super Admin sedang melihat user lain, simpan ke user tersebut
        if (isSuperAdminUser && currentFilter !== 'current') {
            const viewingUserId = getCurrentViewingUserId();
            if (viewingUserId && viewingUserId !== currentUser.uid) {
                targetUserId = viewingUserId;
            }
        }
        
        console.log('üíæ SAVING to Firestore for user:', targetUserId);
        
        // SET FLAG UNTUK MENCEGAH REAL-TIME UPDATE
        isLocalChange = true;
        lastLocalChangeTime = Date.now();

        // Format data untuk Firestore
        const kpiDoc = {
            kpiData: kpiData.map(item => ({
                id: item.id,
                area: item.area,
                target: item.target,
                weight: item.weight,
                description: item.description,
                note: item.note,
                realization: item.realization,
                score: item.score
            })),
            userId: targetUserId,
            userName: currentUser.displayName || currentUser.email,
            userEmail: currentUser.email,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            totalScore: calculateTotalScore(kpiData),
            lastUpdatedBy: currentUser.uid,
            // Tambahkan timestamp untuk tracking
            localUpdateTimestamp: Date.now()
        };

        // Simpan ke Firestore
        await db.collection('kpiData').doc(targetUserId).set(kpiDoc, { merge: true });
        
        console.log('‚úÖ SUCCESS: Data saved to Firestore for user:', targetUserId);
        
        // Reset flag setelah 5 detik (memberi waktu untuk proses selesai)
        setTimeout(() => {
            isLocalChange = false;
            console.log('üîÑ Real-time listener re-enabled');
        }, 5000);
        
        return true;
        
    } catch (error) {
        console.error('‚ùå ERROR saving to Firestore:', error);
        isLocalChange = false; // Reset flag jika error
        showNotification('Gagal menyimpan data: ' + error.message, 'error');
        return false;
    }
}

// ========== MODIFIKASI FUNGSI DISABLE EDIT MODE ==========

// Fungsi untuk menonaktifkan mode edit - DENGAN OPTIMASI
async function disableEditMode() {
    try {
        console.log('üîÑ Disabling edit mode...');
        
        isEditMode = false;
        document.querySelector('.kpi-container').classList.remove('edit-mode');
        
        // Update tombol
        editAllBtn.innerHTML = '<i class="fas fa-edit"></i> Edit All';
        editAllBtn.classList.remove('btn-success');
        editAllBtn.classList.add('btn-primary');
        
        // Kumpulkan dan simpan semua perubahan
        const inputs = document.querySelectorAll('.edit-input');
        let hasChanges = false;
        
        console.log('üìù Processing', inputs.length, 'input fields...');
        
        inputs.forEach(input => {
            const index = parseInt(input.dataset.index);
            const field = input.dataset.field;
            let value = input.value;
            
            if (field === 'target' || field === 'weight' || field === 'realization') {
                value = parseFloat(value) || 0;
            }
            
            // Simpan perubahan ke kpiData
            const oldValue = kpiData[index][field];
            if (oldValue != value) {
                hasChanges = true;
                console.log(`üîÑ Changing ${field} from ${oldValue} to ${value}`);
                kpiData[index][field] = value;
                
                // Hitung ulang score jika realisasi berubah
                if (field === 'realization') {
                    const data = kpiData[index];
                    const isSmallerBetter = data.note.includes("Semakin Kecil");
                    data.score = calculateScore(data.target, data.realization, isSmallerBetter, index);
                    console.log(`üìä Recalculated score: ${data.score}`);
                }
            }
        });
        
        if (hasChanges) {
            console.log('üíæ Changes detected, saving to Firestore...');
            
            // Update tampilan sementara TANPA memanggil updateKPI() yang memicu reload
            updateDisplayWithoutReload();
            
            // SIMPAN KE FIRESTORE dengan flag
            const saveResult = await saveKpiDataToFirestore();
            
            if (saveResult) {
                showNotification('‚úÖ Perubahan berhasil disimpan ke database!', 'success');
                console.log('‚úÖ Save successful');
                
                // TIDAK PERLU load ulang data karena sudah tersimpan dengan benar
                // Biarkan real-time listener yang menangani jika ada perubahan lain
                
            } else {
                showNotification('‚ùå Gagal menyimpan perubahan ke database', 'error');
                console.error('‚ùå Save failed');
            }
        } else {
            console.log('‚ÑπÔ∏è No changes to save');
            showNotification('Tidak ada perubahan yang disimpan', 'info');
        }
        
    } catch (error) {
        console.error('‚ùå Error in disableEditMode:', error);
        showNotification('Error: ' + error.message, 'error');
    }
}

// ========== FUNGSI UPDATE TANPA RELOAD ==========

// Fungsi untuk update display tanpa memicu reload dari Firestore
function updateDisplayWithoutReload() {
    console.log('üîÑ Updating display without reload...');
    
    const rows = document.querySelectorAll('.kpi-table tbody tr:not(.result-row)');
    rows.forEach((row, index) => {
        if (index < kpiData.length) {
            const data = kpiData[index];
            
            // Pastikan semua nilai ada
            const safeTarget = data.target || 0;
            const safeWeight = data.weight || 0;
            const safeRealization = data.realization || 0;
            const safeScore = data.score || 0;
            
            // Update hanya sel yang diperlukan, tanpa mengubah input yang sedang diedit
            if (!isEditMode) {
                row.querySelector('td:nth-child(2)').textContent = data.area || '';
                row.querySelector('td:nth-child(3)').textContent = safeTarget;
                row.querySelector('td:nth-child(4)').textContent = safeWeight.toFixed(2) + '%';
                row.querySelector('td:nth-child(5)').textContent = data.description || '';
                row.querySelector('td:nth-child(6)').textContent = data.note || '';
            }
            
            const realizationCell = row.querySelector('.realization-cell');
            if (realizationCell && !realizationCell.querySelector('input')) {
                realizationCell.textContent = safeRealization;
            }
            
            const scoreCell = row.querySelector('td:nth-child(9)');
            if (scoreCell) {
                scoreCell.textContent = safeScore.toFixed(2) + '%';
                scoreCell.className = '';
                
                if (safeScore >= 100) {
                    scoreCell.classList.add('target-achieved');
                } else if (safeScore >= 70) {
                    scoreCell.classList.add('target-partial');
                } else {
                    scoreCell.classList.add('target-missed');
                }
            }
        }
    });
    
    // Update total tanpa memicu reload
    updateKPITotalsOnly();
    
    console.log('‚úÖ Display updated without reload');
}

// Fungsi untuk update hanya total saja
function updateKPITotalsOnly() {
    let totalScore = 0;
    let totalRealization = 0;
    
    kpiData.forEach((item, index) => {
        totalScore += (item.score * item.weight) / 100;
        totalRealization += item.realization;
    });
    
    // Update total
    updateElementText('total-score', totalScore.toFixed(2) + '%');
    updateElementText('total-realization', totalRealization);
    updateElementText('total-kpi', totalScore.toFixed(2) + '%');
    updateProgressBar('.summary-card:first-child .progress-fill', Math.min(totalScore, 100));
    
    // Update class untuk total score
    const totalScoreCell = document.getElementById('total-score');
    if (totalScoreCell) {
        totalScoreCell.className = '';
        if (totalScore >= 70) {
            totalScoreCell.classList.add('target-achieved');
        } else if (totalScore >= 50) {
            totalScoreCell.classList.add('target-partial');
        } else {
            totalScoreCell.classList.add('target-missed');
        }
    }
}

// ========== FUNGSI UNTUK SINGLE ROW EDIT ==========

// Modifikasi fungsi saveSingleRow untuk menggunakan sistem yang sama
async function saveSingleRow(index) {
    try {
        const row = document.querySelector(`.kpi-table tbody tr:nth-child(${index + 1})`);
        const inputs = row.querySelectorAll('.edit-input');
        
        inputs.forEach(input => {
            const field = input.dataset.field;
            let value = input.value;
            
            if (field === 'target' || field === 'weight' || field === 'realization') {
                value = parseFloat(value) || 0;
            }
            
            kpiData[index][field] = value;
        });
        
        // Hitung ulang skor untuk baris ini
        const data = kpiData[index];
        const isSmallerBetter = data.note.includes("Semakin Kecil");
        data.score = calculateScore(data.target, data.realization, isSmallerBetter, index);
        
        // Update tampilan sementara
        updateDisplayWithoutReload();
        
        // Simpan ke Firestore DENGAN FLAG
        const saveResult = await saveKpiDataToFirestore();
        
        if (saveResult) {
            showNotification(`Data ${data.area} berhasil diperbarui dan disimpan ke database!`, 'success');
            
            // Kembalikan ke mode normal
            const actionCell = row.querySelector('td:last-child');
            if (actionCell) {
                actionCell.innerHTML = `
                    <button class="btn-edit-cell" onclick="editSingleRow(${index})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                `;
            }
        } else {
            showNotification('Gagal menyimpan perubahan ke database', 'error');
        }
        
    } catch (error) {
        console.error('Error saving single row:', error);
        showNotification('Error: ' + error.message, 'error');
    }
}

// ========== ALTERNATIF: DISABLE REAL-TIME LISTENER SAAT EDIT ==========

// Opsi: Nonaktifkan real-time listener sementara saat edit
function disableRealTimeListenersTemporarily() {
    unsubscribeFunctions.forEach(unsubscribe => unsubscribe());
    console.log('üîï Real-time listeners disabled temporarily');
}

function enableRealTimeListeners() {
    setupRealTimeListeners();
    console.log('üîî Real-time listeners re-enabled');
}

// Modifikasi enableEditMode untuk opsi ini
function enableEditModeWithListenerControl() {
    if (!isSuperAdminUser) {
        showNotification('Hanya Super Admin yang dapat mengedit data', 'error');
        return;
    }
    
    // Nonaktifkan real-time listener sementara
    disableRealTimeListenersTemporarily();
    
    // Tampilkan modal pilihan edit
    showEditOptionsModal();
    
    // Aktifkan kembali listener setelah 30 detik (fallback)
    setTimeout(() => {
        if (isEditMode) {
            enableRealTimeListeners();
            console.log('üîÑ Real-time listeners re-enabled (fallback)');
        }
    }, 30000);
}

// Modifikasi disableEditMode untuk opsi ini
async function disableEditModeWithListenerControl() {
    try {
        // ... kode disableEditMode yang sama ...
        
        // Aktifkan kembali real-time listener setelah save
        enableRealTimeListeners();
        
    } catch (error) {
        console.error('‚ùå Error in disableEditMode:', error);
        showNotification('Error: ' + error.message, 'error');
    }
}

// ========== FUNGSI DEBUG UNTUK MEMANTAU KONFLIK ==========

window.monitorEditConflict = function() {
    console.log('=== EDIT CONFLICT MONITOR ===');
    console.log('isLocalChange:', isLocalChange);
    console.log('lastLocalChangeTime:', new Date(lastLocalChangeTime).toLocaleTimeString());
    console.log('Time since last change:', Date.now() - lastLocalChangeTime, 'ms');
    console.log('isEditMode:', isEditMode);
    console.log('isSuperAdminUser:', isSuperAdminUser);
    
    // Check Firestore data
    const db = firebase.firestore();
    const currentUser = firebase.auth().currentUser;
    
    if (currentUser) {
        db.collection('kpiData').doc(currentUser.uid).get().then(doc => {
            if (doc.exists) {
                const data = doc.data();
                console.log('Firestore data timestamp:', data.updatedAt?.toDate());
                console.log('Local update timestamp:', data.localUpdateTimestamp);
                console.log('Current kpiData:', kpiData);
            }
        });
    }
};

// ========== INISIALISASI ==========

// Ganti fungsi setupRealTimeListeners yang lama dengan yang baru
// Pastikan ini dipanggil setelah DOMContentLoaded

console.log('‚úÖ Enhanced Edit System loaded - Conflict prevention enabled');
// SOLUSI RADIKAL: Nonaktifkan real-time listener selama edit
function enableEditModeRadical() {
    if (!isSuperAdminUser) {
        showNotification('Hanya Super Admin yang dapat mengedit data', 'error');
        return;
    }
    
    // HENTIKAN semua real-time listener
    unsubscribeFunctions.forEach(unsubscribe => unsubscribe());
    unsubscribeFunctions = [];
    
    console.log('üîï All real-time listeners stopped for editing');
    
    // Tampilkan modal pilihan edit
    showEditOptionsModal();
}

async function disableEditModeRadical() {
    try {
        // ... kode disableEditMode biasa ...
        
        // SETELAH SIMPAN BERHASIL, aktifkan kembali listeners
        setTimeout(() => {
            setupRealTimeListeners();
            console.log('üîî Real-time listeners restarted');
        }, 2000);
        
    } catch (error) {
        console.error('Error:', error);
    }
}
const kpiTranslations = {
    id: {
        // Header
        "dashboardTitle": "Dashboard KPI CSS",
        "searchPlaceholder": "Cari data KPI...",
        
        // Summary Cards
        "kpiThisMonth": "KPI Bulan Ini",
        "fromMinTarget": "Dari target minimal 70%",
        "ideasSuggestions": "Ideas & Suggestions",
        "research": "Research",
        "chatResponse": "Chat Response",
        "reachingMinTarget": "Mencapai target minimal",
        
        // KPI Table
        "kpiPerformanceData": "Data KPI Performance",
        "editAll": "Edit All",
        "reset": "Reset",
        "saveAllChanges": "Simpan Semua Perubahan",
        "cancelAll": "Batalkan Semua",
        
        // Table Headers
        "no": "No.",
        "mainPerformanceArea": "Area Kinerja Utama",
        "target": "Target",
        "weight": "Bobot",
        "kpiDescription": "Deskripsi KPI",
        "note": "Keterangan",
        "finalScore": "Skor Akhir",
        "month": "Bulan",
        "realization": "Realisasi",
        "action": "Action",
        
        // Performance Areas
        "b2bB2c": "B2B & B2C (Count.)",
        "problemSolving": "Problem Solving (Count.)",
        "idea": "Idea (Count.)",
        "responseChat": "Response Chat (Count.)",
        "research": "Research (Count.)",
        "attitude": "Attitude (Skor.)",
        "discipline": "Disiplin (Day.)",
        
        // Descriptions
        "b2bDescription": "Pembukaan WLB / Agent baru",
        "problemSolvingDescription": "Kemampuan dalam menyelesaikan setiap masalah",
        "ideaDescription": "Aktif memberikan ide, Saran & Masukan",
        "chatDescription": "Kecepatan dan ketepatan dalam Merespon Chat (Max 3 Menit)",
        "researchDescription": "Research keunggulan Platform / Agent Lain",
        "attitudeDescription": "Attitude dalam mengikuti SOP / Arahan",
        "disciplineDescription": "Jumlah kedisiplinan setiap bulan",
        
        // Notes
        "biggerBetter": "Semakin Besar Semakin Bagus",
        "smallerBetter": "Semakin Kecil Semakin Bagus",
        
        // Footer
        "trainingNote": "Catatan: Untuk Lepas training / masa probation Minimal KPI yang harus di Raih = 70%.",
        
        // Submenu Titles
        "ideasSubmenu": "Ideas & Suggestions",
        "researchSubmenu": "Research",
        "chatSubmenu": "Chat Response",
        
        // Criteria
        "ideasCriteria": "Ideas & Suggestions",
        "ideasCriteriaDesc": "Jumlah ide yang diberikan per bulan",
        "researchCriteria": "Research",
        "researchCriteriaDesc": "Jumlah research yang dilakukan per bulan",
        "chatCriteria": "Chat Response",
        "chatCriteriaDesc": "Rata-rata waktu respons chat dalam menit",
        
        // User Filter
        "myData": "Data Saya",
        "allUsers": "Semua User",
        "allUsersData": "Data KPI Semua User",
        
        // Table Columns for All Users
        "user": "User",
        "email": "Email",
        "totalKPI": "Total KPI",
        "ideas": "Ideas",
        "research": "Research",
        "chatResponse": "Chat Response",
        "problemSolving": "Problem Solving",
        "lastUpdated": "Terakhir Update",
        "viewDetails": "Lihat Detail",
        
        // Notifications
        "editModeEnabled": "Mode edit diaktifkan. Anda dapat mengubah target dan bobot KPI.",
        "changesSaved": "Perubahan KPI berhasil disimpan.",
        "dataReset": "Data KPI berhasil direset ke nilai default.",
        "loadingUserData": "Memuat data user...",
        "showingUsersData": "Menampilkan data {count} user",
        "adminOnly": "Hanya Super Admin yang dapat mengedit data",
        "resetOwnDataOnly": "Hanya bisa mereset data sendiri",
        "errorLoadingKPI": "Error memuat data KPI",
        "saveSuccess": "Perubahan berhasil disimpan ke database!",
        "saveFailed": "Gagal menyimpan perubahan ke database",
        "noChanges": "Tidak ada perubahan yang disimpan",
        "editCancelled": "Edit dibatalkan",
        
        // Edit Mode
        "editOptions": "Pilihan Edit",
        "editRealisasiOnly": "Edit Realisasi Saja",
        "editRealisasiOnlyDesc": "Hanya mengubah nilai realisasi",
        "editAllData": "Edit Semua Data",
        "editAllDataDesc": "Edit target, bobot, deskripsi, dll",
        "editRealisasiEnabled": "Mode edit realisasi diaktifkan. Hanya Super Admin yang dapat mengubah data.",
        "fullEditEnabled": "Mode edit penuh diaktifkan. Semua data dapat diubah.",
        
        // Reset Confirmation
        "resetConfirmation": "Konfirmasi Reset Data",
        "resetConfirmText": "Apakah Anda yakin ingin mereset semua data KPI ke nilai default?",
        "resetIrreversible": "Tindakan ini tidak dapat dibatalkan!",
        "confirmReset": "Ya, Reset Data",
        "resetCancelled": "Reset data dibatalkan",
        
        // Status
        "targetAchieved": "Target Tercapai",
        "targetPartial": "Target Sebagian",
        "targetMissed": "Target Terlewat"
    },
    
    en: {
        // Header
        "dashboardTitle": "CSS KPI Dashboard",
        "searchPlaceholder": "Search KPI data...",
        
        // Summary Cards
        "kpiThisMonth": "KPI This Month",
        "fromMinTarget": "From minimum target 70%",
        "ideasSuggestions": "Ideas & Suggestions",
        "research": "Research",
        "chatResponse": "Chat Response",
        "reachingMinTarget": "Reaching minimum target",
        
        // KPI Table
        "kpiPerformanceData": "KPI Performance Data",
        "editAll": "Edit All",
        "reset": "Reset",
        "saveAllChanges": "Save All Changes",
        "cancelAll": "Cancel All",
        
        // Table Headers
        "no": "No.",
        "mainPerformanceArea": "Main Performance Area",
        "target": "Target",
        "weight": "Weight",
        "kpiDescription": "KPI Description",
        "note": "Note",
        "finalScore": "Final Score",
        "month": "Month",
        "realization": "Realization",
        "action": "Action",
        
        // Performance Areas
        "b2bB2c": "B2B & B2C (Count.)",
        "problemSolving": "Problem Solving (Count.)",
        "idea": "Idea (Count.)",
        "responseChat": "Response Chat (Count.)",
        "research": "Research (Count.)",
        "attitude": "Attitude (Score.)",
        "discipline": "Discipline (Day.)",
        
        // Descriptions
        "b2bDescription": "Opening WLB / New Agent",
        "problemSolvingDescription": "Ability to solve every problem",
        "ideaDescription": "Actively providing ideas, suggestions & input",
        "chatDescription": "Speed and accuracy in Responding to Chat (Max 3 Minutes)",
        "researchDescription": "Research on Platform / Other Agent advantages",
        "attitudeDescription": "Attitude in following SOP / Directions",
        "disciplineDescription": "Number of discipline per month",
        
        // Notes
        "biggerBetter": "Bigger is Better",
        "smallerBetter": "Smaller is Better",
        
        // Footer
        "trainingNote": "Note: To pass training / probation period Minimum KPI to Achieve = 70%.",
        
        // Submenu Titles
        "ideasSubmenu": "Ideas & Suggestions",
        "researchSubmenu": "Research",
        "chatSubmenu": "Chat Response",
        
        // Criteria
        "ideasCriteria": "Ideas & Suggestions",
        "ideasCriteriaDesc": "Number of ideas given per month",
        "researchCriteria": "Research",
        "researchCriteriaDesc": "Number of research conducted per month",
        "chatCriteria": "Chat Response",
        "chatCriteriaDesc": "Average chat response time in minutes",
        
        // User Filter
        "myData": "My Data",
        "allUsers": "All Users",
        "allUsersData": "All Users KPI Data",
        
        // Table Columns for All Users
        "user": "User",
        "email": "Email",
        "totalKPI": "Total KPI",
        "ideas": "Ideas",
        "research": "Research",
        "chatResponse": "Chat Response",
        "problemSolving": "Problem Solving",
        "lastUpdated": "Last Updated",
        "viewDetails": "View Details",
        
        // Notifications
        "editModeEnabled": "Edit mode enabled. You can change KPI targets and weights.",
        "changesSaved": "KPI changes saved successfully.",
        "dataReset": "KPI data reset to default values successfully.",
        "loadingUserData": "Loading user data...",
        "showingUsersData": "Showing data for {count} users",
        "adminOnly": "Only Super Admin can edit data",
        "resetOwnDataOnly": "Can only reset own data",
        "errorLoadingKPI": "Error loading KPI data",
        "saveSuccess": "Changes saved to database successfully!",
        "saveFailed": "Failed to save changes to database",
        "noChanges": "No changes saved",
        "editCancelled": "Edit cancelled",
        
        // Edit Mode
        "editOptions": "Edit Options",
        "editRealisasiOnly": "Edit Realization Only",
        "editRealisasiOnlyDesc": "Only change realization values",
        "editAllData": "Edit All Data",
        "editAllDataDesc": "Edit target, weight, description, etc",
        "editRealisasiEnabled": "Realization edit mode enabled. Only Super Admin can change data.",
        "fullEditEnabled": "Full edit mode enabled. All data can be changed.",
        
        // Reset Confirmation
        "resetConfirmation": "Reset Data Confirmation",
        "resetConfirmText": "Are you sure you want to reset all KPI data to default values?",
        "resetIrreversible": "This action cannot be undone!",
        "confirmReset": "Yes, Reset Data",
        "resetCancelled": "Reset cancelled",
        
        // Status
        "targetAchieved": "Target Achieved",
        "targetPartial": "Target Partial",
        "targetMissed": "Target Missed"
    },
    
    ja: {
        // Header
        "dashboardTitle": "CSS KPI „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ",
        "searchPlaceholder": "KPI„Éá„Éº„Çø„ÇíÊ§úÁ¥¢...",
        
        // Summary Cards
        "kpiThisMonth": "‰ªäÊúà„ÅÆKPI",
        "fromMinTarget": "ÊúÄ‰ΩéÁõÆÊ®ô70%„Åã„Çâ",
        "ideasSuggestions": "„Ç¢„Ç§„Éá„Ç¢„Å®ÊèêÊ°à",
        "research": "„É™„Çµ„Éº„ÉÅ",
        "chatResponse": "„ÉÅ„É£„ÉÉ„ÉàÂøúÁ≠î",
        "reachingMinTarget": "ÊúÄ‰ΩéÁõÆÊ®ôÈÅîÊàê",
        
        // KPI Table
        "kpiPerformanceData": "KPI„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Éá„Éº„Çø",
        "editAll": "„Åô„Åπ„Å¶Á∑®ÈõÜ",
        "reset": "„É™„Çª„ÉÉ„Éà",
        "saveAllChanges": "„Åô„Åπ„Å¶„ÅÆÂ§âÊõ¥„Çí‰øùÂ≠ò",
        "cancelAll": "„Åô„Åπ„Å¶„Ç≠„É£„É≥„Çª„É´",
        
        // Table Headers
        "no": "Áï™Âè∑",
        "mainPerformanceArea": "‰∏ªË¶Å„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Ç®„É™„Ç¢",
        "target": "ÁõÆÊ®ô",
        "weight": "Èáç„Åø",
        "kpiDescription": "KPIË™¨Êòé",
        "note": "ÂÇôËÄÉ",
        "finalScore": "ÊúÄÁµÇ„Çπ„Ç≥„Ç¢",
        "month": "Êúà",
        "realization": "ÂÆüÁ∏æ",
        "action": "Êìç‰Ωú",
        
        // Performance Areas
        "b2bB2c": "B2B & B2C (ÂõûÊï∞)",
        "problemSolving": "ÂïèÈ°åËß£Ê±∫ (ÂõûÊï∞)",
        "idea": "„Ç¢„Ç§„Éá„Ç¢ (ÂõûÊï∞)",
        "responseChat": "„ÉÅ„É£„ÉÉ„ÉàÂøúÁ≠î (ÂõûÊï∞)",
        "research": "„É™„Çµ„Éº„ÉÅ (ÂõûÊï∞)",
        "attitude": "ÊÖãÂ∫¶ („Çπ„Ç≥„Ç¢)",
        "discipline": "Ë¶èÂæã (Êó•Êï∞)",
        
        // Descriptions
        "b2bDescription": "WLB / Êñ∞Ë¶è„Ç®„Éº„Ç∏„Çß„É≥„ÉàÈñãË®≠",
        "problemSolvingDescription": "ÂêÑÂïèÈ°å„ÇíËß£Ê±∫„Åô„ÇãËÉΩÂäõ",
        "ideaDescription": "„Ç¢„Ç§„Éá„Ç¢„ÄÅÊèêÊ°à„ÄÅÊÑèË¶ã„ÅÆÁ©çÊ•µÁöÑÊèê‰æõ",
        "chatDescription": "„ÉÅ„É£„ÉÉ„ÉàÂøúÁ≠î„ÅÆÈÄüÂ∫¶„Å®Ê≠£Á¢∫„ÅïÔºàÊúÄÂ§ß3ÂàÜÔºâ",
        "researchDescription": "„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†/‰ªñ„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÅÆÂÑ™‰ΩçÊÄßË™øÊüª",
        "attitudeDescription": "SOP/ÊåáÁ§∫„Å∏„ÅÆÂæìÈ†Ü„Åï",
        "disciplineDescription": "ÊúàÈñì„ÅÆË¶èÂæãÊï∞",
        
        // Notes
        "biggerBetter": "Â§ß„Åç„ÅÑ„Åª„Å©ËâØ„ÅÑ",
        "smallerBetter": "Â∞è„Åï„ÅÑ„Åª„Å©ËâØ„ÅÑ",
        
        // Footer
        "trainingNote": "Ê≥®Ë®òÔºö„Éà„É¨„Éº„Éã„É≥„Ç∞/Ë©¶Áî®ÊúüÈñì„ÇíÁµÇ‰∫Ü„Åô„Çã„Å´„ÅØ„ÄÅÈÅîÊàê„Åô„Åπ„ÅçÊúÄ‰ΩéKPI = 70%„ÄÇ",
        
        // Submenu Titles
        "ideasSubmenu": "„Ç¢„Ç§„Éá„Ç¢„Å®ÊèêÊ°à",
        "researchSubmenu": "„É™„Çµ„Éº„ÉÅ",
        "chatSubmenu": "„ÉÅ„É£„ÉÉ„ÉàÂøúÁ≠î",
        
        // Criteria
        "ideasCriteria": "„Ç¢„Ç§„Éá„Ç¢„Å®ÊèêÊ°à",
        "ideasCriteriaDesc": "ÊúàÈñì„ÅÆ„Ç¢„Ç§„Éá„Ç¢Êèê‰æõÊï∞",
        "researchCriteria": "„É™„Çµ„Éº„ÉÅ",
        "researchCriteriaDesc": "ÊúàÈñì„ÅÆ„É™„Çµ„Éº„ÉÅÂÆüÊñΩÊï∞",
        "chatCriteria": "„ÉÅ„É£„ÉÉ„ÉàÂøúÁ≠î",
        "chatCriteriaDesc": "Âπ≥Âùá„ÉÅ„É£„ÉÉ„ÉàÂøúÁ≠îÊôÇÈñìÔºàÂàÜÔºâ",
        
        // User Filter
        "myData": "Ëá™ÂàÜ„ÅÆ„Éá„Éº„Çø",
        "allUsers": "ÂÖ®„É¶„Éº„Ç∂„Éº",
        "allUsersData": "ÂÖ®„É¶„Éº„Ç∂„ÉºKPI„Éá„Éº„Çø",
        
        // Table Columns for All Users
        "user": "„É¶„Éº„Ç∂„Éº",
        "email": "„É°„Éº„É´",
        "totalKPI": "ÂêàË®àKPI",
        "ideas": "„Ç¢„Ç§„Éá„Ç¢",
        "research": "„É™„Çµ„Éº„ÉÅ",
        "chatResponse": "„ÉÅ„É£„ÉÉ„ÉàÂøúÁ≠î",
        "problemSolving": "ÂïèÈ°åËß£Ê±∫",
        "lastUpdated": "ÊúÄÁµÇÊõ¥Êñ∞",
        "viewDetails": "Ë©≥Á¥∞Ë°®Á§∫",
        
        // Notifications
        "editModeEnabled": "Á∑®ÈõÜ„É¢„Éº„Éâ„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇKPI„ÅÆÁõÆÊ®ô„Å®Èáç„Åø„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ",
        "changesSaved": "KPI„ÅÆÂ§âÊõ¥„ÅåÊ≠£Â∏∏„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü„ÄÇ",
        "dataReset": "KPI„Éá„Éº„Çø„Åå„Éá„Éï„Ç©„É´„ÉàÂÄ§„Å´„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åó„Åü„ÄÇ",
        "loadingUserData": "„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...",
        "showingUsersData": "{count}‰∫∫„ÅÆ„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„ÇíË°®Á§∫‰∏≠",
        "adminOnly": "„Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖ„ÅÆ„Åø„Åå„Éá„Éº„Çø„ÇíÁ∑®ÈõÜ„Åß„Åç„Åæ„Åô",
        "resetOwnDataOnly": "Ëá™ÂàÜ„ÅÆ„Éá„Éº„Çø„ÅÆ„Åø„É™„Çª„ÉÉ„ÉàÂèØËÉΩ",
        "errorLoadingKPI": "KPI„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº",
        "saveSuccess": "„Éá„Éº„Çø„Éô„Éº„Çπ„Å∏„ÅÆ‰øùÂ≠ò„ÅåÊàêÂäü„Åó„Åæ„Åó„ÅüÔºÅ",
        "saveFailed": "„Éá„Éº„Çø„Éô„Éº„Çπ„Å∏„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",
        "noChanges": "Â§âÊõ¥„ÅØ‰øùÂ≠ò„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü",
        "editCancelled": "Á∑®ÈõÜ„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü",
        
        // Edit Mode
        "editOptions": "Á∑®ÈõÜ„Ç™„Éó„Ç∑„Éß„É≥",
        "editRealisasiOnly": "ÂÆüÁ∏æ„ÅÆ„ÅøÁ∑®ÈõÜ",
        "editRealisasiOnlyDesc": "ÂÆüÁ∏æÂÄ§„ÅÆ„ÅøÂ§âÊõ¥",
        "editAllData": "ÂÖ®„Éá„Éº„ÇøÁ∑®ÈõÜ",
        "editAllDataDesc": "ÁõÆÊ®ô„ÄÅÈáç„Åø„ÄÅË™¨Êòé„Å™„Å©„ÇíÁ∑®ÈõÜ",
        "editRealisasiEnabled": "ÂÆüÁ∏æÁ∑®ÈõÜ„É¢„Éº„Éâ„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇ„Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖ„ÅÆ„Åø„Åå„Éá„Éº„Çø„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ",
        "fullEditEnabled": "ÂÆåÂÖ®Á∑®ÈõÜ„É¢„Éº„Éâ„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇ„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ",
        
        // Reset Confirmation
        "resetConfirmation": "„Éá„Éº„Çø„É™„Çª„ÉÉ„ÉàÁ¢∫Ë™ç",
        "resetConfirmText": "„Åô„Åπ„Å¶„ÅÆKPI„Éá„Éº„Çø„Çí„Éá„Éï„Ç©„É´„ÉàÂÄ§„Å´„É™„Çª„ÉÉ„Éà„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü",
        "resetIrreversible": "„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„ÇìÔºÅ",
        "confirmReset": "„ÅØ„ÅÑ„ÄÅ„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô",
        "resetCancelled": "„É™„Çª„ÉÉ„Éà„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü",
        
        // Status
        "targetAchieved": "ÁõÆÊ®ôÈÅîÊàê",
        "targetPartial": "‰∏ÄÈÉ®ÈÅîÊàê",
        "targetMissed": "ÁõÆÊ®ôÊú™ÈÅî"
    },
    
    zh: {
        // Header
        "dashboardTitle": "CSS KPI ‰ª™Ë°®Êùø",
        "searchPlaceholder": "ÊêúÁ¥¢KPIÊï∞ÊçÆ...",
        
        // Summary Cards
        "kpiThisMonth": "Êú¨ÊúàKPI",
        "fromMinTarget": "‰ªéÊúÄ‰ΩéÁõÆÊ†á70%",
        "ideasSuggestions": "ÊÉ≥Ê≥ï‰∏éÂª∫ËÆÆ",
        "research": "Á†îÁ©∂",
        "chatResponse": "ËÅäÂ§©ÂõûÂ§ç",
        "reachingMinTarget": "ËææÂà∞ÊúÄ‰ΩéÁõÆÊ†á",
        
        // KPI Table
        "kpiPerformanceData": "KPIÁª©ÊïàÊï∞ÊçÆ",
        "editAll": "ÂÖ®ÈÉ®ÁºñËæë",
        "reset": "ÈáçÁΩÆ",
        "saveAllChanges": "‰øùÂ≠òÊâÄÊúâÊõ¥Êîπ",
        "cancelAll": "ÂÖ®ÈÉ®ÂèñÊ∂à",
        
        // Table Headers
        "no": "ÁºñÂè∑",
        "mainPerformanceArea": "‰∏ªË¶ÅÁª©ÊïàÈ¢ÜÂüü",
        "target": "ÁõÆÊ†á",
        "weight": "ÊùÉÈáç",
        "kpiDescription": "KPIÊèèËø∞",
        "note": "Â§áÊ≥®",
        "finalScore": "ÊúÄÁªàÂæóÂàÜ",
        "month": "Êúà‰ªΩ",
        "realization": "ÂÆûÈôÖÂÆåÊàê",
        "action": "Êìç‰Ωú",
        
        // Performance Areas
        "b2bB2c": "B2B & B2C (Ê¨°Êï∞)",
        "problemSolving": "ÈóÆÈ¢òËß£ÂÜ≥ (Ê¨°Êï∞)",
        "idea": "ÊÉ≥Ê≥ï (Ê¨°Êï∞)",
        "responseChat": "ËÅäÂ§©ÂõûÂ§ç (Ê¨°Êï∞)",
        "research": "Á†îÁ©∂ (Ê¨°Êï∞)",
        "attitude": "ÊÄÅÂ∫¶ (ÂàÜÊï∞)",
        "discipline": "Á∫™Âæã (Â§©Êï∞)",
        
        // Descriptions
        "b2bDescription": "ÂºÄËÆæWLB / Êñ∞‰ª£ÁêÜ",
        "problemSolvingDescription": "Ëß£ÂÜ≥ÊØè‰∏™ÈóÆÈ¢òÁöÑËÉΩÂäõ",
        "ideaDescription": "ÁßØÊûÅÊèê‰æõÊÉ≥Ê≥ï„ÄÅÂª∫ËÆÆÂíåÊÑèËßÅ",
        "chatDescription": "ÂõûÂ§çËÅäÂ§©ÁöÑÈÄüÂ∫¶ÂíåÂáÜÁ°ÆÊÄßÔºàÊúÄÂ§ö3ÂàÜÈíüÔºâ",
        "researchDescription": "Á†îÁ©∂Âπ≥Âè∞/ÂÖ∂‰ªñ‰ª£ÁêÜÁöÑ‰ºòÂäø",
        "attitudeDescription": "ÈÅµÂæ™SOP/ÊåáÂØºÁöÑÊÄÅÂ∫¶",
        "disciplineDescription": "ÊØèÊúàÁöÑÁ∫™ÂæãÊï∞Èáè",
        
        // Notes
        "biggerBetter": "Ë∂äÂ§ßË∂äÂ•Ω",
        "smallerBetter": "Ë∂äÂ∞èË∂äÂ•Ω",
        
        // Footer
        "trainingNote": "Ê≥®ÊÑèÔºöË¶ÅÈÄöËøáÂüπËÆ≠/ËØïÁî®ÊúüÔºåÂøÖÈ°ªËææÂà∞ÁöÑÊúÄ‰ΩéKPI = 70%„ÄÇ",
        
        // Submenu Titles
        "ideasSubmenu": "ÊÉ≥Ê≥ï‰∏éÂª∫ËÆÆ",
        "researchSubmenu": "Á†îÁ©∂",
        "chatSubmenu": "ËÅäÂ§©ÂõûÂ§ç",
        
        // Criteria
        "ideasCriteria": "ÊÉ≥Ê≥ï‰∏éÂª∫ËÆÆ",
        "ideasCriteriaDesc": "ÊØèÊúàÊèê‰æõÁöÑÊÉ≥Ê≥ïÊï∞Èáè",
        "researchCriteria": "Á†îÁ©∂",
        "researchCriteriaDesc": "ÊØèÊúàËøõË°åÁöÑÁ†îÁ©∂Êï∞Èáè",
        "chatCriteria": "ËÅäÂ§©ÂõûÂ§ç",
        "chatCriteriaDesc": "Âπ≥ÂùáËÅäÂ§©ÂõûÂ§çÊó∂Èó¥ÔºàÂàÜÈíüÔºâ",
        
        // User Filter
        "myData": "ÊàëÁöÑÊï∞ÊçÆ",
        "allUsers": "ÊâÄÊúâÁî®Êà∑",
        "allUsersData": "ÊâÄÊúâÁî®Êà∑KPIÊï∞ÊçÆ",
        
        // Table Columns for All Users
        "user": "Áî®Êà∑",
        "email": "ÈÇÆÁÆ±",
        "totalKPI": "ÊÄªKPI",
        "ideas": "ÊÉ≥Ê≥ï",
        "research": "Á†îÁ©∂",
        "chatResponse": "ËÅäÂ§©ÂõûÂ§ç",
        "problemSolving": "ÈóÆÈ¢òËß£ÂÜ≥",
        "lastUpdated": "ÊúÄÂêéÊõ¥Êñ∞",
        "viewDetails": "Êü•ÁúãËØ¶ÊÉÖ",
        
        // Notifications
        "editModeEnabled": "ÁºñËæëÊ®°ÂºèÂ∑≤ÂêØÁî®„ÄÇÊÇ®ÂèØ‰ª•Êõ¥ÊîπKPIÁõÆÊ†áÂíåÊùÉÈáç„ÄÇ",
        "changesSaved": "KPIÊõ¥ÊîπÂ∑≤ÊàêÂäü‰øùÂ≠ò„ÄÇ",
        "dataReset": "KPIÊï∞ÊçÆÂ∑≤ÊàêÂäüÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂÄº„ÄÇ",
        "loadingUserData": "Ê≠£Âú®Âä†ËΩΩÁî®Êà∑Êï∞ÊçÆ...",
        "showingUsersData": "ÊòæÁ§∫{count}‰∏™Áî®Êà∑ÁöÑÊï∞ÊçÆ",
        "adminOnly": "Âè™ÊúâË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÂèØ‰ª•ÁºñËæëÊï∞ÊçÆ",
        "resetOwnDataOnly": "Âè™ËÉΩÈáçÁΩÆËá™Â∑±ÁöÑÊï∞ÊçÆ",
        "errorLoadingKPI": "Âä†ËΩΩKPIÊï∞ÊçÆÊó∂Âá∫Èîô",
        "saveSuccess": "ÊàêÂäü‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºÅ",
        "saveFailed": "‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÂ§±Ë¥•",
        "noChanges": "Ê≤°Êúâ‰øùÂ≠ò‰ªª‰ΩïÊõ¥Êîπ",
        "editCancelled": "ÁºñËæëÂ∑≤ÂèñÊ∂à",
        
        // Edit Mode
        "editOptions": "ÁºñËæëÈÄâÈ°π",
        "editRealisasiOnly": "‰ªÖÁºñËæëÂÆûÈôÖÂÆåÊàê",
        "editRealisasiOnlyDesc": "‰ªÖÊõ¥ÊîπÂÆûÈôÖÂÆåÊàêÂÄº",
        "editAllData": "ÁºñËæëÊâÄÊúâÊï∞ÊçÆ",
        "editAllDataDesc": "ÁºñËæëÁõÆÊ†á„ÄÅÊùÉÈáç„ÄÅÊèèËø∞Á≠â",
        "editRealisasiEnabled": "ÂÆûÈôÖÂÆåÊàêÁºñËæëÊ®°ÂºèÂ∑≤ÂêØÁî®„ÄÇÂè™ÊúâË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÂèØ‰ª•Êõ¥ÊîπÊï∞ÊçÆ„ÄÇ",
        "fullEditEnabled": "ÂÆåÂÖ®ÁºñËæëÊ®°ÂºèÂ∑≤ÂêØÁî®„ÄÇÊâÄÊúâÊï∞ÊçÆÈÉΩÂèØ‰ª•Êõ¥Êîπ„ÄÇ",
        
        // Reset Confirmation
        "resetConfirmation": "ÈáçÁΩÆÊï∞ÊçÆÁ°ÆËÆ§",
        "resetConfirmText": "ÊÇ®Á°ÆÂÆöË¶ÅÂ∞ÜÊâÄÊúâKPIÊï∞ÊçÆÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂÄºÂêóÔºü",
        "resetIrreversible": "Ê≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄÔºÅ",
        "confirmReset": "ÊòØÁöÑÔºåÈáçÁΩÆÊï∞ÊçÆ",
        "resetCancelled": "ÈáçÁΩÆÂ∑≤ÂèñÊ∂à",
        
        // Status
        "targetAchieved": "ÁõÆÊ†áËææÊàê",
        "targetPartial": "ÈÉ®ÂàÜËææÊàê",
        "targetMissed": "ÁõÆÊ†áÊú™ËææÊàê"
    }
};
function applyKpiTranslations(language) {
    const lang = kpiTranslations[language] || kpiTranslations['id'];
    
    if (!lang) {
        console.error("Language not found:", language);
        return;
    }

    console.log("üî§ Applying COMPREHENSIVE KPI translations for:", language);

    // 1. TERJEMAHKAN HEADER & NAVIGASI
    translateHeader(lang);
    
    // 2. TERJEMAHKAN SUMMARY CARDS
    translateSummaryCards(lang);
    
    // 3. TERJEMAHKAN KPI TABLE
    translateKpiTable(lang);
    
    // 4. TERJEMAHKAN SUBMENUS
    translateSubmenus(lang);
    
    // 5. TERJEMAHKAN FOOTER
    translateFooter(lang);
    
    // 6. TERJEMAHKAN FILTER USER
    translateUserFilter(lang);
    
    // 7. TERJEMAHKAN TOMBOL & ACTION
    translateButtons(lang);
    
    // 8. TERJEMAHKAN MODAL
    translateModals(lang);
    
    // 9. TERJEMAHKAN TABLE SEMUA USER (jika ada)
    translateAllUsersTable(lang);
    
    // 10. TERJEMAHKAN NOTIFICATION
    translateNotifications(lang);
    
    console.log("‚úÖ KPI translations applied completely");
}

// ========== FUNGSI TERJEMAHAN SPESIFIK ==========

function translateHeader(lang) {
    // Header utama
    const dashboardTitle = document.querySelector('.header h1');
    if (dashboardTitle && lang.dashboardTitle) {
        dashboardTitle.innerHTML = `<i class="fas fa-chart-line"></i> ${lang.dashboardTitle}`;
    }

    // Search placeholder
    const searchInput = document.querySelector('.search-bar input');
    if (searchInput && lang.searchPlaceholder) {
        searchInput.placeholder = lang.searchPlaceholder;
    }

    // User role
    const userRole = document.querySelector('.user-info p');
    if (userRole && lang.customerServiceSupport) {
        userRole.textContent = lang.customerServiceSupport;
    }
}

function translateSummaryCards(lang) {
    const cards = document.querySelectorAll('.summary-card');
    
    cards.forEach((card, index) => {
        const title = card.querySelector('.summary-title');
        const desc = card.querySelector('.summary-content p');
        
        switch(index) {
            case 0: // KPI Bulan Ini
                if (title && lang.kpiThisMonth) title.textContent = lang.kpiThisMonth;
                if (desc && lang.fromMinTarget) desc.textContent = lang.fromMinTarget;
                break;
            case 1: // Ideas & Suggestions
                if (title && lang.ideasSuggestions) title.textContent = lang.ideasSuggestions;
                if (desc && lang.reachingMinTarget) desc.textContent = lang.reachingMinTarget;
                break;
            case 2: // Research
                if (title && lang.research) title.textContent = lang.research;
                if (desc && lang.reachingMinTarget) desc.textContent = lang.reachingMinTarget;
                break;
            case 3: // Chat Response
                if (title && lang.chatResponse) title.textContent = lang.chatResponse;
                if (desc && lang.reachingMinTarget) desc.textContent = lang.reachingMinTarget;
                break;
        }
    });
}

function translateKpiTable(lang) {
    // Judul tabel
    const tableTitle = document.querySelector('.kpi-container h2');
    if (tableTitle && lang.kpiPerformanceData) {
        tableTitle.textContent = lang.kpiPerformanceData;
    }
    
    // Header tabel - PERBAIKI SELECTOR INI
    const tableHeaders = document.querySelectorAll('.kpi-table thead th');
    if (tableHeaders.length > 0) {
        // Header untuk tabel KPI utama
        const headerMapping = {
            0: lang.no,
            1: lang.mainPerformanceArea,
            2: lang.target,
            3: lang.weight,
            4: lang.kpiDescription,
            5: lang.note,
            6: lang.finalScore,
            7: lang.month,
            8: lang.realization,
            9: lang.finalScore, // Skor Akhir bulan ini
            10: lang.action
        };
        
        tableHeaders.forEach((header, index) => {
            if (headerMapping[index]) {
                header.textContent = headerMapping[index];
            }
        });
    }
    
    // Data dalam tabel - PERBAIKI DENGAN SELECTOR YANG LEBIH TEPAT
    translateTableData(lang);
    
    // Total row
    const totalRow = document.querySelector('.result-row');
    if (totalRow) {
        const totalCells = totalRow.querySelectorAll('td');
        if (totalCells[0] && lang.total) {
            totalCells[0].textContent = lang.total;
        }
        if (totalCells[4] && lang.totalFinalScore) {
            totalCells[4].textContent = lang.totalFinalScore;
        }
    }
}

function translateTableData(lang) {
    const performanceData = [
        {
            area: lang.b2bB2c,
            description: lang.b2bDescription,
            note: lang.biggerBetter
        },
        {
            area: lang.problemSolving,
            description: lang.problemSolvingDescription,
            note: lang.biggerBetter
        },
        {
            area: lang.idea,
            description: lang.ideaDescription,
            note: lang.biggerBetter
        },
        {
            area: lang.responseChat,
            description: lang.chatDescription,
            note: lang.smallerBetter
        },
        {
            area: lang.research,
            description: lang.researchDescription,
            note: lang.biggerBetter
        },
        {
            area: lang.attitude,
            description: lang.attitudeDescription,
            note: lang.biggerBetter
        },
        {
            area: lang.discipline,
            description: lang.disciplineDescription,
            note: lang.biggerBetter
        }
    ];
    
    const rows = document.querySelectorAll('.kpi-table tbody tr:not(.result-row)');
    rows.forEach((row, index) => {
        if (index < performanceData.length) {
            const data = performanceData[index];
            
            // Area kinerja (kolom 2)
            const areaCell = row.querySelector('td:nth-child(2)');
            if (areaCell && data.area) {
                areaCell.textContent = data.area;
                // Simpan data asli untuk edit mode
                areaCell.dataset.originalText = data.area;
            }
            
            // Deskripsi KPI (kolom 5)
            const descCell = row.querySelector('td:nth-child(5)');
            if (descCell && data.description) {
                descCell.textContent = data.description;
                descCell.dataset.originalText = data.description;
            }
            
            // Keterangan (kolom 6)
            const noteCell = row.querySelector('td:nth-child(6)');
            if (noteCell && data.note) {
                noteCell.textContent = data.note;
                noteCell.dataset.originalText = data.note;
            }
        }
    });
}

function translateSubmenus(lang) {
    // Ideas submenu
    const ideasDashboard = document.getElementById('dashboard-ideas');
    if (ideasDashboard) {
        const ideasTitle = ideasDashboard.querySelector('.submenu-title');
        if (ideasTitle && lang.ideasSubmenu) {
            ideasTitle.innerHTML = `<i class="fas fa-lightbulb"></i> ${lang.ideasSubmenu}`;
        }
        
        const ideasCriteria = ideasDashboard.querySelector('.criteria-name');
        const ideasDesc = ideasDashboard.querySelector('.criteria-desc');
        if (ideasCriteria && lang.ideasCriteria) ideasCriteria.textContent = lang.ideasCriteria;
        if (ideasDesc && lang.ideasCriteriaDesc) ideasDesc.textContent = lang.ideasCriteriaDesc;
    }
    
    // Research submenu
    const researchDashboard = document.getElementById('dashboard-research');
    if (researchDashboard) {
        const researchTitle = researchDashboard.querySelector('.submenu-title');
        if (researchTitle && lang.researchSubmenu) {
            researchTitle.innerHTML = `<i class="fas fa-search"></i> ${lang.researchSubmenu}`;
        }
        
        const researchCriteria = researchDashboard.querySelector('.criteria-name');
        const researchDesc = researchDashboard.querySelector('.criteria-desc');
        if (researchCriteria && lang.researchCriteria) researchCriteria.textContent = lang.researchCriteria;
        if (researchDesc && lang.researchCriteriaDesc) researchDesc.textContent = lang.researchCriteriaDesc;
    }
    
    // Chat submenu
    const chatDashboard = document.getElementById('dashboard-chat');
    if (chatDashboard) {
        const chatTitle = chatDashboard.querySelector('.submenu-title');
        if (chatTitle && lang.chatSubmenu) {
            chatTitle.innerHTML = `<i class="fas fa-comments"></i> ${lang.chatSubmenu}`;
        }
        
        const chatCriteria = chatDashboard.querySelector('.criteria-name');
        const chatDesc = chatDashboard.querySelector('.criteria-desc');
        if (chatCriteria && lang.chatCriteria) chatCriteria.textContent = lang.chatCriteria;
        if (chatDesc && lang.chatCriteriaDesc) chatDesc.textContent = lang.chatCriteriaDesc;
    }
}

function translateFooter(lang) {
    const footerNote = document.querySelector('.footer-note p');
    if (footerNote) {
        if (lang.trainingNote) {
            const noteText = lang.trainingNote.replace('Catatan:', '').replace('Note:', '').replace('Ê≥®Ë®òÔºö', '').replace('Ê≥®ÊÑèÔºö', '').trim();
            footerNote.innerHTML = `<strong>${lang.note || 'Note'}:</strong> ${noteText}`;
        }
    }
}

function translateUserFilter(lang) {
    const userFilter = document.getElementById('userFilter');
    if (userFilter) {
        if (lang.myData && userFilter.options[0]) {
            userFilter.options[0].text = lang.myData;
        }
        if (lang.allUsers && userFilter.options[1]) {
            userFilter.options[1].text = lang.allUsers;
        }
    }
}

function translateButtons(lang) {
    // Tombol Edit All
    const editAllBtn = document.getElementById('edit-all-btn');
    if (editAllBtn && lang.editAll) {
        editAllBtn.innerHTML = `<i class="fas fa-edit"></i> ${lang.editAll}`;
    }
    
    // Tombol Reset
    const resetBtn = document.getElementById('reset-data-btn');
    if (resetBtn && lang.reset) {
        resetBtn.innerHTML = `<i class="fas fa-sync-alt"></i> <span>${lang.reset}</span>`;
    }
    
    // Tombol Save All Changes
    const saveAllBtn = document.getElementById('save-all-btn');
    if (saveAllBtn && lang.saveAllChanges) {
        saveAllBtn.innerHTML = `<i class="fas fa-save"></i> ${lang.saveAllChanges}`;
    }
    
    // Tombol Cancel All
    const cancelAllBtn = document.getElementById('cancel-all-btn');
    if (cancelAllBtn && lang.cancelAll) {
        cancelAllBtn.innerHTML = `<i class="fas fa-times"></i> ${lang.cancelAll}`;
    }
    
    // Tombol di submenus
    const submenuEditButtons = document.querySelectorAll('.submenu-container .btn-edit-all');
    submenuEditButtons.forEach(btn => {
        if (lang.editAll) {
            btn.innerHTML = `<i class="fas fa-edit"></i> ${lang.editAll}`;
        }
    });
    
    // Tombol edit di criteria items
    const criteriaEditButtons = document.querySelectorAll('.criteria-list .btn-primary');
    criteriaEditButtons.forEach(btn => {
        if (lang.edit) {
            btn.textContent = lang.edit;
        }
    });
    
    // Tombol edit individual di tabel
    const editCellButtons = document.querySelectorAll('.btn-edit-cell');
    editCellButtons.forEach(btn => {
        if (lang.edit) {
            btn.innerHTML = `<i class="fas fa-edit"></i> ${lang.edit}`;
        }
    });
}

function translateModals(lang) {
    // Modal Edit Options
    const editModal = document.getElementById('edit-options-modal');
    if (editModal) {
        const modalTitle = editModal.querySelector('.reset-modal-title');
        if (modalTitle && lang.editOptions) modalTitle.textContent = lang.editOptions;
        
        const modalText = editModal.querySelector('.reset-modal-text');
        if (modalText && lang.editOptions) modalText.textContent = lang.editOptions;
        
        const optionButtons = editModal.querySelectorAll('.edit-option-btn');
        optionButtons.forEach((btn, index) => {
            if (index === 0 && lang.editRealisasiOnly) {
                const strong = btn.querySelector('strong') || btn;
                const small = btn.querySelector('small') || btn.querySelector('p');
                strong.textContent = lang.editRealisasiOnly;
                if (small && lang.editRealisasiOnlyDesc) small.textContent = lang.editRealisasiOnlyDesc;
            } else if (index === 1 && lang.editAllData) {
                const strong = btn.querySelector('strong') || btn;
                const small = btn.querySelector('small') || btn.querySelector('p');
                strong.textContent = lang.editAllData;
                if (small && lang.editAllDataDesc) small.textContent = lang.editAllDataDesc;
            }
        });
    }
    
    // Modal Reset Confirmation
    const resetModal = document.getElementById('reset-confirmation-modal');
    if (resetModal) {
        const modalTitle = resetModal.querySelector('.reset-modal-title');
        if (modalTitle && lang.resetConfirmation) modalTitle.textContent = lang.resetConfirmation;
        
        const modalText = resetModal.querySelector('.reset-modal-text');
        if (modalText && lang.resetConfirmText) modalText.textContent = lang.resetConfirmText;
        
        const cancelBtn = resetModal.querySelector('.reset-modal-btn-cancel');
        if (cancelBtn) {
            cancelBtn.innerHTML = `<i class="fas fa-times"></i> ${lang.cancel || 'Cancel'}`;
        }
        
        const confirmBtn = resetModal.querySelector('.reset-modal-btn-confirm');
        if (confirmBtn && lang.confirmReset) {
            confirmBtn.innerHTML = `<i class="fas fa-check"></i> ${lang.confirmReset}`;
        }
    }
}

function translateAllUsersTable(lang) {
    const allUsersTable = document.querySelector('.all-users-table');
    if (!allUsersTable) return;
    
    // Judul
    const title = allUsersTable.querySelector('h3');
    if (title && lang.allUsersData) {
        const userCount = allUsersTable.querySelector('tbody')?.children.length || 0;
        title.innerHTML = `<i class="fas fa-users"></i> ${lang.allUsersData} (${userCount} users)`;
    }
    
    // Header
    const headers = allUsersTable.querySelectorAll('thead th');
    const headerTexts = [
        lang.no, lang.user, lang.email, lang.totalKPI, 
        lang.ideas, lang.research, lang.chatResponse, 
        lang.problemSolving, lang.lastUpdated, lang.action
    ];
    
    headers.forEach((header, index) => {
        if (headerTexts[index]) {
            header.textContent = headerTexts[index];
        }
    });
    
    // Tombol view details
    const viewButtons = allUsersTable.querySelectorAll('.btn-view-user');
    viewButtons.forEach(btn => {
        if (lang.viewDetails) {
            btn.innerHTML = `<i class="fas fa-eye"></i> ${lang.viewDetails}`;
        }
    });
}

function translateNotifications(lang) {
    // Override fungsi showNotification untuk menerjemahkan pesan
    if (typeof window.showNotification === 'function') {
        const originalShowNotification = window.showNotification;
        
        window.showNotification = function(message, type = 'info') {
            let translatedMessage = message;
            
            // Mapping pesan notifikasi
            const notificationMap = {
                'Mode edit diaktifkan': lang.editModeEnabled,
                'Perubahan KPI berhasil disimpan': lang.changesSaved,
                'Data KPI berhasil direset': lang.dataReset,
                'Memuat data user': lang.loadingUserData,
                'Menampilkan data': lang.showingUsersData,
                'Hanya Super Admin yang dapat mengedit data': lang.adminOnly,
                'Hanya bisa mereset data sendiri': lang.resetOwnDataOnly,
                'Error memuat data KPI': lang.errorLoadingKPI,
                'Perubahan berhasil disimpan ke database': lang.saveSuccess,
                'Gagal menyimpan perubahan ke database': lang.saveFailed,
                'Tidak ada perubahan yang disimpan': lang.noChanges,
                'Edit dibatalkan': lang.editCancelled,
                'Mode edit realisasi diaktifkan': lang.editRealisasiEnabled,
                'Mode edit penuh diaktifkan': lang.fullEditEnabled,
                'Reset data dibatalkan': lang.resetCancelled
            };
            
            // Cari terjemahan yang cocok
            for (const [id, translation] of Object.entries(notificationMap)) {
                if (message.includes(id)) {
                    translatedMessage = translation;
                    break;
                }
            }
            
            // Handle pesan dengan placeholder
            if (message.includes('{count}')) {
                const count = message.match(/\d+/);
                if (count) {
                    translatedMessage = translatedMessage.replace('{count}', count[0]);
                }
            }
            
            originalShowNotification(translatedMessage, type);
        };
    }
}

// ========== FUNGSI UTAMA & EVENT HANDLING ==========

function initializeKpiLanguage() {
    const savedLanguage = localStorage.getItem('language') || 'id';
    console.log("üåç Initializing KPI language:", savedLanguage);
    
    // Terapkan terjemahan pertama kali
    applyKpiTranslations(savedLanguage);
    
    // Setup observer untuk elemen yang dibuat dinamis
    setupDynamicElementObserver();
    
    // Setup event listener untuk perubahan bahasa
    setupLanguageChangeListener();
}

function setupDynamicElementObserver() {
    // Observer untuk menangani elemen yang dibuat dinamis
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                        // Jika modal edit options ditambahkan
                        if (node.id === 'edit-options-modal' || node.querySelector?.('#edit-options-modal')) {
                            const lang = kpiTranslations[localStorage.getItem('language') || 'id'];
                            translateModals(lang);
                        }
                        
                        // Jika tabel semua user ditambahkan
                        if (node.classList?.contains('all-users-table') || node.querySelector?.('.all-users-table')) {
                            const lang = kpiTranslations[localStorage.getItem('language') || 'id'];
                            translateAllUsersTable(lang);
                        }
                    }
                });
            }
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
}

function setupLanguageChangeListener() {
    // Event listener untuk perubahan bahasa
    window.addEventListener('languageChanged', function(event) {
        console.log("üîÑ Language changed to:", event.detail.language);
        applyKpiTranslations(event.detail.language);
    });
    
    // Juga dengar event storage untuk perubahan localStorage
    window.addEventListener('storage', function(event) {
        if (event.key === 'language') {
            applyKpiTranslations(event.newValue);
        }
    });
}

// ========== INISIALISASI ==========

// Panggil saat DOM ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeKpiLanguage);
} else {
    initializeKpiLanguage();
}

// Juga panggil saat halaman fully loaded
window.addEventListener('load', initializeKpiLanguage);

// Force re-apply translations setelah timeout (fallback)
setTimeout(initializeKpiLanguage, 2000);

// Export untuk penggunaan global
window.KpiTranslations = {
    apply: applyKpiTranslations,
    initialize: initializeKpiLanguage
};

console.log("‚úÖ Enhanced KPI Translation System loaded");
function getCurrentViewingUserId() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) return null;
    
    // Default ke user sendiri
    let viewingUserId = currentUser.uid;
    
    // Cek URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('userId')) {
        const urlUserId = urlParams.get('userId');
        // VALIDASI: hanya terima jika super admin
        if (isSuperAdminUser && urlUserId !== currentUser.uid) {
            viewingUserId = urlUserId;
        }
    }
    
    console.log('üîç Viewing user ID:', viewingUserId);
    return viewingUserId;
}
function updateKpiFromFirestore(firestoreData) {
    if (firestoreData.kpiData && Array.isArray(firestoreData.kpiData)) {
        firestoreData.kpiData.forEach((savedItem, index) => {
            if (index < kpiData.length) {
                // Update hanya jika data berbeda
                if (JSON.stringify(kpiData[index]) !== JSON.stringify(savedItem)) {
                    Object.assign(kpiData[index], savedItem);
                }
            }
        });
        
        updateDisplay();
        console.log('‚úÖ Data updated from Firestore real-time listener');
    }
}
// ========== FUNGSI UNTUK UPDATE BULAN OTOMATIS ==========

// Fungsi untuk mendapatkan nama bulan dalam bahasa Indonesia
function getCurrentMonth() {
    const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    const monthsID = [
        'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
    ];
    
    const now = new Date();
    const currentMonthIndex = now.getMonth();
    
    // Return berdasarkan bahasa yang dipilih
    const currentLanguage = localStorage.getItem('language') || 'id';
    return currentLanguage === 'id' ? monthsID[currentMonthIndex] : months[currentMonthIndex];
}

// Fungsi untuk update header bulan
function updateMonthHeader() {
    const currentMonth = getCurrentMonth();
    const monthHeader = document.getElementById('current-month-header');
    
    if (monthHeader) {
        monthHeader.textContent = currentMonth;
    }
    
    // Juga update teks "Bulan" di header jika perlu
    const monthLabel = document.querySelector('.kpi-table thead th:nth-child(8)');
    if (monthLabel && monthLabel.textContent === 'October') {
        monthLabel.textContent = 'Bulan';
    }
}

// ========== FUNGSI UNTUK DATA BULAN BERJALAN ==========

// Fungsi untuk mendapatkan bulan dan tahun saat ini dalam format yang konsisten
function getCurrentMonthYear() {
    const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    const monthsID = [
        'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
    ];
    
    const now = new Date();
    const currentMonthIndex = now.getMonth();
    const currentYear = now.getFullYear();
    
    // Return berdasarkan bahasa yang dipilih
    const currentLanguage = localStorage.getItem('language') || 'id';
    const monthName = currentLanguage === 'id' ? monthsID[currentMonthIndex] : months[currentMonthIndex];
    
    return {
        month: (currentMonthIndex + 1).toString().padStart(2, '0'),
        year: currentYear,
        display: `${(currentMonthIndex + 1).toString().padStart(2, '0')}/${currentYear}`,
        fullDisplay: `${monthName} ${currentYear}`
    };
}


// Fungsi untuk setup data bulanan
function setupMonthlyData() {
    const currentMonthYear = getCurrentMonthYear();
    
    // PERBAIKAN: Gunakan currentMonthYear.year, bukan currentYear yang tidak terdefinisi
    window.currentDataKey = `kpiData_${currentMonthYear.month}_${currentMonthYear.year}`;
    
    console.log('üìÖ Current period:', currentMonthYear.fullDisplay);
    console.log('üîë Data key:', window.currentDataKey);
    
    // Update tampilan dengan info bulan-tahun di top bar
    updatePeriodDisplay(currentMonthYear);
    
    // Hapus tampilan periode lama di bawah judul KPI jika ada
    const oldKpiPeriod = document.getElementById('kpi-period-display');
    if (oldKpiPeriod) {
        oldKpiPeriod.remove();
    }
}

// Fungsi untuk update tampilan periode di top bar
// Fungsi untuk update tampilan periode berdasarkan role
function updatePeriodDisplay(period) {
    const currentPeriod = getCurrentMonthYear();
    
    // Hapus elemen periode lama jika ada
    const oldPeriodElement = document.getElementById('current-period-display');
    if (oldPeriodElement) {
        oldPeriodElement.remove();
    }
    
    // Buat elemen periode baru
    const periodElement = document.createElement('div');
    periodElement.id = 'current-period-display';
    periodElement.className = 'period-display';
    periodElement.innerHTML = `
        <i class="fas fa-calendar-alt"></i>
        <span>${currentPeriod.fullDisplay}</span>
    `;
    
    if (isSuperAdminUser) {
        // SUPER ADMIN: Period display di TOP BAR
        setupSuperAdminPeriod(periodElement);
    } else {
        // USER BIASA: Period display di bawah judul KPI
        setupRegularUserPeriod(periodElement);
    }
    
    console.log('‚úÖ Period display updated for:', isSuperAdminUser ? 'Super Admin' : 'Regular User');
}

// Fungsi untuk Super Admin (period di top bar)
function setupSuperAdminPeriod(periodElement) {
    periodElement.classList.add('super-admin-period');
    
    // Cari container waktu di header
    const timeContainer = document.querySelector('.header-time');
    
    if (timeContainer && timeContainer.parentElement) {
        // Buat wrapper container untuk waktu dan periode
        const headerTimeContainer = document.createElement('div');
        headerTimeContainer.className = 'header-time-container';
        
        // Masukkan periode dan waktu ke container baru
        headerTimeContainer.appendChild(periodElement);
        headerTimeContainer.appendChild(timeContainer.cloneNode(true));
        
        // Ganti elemen waktu lama dengan container baru
        timeContainer.parentElement.replaceChild(headerTimeContainer, timeContainer);
    } else {
        // Fallback: tempatkan di header actions
        const headerActions = document.querySelector('.header-actions');
        if (headerActions) {
            headerActions.insertBefore(periodElement, headerActions.firstChild);
        }
    }
}

// Fungsi untuk User Biasa (period di bawah judul KPI)
function setupRegularUserPeriod(periodElement) {
    periodElement.classList.add('regular-user-period');
    
    const kpiContainer = document.querySelector('.kpi-container');
    if (kpiContainer) {
        // Cari elemen judul KPI
        const kpiTitle = kpiContainer.querySelector('h2');
        if (kpiTitle) {
            // Tempatkan period display setelah judul
            kpiTitle.parentNode.insertBefore(periodElement, kpiTitle.nextSibling);
        } else {
            // Fallback: tempatkan di awal container
            kpiContainer.insertBefore(periodElement, kpiContainer.firstChild);
        }
    }
}

// Modifikasi fungsi setupAdminUI untuk handle period display
function setupAdminUI(isAdmin) {
    console.log('Setting up admin UI, isAdmin:', isAdmin);
    
    const headerActions = document.querySelector('.header-actions');
    if (!headerActions) {
        console.error('Header actions element not found');
        return;
    }
    
    // Hapus filter yang sudah ada jika ada
    const existingFilter = document.getElementById('userFilterContainer');
    if (existingFilter) {
        existingFilter.remove();
    }
    
    // Update tombol visibility
    const editAllBtn = document.getElementById('edit-all-btn');
    const resetBtn = document.getElementById('reset-data-btn');
    const submenuEditButtons = document.querySelectorAll('.submenu-container .btn-edit-all');
    const criteriaEditButtons = document.querySelectorAll('.criteria-list .btn-primary');
    
    if (isAdmin) {
        // Tampilkan semua tombol untuk super admin
        if (editAllBtn) editAllBtn.classList.add('admin-visible');
        if (resetBtn) resetBtn.classList.add('admin-visible');
        submenuEditButtons.forEach(btn => btn.classList.add('admin-visible'));
        criteriaEditButtons.forEach(btn => btn.classList.add('admin-visible'));
        
        // Tambahkan filter dropdown untuk super admin
        const filterHTML = `
            <div class="user-filter" id="userFilterContainer">
                <select id="userFilter" class="filter-select">
                    <option value="current">Data Saya</option>
                    <option value="all">Semua User</option>
                </select>
            </div>
        `;
        
        const userProfile = headerActions.querySelector('.user-profile');
        if (userProfile) {
            userProfile.insertAdjacentHTML('beforebegin', filterHTML);
            
            document.getElementById('userFilter').addEventListener('change', function() {
                currentFilter = this.value;
                console.log('Filter changed to:', currentFilter);
                loadKpiData(currentFilter);
            });
        }
        
        isSuperAdminUser = true;
        
    } else {
        // Sembunyikan semua tombol untuk user biasa
        if (editAllBtn) editAllBtn.classList.remove('admin-visible');
        if (resetBtn) resetBtn.classList.remove('admin-visible');
        submenuEditButtons.forEach(btn => btn.classList.remove('admin-visible'));
        criteriaEditButtons.forEach(btn => btn.classList.remove('admin-visible'));
        
        isSuperAdminUser = false;
    }
    
    // UPDATE PERIOD DISPLAY SETELAH ROLE BERUBAH
    const currentPeriod = getCurrentMonthYear();
    updatePeriodDisplay(currentPeriod);
}

// Fungsi untuk refresh period display saat filter berubah
function refreshPeriodDisplay() {
    const currentPeriod = getCurrentMonthYear();
    updatePeriodDisplay(currentPeriod);
}

// Event listener untuk perubahan filter (Super Admin)
if (document.getElementById('userFilter')) {
    document.getElementById('userFilter').addEventListener('change', function() {
        // Beri sedikit delay untuk memastikan DOM sudah update
        setTimeout(refreshPeriodDisplay, 100);
    });
}

// Event listener untuk perubahan dashboard
document.addEventListener('DOMContentLoaded', function() {
    const menuItems = document.querySelectorAll('.menu-item');
    menuItems.forEach(item => {
        item.addEventListener('click', function() {
            // Refresh period display saat berpindah dashboard
            setTimeout(refreshPeriodDisplay, 200);
        });
    });
});
// FUNGSI BARU: Auto-save untuk user biasa
async function autoSaveKpiForRegularUser() {
    try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser || isSuperAdminUser) return;

        console.log('üîÑ Auto-saving KPI data for regular user...');
        
        // Update data dari modules terlebih dahulu
        await updateAllKpiData();
        
        // Simpan ke kpiData collection
        const saveResult = await saveKpiDataToFirestore();
        
        if (saveResult) {
            console.log('‚úÖ Auto-save successful for regular user');
        } else {
            console.log('‚ùå Auto-save failed for regular user');
        }
    } catch (error) {
        console.error('Error in auto-save:', error);
    }
}

// MODIFIKASI fungsi initializeKpiData:
async function initializeKpiData() {
    try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) return;

        // 1. Coba load dari kpiData collection
        const firestoreLoaded = await loadKpiDataFromFirestore();
        
        if (!firestoreLoaded) {
            console.log('üì≠ No data in kpiData collection, initializing...');
            
            // 2. Jika tidak ada data, ambil dari collections terpisah
            await updateAllKpiData();
            
            // 3. AUTO-SAVE: Simpan ke kpiData collection (UNTUK USER BIASA)
            await autoSaveKpiForRegularUser();
        }
        
        // 4. Update tampilan
        updateDisplay();
        
    } catch (error) {
        console.error('Error initializing KPI data:', error);
    }
}

// MODIFIKASI fungsi updateAllKpiData untuk user biasa:
async function updateAllKpiData(userId = null) {
    try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) return;

        const targetUserId = userId || currentUser.uid;
        
        console.log('üîÑ Updating KPI realization for user:', targetUserId);
        
        // Ambil data realisasi dari collections terpisah
        const ideasData = await getIdeasData(userId);
        const researchData = await getResearchData(userId);
        const chatData = await getChatData(userId);
        const problemData = await getProblemSolvingData(userId);
        const b2bData = await getB2BData(userId);
        const attitudeData = await getAttitudeData(userId);
        const disciplineData = await getDisciplineData(userId);

        // Update HANYA realisasi
        kpiData[0].realization = b2bData.count;
        kpiData[1].realization = problemData.count;
        kpiData[2].realization = ideasData.count;
        kpiData[3].realization = chatData.count;
        kpiData[4].realization = researchData.count;
        kpiData[5].realization = attitudeData.averageScore;
        kpiData[6].realization = disciplineData.count;

        // Simpan data chat untuk perhitungan
        window.chatDataForCalculation = chatData;

        // Hitung ulang semua skor
        updateKPI();
        
        console.log('‚úÖ KPI realization updated from modules');
        
    } catch (error) {
        console.error('Error updating KPI realization data:', error);
    }
}

// TAMBAHKAN real-time listener untuk modules (ideas, research, dll)
function setupModulesRealTimeListeners() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) return;

    const db = firebase.firestore();
    const userId = currentUser.uid;

    // Listen untuk perubahan di semua collections
    const collections = ['ideas', 'research', 'chats', 'problems', 'b2b', 'attitude', 'discipline'];
    
    collections.forEach(collectionName => {
        const unsubscribe = db.collection(collectionName)
            .where('userId', '==', userId)
            .onSnapshot(() => {
                console.log(`üîÑ ${collectionName} collection changed, updating KPI...`);
                
                // Update data dari modules
                updateAllKpiData();
                
                // Auto-save ke kpiData collection (untuk user biasa)
                if (!isSuperAdminUser) {
                    setTimeout(() => autoSaveKpiForRegularUser(), 1000);
                }
            });
        
        unsubscribeFunctions.push(unsubscribe);
    });
}

// MODIFIKASI inisialisasi di DOMContentLoaded:
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ KPI Integration initialized');
    
    if (typeof firebase !== 'undefined' && firebase.auth()) {
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                console.log('‚úÖ User authenticated:', user.email);
                
                // Setup admin UI
                await checkAndSetupSuperAdmin();
                
                // Setup monthly data
                setupMonthlyData();
                
                // Initialize KPI data
                await initializeKpiData();
                
                // Setup real-time listeners
                setupRealTimeListeners();
                setupModulesRealTimeListeners(); // <- TAMBAHKAN INI
                
                console.log('‚úÖ KPI Dashboard initialized successfully');
                
            } else {
                console.log('‚ùå User not authenticated');
                setupAdminUI(false);
            }
        });
    }
});
// FUNGSI TAMBAHAN: Validasi dan repair data
async function validateAndRepairKpiData() {
    try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) return;

        const db = firebase.firestore();
        const kpiDoc = await db.collection('kpiData').doc(currentUser.uid).get();
        
        if (kpiDoc.exists) {
            const savedData = kpiDoc.data();
            
            // Validasi: apakah data di kpiData sesuai dengan modules?
            const needsRepair = await checkDataConsistency();
            
            if (needsRepair) {
                console.log('üõ†Ô∏è Data inconsistency detected, repairing...');
                await updateAllKpiData();
                await saveKpiDataToFirestore();
                console.log('‚úÖ Data repaired successfully');
            }
        }
    } catch (error) {
        console.error('Error validating KPI data:', error);
    }
}

async function checkDataConsistency() {
    // Implementasi logika untuk mengecek konsistensi data
    // antara kpiData collection dan modules terpisah
    return false; // Return true jika perlu repair
}
</script>
</body>

</html>
