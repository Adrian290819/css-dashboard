<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research - Sistem Terintegrasi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="global.css">
    <link rel="stylesheet" href="stylemobile.css">
    <script src="global-time.js"></script>
    <style>
        /* ========== VARIABEL CSS ========== */
        :root {
            --primary-gradient: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            --warning-gradient: linear-gradient(135deg, #f72585 0%, #7209b7 100%);
            --info-gradient: linear-gradient(135deg, #4895ef 0%, #3f37c9 100%);
            --completed-color: #10b981;
            --pending-color: #f59e0b;
            --overdue-color: #ef4444;
        }

        /* ========== LAYOUT UTAMA ========== */
        .main-content {
            padding: var(--space-lg);
            background-color: var(--bg-secondary);
            min-height: 100vh;
        }

        .header {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin: 0;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .search-bar {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-bar i {
            position: absolute;
            left: 12px;
            color: var(--text-secondary);
        }

        .search-bar input {
            padding: var(--space-sm) var(--space-sm) var(--space-sm) 40px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--input-bg);
            color: var(--text-primary);
            font-size: var(--text-sm);
            width: 250px;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--bg-secondary);
            transition: background-color var(--transition-fast);
        }

        .notification-bell:hover {
            background: var(--hover-color);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--overdue-color);
            color: white;
            font-size: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-info h4 {
            margin: 0;
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
        }

        .user-info p {
            margin: 0;
            font-size: var(--text-xs);
            color: var(--text-secondary);
        }

        /* ========== STATISTICS STYLES ========== */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }

        .stat-title {
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--text-secondary);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .stat-icon.total { background: var(--primary-gradient); }
        .stat-icon.completed { background: var(--success-gradient); }
        .stat-icon.pending { background: var(--warning-gradient); }
        .stat-icon.kpi { background: var(--info-gradient); }

        .stat-value {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
        }

        .stat-description {
            font-size: var(--text-xs);
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
        }

        .progress-bar {
            height: 8px;
            background-color: var(--bg-secondary);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: var(--radius-full);
            transition: width 1s ease;
        }

        /* ========== RESEARCH CONTAINER ========== */
        .research-container {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-bottom: var(--space-xl);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border-color);
        }

        .section-title {
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        /* ========== RESEARCH FORM ========== */
        .research-form {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .form-group {
            margin-bottom: var(--space-md);
        }

        .form-label {
            display: block;
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
        }

        .form-control {
            padding: var(--space-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--input-bg);
            color: var(--text-primary);
            font-size: var(--text-sm);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
            width: 100%;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }

        /* ========== RESEARCH TABLE ========== */
        .research-table-container {
            margin-top: var(--space-md);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .table-title {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
        }

        .research-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .research-table th {
            background: var(--primary-gradient);
            color: white;
            font-weight: var(--font-semibold);
            text-align: left;
            padding: var(--space-sm) var(--space-md);
            font-size: var(--text-sm);
        }

        .research-table td {
            padding: var(--space-sm) var(--space-md);
            border-bottom: 1px solid var(--border-color);
            font-size: var(--text-sm);
        }

        .research-table tr:last-child td {
            border-bottom: none;
        }

        .research-table tr:hover {
            background-color: var(--hover-color);
        }

        .table-input {
            width: 100%;
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: var(--text-sm);
        }

        .table-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        .table-textarea {
            width: 100%;
            min-height: 60px;
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: var(--text-sm);
            resize: vertical;
        }

        .table-select {
            width: 100%;
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: var(--text-sm);
        }

        /* ========== RESEARCH GRID ========== */
        .research-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: var(--space-lg);
        }

        .research-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .research-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .research-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
            position: relative;
        }

        .research-title {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin: 0 0 var(--space-xs);
            line-height: 1.4;
            flex: 1;
            padding-right: var(--space-md);
        }

        .research-date {
            font-size: var(--text-xs);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            margin-bottom: var(--space-sm);
        }

        .research-details {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: var(--space-md);
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .research-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: var(--space-md);
            border-top: 1px solid var(--border-color-light);
        }

        .research-author {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .author-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }

        .author-info {
            display: flex;
            flex-direction: column;
        }

        .author-name {
            font-size: var(--text-xs);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
        }

        .author-role {
            font-size: var(--text-xs);
            color: var(--text-tertiary);
        }

        /* ========== STATUS BADGE ========== */
        .research-status {
            padding: 6px 12px;
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: var(--font-semibold);
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            z-index: 2;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .status-completed {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .status-overdue {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        /* ========== ACTION BUTTONS ========== */
        .research-actions {
            display: flex;
            gap: var(--space-xs);
            margin-top: var(--space-sm);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-icon:hover {
            transform: translateY(-2px);
        }

        .btn-icon.edit:hover {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 4px 8px rgba(67, 97, 238, 0.2);
        }

        .btn-icon.delete:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border-color: var(--danger);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.2);
        }

        .btn-icon.view {
            background: rgba(16, 185, 129, 0.1);
            color: var(--completed-color);
        }

        .btn-icon.view:hover {
            background: rgba(16, 185, 129, 0.2);
            color: var(--completed-color);
            border-color: var(--completed-color);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.2);
        }

        /* ========== BUTTON STYLES ========== */
        .btn {
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            cursor: pointer;
            border: none;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-outline {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-outline:hover {
            background: var(--hover-color);
        }

        .add-row-btn {
            background: var(--success-gradient);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: var(--space-xs) var(--space-sm);
            font-size: var(--text-xs);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all var(--transition-fast);
        }

        .add-row-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .delete-row-btn {
            background: transparent;
            border: none;
            color: var(--overdue-color);
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .delete-row-btn:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-secondary);
            grid-column: 1 / -1;
            display: none;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: var(--space-md);
            color: var(--text-tertiary);
        }

        .empty-state h3 {
            margin: 0 0 var(--space-sm);
            color: var(--text-primary);
        }

        .empty-state p {
            margin: 0;
        }

        /* ========== NOTIFICATION STYLES ========== */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            padding: 12px 16px;
            border-radius: var(--radius-md);
            background: var(--card-bg);
            border-left: 4px solid var(--primary);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: notificationSlideIn 0.5s ease forwards;
            max-width: 350px;
            position: relative;
        }

        .notification.success {
            border-left-color: var(--completed-color);
        }

        .notification.error {
            border-left-color: var(--overdue-color);
        }

        .notification.info {
            border-left-color: var(--primary);
        }

        .notification button.notification-close {
            background: none;
            border: none;
            cursor: pointer;
            margin-left: auto;
            color: var(--text-secondary);
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .notification button.notification-close:hover {
            color: var(--text-primary);
            background-color: rgba(0, 0, 0, 0.1);
        }

        .notification.hiding {
            animation: notificationSlideOut 0.5s ease forwards;
        }

        @keyframes notificationSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes notificationSlideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ========== FADE ANIMATION ========== */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== PAGINATION ========== */
        .pagination-container {
            margin-top: var(--space-lg);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }

        /* ========== RESPONSIVE ADJUSTMENTS ========== */
        @media (max-width: 1024px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-md);
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .search-bar input {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .research-grid {
                grid-template-columns: 1fr;
            }

            .header-actions {
                flex-wrap: wrap;
                gap: var(--space-sm);
            }

            .search-bar {
                order: 3;
                width: 100%;
            }

            .search-bar input {
                width: 100%;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-md);
            }
        }

        @media (max-width: 480px) {
            .research-card {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-md);
            }

            .research-actions {
                width: 100%;
                justify-content: space-between;
            }

            .btn {
                width: 100%;
            }
        }
        /* Tambahkan di bagian CSS */
.form-select {
    padding: var(--space-sm);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background-color: var(--input-bg);
    color: var(--text-primary);
    font-size: var(--text-sm);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    width: 100%;
}

.form-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.form-select option {
    background-color: var(--card-bg);
    color: var(--text-primary);
    padding: 8px;
}

.form-select option[value=""] {
    color: var(--text-secondary);
}
    </style>
</head>
<body>
    <div class="notification-container" id="notificationContainer"></div>
    
    <div id="sidebar-container"></div>
    <button class="menu-toggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <h1><i class="fas fa-search"></i> Research</h1>
            <div class="header-actions">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Cari research..." id="searchResearch">
                </div>
                
                <button class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="user-profile">
                    <img class="profile-img" src="https://iili.io/Fpiva7S.png" alt="Profile">
                    <div class="user-info">
                        <h4>Nama Masing Masing</h4>
                        <p>Customer Service Support</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="stats-container">
            <div class="stat-card fade-in">
                <div class="stat-header">
                    <span class="stat-title">Total Research</span>
                    <div class="stat-icon total">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                </div>
                <div class="stat-value" id="total-research">0</div>
                <div class="stat-description">Dari target 28 research/bulan</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="total-progress" style="width: 0%; background: var(--primary-gradient);"></div>
                </div>
            </div>

            <div class="stat-card fade-in">
                <div class="stat-header">
                    <span class="stat-title">Research Selesai</span>
                    <div class="stat-icon completed">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                <div class="stat-value" id="completed-research">0</div>
                <div class="stat-description">Research yang telah diselesaikan</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="completed-progress" style="width: 0%; background: var(--success-gradient);"></div>
                </div>
            </div>

            <div class="stat-card fade-in">
                <div class="stat-header">
                    <span class="stat-title">Research Tertunda</span>
                    <div class="stat-icon pending">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                <div class="stat-value" id="pending-research">0</div>
                <div class="stat-description">Research yang masih dalam proses</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="pending-progress" style="width: 0%; background: var(--warning-gradient);"></div>
                </div>
            </div>

            <div class="stat-card fade-in">
                <div class="stat-header">
                    <span class="stat-title">KPI Research</span>
                    <div class="stat-icon kpi">
                        <i class="fas fa-percentage"></i>
                    </div>
                </div>
                <div class="stat-value" id="kpi-research">0%</div>
                <div class="stat-description">Pencapaian target research</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="kpi-progress" style="width: 0%; background: var(--info-gradient);"></div>
                </div>
            </div>
        </div>

        <div class="research-container">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-plus-circle"></i> Formulir Research</h2>
            </div>
            
            <form id="researchForm" class="research-form">
                <div class="form-group">
                    <label for="researchPlatform" class="form-label">Platform/Agent*</label>
                    <input type="text" id="researchPlatform" class="form-control" placeholder="Masukkan nama platform/agent yang di research" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Detail Research*</label>
                    <div class="research-table-container">
                        <div class="table-header">
                            <h3 class="table-title">Kategori Research</h3>
                            <button type="button" class="add-row-btn" id="addRowBtn">
                                <i class="fas fa-plus"></i>
                                Tambah Kategori
                            </button>
                        </div>
                        <table class="research-table" id="researchDetailTable">
                            <thead>
                                <tr>
                                    <th>Kategori</th>
                                    <th>Deskripsi</th>
                                    <th>URL (Opsional)</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="researchDetailTbody">
                                <!-- Rows will be added dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="form-group" style="display: flex; justify-content: flex-end;">
                    <button type="submit" class="btn btn-primary" id="submitButton">
                        <i class="fas fa-paper-plane"></i> Simpan Research
                    </button>
                </div>
            </form>
            
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-list"></i> Daftar Research</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="refreshResearch">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <div class="research-grid" id="researchGrid"></div>

            <!-- PAGINATION -->
            <div class="pagination-container" id="paginationContainer" style="display:none;">
                <button class="btn btn-outline" id="prevPage">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span id="pageInfo">Page 1 / 1</span>
                <button class="btn btn-outline" id="nextPage">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <div class="empty-state" id="emptyState">
                <i class="fas fa-search"></i>
                <h3>Tidak ada research</h3>
                <p>Tambahkan research baru untuk memulai!</p>
            </div>
        </div>
    </div>

    <!-- Modal Detail Research -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-eye"></i> Detail Research</h3>
                <button class="modal-close" id="closeDetailModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-content" id="detailContent">
                    <!-- Detail konten akan dimuat di sini -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="closeDetail">
                    <i class="fas fa-times"></i> Tutup
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Edit Research -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-edit"></i> Edit Research</h3>
                <button class="modal-close" id="closeEditModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editResearchForm">
                    <input type="hidden" id="editResearchId">
                    <div class="form-group">
                        <label for="editResearchPlatform" class="form-label">Platform/Agent</label>
                        <input type="text" id="editResearchPlatform" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelEdit">
                    <i class="fas fa-times"></i> Batal
                </button>
                <button class="btn btn-primary" id="saveEdit">
                    <i class="fas fa-save"></i> Simpan Perubahan
                </button>
            </div>
        </div>
    </div>
    
    <script src="sidebar-loader.js"></script>
    <script src="user-profile.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
    // Konfigurasi Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDUZka4FZyLi_cv6X_5D4zeRsfkpqOlBpY",
        authDomain: "dashboard-css.firebaseapp.com",
        databaseURL: "https://dashboard-css-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "dashboard-css",
        storageBucket: "dashboard-css.appspot.com",
        messagingSenderId: "771131792881",
        appId: "1:771131792881:web:ad634424225bd7de847850",
        measurementId: "G-3CYBC5B101"
    };

    // Inisialisasi Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Data Research
    let researchData = [];
    let currentEditId = null;
    let currentUser = null;
    let currentUserData = null;
    let unsubscribeResearch = null;
    let currentPage = 1;
    const pageSize = 10;
    let currentFilteredResearch = null;
    const researchTarget = 28;

    // Elemen DOM
    const researchForm = document.getElementById('researchForm');
    const researchGrid = document.getElementById('researchGrid');
    const emptyState = document.getElementById('emptyState');
    const searchResearch = document.getElementById('searchResearch');
    const refreshResearch = document.getElementById('refreshResearch');
    const notificationContainer = document.getElementById('notificationContainer');
    const submitButton = document.getElementById('submitButton');
    const addRowBtn = document.getElementById('addRowBtn');
    const researchDetailTbody = document.getElementById('researchDetailTbody');

    // Statistik elements
    const totalResearchEl = document.getElementById('total-research');
    const completedResearchEl = document.getElementById('completed-research');
    const pendingResearchEl = document.getElementById('pending-research');
    const kpiResearchEl = document.getElementById('kpi-research');
    const totalProgress = document.getElementById('total-progress');
    const completedProgress = document.getElementById('completed-progress');
    const pendingProgress = document.getElementById('pending-progress');
    const kpiProgress = document.getElementById('kpi-progress');

    // Pagination elements
    const paginationContainer = document.getElementById('paginationContainer');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');

    // Buat elemen status koneksi jika belum ada
    let connectionStatus = document.getElementById('connectionStatus');
    if (!connectionStatus) {
        connectionStatus = document.createElement('div');
        connectionStatus.id = 'connectionStatus';
        connectionStatus.className = 'connection-status status-connected';
        connectionStatus.innerHTML = '<i class="fas fa-check-circle"></i> Terhubung dengan Firebase';
        document.body.appendChild(connectionStatus);
        
        setTimeout(() => {
            connectionStatus.style.display = 'none';
        }, 3000);
    }

    // Fungsi untuk menampilkan notifikasi
    function showNotification(message, type = 'info') {
        if (!notificationContainer) {
            console.error('Notification container not found');
            return;
        }
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
            <button class="notification-close">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        notificationContainer.appendChild(notification);
        
        const closeBtn = notification.querySelector('.notification-close');
        closeBtn.addEventListener('click', function() {
            closeNotification(notification);
        });
        
        const timeoutId = setTimeout(() => {
            closeNotification(notification);
        }, 5000);
        
        notification.dataset.timeoutId = timeoutId;
    }

    function closeNotification(notification) {
        if (notification.dataset.timeoutId) {
            clearTimeout(parseInt(notification.dataset.timeoutId));
        }
        
        notification.classList.add('hiding');
        
        setTimeout(() => {
            if (notification.parentElement) {
                notificationContainer.removeChild(notification);
            }
        }, 500);
    }

    // Fungsi untuk memastikan user document ada
    async function ensureUserDocument(user) {
        try {
            const userRef = db.collection('users').doc(user.uid);
            const userDoc = await userRef.get();
            
            const superAdminEmails = [
                "superadmin@gachaengine.com",
                "admin@gachaengine.com"
            ];
            
            const isSuperAdmin = superAdminEmails.includes(user.email);
            
            if (userDoc.exists) {
                const currentData = userDoc.data();
                const updateData = {
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    email: user.email,
                    displayName: user.displayName || currentData.displayName || user.email
                };
                
                if (!currentData.hasOwnProperty('role')) {
                    updateData.role = isSuperAdmin ? 'super_admin' : 'user';
                }
                if (!currentData.hasOwnProperty('isSuperAdmin')) {
                    updateData.isSuperAdmin = isSuperAdmin;
                }
                
                await userRef.update(updateData);
                return { ...currentData, ...updateData };
            } else {
                const newUserDoc = {
                    email: user.email,
                    displayName: user.displayName || user.email,
                    role: isSuperAdmin ? 'super_admin' : 'user',
                    isSuperAdmin: isSuperAdmin,
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await userRef.set(newUserDoc);
                return newUserDoc;
            }
        } catch (error) {
            console.error('Error ensuring user document:', error);
            throw error;
        }
    }

    // Fungsi untuk memeriksa autentikasi pengguna
    async function checkAuth() {
        return new Promise((resolve, reject) => {
            const unsubscribe = auth.onAuthStateChanged(async user => {
                unsubscribe();
                if (user) {
                    currentUser = user;
                    try {
                        currentUserData = await ensureUserDocument(user);
                        resolve(user);
                    } catch (error) {
                        reject(error);
                    }
                } else {
                    reject(new Error('User not authenticated'));
                }
            });
        });
    }

    // Fungsi untuk mendapatkan research details dari tabel
    function getResearchDetailsFromTable() {
        if (!researchDetailTbody) {
            console.error('researchDetailTbody not found');
            return [];
        }
        
        const rows = researchDetailTbody.querySelectorAll('tr');
        const details = [];
        
        rows.forEach(row => {
            const categorySelect = row.querySelector('.detail-category');
            const descriptionTextarea = row.querySelector('.detail-description');
            const urlInput = row.querySelector('.detail-url');
            
            const category = categorySelect ? categorySelect.value : '';
            const description = descriptionTextarea ? descriptionTextarea.value : '';
            const url = urlInput ? urlInput.value.trim() : '';
            
            if (category && description) {
                details.push({
                    category,
                    description,
                    url: url || null
                });
            }
        });
        
        return details;
    }

    // Fungsi untuk mengisi research details ke tabel
    function populateResearchDetailsTable(details) {
        if (!researchDetailTbody) {
            console.error('researchDetailTbody not found');
            return;
        }
        
        researchDetailTbody.innerHTML = '';
        
        if (details && details.length > 0) {
            details.forEach(detail => {
                addResearchDetailRow(detail);
            });
        } else {
            addResearchDetailRow();
        }
    }

    // Fungsi untuk menambah baris research detail
    function addResearchDetailRow(data = {}) {
        if (!researchDetailTbody) {
            console.error('researchDetailTbody not found');
            return;
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <select class="table-select detail-category" required>
                    <option value="">Pilih kategori</option>
                    <option value="Tampilan UIUX" ${data.category === 'Tampilan UIUX' ? 'selected' : ''}>Tampilan UI/UX</option>
                    <option value="Fitur System" ${data.category === 'Fitur System' ? 'selected' : ''}>Fitur/System</option>
                    <option value="Provider Game" ${data.category === 'Provider Game' ? 'selected' : ''}>Provider/Game</option>
                    <option value="Promosi" ${data.category === 'Promosi' ? 'selected' : ''}>Promosi</option>
                    <option value="Other" ${data.category === 'Other' ? 'selected' : ''}>Other</option>
                </select>
            </td>
            <td>
                <textarea class="table-textarea detail-description" placeholder="Deskripsi research..." required>${data.description || ''}</textarea>
            </td>
            <td>
                <input type="url" class="table-input detail-url" placeholder="https://example.com" value="${data.url || ''}">
            </td>
            <td>
                <button type="button" class="delete-row-btn" onclick="this.closest('tr').remove()">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        researchDetailTbody.appendChild(row);
    }

    // Fungsi untuk menyimpan research ke Firestore
    async function saveResearch(researchData, targetUserId = null) {
        try {
            await checkAuth();
            
            // Tentukan user ID target
            let targetUserUid;
            let targetUserEmail;
            let targetUserName;
            
            if (targetUserId && currentUserData && currentUserData.isSuperAdmin) {
                // Super Admin bisa pilih user lain
                targetUserUid = targetUserId;
                
                // Dapatkan data user target
                try {
                    const targetUserDoc = await db.collection('users').doc(targetUserId).get();
                    if (targetUserDoc.exists) {
                        const targetUserData = targetUserDoc.data();
                        targetUserEmail = targetUserData.email;
                        targetUserName = targetUserData.displayName || targetUserData.email;
                    } else {
                        targetUserEmail = currentUser.email;
                        targetUserName = currentUser.displayName || currentUser.email;
                    }
                } catch (error) {
                    console.error('Error getting target user data:', error);
                    targetUserEmail = currentUser.email;
                    targetUserName = currentUser.displayName || currentUser.email;
                }
            } else {
                // User biasa hanya untuk dirinya sendiri
                targetUserUid = currentUser.uid;
                targetUserEmail = currentUser.email;
                targetUserName = currentUser.displayName || currentUser.email;
            }
            
            // Siapa yang membuat research? (bisa berbeda dengan user target)
            const createdBy = {
                uid: currentUser.uid,
                email: currentUser.email,
                name: currentUser.displayName || currentUser.email,
                isSuperAdmin: currentUserData.isSuperAdmin || false
            };
            
            const researchWithUser = {
                platform: researchData.platform,
                details: researchData.details || [],
                userId: targetUserUid,
                userEmail: targetUserEmail,
                userName: targetUserName,
                createdBy: createdBy,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pending'
            };
            
            if (researchData.id) {
                // Update existing research
                await db.collection('research').doc(researchData.id).update({
                    platform: researchData.platform,
                    details: researchData.details || [],
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return researchData.id;
            } else {
                // Create new research
                const docRef = await db.collection('research').add(researchWithUser);
                return docRef.id;
            }
        } catch (error) {
            console.error('Error saving research:', error);
            throw error;
        }
    }

    // Fungsi untuk menghapus research dari Firestore
    async function deleteResearchFromFirestore(researchId) {
        try {
            await checkAuth();
            await db.collection('research').doc(researchId).delete();
        } catch (error) {
            console.error('Error deleting research:', error);
            throw error;
        }
    }

    // Fungsi untuk membuat dropdown user selector
    async function createUserSelector() {
        if (!currentUserData || !currentUserData.isSuperAdmin) return;
        
        try {
            const usersSnapshot = await db.collection('users').get();
            const userSelectContainer = document.getElementById('userSelectContainer');
            
            if (!userSelectContainer) {
                // Tambahkan dropdown untuk memilih user
                const platformGroup = document.querySelector('label[for="researchPlatform"]').parentElement;
                const userSelectHTML = `
                    <div class="form-group" id="userSelectContainer">
                        <label for="researchUser" class="form-label">User Target*</label>
                        <select id="researchUser" class="form-control form-select" required>
                            <option value="">Pilih User</option>
                        </select>
                    </div>
                `;
                platformGroup.insertAdjacentHTML('beforebegin', userSelectHTML);
            }
            
            const researchUserSelect = document.getElementById('researchUser');
            researchUserSelect.innerHTML = '<option value="">Pilih User</option>';
            
            usersSnapshot.forEach(doc => {
                const userData = doc.data();
                const option = document.createElement('option');
                option.value = doc.id; // User UID
                option.textContent = `${userData.displayName || 'No Name'} (${userData.email})`;
                if (doc.id === currentUser.uid) {
                    option.textContent += ' (Anda)';
                    option.selected = true;
                }
                researchUserSelect.appendChild(option);
            });
            
        } catch (error) {
            console.error('Error loading users:', error);
            showNotification('Gagal memuat daftar user', 'error');
        }
    }

    // Fungsi untuk menangani submit form
    async function handleSubmitResearch(e) {
        e.preventDefault();
        
        // Pastikan user sudah login
        if (!currentUser) {
            showNotification('Silakan login terlebih dahulu', 'error');
            return;
        }
        
        const platform = document.getElementById('researchPlatform').value;
        
        if (!platform) {
            showNotification('Harap isi platform/agent research', 'error');
            return;
        }
        
        const researchDetails = getResearchDetailsFromTable();
        
        if (researchDetails.length === 0) {
            showNotification('Harap tambahkan minimal satu detail research', 'error');
            return;
        }
        
        // Ambil target user ID jika Super Admin
        let targetUserId = null;
        if (currentUserData && currentUserData.isSuperAdmin) {
            const userSelect = document.getElementById('researchUser');
            if (userSelect) {
                targetUserId = userSelect.value;
                if (!targetUserId) {
                    showNotification('Harap pilih user target', 'error');
                    return;
                }
            }
        }
        
        submitButton.classList.add('btn-loading');
        submitButton.disabled = true;
        
        try {
            const newResearch = {
                platform,
                details: researchDetails
            };
            
            if (currentEditId) {
                newResearch.id = currentEditId;
            }
            
            await saveResearch(newResearch, targetUserId);
            
            researchForm.reset();
            populateResearchDetailsTable([]);
            
            // Reset user selector ke default
            if (currentUserData && currentUserData.isSuperAdmin && document.getElementById('researchUser')) {
                document.getElementById('researchUser').value = currentUser.uid;
            }
            
            submitButton.classList.remove('btn-loading');
            submitButton.disabled = false;
            
            showNotification(currentEditId ? 'Research berhasil diperbarui!' : 'Research berhasil disimpan!', 'success');
            
            currentEditId = null;
            
        } catch (error) {
            console.error('Error saving research:', error);
            showNotification('Gagal menyimpan research: ' + error.message, 'error');
            
            submitButton.classList.remove('btn-loading');
            submitButton.disabled = false;
        }
    }

    // Fungsi untuk update pagination UI
    function updatePaginationUI(totalItems) {
        const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));

        if (paginationContainer) {
            paginationContainer.style.display = totalItems > 0 ? 'flex' : 'none';
        }

        if (currentPage > totalPages) currentPage = totalPages;

        if (pageInfo) pageInfo.textContent = `Page ${currentPage} / ${totalPages}`;
        if (prevPageBtn) prevPageBtn.disabled = currentPage <= 1;
        if (nextPageBtn) nextPageBtn.disabled = currentPage >= totalPages;
    }

    // Fungsi untuk merender daftar research
    function renderResearchList(filteredResearch = null) {
        const researchToRender = filteredResearch || researchData;
        currentFilteredResearch = filteredResearch;

        if (researchToRender.length === 0) {
            emptyState.style.display = 'block';
            researchGrid.style.display = 'none';
            updatePaginationUI(0);
            return;
        }

        emptyState.style.display = 'none';
        researchGrid.style.display = 'grid';
        researchGrid.innerHTML = '';

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pagedResearch = researchToRender.slice(startIndex, endIndex);

        updatePaginationUI(researchToRender.length);

        // Cek jika pagedResearch kosong
        if (!pagedResearch || pagedResearch.length === 0) {
            emptyState.style.display = 'block';
            researchGrid.style.display = 'none';
            return;
        }

        pagedResearch.forEach(research => {
            const researchCard = document.createElement('div');
            researchCard.className = 'research-card fade-in';
            
            const createdDate = research.createdAt
                ? (research.createdAt.toDate ? research.createdAt.toDate() : new Date(research.createdAt))
                : new Date();
            const formattedDate = createdDate.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            let statusClass = '';
            let statusText = '';
            
            switch(research.status) {
                case 'pending':
                    statusClass = 'status-pending';
                    statusText = 'Dalam Proses';
                    break;
                case 'completed':
                    statusClass = 'status-completed';
                    statusText = 'Selesai';
                    break;
                case 'overdue':
                    statusClass = 'status-overdue';
                    statusText = 'Terlambat';
                    break;
                default:
                    statusClass = 'status-pending';
                    statusText = 'Dalam Proses';
            }
            
            // Tentukan informasi user untuk ditampilkan
            let displayName = '';
            let displayRole = '';
            
            // Gunakan data dari research jika ada
            if (research.userName) {
                displayName = research.userName;
                displayRole = 'Customer Service Support';
            } else if (research.userEmail) {
                displayName = research.userEmail;
                displayRole = 'Customer Service Support';
            } else if (research.createdBy && research.createdBy.name) {
                displayName = research.createdBy.name;
                displayRole = research.createdBy.isSuperAdmin ? 'Super Admin' : 'Customer Service Support';
            } else {
                // Fallback ke currentUser
                displayName = currentUser ? (currentUser.displayName || currentUser.email) : 'Unknown User';
                displayRole = currentUserData && currentUserData.isSuperAdmin ? 'Super Admin' : 'Customer Service Support';
            }
            
            // Info pemilik untuk Super Admin
            const ownerInfo = currentUserData && currentUserData.isSuperAdmin ? 
                `<div class="card-meta" style="margin-bottom: 10px; font-size: 12px; color: var(--text-secondary);">
                    <div class="meta-item">
                        <i class="fas fa-user"></i>
                        <span>User ID: ${research.userId || 'N/A'}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-envelope"></i>
                        <span>Email: ${research.userEmail || 'No email'}</span>
                    </div>
                </div>` : '';
            
            let detailsHtml = 'Tidak ada detail';
            if (research.details && research.details.length > 0) {
                detailsHtml = research.details.map(detail => {
                    if (detail.url) {
                        return `<a href="${detail.url}" target="_blank" class="detail-link">
                            <i class="fas fa-external-link-alt"></i> ${detail.category}
                        </a>`;
                    } else {
                        return `<span>${detail.category}</span>`;
                    }
                }).join(', ');
            }
            
            researchCard.innerHTML = `
                <div class="research-header">
                    <div>
                        <h3 class="research-title">${research.platform || 'No Platform'}</h3>
                        <p class="research-date"><i class="far fa-calendar-alt"></i> ${formattedDate}</p>
                    </div>
                    <span class="research-status ${statusClass}">
                        <i class="fas fa-circle"></i> ${statusText}
                    </span>
                </div>
                
                ${ownerInfo}
                
                <p class="research-details">${detailsHtml}</p>
                
                <div class="research-footer">
                    <div class="research-author">
                        <img class="author-avatar" src="https://iili.io/Fpiva7S.png" alt="Author">
                        <div class="author-info">
                            <span class="author-name">${displayName}</span>
                            <span class="author-role">${displayRole}</span>
                        </div>
                    </div>
                </div>
                
                <div class="research-actions">
                    ${currentUserData && (currentUserData.isSuperAdmin || (research.userId === currentUser.uid)) ? `
                        <button class="btn-icon edit" data-id="${research.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon delete" data-id="${research.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : `
                        <span style="color: var(--text-secondary); font-size: var(--text-xs);">Read Only</span>
                    `}
                </div>
            `;
            
            researchGrid.appendChild(researchCard);
            
            if (currentUserData && (currentUserData.isSuperAdmin || research.userId === currentUser.uid)) {
                const editBtn = researchCard.querySelector('.btn-icon.edit');
                const deleteBtn = researchCard.querySelector('.btn-icon.delete');
                
                if (editBtn) {
                    editBtn.addEventListener('click', function() {
                        editResearch(research.id);
                    });
                }
                
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function() {
                        deleteResearch(research.id);
                    });
                }
            }
        });
    }

    // Fungsi untuk mengedit research
    function editResearch(id) {
        const research = researchData.find(item => item.id === id);
        
        if (!research) return;
        
        if (!currentUserData.isSuperAdmin && research.userId !== currentUser.uid) {
            showNotification('Anda tidak memiliki izin untuk mengedit research ini', 'error');
            return;
        }
        
        currentEditId = research.id;
        
        document.getElementById('researchPlatform').value = research.platform;
        
        // Set user selector untuk Super Admin
        if (currentUserData && currentUserData.isSuperAdmin && document.getElementById('researchUser')) {
            document.getElementById('researchUser').value = research.userId;
        }
        
        if (research.details) {
            populateResearchDetailsTable(research.details);
        } else {
            populateResearchDetailsTable([]);
        }
        
        researchForm.scrollIntoView({ behavior: 'smooth' });
        showNotification('Anda sedang dalam mode edit. Perbarui data dan klik "Simpan Research" untuk menyimpan perubahan.', 'info');
    }

    // Fungsi untuk menghapus research
    async function deleteResearch(id) {
        const research = researchData.find(item => item.id === id);
        if (!research) return;
        
        if (!currentUserData.isSuperAdmin && research.userId !== currentUser.uid) {
            showNotification('Anda tidak memiliki izin untuk menghapus research ini', 'error');
            return;
        }
        
        if (confirm('Apakah Anda yakin ingin menghapus research ini?')) {
            try {
                await deleteResearchFromFirestore(id);
                showNotification('Research berhasil dihapus', 'success');
                
                if (currentEditId === id) {
                    currentEditId = null;
                    researchForm.reset();
                    populateResearchDetailsTable([]);
                }
                
            } catch (error) {
                console.error('Error deleting research:', error);
                showNotification('Gagal menghapus research', 'error');
            }
        }
    }

    // Fungsi untuk memperbarui statistik
    function updateResearchStats() {
        const totalResearch = researchData.length;
        const completedResearch = researchData.filter(item => item.status === 'completed').length;
        const pendingResearch = researchData.filter(item => item.status === 'pending' || item.status === 'overdue').length;
        const kpiResearch = Math.min(100, Math.round((totalResearch / researchTarget) * 100));
        
        if (totalResearchEl) totalResearchEl.textContent = totalResearch;
        if (completedResearchEl) completedResearchEl.textContent = completedResearch;
        if (pendingResearchEl) pendingResearchEl.textContent = pendingResearch;
        if (kpiResearchEl) kpiResearchEl.textContent = `${kpiResearch}%`;
        
        setTimeout(() => {
            if (totalProgress) totalProgress.style.width = `${Math.min(100, (totalResearch / researchTarget) * 100)}%`;
            if (completedProgress) completedProgress.style.width = `${completedResearch > 0 ? (completedResearch / totalResearch) * 100 : 0}%`;
            if (pendingProgress) pendingProgress.style.width = `${pendingResearch > 0 ? (pendingResearch / totalResearch) * 100 : 0}%`;
            if (kpiProgress) kpiProgress.style.width = `${kpiResearch}%`;
        }, 100);
        
        updateResearchKPI(totalResearch);
    }

    // Fungsi untuk memperbarui KPI
    function updateResearchKPI(count) {
        const researchScore = Math.min(100, (count / researchTarget) * 100);
        
        localStorage.setItem('researchCount', count);
        
        window.dispatchEvent(new CustomEvent('researchDataChanged', { 
            detail: { researchCount: count } 
        }));
        
        if (connectionStatus) {
            connectionStatus.className = 'connection-status status-connected';
            connectionStatus.innerHTML = '<i class="fas fa-check-circle"></i> Data research tersimpan di Firebase';
            connectionStatus.style.display = 'flex';
            
            setTimeout(() => {
                connectionStatus.style.display = 'none';
            }, 3000);
        }
        
        return researchScore;
    }

    // Fungsi untuk memfilter research
    function filterResearch() {
        const searchTerm = searchResearch.value.toLowerCase();
        
        if (!searchTerm) {
            currentPage = 1;
            renderResearchList();
            return;
        }
        
        const filteredResearch = researchData.filter(research => 
            research.platform.toLowerCase().includes(searchTerm) ||
            (research.details && research.details.some(detail => 
                detail.category.toLowerCase().includes(searchTerm) ||
                detail.description.toLowerCase().includes(searchTerm)
            ))
        );
        
        currentPage = 1;
        renderResearchList(filteredResearch);
    }

    // Setup real-time listener
    function setupRealTimeListener() {
        if (unsubscribeResearch) {
            unsubscribeResearch();
        }
        
        let query;
        
        if (currentUserData && currentUserData.isSuperAdmin) {
            query = db.collection('research');
        } else {
            query = db.collection('research').where('userId', '==', currentUser.uid);
        }
        
        unsubscribeResearch = query.onSnapshot(snapshot => {
            researchData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            // Sort berdasarkan tanggal terbaru
            researchData.sort((a, b) => {
                const dateA = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
                const dateB = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
                return dateB - dateA;
            });
            
            // Reset ke halaman 1 saat data berubah
            currentPage = 1;
            
            renderResearchList();
            updateResearchStats();
            
            if (currentUserData && currentUserData.isSuperAdmin) {
                showNotification(`Super Admin Mode: Memuat ${researchData.length} research dari semua user`, 'info');
            }
        }, error => {
            console.error('Error in real-time listener:', error);
            showNotification('Gagal memuat data real-time', 'error');
        });
    }

    // Update user profile info
    function updateUserProfile(user, userData) {
        const userProfile = document.querySelector('.user-info h4');
        const userRole = document.querySelector('.user-info p');
        
        if (userProfile) {
            const displayName = userData?.displayName || user.displayName || user.email || 'User';
            userProfile.textContent = displayName;
        }
        
        if (userRole) {
            const roleText = userData && userData.isSuperAdmin ? 
                'Super Administrator' : 
                'Customer Service Support';
            userRole.textContent = roleText;
            
            if (userData && userData.isSuperAdmin) {
                const headerTitle = document.querySelector('.header h1');
                if (headerTitle && !headerTitle.querySelector('.super-admin-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'super-admin-badge';
                    badge.style.background = 'var(--warning-gradient)';
                    badge.style.color = 'white';
                    badge.style.padding = '2px 8px';
                    badge.style.borderRadius = '12px';
                    badge.style.fontSize = 'var(--text-xs)';
                    badge.style.marginLeft = '8px';
                    badge.textContent = 'Super Admin';
                    headerTitle.appendChild(badge);
                }
            }
        }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('DOM Content Loaded - Initializing Research Dashboard');
        
        try {
            await checkAuth();
            await createUserSelector();

            console.log('User authenticated:', currentUser.uid, 'Role:', currentUserData.role);
            
            setupRealTimeListener();
            
            if (researchForm) {
                researchForm.addEventListener('submit', handleSubmitResearch);
            }
            
            if (searchResearch) {
                searchResearch.addEventListener('input', filterResearch);
            }
            
            if (refreshResearch) {
                refreshResearch.addEventListener('click', function() {
                    renderResearchList();
                    showNotification('Daftar research diperbarui', 'info');
                });
            }
            
            if (addRowBtn) {
                addRowBtn.addEventListener('click', function() {
                    addResearchDetailRow();
                });
            }
            
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderResearchList(currentFilteredResearch);
                    }
                });
            }
            
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', () => {
                    const data = currentFilteredResearch || researchData;
                    const totalPages = Math.max(1, Math.ceil(data.length / pageSize));
            
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderResearchList(currentFilteredResearch);
                    }
                });
            }
            
            updateUserProfile(currentUser, currentUserData);
            
            populateResearchDetailsTable([]);
            
            console.log('Research dashboard initialized successfully');
            
        } catch (error) {
            console.error('Authentication error:', error);
            showNotification('Silakan login untuk mengakses dashboard research', 'error');
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 3000);
        }
    });

    // Handle auth state changes
    auth.onAuthStateChanged(async user => {
        if (user) {
            currentUser = user;
            try {
                currentUserData = await ensureUserDocument(user);
                console.log('User is signed in:', user.uid, 'Role:', currentUserData.role);
                
                if (unsubscribeResearch) {
                    unsubscribeResearch();
                }
                setupRealTimeListener();
                updateUserProfile(user, currentUserData);
                
            } catch (error) {
                console.error('Error handling auth state:', error);
            }
            
        } else {
            console.log('User is signed out');
            if (unsubscribeResearch) {
                unsubscribeResearch();
            }
            showNotification('Anda telah logout', 'info');
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        }
    });

    // Tambahkan pengecekan null untuk semua event listener
    window.addEventListener('beforeunload', () => {
        if (unsubscribeResearch) {
            unsubscribeResearch();
        }
    });
</script>
</body>
</html>
