<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solved Reports - My Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/charts.css/dist/charts.min.css">
    <link rel="stylesheet" href="global.css">
        <link rel="stylesheet" href="stylemobile.css">
        <script src="global-time.js"></script>
    <style>
:root {
    --primary-gradient: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
    --success-gradient: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
    --warning-gradient: linear-gradient(135deg, #f72585 0%, #7209b7 100%);
    --info-gradient: linear-gradient(135deg, #4895ef 0%, #3f37c9 100%);
}

/* ========== PERBAIKAN UTAMA UNTUK LAYOUT ========== */
.main-content {
    padding: var(--space-lg);
    background-color: var(--bg-secondary);
    min-height: 100vh;
}

.header {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin-bottom: var(--space-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

/* ========== PERBAIKAN STATISTIC CARDS ========== */
.filter-panel {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    margin-bottom: var(--space-lg);
}

.filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--border-color);
}

.filter-title {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin: 0;
}

.filter-reset {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: var(--space-sm) var(--space-md);
    color: var(--text-secondary);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
}

.filter-reset:hover {
    background: var(--hover-color);
    color: var(--text-primary);
    border-color: var(--primary);
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-lg);
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.filter-label {
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.filter-select {
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background-color: var(--input-bg);
    color: var(--text-primary);
    font-size: var(--text-sm);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    height: 42px;
}

.filter-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

/* ========== PERBAIKAN KHUSUS UNTUK DATE RANGE ========== */
.date-range-inputs {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    height: 42px;
}

.date-range-inputs .filter-select {
    flex: 1;
    min-width: 0;
}

.date-range-inputs span {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    font-weight: var(--font-medium);
    white-space: nowrap;
}

/* Responsive adjustments untuk date range */
@media (max-width: 768px) {
    .filter-grid {
        grid-template-columns: 1fr;
        gap: var(--space-md);
    }
    
    .date-range-inputs {
        flex-direction: column;
        height: auto;
        gap: var(--space-xs);
    }
    
    .date-range-inputs span {
        align-self: center;
        padding: var(--space-xs) 0;
    }
}

@media (max-width: 480px) {
    .filter-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-md);
    }
    
    .filter-reset {
        align-self: stretch;
        justify-content: center;
    }
}   


/* ========== PERBAIKAN CHART SECTION ========== */
.chart-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: var(--space-lg);
    margin-bottom: var(--space-xl);
}

.chart-card {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
}

.chart-title {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin: 0;
}

.chart-container {
    position: relative;
    min-height: 280px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

/* Enhanced Brand Chart - Horizontal Bars */
.enhanced-bar-chart {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 15px;
    height: 100%;
}

.bar-item {
    display: flex;
    align-items: center;
    gap: 15px;
    animation: slideInRight 0.6s ease-out forwards;
    opacity: 0;
}

.bar-label {
    min-width: 120px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    text-align: right;
}

.bar-track {
    flex-grow: 1;
    height: 24px;
    background: var(--bg-secondary);
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}

.bar-fill {
    height: 100%;
    border-radius: 12px;
    background: var(--primary-gradient);
    position: relative;
    transition: width 1s ease-out;
    width: 0;
}

.bar-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255,255,255,0.3) 50%, 
                transparent 100%);
    animation: barShine 2s infinite;
}

.bar-value {
    min-width: 80px;
    text-align: left;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    display: flex;
    justify-content: space-between;
}

.bar-count {
    color: var(--text-primary);
    font-weight: 700;
}

@keyframes barShine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(200%); }
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Enhanced Pie Chart */
.enhanced-pie-container {
    position: relative;
    width: 220px;
    height: 220px;
    margin: 0 auto;
}

.enhanced-pie-chart {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    overflow: hidden;
    transform: rotate(-90deg);
    background: var(--bg-secondary);
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.pie-segment-enhanced {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    clip-path: polygon(50% 50%, 50% 0%, 100% 0%, 100% 100%, 50% 100%);
    transform-origin: center;
    transition: all 0.3s ease;
}

.pie-segment-enhanced:hover {
    transform: scale(1.02) rotate(0deg);
    z-index: 2;
    filter: brightness(1.1);
}

.pie-center-enhanced {
    position: absolute;
    width: 90px;
    height: 90px;
    background: var(--card-bg);
    border-radius: 50%;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: var(--text-primary);
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    z-index: 1;
}

.pie-total {
    font-size: 1.5rem;
    line-height: 1;
}

.pie-total-label {
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    margin-top: 2px;
}

.enhanced-legend {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 25px;
    padding: 0 20px;
}

.legend-item-enhanced {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    border-radius: 8px;
    background: var(--bg-secondary);
    transition: all 0.2s ease;
    cursor: pointer;
}

.legend-item-enhanced:hover {
    background: var(--hover-color);
    transform: translateX(5px);
}

.legend-color-container {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
}

.legend-color-box {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    flex-shrink: 0;
}

.legend-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
}

.legend-value {
    font-size: 13px;
    font-weight: 700;
    color: var(--text-primary);
}

/* Tooltip for charts */
.chart-tooltip {
    position: absolute;
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    border-radius: 4px;
    font-size: 12px;
    pointer-events: none;
    z-index: 10;
    opacity: 0;
    transition: opacity 0.3s;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.chart-tooltip::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 5px 5px 0 5px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
}

/* Empty state for charts */
.enhanced-empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 30px;
    text-align: center;
    color: var(--text-tertiary);
}

.enhanced-empty-state i {
    font-size: 3.5rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.enhanced-empty-state h4 {
    font-size: 1.1rem;
    margin-bottom: 8px;
    color: var(--text-secondary);
}

.enhanced-empty-state p {
    font-size: 0.9rem;
    max-width: 300px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .enhanced-pie-container {
        width: 180px;
        height: 180px;
    }
    
    .pie-center-enhanced {
        width: 70px;
        height: 70px;
    }
    
    .pie-total {
        font-size: 1.2rem;
    }
    
    .bar-label {
        min-width: 90px;
        font-size: 12px;
    }
    
    .bar-value {
        min-width: 60px;
        font-size: 12px;
    }
}

@media (max-width: 480px) {
    .enhanced-pie-container {
        width: 150px;
        height: 150px;
    }
    
    .pie-center-enhanced {
        width: 60px;
        height: 60px;
    }
    
    .pie-total {
        font-size: 1rem;
    }
    
    .enhanced-legend {
        padding: 0 10px;
    }
    
    .legend-item-enhanced {
        padding: 6px 8px;
    }
}

/* ========== PERBAIKAN FILTER SECTION ========== */
.maintenance-filters {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
    padding: var(--space-lg);
    background-color: var(--card-bg);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
}

.filter-group label {
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.filter-select {
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background-color: var(--input-bg);
    color: var(--text-primary);
    font-size: var(--text-sm);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    height: 42px;
}

.filter-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

/* ========== PERBAIKAN ACTION BUTTONS ========== */
.maintenance-actions {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
    align-items: center;
}

.view-toggle {
    display: flex;
    gap: var(--space-xs);
    background: var(--bg-secondary);
    padding: var(--space-xs);
    border-radius: var(--radius-md);
}

.view-toggle .btn-icon {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    color: var(--text-secondary);
    border: none;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.view-toggle .btn-icon.active,
.view-toggle .btn-icon:hover {
    background: var(--card-bg);
    color: var(--primary);
    box-shadow: var(--shadow-xs);
}

/* ========== PERBAIKAN TABLE ========== */
.activities-section {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    margin-bottom: var(--space-xl);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--border-color);
}

.section-title {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin: 0;
}

.section-actions {
    font-size: var(--text-sm);
    color: var(--text-secondary);
}

.maintenance-table-container {
    overflow-x: auto;
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    margin-bottom: var(--space-lg);
}

.maintenance-table {
    margin: 0;
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 900px;
}

.maintenance-table th {
    padding: var(--space-md) var(--space-lg);
    background: var(--table-header-bg);
    font-weight: var(--font-semibold);
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-color);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    text-align: left;
    position: sticky;
    top: 0;
}

.maintenance-table td {
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
    font-size: var(--text-sm);
    vertical-align: middle;
    line-height: 1.5;
}

.maintenance-table tr:last-child td {
    border-bottom: none;
}

.maintenance-table tr:hover {
    background-color: var(--hover-color);
    transition: background-color var(--transition-fast);
}

/* Perbaikan untuk Priority Badges */
.priority-high, .priority-medium, .priority-low {
    padding: 6px 12px;
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    display: inline-block;
    text-align: center;
    min-width: 80px;
    letter-spacing: 0.3px;
}

.priority-high {
    background-color: var(--danger-light);
    color: var(--danger);
    border: 1px solid rgba(239, 68, 68, 0.2);
}

.priority-medium {
    background-color: var(--warning-light);
    color: var(--warning);
    border: 1px solid rgba(245, 158, 11, 0.2);
}

.priority-low {
    background-color: var(--success-light);
    color: var(--success);
    border: 1px solid rgba(16, 185, 129, 0.2);
}

/* Perbaikan untuk Action Buttons */
.action-buttons {
    display: flex;
    gap: var(--space-xs);
    justify-content: flex-start;
    flex-wrap: nowrap;
}

.btn-icon {
    width: 34px;
    height: 34px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    transition: all var(--transition-fast);
    font-size: var(--text-sm);
    padding: 0;
    box-shadow: var(--shadow-xs);
}

.btn-icon.view {
    background: var(--info-light);
    color: var(--info);
}

.btn-icon:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
    opacity: 0.9;
}

/* ========== PERBAIKAN EMPTY STATE ========== */
.empty-state {
    text-align: center;
    padding: var(--space-xl) var(--space-lg);
    background-color: var(--card-bg);
    border-radius: var(--radius-lg);
    border: 2px dashed var(--border-color);
    margin: var(--space-lg) 0;
}

.empty-state i {
    font-size: 3rem;
    color: var(--text-tertiary);
    margin-bottom: var(--space-md);
}

.empty-state h3 {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.empty-state p {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    margin-bottom: var(--space-lg);
}

/* ========== PERBAIKAN PAGINATION ========== */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--space-md);
    margin-top: var(--space-lg);
    padding: var(--space-md) 0;
}

.page-numbers {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    font-weight: var(--font-medium);
}

/* ========== PERBAIKAN MODAL ========== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: var(--z-modal);
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-normal);
}

.modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

.modal {
    background: var(--card-bg);
    border-radius: var(--radius-xl);
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-2xl);
    transform: translateY(20px);
    transition: transform var(--transition-normal);
    border: 1px solid var(--border-color);
}

.modal-overlay.active .modal {
    transform: translateY(0);
}

.modal-header {
    padding: var(--space-xl) var(--space-xl) var(--space-md);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--primary-gradient);
    color: white;
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
}

.modal-title {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: white;
    margin: 0;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.modal-close {
    background: rgb(230, 210, 210);
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: white;
    padding: 0;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-full);
    transition: all var(--transition-fast);
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.modal-body {
    padding: var(--space-xl);
}

.modal-footer {
    padding: var(--space-lg) var(--space-xl);
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: var(--space-sm);
    background: var(--bg-secondary);
    border-radius: 0 0 var(--radius-xl) var(--radius-xl);
}

/* Form input static (readonly) */
.form-input-static {
    padding: var(--space-sm) 0;
    color: var(--text-primary);
    font-size: var(--text-sm);
    line-height: var(--leading-normal);
    min-height: 20px;
}

/* Time tracking styles */
.time-tracking {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    background: var(--bg-secondary);
    padding: var(--space-md);
    border-radius: var(--radius-md);
}

.time-track-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-xs) 0;
}

.time-track-label {
    font-weight: var(--font-medium);
    color: var(--text-secondary);
}

.time-track-value {
    font-weight: var(--font-semibold);
    color: var(--text-primary);
}

/* Report details styling */
.report-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
    padding: var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
}

.report-detail-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
}

.report-detail-label {
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.report-detail-value {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-primary);
    word-break: break-word;
}

/* Status info grid */
.status-info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
}

.status-info-item {
    padding: var(--space-md);
    border-radius: var(--radius-lg);
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    text-align: center;
}

.status-info-label {
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: var(--space-xs);
}

.status-info-value {
    font-size: var(--text-md);
    font-weight: var(--font-bold);
    color: var(--text-primary);
}

/* Report description and resolution */
.report-description, .report-resolution {
    margin-bottom: var(--space-xl);
    padding: var(--space-lg);
    border-radius: var(--radius-lg);
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
}

.report-description h4, .report-resolution h4 {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-xs);
    border-bottom: 2px solid var(--primary);
    display: inline-block;
}

.report-description div, .report-resolution div {
    font-size: var(--text-sm);
    line-height: 1.6;
    color: var(--text-primary);
    white-space: pre-wrap;
}

/* Enhanced buttons in modal footer */
.modal-footer .btn {
    padding: var(--space-sm) var(--space-lg);
    border-radius: var(--radius-md);
    font-weight: var(--font-semibold);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    transition: all var(--transition-fast);
}

.modal-footer .btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

/* Confirmation modal enhancements */
.confirm-modal {
    max-width: 500px;
}

.confirm-icon {
    text-align: center;
    margin-bottom: var(--space-lg);
}

.confirm-icon i {
    font-size: 3rem;
    color: var(--warning);
}

.confirm-message {
    text-align: center;
    font-size: var(--text-lg);
    margin-bottom: var(--space-xl);
    line-height: 1.5;
}

.confirm-actions {
    display: flex;
    justify-content: center;
    gap: var(--space-md);
}

/* ========== ANIMATIONS ========== */
.fade-in {
    animation: fadeIn 0.5s ease forwards;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Animation for modal content */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-body > * {
    animation: slideIn 0.3s ease forwards;
}

.modal-body > *:nth-child(1) { animation-delay: 0.1s; }
.modal-body > *:nth-child(2) { animation-delay: 0.2s; }
.modal-body > *:nth-child(3) { animation-delay: 0.3s; }
.modal-body > *:nth-child(4) { animation-delay: 0.4s; }

/* ========== TOAST NOTIFICATION ========== */
.toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: var(--radius-md);
    color: white;
    z-index: var(--z-modal);
    max-width: 300px;
    box-shadow: var(--shadow-lg);
    opacity: 0;
    transform: translateY(-30px);
    pointer-events: none;
    animation: toast-in 0.5s ease forwards;
}

/* Animation for showing toast */
@keyframes toast-in {
    0% {
        opacity: 0;
        transform: translateY(-30px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Animation for hiding toast */
@keyframes toast-out {
    0% {
        opacity: 1;
        transform: translateY(0);
    }
    100% {
        opacity: 0;
        transform: translateY(-20px);
    }
}

.toast-notification.hide {
    animation: toast-out 0.4s ease forwards;
}

/* Status colors */
.toast-notification.success {
    background-color: var(--success);
}

.toast-notification.error {
    background-color: var(--danger);
}

.toast-notification.info {
    background-color: var(--info);
}

/* Toast content layout */
.toast-content {
    display: flex;
    align-items: center;
    gap: 10px;
}

/* ========== RESPONSIVE ADJUSTMENTS ========== */
@media (max-width: 1024px) {
    .chart-section {
        grid-template-columns: 1fr;
    }
    
    .maintenance-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .main-content {
        padding: var(--space-md);
    }
    
    .header {
        padding: var(--space-md);
    }
    
    .maintenance-stats {
        grid-template-columns: 1fr;
    }
    
    .maintenance-filters {
        grid-template-columns: 1fr;
    }
    
    .maintenance-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .view-toggle {
        align-self: center;
    }
    
    .maintenance-table th, 
    .maintenance-table td {
        padding: var(--space-sm) var(--space-md);
    }
    
    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-sm);
    }
    
    .chart-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-sm);
    }
    
    .chart-header .filter-select {
        width: 100%;
    }
    
    .custom-bar-chart {
        gap: 8px;
    }
    
    .bar {
        width: 20px;
    }
    
    .bar-label {
        font-size: 10px;
    }
    
    .custom-pie-chart {
        width: 140px;
        height: 140px;
    }
    
    .pie-center {
        width: 50px;
        height: 50px;
        font-size: var(--text-xs);
    }
    
    .modal {
        width: 95%;
        margin: var(--space-md);
    }
    
    .report-details {
        grid-template-columns: 1fr;
    }
    
    .status-info-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-footer {
        flex-direction: column;
    }
    
    .modal-footer .btn {
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 640px) {
    .maintenance-table {
        min-width: 100%;
    }
    
    .maintenance-table th:nth-child(3),
    .maintenance-table td:nth-child(3),
    .maintenance-table th:nth-child(6),
    .maintenance-table td:nth-child(6) {
        display: none;
    }
    
    .pagination {
        flex-direction: column;
        gap: var(--space-sm);
    }
}

/* Custom scrollbar for table container */
.maintenance-table-container::-webkit-scrollbar {
    height: 8px;
}

.maintenance-table-container::-webkit-scrollbar-track {
    background: var(--scrollbar-track);
    border-radius: var(--radius-full);
}

.maintenance-table-container::-webkit-scrollbar-thumb {
    background: var(--scrollbar-thumb);
    border-radius: var(--radius-full);
}

.maintenance-table-container::-webkit-scrollbar-thumb:hover {
    background: var(--scrollbar-thumb-hover);
}

/* Custom scrollbar for modal */
.modal::-webkit-scrollbar {
    width: 8px;
}

.modal::-webkit-scrollbar-track {
    background: var(--scrollbar-track);
    border-radius: var(--radius-full);
}

.modal::-webkit-scrollbar-thumb {
    background: var(--scrollbar-thumb);
    border-radius: var(--radius-full);
}

.modal::-webkit-scrollbar-thumb:hover {
    background: var(--scrollbar-thumb-hover);
}

/* Hover effects for table rows */
.maintenance-table tr {
    transition: background-color var(--transition-fast), transform var(--transition-fast);
}

.maintenance-table tr:hover {
    background-color: var(--hover-color);
    transform: translateX(4px);
}

/* Improved focus states for accessibility */
.btn-icon:focus,
.filter-select:focus,
.modal-close:focus {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}
/* Notification Dropdown Styles */
.notification-bell {
    position: relative;
    cursor: pointer;
}

.notification-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    width: 350px;
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border-color);
    z-index: var(--z-dropdown);
    margin-top: 10px;
    display: none;
    max-height: 400px;
    overflow-y: auto;
}

.notification-bell:hover .notification-dropdown {
    display: block;
}

.notification-header {
    padding: var(--space-md);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notification-title {
    font-size: var(--text-md);
    font-weight: var(--font-semibold);
    margin: 0;
}

.notification-clear {
    background: none;
    border: none;
    color: var(--primary);
    cursor: pointer;
    font-size: var(--text-xs);
    display: flex;
    align-items: center;
    gap: 4px;
}

.notification-list {
    padding: var(--space-xs);
}

.notification-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    padding: var(--space-sm);
    border-radius: var(--radius-md);
    cursor: pointer;
    position: relative;
    transition: background-color var(--transition-fast);
}

.notification-item:hover {
    background-color: var(--hover-color);
}

.notification-item.unread {
    background-color: rgba(59, 130, 246, 0.05);
}

.notification-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.notification-icon i {
    color: var(--primary);
    font-size: var(--text-sm);
}

.notification-content {
    flex: 1;
}

.notification-message {
    margin: 0;
    font-size: var(--text-sm);
    line-height: 1.4;
    color: var(--text-primary);
}

.notification-time {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    margin-top: 2px;
    display: block;
}

.notification-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--primary);
    flex-shrink: 0;
    margin-left: auto;
}

.notification-footer {
    padding: var(--space-sm);
    border-top: 1px solid var(--border-color);
    text-align: center;
}

.notification-footer a {
    color: var(--primary);
    text-decoration: none;
    font-size: var(--text-sm);
}

.notification-footer a:hover {
    text-decoration: underline;
}
.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-completed {
    background-color: #10b981;
    color: white;
}


.status-pending {
    background-color: #f59e0b;
    color: white;
}
/* Styling untuk filter kategori */
.filter-group select#categoryFilter {
    /* Style sama dengan filter lainnya */
}
/* Styling untuk tombol hapus */
.btn-icon.delete {
    background: var(--danger-light);
    color: var(--danger);
}

.btn-icon.delete:hover {
    background: var(--danger);
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}
/* Tambahkan styling untuk status reopened */
.status-reopened {
    background-color: #f59e0b;
    color: white;
}

.status-completed {
    background-color: #10b981;
    color: white;
}
</style>
</head>
<body>
    <div id="sidebar-container"></div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div id="notificationContainer"></div>
            <button class="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <h1><i class="fas fa-check-circle"></i> Solved Reports</h1>
            
            <div class="header-actions">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search solved reports..." id="dashboardSearch">
                </div>
                
<button class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="user-profile">
                    <img class="profile-img" src="https://iili.io/Fpiva7S.png" alt="Profile">
                    <div class="user-info">
                        <h4>Nama Masing Masing</h4>
                        <p>Customer Service Support</p>
                    </div>
                </div>
            </div>
        </div>
        
        
        <!-- Filter Panel -->
        <div class="filter-panel fade-in">
            <div class="filter-header">
                <h3 class="filter-title">Filter Solved Reports</h3>
                <button class="filter-reset" id="resetFilters">
                    <i class="fas fa-sync-alt"></i> Reset Filters
                </button>
            </div>
            <div class="filter-grid">
                <div class="filter-group">
                    <label class="filter-label">Brand</label>
                    <select class="filter-select" id="brandFilter">
                        <option value="">All Brands</option>
                        <option value="CINTAWIN88 (D-GAMING)">CINTAWIN88 (D-GAMING)</option>
                            <option value="CERIASLOT99 (D-GAMING)">CERIASLOT99 (D-GAMING)</option>
                            <option value="RAJASCATTER88 (D-GAMING)">RAJASCATTER88 (D-GAMING)</option>
                            <option value="MAHJONGJP88 (D-GAMING)">MAHJONGJP88 (D-GAMING)</option>
                            <option value="NAGAHOKI88 (D-GAMING)">NAGAHOKI88 (D-GAMING)</option>
                            <option value="SPACEMAN88 (D-GAMING)">SPACEMAN88 (D-GAMING)</option>
                            <option value="RAJAPANEN (D-GAMING)">RAJAPANEN (D-GAMING)</option>
                            <option value="BROTO88 (D-GAMING)">BROTO88 (D-GAMING)</option>
                            <option value="MEDUSA88 (GACHA)">MEDUSA88 (GACHA)</option>
                            <option value="ATHENA168 (GACHA)">ATHENA168 (GACHA)</option>
                            <option value="ARES GACOR (GACHA)">ARES GACOR (GACHA)</option>
                            <option value="RAJA MAHJONG (GACHA)">RAJA MAHJONG (GACHA)</option>
                            <option value="OLYMPUS1000 (GACHA)">OLYMPUS1000 (GACHA)</option>
                            <option value="CLICKBET (GACHA)">CBWL (GACHA)</option>
                            <option value="RAJA COVID (GACHA)">RAJA COVID (GACHA)</option>
                            <option value="BANG GACOR 88 (GACHA)">BANG GACOR 88 (GACHA)</option>
                            <option value="HACKSAW88 (GACHA)">HACKSAW88 (GACHA)</option>
                            <option value="GACHA99 (GACHA)">GACHA99 (GACHA)</option>
                            <option value="UJANGBET (BREM)">UJANGBET (BREM)</option>
                            <option value="EPISODEBET (BREM)">EPISODEBET (BREM)</option>
                            <option value="FOKUSBET88 (89ENGINE)">FOKUSBET88 (89ENGINE)</option>
                            <option value="RAJAKING88 (89ENGINE)">RAJAKING88 (89ENGINE)</option>
                            <option value="RAJANAGA99 (89ENGINE)">RAJANAGA99 (89ENGINE)</option>
                            <option value="JOIN999 (LUXION)">JOIN999 (LUXION)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select class="filter-select" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="completed">Completed</option>
                        <option value="reopened">Reopened</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Date Range</label>
                    <div class="date-range-inputs">
                        <input type="date" class="filter-select" id="startDate">
                        <span>to</span>
                        <input type="date" class="filter-select" id="endDate">
                    </div>
                </div>
            </div>
        </div>
        
        
        <!-- Solved Reports Table -->
        <div class="activities-section fade-in">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-list-check"></i> Solved Reports
                    <span class="badge badge-primary" id="reportsCount">0</span>
                </h2>
                <div class="section-actions">
                </div>
            </div>
            
            <div class="maintenance-table-container">
                <table class="maintenance-table">
                    <thead>
                        <tr>
                            <th>Report ID</th>
                            <th>Brand</th>
                            <th>Reported By</th>
                            <th>Title</th>  <!-- Kolom Title ditambahkan -->
                            <th>Category</th>
                            <th>Reported At</th>
                            <th>Resolved At</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="solvedReportsTableBody">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="pagination">
                <button class="btn btn-secondary" id="prevPage">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span class="page-numbers" id="pageInfo">Page 1 of 1</span>
                <button class="btn btn-secondary" id="nextPage">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Report Details Modal -->
    <div class="modal-overlay" id="reportDetailsModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-file-alt"></i> Report Details</h2>
                <button class="modal-close" id="closeDetailsModal">&times;</button>
            </div>
            <div class="modal-body" id="reportDetailsContent">
                <!-- Konten akan diisi oleh JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeDetailsBtn">Close</button>
                <button class="btn btn-warning" id="reopenReportBtn">
                    <i class="fas fa-undo"></i> Reopen Report
                </button>
            </div>
        </div>
    </div>
    
    <!-- Reopen Confirmation Modal -->
    <div class="modal-overlay" id="reopenConfirmModal">
        <div class="modal confirm-modal">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirm Reopen</h2>
                <button class="modal-close" id="closeReopenModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirm-icon">
                    <i class="fas fa-question-circle"></i>
                </div>
                <p class="confirm-message" id="reopenConfirmMessage">
                    Are you sure you want to reopen this report? This will move it back to pending reports.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelReopenBtn">Cancel</button>
                <button class="btn btn-warning" id="confirmReopenBtn">Yes, Reopen Report</button>
            </div>
        </div>
    </div>
    <script src="sidebar-loader.js"></script>
    <script src="user-profile.js"></script>
    
    <!-- Firebase App (core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <script>
    // Konfigurasi Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDUZka4FZyLi_cv6X_5D4zeRsfkpqOlBpY",
        authDomain: "dashboard-css.firebaseapp.com",
        databaseURL: "https://dashboard-css-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "dashboard-css",
        storageBucket: "dashboard-css.appspot.com",
        messagingSenderId: "771131792881",
        appId: "1:771131792881:web:ad634424225bd7de847850",
        measurementId: "G-3CYBC5B101"
    };

    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Deklarasi variabel global untuk solved reports
    let solvedReports = [];
    let unsubscribeSolved = null;
    let currentReportId = null;
    let currentPage = 1;
    const reportsPerPage = 10;

    function setupSolvedReportsListener() {
        if (unsubscribeSolved) {
            unsubscribeSolved();
        }
        
        const reportsRef = db.collection('solvedReports');

        unsubscribeSolved = reportsRef
            .orderBy('dateSolved', 'desc')
            .onSnapshot(snapshot => {
                solvedReports = [];
                snapshot.forEach(doc => {
                    const report = doc.data();
                    report.id = doc.id;
                    
                    // Pastikan data yang diperlukan ada
                    if (report.dateCreated && report.dateSolved && report.status) {
                        solvedReports.push(report);
                    } else {
                        console.warn("Invalid report data:", report);
                    }
                });

                updateSolvedReportsUI();
                updateStatistics();


            }, error => {
                console.error("Error fetching solved reports:", error);
                showToast("Error loading solved reports", "error");
            });
    }

    function updateStatistics() {
        const now = new Date();
        const completedReports = solvedReports.filter(report => report.status === "completed");
        const completed = completedReports.length;

        let thisWeek = 0;
        let thisMonth = 0;
        let totalResolutionTime = 0;

        completedReports.forEach(report => {
            // Konversi Firestore timestamp ke JS Date
            const created = report.dateCreated.toDate ? report.dateCreated.toDate() : new Date(report.dateCreated);
            const solved = report.dateSolved.toDate ? report.dateSolved.toDate() : new Date(report.dateSolved);

            const resolutionTime = solved - created;
            totalResolutionTime += resolutionTime;

            const daysAgo = (now - solved) / (1000 * 60 * 60 * 24);
            if (daysAgo <= 7) thisWeek++;
            if (now.getMonth() === solved.getMonth() &&
                now.getFullYear() === solved.getFullYear()) {
                thisMonth++;
            }
        });
    }

   async function updateSolvedReportsUI() {
    const tableBody = document.getElementById('solvedReportsTableBody');
    const reportsCount = document.getElementById('reportsCount');
    
    // Cek role user
    const isAdmin = await isSuperAdmin();
    
    if (solvedReports.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="10" class="empty-state">
                    <i class="fas fa-database"></i>
                    <h3>No Solved Reports Found</h3>
                    <p>There are no completed reports in the database yet.</p>
                </td>
            </tr>
        `;
        return;
    }
    
    const filteredReports = filterReports(solvedReports);
    reportsCount.textContent = filteredReports.length;
    
    // Pagination
    const totalPages = Math.ceil(filteredReports.length / reportsPerPage);
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
    
    const startIndex = (currentPage - 1) * reportsPerPage;
    const endIndex = Math.min(startIndex + reportsPerPage, filteredReports.length);
    const currentPageReports = filteredReports.slice(startIndex, endIndex);
    
    // Clear table
    tableBody.innerHTML = '';
    
    if (currentPageReports.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
            <td colspan="10" style="text-align: center; padding: 40px 20px;">
                <i class="fas fa-inbox" style="font-size: 3rem; color: var(--text-tertiary); margin-bottom: 15px; display: block;"></i>
                <h3 style="color: var(--text-secondary; margin-bottom: 10px;">No solved reports found</h3>
                <p style="color: var(--text-tertiary);">Try adjusting your filters or check back later.</p>
            </td>
        `;
        tableBody.appendChild(emptyRow);
        return;
    }
    
    // Process each report asynchronously
    for (const report of currentPageReports) {
        const row = document.createElement('tr');
        
        // Format dates
        const reportedDate = report.dateCreated ? formatDate(report.dateCreated.toDate()) : 'N/A';
        const resolvedDate = report.dateSolved ? formatDate(report.dateSolved.toDate()) : 'N/A';
        
        // Get user name
        const reportedBy = await getCachedUserName(report.userId);
        
        // Hanya super admin yang bisa melihat tombol hapus
        const deleteButtonHtml = isAdmin ? 
            `<button class="btn-icon delete" data-id="${report.id}" title="Delete Report">
                <i class="fas fa-trash"></i>
            </button>` : '';
        
        row.innerHTML = `
            <td>${report.id}</td>
            <td>${report.brand || 'N/A'}</td>
            <td>${reportedBy}</td>
            <td>${report.title || 'No Title'}</td>
            <td>${report.category || 'N/A'}</td>
            <td>${reportedDate}</td>
            <td>${resolvedDate}</td>
            <td><span class="status-badge status-${report.status}">${report.status}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="btn-icon view" data-id="${report.id}" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${deleteButtonHtml}
                </div>
            </td>
        `;
        
        tableBody.appendChild(row);
    }
    
    // Add event listeners to view buttons
    document.querySelectorAll('.btn-icon.view').forEach(button => {
        button.addEventListener('click', function() {
            const reportId = this.getAttribute('data-id');
            showReportDetails(reportId);
        });
    });
    
    // Add event listeners to delete buttons - HANYA UNTUK SUPER ADMIN
    if (isAdmin) {
        document.querySelectorAll('.btn-icon.delete').forEach(button => {
            button.addEventListener('click', function() {
                const reportId = this.getAttribute('data-id');
                showDeleteConfirmation(reportId);
            });
        });
    }
}
// Fungsi untuk menampilkan konfirmasi hapus
function showDeleteConfirmation(reportId) {
    const report = solvedReports.find(r => r.id === reportId);
    
    if (!report) {
        showToast("Report not found", "error");
        return;
    }
    
    // Buat modal konfirmasi hapus
    const confirmModal = document.createElement('div');
    confirmModal.className = 'modal-overlay active';
    confirmModal.innerHTML = `
        <div class="modal confirm-modal">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-trash"></i> Delete Report</h2>
                <button class="modal-close" id="closeDeleteModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirm-icon">
                    <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
                </div>
                <p class="confirm-message">
                    Are you sure you want to delete report <strong>${reportId}</strong>?<br>
                    This action cannot be undone.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash"></i> Delete Report
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(confirmModal);
    
    // Event listeners untuk modal hapus
    document.getElementById('closeDeleteModal').addEventListener('click', () => {
        document.body.removeChild(confirmModal);
    });
    
    document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
        document.body.removeChild(confirmModal);
    });
    
    document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
        deleteReport(reportId);
        document.body.removeChild(confirmModal);
    });
    
    // Close modal ketika klik di luar
    confirmModal.addEventListener('click', (e) => {
        if (e.target === confirmModal) {
            document.body.removeChild(confirmModal);
        }
    });
}

// Fungsi untuk menghapus report
async function deleteReport(reportId) {
    try {
        // Cek lagi apakah user adalah super admin
        const isAdmin = await isSuperAdmin();
        if (!isAdmin) {
            showToast("Access denied: Only super admin can delete reports", "error");
            return;
        }
        
        await db.collection('solvedReports').doc(reportId).delete();
        showToast("Report deleted successfully", "success");
        
        // Refresh data
        setupSolvedReportsListener();
        
    } catch (error) {
        console.error("Error deleting report:", error);
        showToast("Error deleting report", "error");
    }
}
    
    function filterReports(reports) {
        const brandFilter = document.getElementById('brandFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        return reports.filter(report => {
            // Filter by brand
            if (brandFilter && report.brand !== brandFilter) {
                return false;
            }
            
            // Filter by status
            if (statusFilter && report.status !== statusFilter) {
                return false;
            }
            

            
            // Filter by date range - gunakan dateSolved yang sesuai dengan Firestore
            if (startDate && report.dateSolved) {
                const solvedDate = report.dateSolved.toDate().toISOString().split('T')[0];
                if (solvedDate < startDate) {
                    return false;
                }
            }
            
            if (endDate && report.dateSolved) {
                const solvedDate = report.dateSolved.toDate().toISOString().split('T')[0];
                if (solvedDate > endDate) {
                    return false;
                }
            }
            
            return true;
        });
    }
    

    function updateBrandChart() {
    const chartContainer = document.getElementById('brandChart');
    chartContainer.innerHTML = '';
    chartContainer.className = 'enhanced-bar-chart';
    
    // Group reports by brand
    const brandCounts = {};
    solvedReports.forEach(report => {
        const brand = report.brand || 'Unknown';
        brandCounts[brand] = (brandCounts[brand] || 0) + 1;
    });
    
    // Sort brands by count (descending)
    const sortedBrands = Object.entries(brandCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8); // Top 8 brands
    
    if (sortedBrands.length === 0) {
        chartContainer.innerHTML = `
            <div class="enhanced-empty-state">
                <i class="fas fa-chart-bar"></i>
                <h4>No Data Available</h4>
                <p>There are no solved reports to display in the chart.</p>
            </div>
        `;
        return;
    }
    
    // Find max count for scaling
    const maxCount = Math.max(...sortedBrands.map(b => b[1]));
    const totalCount = sortedBrands.reduce((sum, [_, count]) => sum + count, 0);
    
    // Create bars for each brand
    sortedBrands.forEach(([brand, count], index) => {
        const percentage = Math.round((count / totalCount) * 100);
        
        const barItem = document.createElement('div');
        barItem.className = 'bar-item';
        barItem.style.animationDelay = `${index * 0.1}s`;
        
        barItem.innerHTML = `
            <div class="bar-label">${brand.length > 18 ? brand.substring(0, 18) + '...' : brand}</div>
            <div class="bar-track">
                <div class="bar-fill" data-value="${count}" style="width: 0%;"></div>
            </div>
            <div class="bar-value">
                <span class="bar-percentage">${percentage}%</span>
                <span class="bar-count">${count}</span>
            </div>
        `;
        
        chartContainer.appendChild(barItem);
        
        // Animate the bar after a short delay
        setTimeout(() => {
            const barFill = barItem.querySelector('.bar-fill');
            barFill.style.width = `${(count / maxCount) * 85}%`;
        }, 100 + (index * 100));
    });
    
    // Add tooltip functionality
    addBarChartTooltips();
}

// Fungsi untuk memperbarui grafik waktu resolusi dengan desain baru
function updateResolutionTimeChart() {
    const chartContainer = document.getElementById('resolutionTimeChart');
    const legendContainer = document.getElementById('resolutionTimeLegend');
    chartContainer.innerHTML = '';
    legendContainer.innerHTML = '';
    
    chartContainer.className = 'enhanced-pie-container';
    legendContainer.className = 'enhanced-legend';
    
    // Kategorikan berdasarkan waktu resolusi
    const categories = {
        'Under 1h': 0,
        '1-4h': 0,
        '4-12h': 0,
        '12-24h': 0,
        'Over 24h': 0
    };
    
    solvedReports.forEach(report => {
        if (report.dateCreated && report.dateSolved) {
            const reportedTime = report.dateCreated.toDate();
            const solvedTime = report.dateSolved.toDate();
            const diffHours = Math.abs(solvedTime - reportedTime) / 36e5;
            
            if (diffHours < 1) {
                categories['Under 1h']++;
            } else if (diffHours < 4) {
                categories['1-4h']++;
            } else if (diffHours < 12) {
                categories['4-12h']++;
            } else if (diffHours < 24) {
                categories['12-24h']++;
            } else {
                categories['Over 24h']++;
            }
        }
    });
        
    // Filter out categories with zero counts
    const nonZeroCategories = Object.entries(categories).filter(([_, count]) => count > 0);
    
    if (nonZeroCategories.length === 0) {
        chartContainer.innerHTML = `
            <div class="enhanced-empty-state">
                <i class="fas fa-chart-pie"></i>
                <h4>No Data Available</h4>
                <p>There are no solved reports to display in the chart.</p>
            </div>
        `;
        return;
    }
    
    // Colors for pie chart segments
    const colors = [
        'var(--success)',      // Under 1h - Green
        'var(--info)',         // 1-4h - Blue
        'var(--warning)',      // 4-12h - Orange
        'var(--purple)',       // 12-24h - Purple
        'var(--danger)'        // Over 24h - Red
    ];
    
    // Calculate total for percentages
    const total = nonZeroCategories.reduce((sum, [_, count]) => sum + count, 0);
    
    // Create pie chart container
    const pieChart = document.createElement('div');
    pieChart.className = 'enhanced-pie-chart';
    chartContainer.appendChild(pieChart);
    
    // Create center text
    const center = document.createElement('div');
    center.className = 'pie-center-enhanced';
    center.innerHTML = `
        <div class="pie-total">${total}</div>
        <div class="pie-total-label">Total</div>
    `;
    chartContainer.appendChild(center);
    
    // Create segments
    let cumulativePercentage = 0;
    
    nonZeroCategories.forEach(([label, count], index) => {
        const percentage = (count / total) * 100;
        const segment = document.createElement('div');
        segment.className = 'pie-segment-enhanced';
        segment.style.background = colors[index];
        segment.style.transform = `rotate(${cumulativePercentage * 3.6}deg)`;
        segment.setAttribute('data-label', label);
        segment.setAttribute('data-value', count);
        segment.setAttribute('data-percentage', `${Math.round(percentage)}%`);
        
        // Calculate clip-path based on percentage
        if (percentage > 50) {
            segment.style.clipPath = `polygon(50% 50%, 50% 0%, 100% 0%, 100% 100%, 50% 100%)`;
        } else {
            segment.style.clipPath = `polygon(50% 50%, 50% 0%, ${50 + (percentage * 0.9)}% 0%, ${50 + (percentage * 0.9)}% 100%, 50% 100%)`;
        }
        
        pieChart.appendChild(segment);
        cumulativePercentage += percentage;
        
        // Add legend item
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item-enhanced';
        legendItem.setAttribute('data-category', label);
        
        legendItem.innerHTML = `
            <div class="legend-color-container">
                <div class="legend-color-box" style="background: ${colors[index]}"></div>
                <span class="legend-label">${label}</span>
            </div>
            <div class="legend-value">${count} (${Math.round(percentage)}%)</div>
        `;
        
        legendContainer.appendChild(legendItem);
        
        // Add interactivity
        legendItem.addEventListener('mouseenter', () => {
            highlightSegment(segment);
        });
        
        legendItem.addEventListener('mouseleave', () => {
            resetSegments();
        });
        
        segment.addEventListener('mouseenter', (e) => {
            highlightSegment(segment);
            showPieTooltip(e, label, count, percentage);
        });
        
        segment.addEventListener('mouseleave', () => {
            resetSegments();
            hidePieTooltip();
        });
    });
    
    // Add animation
    animatePieChart();
}

// Fungsi pembantu untuk grafik
function addBarChartTooltips() {
    const tooltip = document.createElement('div');
    tooltip.className = 'chart-tooltip';
    document.body.appendChild(tooltip);
    
    const bars = document.querySelectorAll('.bar-fill');
    bars.forEach(bar => {
        bar.addEventListener('mouseenter', (e) => {
            const value = bar.getAttribute('data-value');
            const rect = bar.getBoundingClientRect();
            
            tooltip.textContent = `${value} reports`;
            tooltip.style.left = `${rect.left + rect.width/2}px`;
            tooltip.style.top = `${rect.top - 40}px`;
            tooltip.style.transform = 'translateX(-50%)';
            tooltip.style.opacity = '1';
        });
        
        bar.addEventListener('mouseleave', () => {
            tooltip.style.opacity = '0';
        });
    });
}

function highlightSegment(segment) {
    // Reset all segments first
    resetSegments();
    
    // Highlight the selected segment
    segment.style.transform = segment.style.transform.replace('rotate', 'scale(1.05) rotate');
    segment.style.zIndex = '10';
    segment.style.filter = 'brightness(1.2)';
}

function resetSegments() {
    const segments = document.querySelectorAll('.pie-segment-enhanced');
    segments.forEach(segment => {
        const rotation = segment.style.transform.match(/rotate\(([^)]+)deg\)/);
        segment.style.transform = rotation ? `rotate(${rotation[1]}deg)` : '';
        segment.style.zIndex = '';
        segment.style.filter = '';
    });
}

function showPieTooltip(event, label, value, percentage) {
    let tooltip = document.getElementById('pie-tooltip');
    if (!tooltip) {
        tooltip = document.createElement('div');
        tooltip.id = 'pie-tooltip';
        tooltip.className = 'chart-tooltip';
        document.body.appendChild(tooltip);
    }
    
    tooltip.innerHTML = `
        <strong>${label}</strong><br>
        ${value} reports (${Math.round(percentage)}%)
    `;
    
    tooltip.style.left = `${event.pageX}px`;
    tooltip.style.top = `${event.pageY - 50}px`;
    tooltip.style.opacity = '1';
}

function hidePieTooltip() {
    const tooltip = document.getElementById('pie-tooltip');
    if (tooltip) {
        tooltip.style.opacity = '0';
    }
}

function animatePieChart() {
    const segments = document.querySelectorAll('.pie-segment-enhanced');
    segments.forEach((segment, index) => {
        segment.style.opacity = '0';
        setTimeout(() => {
            segment.style.transition = 'opacity 0.5s ease, transform 0.3s ease';
            segment.style.opacity = '1';
        }, index * 100);
    });

        
        // Add center text
        const center = document.createElement('div');
        center.className = 'pie-center';
        center.textContent = `${total}`;
        chartContainer.appendChild(center);
    }
    
    async function showReportDetails(reportId) {
    const report = solvedReports.find(r => r.id === reportId);
    
    if (!report) {
        showToast("Report not found", "error");
        return;
    }
    
    currentReportId = reportId;
    
    const modalContent = document.getElementById('reportDetailsContent');
    
    // Format dates
    const reportedDate = report.dateCreated ? formatDateTime(report.dateCreated.toDate()) : 'N/A';
    const resolvedDate = report.dateSolved ? formatDateTime(report.dateSolved.toDate()) : 'N/A';
    
    // Get user names
    const reportedBy = await getCachedUserName(report.userId);
    const completedBy = await getCachedUserName(report.completedBy);
    
    // Calculate resolution time
    let resolutionTime = 'N/A';
    if (report.dateCreated && report.dateSolved) {
        const reportedTime = report.dateCreated.toDate();
        const solvedTime = report.dateSolved.toDate();
        const diffHours = Math.abs(solvedTime - reportedTime) / 36e5;
        resolutionTime = `${Math.round(diffHours)} hours`;
    }
    
    modalContent.innerHTML = `
        <div class="report-details">
            <div class="report-detail-item">
                <span class="report-detail-label">Report ID</span>
                <span class="report-detail-value">${report.id}</span>
            </div>
            <div class="report-detail-item">
                <span class="report-detail-label">Brand</span>
                <span class="report-detail-value">${report.brand || 'N/A'}</span>
            </div>
            <div class="report-detail-item">
                <span class="report-detail-label">Reported By</span>
                <span class="report-detail-value">${reportedBy}</span>
            </div>
            <div class="report-detail-item">
                <span class="report-detail-label">Title</span>
                <span class="report-detail-value">${report.title || 'No Title'}</span>
            </div>
            <div class="report-detail-item">
                <span class="report-detail-label">Category</span>
                <span class="report-detail-value">${report.category || 'N/A'}</span>
            </div>
            <div class="report-detail-item">
                <span class="report-detail-label">Status</span>
                <span class="report-detail-value status-badge status-${report.status}">${report.status}</span>
            </div>
            <div class="report-detail-item">
                <span class="report-detail-label">Reported At</span>
                <span class="report-detail-value">${reportedDate}</span>
            </div>
            <div class="report-detail-item">
                <span class="report-detail-label">Solved At</span>
                <span class="report-detail-value">${resolvedDate}</span>
            </div>
        </div>
        
        <div class="status-info-grid">
            <div class="status-info-item">
                <div class="status-info-label">Resolution Time</div>
                <div class="status-info-value">${resolutionTime}</div>
            </div>
            <div class="status-info-item">
                <div class="status-info-label">Completed By</div>
                <div class="status-info-value">${completedBy}</div>
            </div>
        </div>
        
        <div class="report-description">
            <h4>Issue Description</h4>
            <div>${report.description || 'No description provided'}</div>
        </div>
        
        <div class="report-resolution">
            <h4>Resolution Notes</h4>
            <div>${report.resolution || 'No resolution notes provided'}</div>
        </div>
    `;
    
    // Update modal footer berdasarkan role user
    await updateModalFooter();
    
    // Tampilkan modal
    document.getElementById('reportDetailsModal').classList.add('active');
}

// Fungsi untuk update modal footer berdasarkan role
async function updateModalFooter() {
    const modalFooter = document.querySelector('#reportDetailsModal .modal-footer');
    const isAdmin = await isSuperAdmin();
    
    if (isAdmin) {
        // Super admin bisa melihat tombol reopen
        modalFooter.innerHTML = `
            <button class="btn btn-secondary" id="closeDetailsBtn">Close</button>
            <button class="btn btn-warning" id="reopenReportBtn">
                <i class="fas fa-undo"></i> Reopen Report
            </button>
        `;
    } else {
        // User biasa hanya bisa close
        modalFooter.innerHTML = `
            <button class="btn btn-secondary" id="closeDetailsBtn">Close</button>
        `;
    }
    
    // Tambahkan event listeners untuk tombol baru
    document.getElementById('closeDetailsBtn').addEventListener('click', function() {
        document.getElementById('reportDetailsModal').classList.remove('active');
    });
    
    const reopenBtn = document.getElementById('reopenReportBtn');
    if (reopenBtn) {
        reopenBtn.addEventListener('click', function() {
            document.getElementById('reopenConfirmModal').classList.add('active');
            document.getElementById('reopenConfirmMessage').textContent = 
                `Are you sure you want to reopen report ${currentReportId}? This will move it back to pending reports.`;
        });
    }
}
    async function reopenReport(reportId) {
    // Cek apakah user adalah super admin
    const isAdmin = await isSuperAdmin();
    if (!isAdmin) {
        showToast("Access denied: Only super admin can reopen reports", "error");
        document.getElementById('reopenConfirmModal').classList.remove('active');
        return;
    }
    
    const solvedReportRef = db.collection('solvedReports').doc(reportId);
    const pendingReportRef = db.collection('pendingReports').doc(reportId);

    // Pertama, ambil data dari solvedReports
    solvedReportRef.get().then((doc) => {
        if (doc.exists) {
            const reportData = doc.data();
            
            // Pindahkan ke pendingReports dengan status pending
            pendingReportRef.set({
                ...reportData,
                status: 'pending',
                dateSolved: null,
                resolution: null,
                completedBy: null,
                dateUpdated: new Date()
            })
            .then(() => {
                // Hapus dari solvedReports
                return solvedReportRef.delete();
            })
            .then(() => {
                showToast("Report reopened successfully", "success");
                document.getElementById('reopenConfirmModal').classList.remove('active');
                document.getElementById('reportDetailsModal').classList.remove('active');
            })
            .catch(error => {
                console.error("Error reopening report:", error);
                showToast("Error reopening report", "error");
            });
        }
    });
}
    function showToast(message, type = "info") {
        // Create toast element if it doesn't exist
        let toast = document.getElementById('toastNotification');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'toastNotification';
            toast.className = 'toast-notification';
            toast.innerHTML = `
                <div class="toast-content">
                    <span id="toastMessage"></span>
                </div>
            `;
            document.body.appendChild(toast);
        }
        
        const toastMessage = document.getElementById('toastMessage');
        
        toastMessage.textContent = message;
        toast.className = `toast-notification ${type}`;
        toast.style.display = 'block';
        toast.style.animation = 'toast-in 0.5s ease forwards';
        
        // Show toast
        setTimeout(() => {
            toast.style.animation = 'toast-out 0.4s ease forwards';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 400);
        }, 3000);
    }
    
    function formatDate(date) {
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }
    
    function formatDateTime(date) {
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    function convertToCSV(reports) {
        const headers = ['ID', 'Brand', 'User', 'Title', 'Category', 'Reported Date', 'Solved Date', 'Status'];
        
        const rows = reports.map(report => [
            report.id,
            report.brand || '',
            report.userId || report.reportedBy || '',
            report.title || '',
            report.category || '',
            report.dateCreated ? formatDate(report.dateCreated.toDate()) : '',
            report.dateCreated ? formatDate(report.dateSolved.toDate()) : '',
            report.status || ''
        ]);
        
        return [headers, ...rows].map(row => row.join(',')).join('\n');
    }
    
    function downloadCSV(content, filename) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
    }
    
    // Event listeners
document.addEventListener('DOMContentLoaded', function() {
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            console.log("User logged in:", user.uid);
            
            // Cek role user
            const role = await getCurrentUserRole();
            console.log("User role:", role);
            
            setupSolvedReportsListener();
            
            // Test koneksi Firebase
            db.collection('solvedReports').limit(1).get()
                .then(snapshot => {
                    console.log("Firebase connection test successful:", snapshot.size, "documents found");
                })
                .catch(error => {
                    console.error("Firebase connection error:", error);
                    showToast("Cannot connect to database", "error");
                });
            
            // Filter event listeners
            document.getElementById('brandFilter').addEventListener('change', updateSolvedReportsUI);
            document.getElementById('statusFilter').addEventListener('change', updateSolvedReportsUI);
            document.getElementById('startDate').addEventListener('change', updateSolvedReportsUI);
            document.getElementById('endDate').addEventListener('change', updateSolvedReportsUI);
            document.getElementById('resetFilters').addEventListener('click', function() {
                document.getElementById('brandFilter').value = '';
                document.getElementById('statusFilter').value = '';
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                updateSolvedReportsUI();
            });
            
            // Pagination event listeners
            document.getElementById('prevPage').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    updateSolvedReportsUI();
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', function() {
                const filteredReports = filterReports(solvedReports);
                const totalPages = Math.ceil(filteredReports.length / reportsPerPage);
                
                if (currentPage < totalPages) {
                    currentPage++;
                    updateSolvedReportsUI();
                }
            });
            
            // Modal event listeners - HANYA UNTUK CLOSE
            document.getElementById('closeDetailsModal').addEventListener('click', function() {
                document.getElementById('reportDetailsModal').classList.remove('active');
            });
            
            // Event listeners untuk reopen modal (akan ditambahkan secara dinamis)
            document.getElementById('closeReopenModal').addEventListener('click', function() {
                document.getElementById('reopenConfirmModal').classList.remove('active');
            });
            
            document.getElementById('cancelReopenBtn').addEventListener('click', function() {
                document.getElementById('reopenConfirmModal').classList.remove('active');
            });
            
            document.getElementById('confirmReopenBtn').addEventListener('click', async function() {
                // Cek role sebelum membuka report
                const isAdmin = await isSuperAdmin();
                if (!isAdmin) {
                    showToast("Access denied: Only super admin can reopen reports", "error");
                    document.getElementById('reopenConfirmModal').classList.remove('active');
                    return;
                }
                reopenReport(currentReportId);
            });
            
            // Export button event listener
            const exportButton = document.getElementById('exportButton');
            if (exportButton) {
                exportButton.addEventListener('click', function() {
                    const filteredReports = filterReports(solvedReports);
                    const csvContent = convertToCSV(filteredReports);
                    downloadCSV(csvContent, 'solved-reports.csv');
                });
            }
            
            // Chart filter event listeners
            const chartTimeRange = document.getElementById('chartTimeRange');
            const resolutionTimeRange = document.getElementById('resolutionTimeRange');
            
            if (chartTimeRange) {
                chartTimeRange.addEventListener('change', updateBrandChart);
            }
            
            if (resolutionTimeRange) {
                resolutionTimeRange.addEventListener('change', updateResolutionTimeChart);
            }
        } else {
            // Pengguna belum login, redirect ke halaman login
            console.log("User not logged in, redirecting...");
            window.location.href = "login.html";
        }
    });
});
// Tambahkan security check di fungsi yang membutuhkan akses super admin
async function withAdminCheck(action, errorMessage = "Access denied: Only super admin can perform this action") {
    const isAdmin = await isSuperAdmin();
    if (!isAdmin) {
        showToast(errorMessage, "error");
        return false;
    }
    return true;
}

// Contoh penggunaan:
async function someAdminFunction() {
    if (!await withAdminCheck()) return;
    // Lanjutkan dengan fungsi admin
}
    function setupSearchFunctionality() {
    const searchInput = document.getElementById('dashboardSearch');
    
    // Debounce function untuk membatasi frekuensi pencarian
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Fungsi pencarian
    function handleSearch() {
        updateSolvedReportsUI();
    }
    
    // Menambahkan event listener dengan debounce
    searchInput.addEventListener('input', debounce(handleSearch, 300));
    
    // Memperbarui fungsi filterReports untuk memasukkan pencarian
    const originalFilterReports = window.filterReports;
    
    window.filterReports = function(reports) {
        let filteredReports = originalFilterReports(reports);
        
        // Terapkan filter pencarian
        const searchTerm = searchInput.value.trim().toLowerCase();
        if (searchTerm) {
            filteredReports = filteredReports.filter(report => {
                // Cari di berbagai field yang relevan
                return (
                    (report.id && report.id.toLowerCase().includes(searchTerm)) ||
                    (report.brand && report.brand.toLowerCase().includes(searchTerm)) ||
                    (report.userId && report.userId.toLowerCase().includes(searchTerm)) ||
                    (report.reportedBy && report.reportedBy.toLowerCase().includes(searchTerm)) ||
                    (report.title && report.title.toLowerCase().includes(searchTerm)) ||
                    (report.category && report.category.toLowerCase().includes(searchTerm)) ||
                    (report.description && report.description.toLowerCase().includes(searchTerm)) ||
                    (report.resolution && report.resolution.toLowerCase().includes(searchTerm)) ||
                    (report.status && report.status.toLowerCase().includes(searchTerm))
                );
            });
        }
        
        return filteredReports;
    };
}

// Panggil fungsi setup setelah DOM selesai dimuat
document.addEventListener('DOMContentLoaded', function() {
    // ... kode yang sudah ada ...
    
    // Tambahkan setup fungsi search
    setupSearchFunctionality();
    
    // ... kode yang sudah ada ...
});
// Fungsi untuk memperbarui filter kategori berdasarkan status solved
function updateCategoryFilter() {
    const categoryFilter = document.getElementById('categoryFilter');
    
    // Hapus opsi kategori yang ada (kecuali opsi "All Categories")
    while (categoryFilter.children.length > 1) {
        categoryFilter.removeChild(categoryFilter.lastChild);
    }
    
    // Dapatkan semua kategori unik dari laporan yang solved
    const uniqueCategories = [...new Set(solvedReports.map(report => report.category))].filter(category => category);
    
    // Tambahkan opsi kategori ke dropdown
    uniqueCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
    });
}

// Fungsi untuk memfilter laporan berdasarkan kategori
function filterReports(reports) {
    const brandFilter = document.getElementById('brandFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    return reports.filter(report => {
        // Filter by brand
        if (brandFilter && report.brand !== brandFilter) {
            return false;
        }
        
        // Filter by status
        if (statusFilter && report.status !== statusFilter) {
            return false;
        }
        
        // Filter by category - TAMBAHAN BARU
        if (categoryFilter && report.category !== categoryFilter) {
            return false;
        }
        
        // Filter by date range - gunakan dateSolved yang sesuai dengan Firestore
        if (startDate && report.dateSolved) {
            const solvedDate = report.dateSolved.toDate().toISOString().split('T')[0];
            if (solvedDate < startDate) {
                return false;
            }
        }
        
        if (endDate && report.dateSolved) {
            const solvedDate = report.dateSolved.toDate().toISOString().split('T')[0];
            if (solvedDate > endDate) {
                return false;
            }
        }
        
        return true;
    });
}

// Perbarui fungsi setupSolvedReportsListener untuk menambahkan update kategori
function setupSolvedReportsListener() {
    if (unsubscribeSolved) {
        unsubscribeSolved();
    }
    
    const reportsRef = db.collection('solvedReports');

    unsubscribeSolved = reportsRef
        .orderBy('dateSolved', 'desc')
        .onSnapshot(snapshot => {
            solvedReports = [];
            snapshot.forEach(doc => {
                const report = doc.data();
                report.id = doc.id;
                
                // Pastikan data yang diperlukan ada
                if (report.dateCreated && report.dateSolved && report.status) {
                    solvedReports.push(report);
                } else {
                    console.warn("Invalid report data:", report);
                }
            });

            updateSolvedReportsUI();
            updateStatistics();
            updateCategoryFilter(); // TAMBAHAN: Perbarui filter kategori

        }, error => {
            console.error("Error fetching solved reports:", error);
            showToast("Error loading solved reports", "error");
        });
}

// Tambahkan HTML untuk filter kategori di dalam Filter Panel
// Tambahkan kode ini di dalam div.filter-grid, setelah filter status
document.addEventListener('DOMContentLoaded', function() {
    // Tunggu sampai DOM sepenuhnya dimuat
    setTimeout(() => {
        const filterGrid = document.querySelector('.filter-grid');
        
        // Buat elemen filter kategori
        const categoryFilterGroup = document.createElement('div');
        categoryFilterGroup.className = 'filter-group';
        categoryFilterGroup.innerHTML = `
            <label class="filter-label">Category</label>
            <select class="filter-select" id="categoryFilter">
                <option value="">All Categories</option>
                <!-- Opsi kategori akan diisi oleh JavaScript -->
            </select>
        `;
        
        // Sisipkan filter kategori setelah filter status
        const statusFilterGroup = document.querySelector('.filter-group:nth-child(2)');
        if (statusFilterGroup) {
            statusFilterGroup.parentNode.insertBefore(categoryFilterGroup, statusFilterGroup.nextSibling);
        } else {
            // Jika tidak menemukan filter status, tambahkan di akhir
            filterGrid.appendChild(categoryFilterGroup);
        }
        
        // Tambahkan event listener untuk filter kategori
        const categoryFilter = document.getElementById('categoryFilter');
        if (categoryFilter) {
            categoryFilter.addEventListener('change', updateSolvedReportsUI);
        }
        
        // Perbarui reset filter untuk menyertakan kategori
        const resetButton = document.getElementById('resetFilters');
        if (resetButton) {
            const originalReset = resetButton.onclick;
            resetButton.onclick = function() {
                document.getElementById('brandFilter').value = '';
                document.getElementById('statusFilter').value = '';
                document.getElementById('categoryFilter').value = ''; // TAMBAHAN
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                updateSolvedReportsUI();
            };
        }
    }, 100);
});
// Fungsi untuk mendapatkan nama user berdasarkan userId
async function getUserName(userId) {
    try {
        // Jika userId adalah ID dari current user, ambil dari profil
        const currentUser = auth.currentUser;
        if (currentUser && userId === currentUser.uid) {
            const profile = await getProfileFromFirestore();
            return profile ? profile.name : 'Unknown User';
        }
        
        // Jika userId berbeda, coba ambil dari Firestore
        const userDoc = await db.collection('users').doc(userId).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            return userData.name || 'Unknown User';
        }
        
        return 'Unknown User';
    } catch (error) {
        console.error('Error getting user name:', error);
        return 'Unknown User';
    }
}

// Fungsi untuk mendapatkan nama user dengan caching
const userCache = new Map();
async function getCachedUserName(userId) {
    if (!userId) return 'Unknown User';
    
    if (userCache.has(userId)) {
        return userCache.get(userId);
    }
    
    const userName = await getUserName(userId);
    userCache.set(userId, userName);
    return userName;
}
// Fungsi untuk mendapatkan role user saat ini
async function getCurrentUserRole() {
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) return null;
        
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            return userData.role || 'user';
        }
        return 'user';
    } catch (error) {
        console.error('Error getting user role:', error);
        return 'user';
    }
}

// Fungsi untuk mengecek apakah user adalah super admin
async function isSuperAdmin() {
    const role = await getCurrentUserRole();
    return role === 'super_admin';
}
// Tambahkan fungsi ini sebelum getUserName
async function getProfileFromFirestore() {
    try {
        const user = auth.currentUser;
        if (!user) return null;
        
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            return userDoc.data();
        }
        return null;
    } catch (error) {
        console.error('Error getting profile from Firestore:', error);
        return null;
    }
}

// Fungsi untuk mendapatkan nama user berdasarkan userId
async function getUserName(userId) {
    try {
        // Jika userId adalah ID dari current user, ambil dari profil
        const currentUser = auth.currentUser;
        if (currentUser && userId === currentUser.uid) {
            const profile = await getProfileFromFirestore();
            return profile ? profile.name : 'Unknown User';
        }
        
        // Jika userId berbeda, coba ambil dari Firestore
        const userDoc = await db.collection('users').doc(userId).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            return userData.name || 'Unknown User';
        }
        
        return 'Unknown User';
    } catch (error) {
        console.error('Error getting user name:', error);
        return 'Unknown User';
    }
}
</script>
</body>
</html>
