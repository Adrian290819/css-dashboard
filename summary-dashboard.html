<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summary Dashboard - CSS Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="global.css">
    <link rel="stylesheet" href="stylemobile.css">
    <script src="global-time.js"></script>
    <script src="translations.js"></script>
    <style>
        /* ========== VARIABEL CSS YANG DIPERLUKAN ========== */
        :root {
            --primary-gradient: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            --warning-gradient: linear-gradient(135deg, #f72585 0%, #7209b7 100%);
            --info-gradient: linear-gradient(135deg, #4895ef 0%, #3f37c9 100%);
        }

        /* ========== PERBAIKAN UTAMA UNTUK LAYOUT ========== */
        .main-content {
            padding: var(--space-lg);
            background-color: var(--bg-secondary);
            min-height: 100vh;
        }

        .header {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        

        /* ========== PERBAIKAN STATISTIC CARDS ========== */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .summary-stat-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .summary-stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .summary-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .summary-stat-card.performance::before {
            background: var(--success-gradient);
        }

        .summary-stat-card.trend::before {
            background: var(--info-gradient);
        }

        .summary-stat-card.comparison::before {
            background: var(--warning-gradient);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }

        .stat-title {
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--text-secondary);
            margin: 0;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .stat-icon.performance {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .stat-icon.trend {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--info);
        }

        .stat-icon.comparison {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: var(--font-bold);
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
            line-height: 1;
        }

        .stat-description {
            font-size: var(--text-xs);
            color: var(--text-secondary);
        }

        /* Tooltip untuk info metrik */
        .info-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: help;
        }

        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--text-primary);
            color: var(--bg-primary);
            text-align: center;
            border-radius: var(--radius-md);
            padding: var(--space-sm);
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: var(--text-xs);
            font-weight: normal;
        }

        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* ========== PERBAIKAN FILTER SECTION ========== */
        /* ========== PERBAIKAN FILTER SECTION ========== */
.summary-filters {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr auto; /* Kolom ke-4 untuk actions */
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
    padding: var(--space-lg);
    background-color: var(--card-bg);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    min-height: 70px;
}

.filter-group label {
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: var(--space-xs);
    display: block;
}

.filter-select {
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background-color: var(--input-bg);
    color: var(--text-primary);
    font-size: var(--text-sm);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    height: 42px;
    width: 100%;
    box-sizing: border-box;
}

.filter-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

/* Perbaikan khusus untuk date range filter */
.date-range-inputs {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    flex-wrap: nowrap;
    width: 100%;
}

.date-range-inputs span {
    color: var(--text-secondary);
    font-size: var(--text-sm);
    white-space: nowrap;
    min-width: 20px;
    text-align: center;
}

.date-range-inputs input[type="date"] {
    flex: 1;
    min-width: 120px;
}

/* Filter Actions - posisi sejajar dengan filter lainnya */
.filter-actions {
    display: flex;
    gap: var(--space-sm);
    align-items: end;
    height: 42px;
}

.filter-actions .btn {
    height: 42px;
    white-space: nowrap;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 120px;
}

/* Responsif untuk filter section */
@media (max-width: 1024px) {
    .summary-filters {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .filter-actions {
        grid-column: 1 / -1;
        margin-top: var(--space-sm);
        justify-content: flex-start;
    }
}

@media (max-width: 768px) {
    .summary-filters {
        grid-template-columns: 1fr;
        gap: var(--space-md);
    }
    
    .date-range-inputs {
        flex-direction: row;
        align-items: center;
    }
    
    .date-range-inputs span {
        margin: 0;
    }
    
    .filter-actions {
        flex-direction: row;
        gap: var(--space-sm);
    }
    
    .filter-actions .btn {
        min-width: auto;
        flex: 1;
    }
}

        /* ========== PERBAIKAN CHART CONTAINER ========== */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
        }

        .chart-title {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin: 0;
        }

        .chart-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .chart-content {
            height: 300px;
            position: relative;
        }

        /* ========== PERBAIKAN TABLE ========== */
        .summary-table-section {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-bottom: var(--space-xl);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border-color);
        }

        .section-title {
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin: 0;
        }

        .section-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .summary-table-container {
            overflow-x: auto;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            margin-bottom: var(--space-lg);
        }

        .summary-table {
            margin: 0;
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 900px;
        }

        .summary-table th {
            padding: var(--space-md) var(--space-lg);
            background: var(--table-header-bg);
            font-weight: var(--font-semibold);
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .summary-table td {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: var(--text-sm);
            vertical-align: middle;
            line-height: 1.5;
        }

        .summary-table tr:last-child td {
            border-bottom: none;
        }

        .summary-table tr:hover {
            background-color: var(--hover-color);
            transition: background-color var(--transition-fast);
        }

        /* Perbaikan untuk Action Buttons */
        .action-buttons {
            display: flex;
            gap: var(--space-xs);
            justify-content: flex-start;
            flex-wrap: nowrap;
        }

        .btn-icon {
            width: 34px;
            height: 34px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: var(--text-sm);
            padding: 0;
            box-shadow: var(--shadow-xs);
        }

        .btn-icon.view {
            background: var(--info-light);
            color: var(--info);
        }

        .btn-icon:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
            opacity: 0.9;
        }

        /* ========== PERBAIKAN EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: var(--space-xl) var(--space-lg);
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            border: 2px dashed var(--border-color);
            margin: var(--space-lg) 0;
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--text-tertiary);
            margin-bottom: var(--space-md);
        }

        .empty-state h3 {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
        }

        .empty-state p {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-lg);
        }

        /* ========== PERBAIKAN PAGINATION ========== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-md);
            margin-top: var(--space-lg);
            padding: var(--space-md) 0;
        }

        .page-numbers {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            font-weight: var(--font-medium);
        }

        /* ========== PERBAIKAN MODAL ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            transform: translateY(20px);
            transition: transform var(--transition-normal);
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: background-color var(--transition-fast);
        }

        .modal-close:hover {
            background-color: var(--hover-color);
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--space-lg);
        }

        .modal-footer {
            padding: var(--space-lg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-sm);
        }

        /* Form input static (readonly) */
        .form-input-static {
            padding: var(--space-sm) 0;
            color: var(--text-primary);
            font-size: var(--text-sm);
            line-height: var(--leading-normal);
            min-height: 20px;
        }

        /* Time tracking styles */
        .time-tracking {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
            background: var(--bg-secondary);
            padding: var(--space-md);
            border-radius: var(--radius-md);
        }

        .time-track-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-xs) 0;
        }

        .time-track-label {
            font-weight: var(--font-medium);
            color: var(--text-secondary);
        }

        .time-track-value {
            font-weight: var(--font-semibold);
            color: var(--text-primary);
        }

        /* Menu item styles */
        .menu-item {
            background-color: transparent;
            color: var(--text-primary);
            padding: 12px;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.3s ease, color 0.3s ease;
            border: none;
            text-decoration: none;
        }

        .menu-item:hover {
            background-color: var(--hover-color);
            color: var(--menu-hover-text);
        }

        .menu-item:hover i,
        .menu-item:hover .menu-icon {
            color: var(--menu-hover-text);
        }

        .menu-item.active {
            background: var(--success-gradient);
            color: #fff;
        }

        /* Today indicator */
        .today-indicator {
            display: inline-block;
            padding: 4px 8px;
            background-color: var(--info-light);
            color: var(--info);
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
            margin-left: var(--space-sm);
        }

        /* Chart canvas styling */
        .chart-canvas {
            width: 100%;
            height: 100%;
        }

        /* Export button */
        .btn-export {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            transition: all var(--transition-fast);
        }

        .btn-export:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* Button styles */
        .btn {
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            transition: all var(--transition-fast);
            border: none;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-outline {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* KPI Container */
        .kpi-container {
            margin-bottom: var(--space-lg);
        }

        .kpi-tab-menu {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ========== RESPONSIVE ADJUSTMENTS ========== */
        @media (max-width: 1024px) {
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: var(--space-md);
            }
            
            .header {
                padding: var(--space-md);
            }
            
            .summary-stats {
                grid-template-columns: 1fr;
            }
            
            .summary-filters {
                grid-template-columns: 1fr;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-sm);
            }
            
            .summary-table th, 
            .summary-table td {
                padding: var(--space-sm) var(--space-md);
            }
            
            .modal {
                width: 95%;
                margin: var(--space-md);
            }
        }

        @media (max-width: 640px) {
            .summary-table {
                min-width: 100%;
            }
            
            .summary-table th:nth-child(3),
            .summary-table td:nth-child(3),
            .summary-table th:nth-child(6),
            .summary-table td:nth-child(6) {
                display: none;
            }
            
            .pagination {
                flex-direction: column;
                gap: var(--space-sm);
            }
            
            .chart-content {
                height: 250px;
            }
        }

        /* Custom scrollbar for table container */
        .summary-table-container::-webkit-scrollbar {
            height: 8px;
        }

        .summary-table-container::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: var(--radius-full);
        }

        .summary-table-container::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: var(--radius-full);
        }

        .summary-table-container::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        /* Hover effects for table rows */
        .summary-table tr {
            transition: background-color var(--transition-fast), transform var(--transition-fast);
        }

        .summary-table tr:hover {
            background-color: var(--hover-color);
            transform: translateX(4px);
        }

        /* Improved focus states for accessibility */
        .btn-icon:focus,
        .filter-select:focus,
        .modal-close:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Style untuk status indicator */
        .status-pending {
            color: #f59e0b;
            background-color: rgba(245, 158, 11, 0.1);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
        }

        .status-solved {
            color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
        }

        .status-maintenance {
            color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--info);
            z-index: 1001;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: #ef4444;
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .notification i {
            font-size: 1.25rem;
        }

        .notification.success i {
            color: var(--success);
        }

        .notification.error i {
            color: #ef4444;
        }
         .chart-card.expanded {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90vw;
            height: 90vh;
            z-index: 1002;
            animation: expandChart 0.3s ease;
        }

        .chart-card.expanded .chart-content {
            height: calc(100% - 80px);
        }

        @keyframes expandChart {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

       /* ========== PERBAIKAN ADDITIONAL STATS ========== */
        .additional-stats {
            margin-bottom: var(--space-lg);
        }

        .additional-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
        }

        .additional-stat-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .additional-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .additional-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
        }

        .additional-stat-value {
            font-size: 2rem;
            font-weight: var(--font-bold);
            color: var(--primary);
            margin-bottom: var(--space-xs);
            line-height: 1;
        }

        .additional-stat-label {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            font-weight: var(--font-medium);
        }

        /* Warna khusus untuk beberapa statistik */
        .additional-stat-card:nth-child(2)::before { background: var(--warning-gradient); }
        .additional-stat-card:nth-child(3)::before { background: var(--success-gradient); }
        .additional-stat-card:nth-child(4)::before { background: var(--info-gradient); }
        .additional-stat-card:nth-child(5)::before { background: #f72585; }
        .additional-stat-card:nth-child(6)::before { background: #7209b7; }
        .additional-stat-card:nth-child(7)::before { background: #3a0ca3; }
        .additional-stat-card:nth-child(8)::before { background: #4361ee; }

        /* Responsif untuk additional stats */
        @media (max-width: 1024px) {
            .additional-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .additional-stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Filter actions */
        .filter-actions {
            display: flex;
            gap: var(--space-sm);
            align-items: end;
        }

        .filter-actions .btn {
            height: 42px;
            white-space: nowrap;
        }
        /* Tambahkan ini setelah .summary-stat-card.comparison::before */
.summary-stat-card.pending::before {
    background: #f72585; /* Warna merah muda seperti di gambar */
}

.summary-stat-card.solved::before {
    background: #10b981; /* Warna hijau */
}

.summary-stat-card.maintenance::before {
    background: #4895ef; /* Warna biru */
}
    </style>
</head>
<body>
    <!-- Container untuk sidebar yang akan dimuat oleh sidebar-loader.js -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div id="notificationContainer"></div>
            <button class="menu-toggle">
                <i class="fas fa-chart-pie"></i>
            </button>
            <h1><i class="fas fa-chart-pie"></i>Dashboard Overview</h1>
            <div class="header-actions">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search..." id="summarySearch">
                </div>
                
                <button class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="user-profile">
                    <img class="profile-img" src="https://iili.io/Fpiva7S.png" alt="Profile">
                    <div class="user-info">
                        <h4>Nama Masing Masing</h4>
                        <p>Customer Service Support</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="kpi-container">
            <!-- Tab Menu -->
            <div class="kpi-tab-menu">
                <!-- Dashboard Overview -->
            </div>
        </div>

        <!-- Summary Stats Cards -->
        <div class="summary-stats">
            <div class="summary-stat-card fade-in" style="animation-delay: 0.1s;">
                <div class="stat-header">
                    <h3 class="stat-title">Weekly Performance
                        <span class="info-tooltip">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltip-text">Persentase laporan yang diselesaikan dalam 7 hari terakhir</span>
                        </span>
                    </h3>
                    <div class="stat-icon performance">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                <div class="stat-value" id="weeklyPerformance">0%</div>
                <div class="stat-description">
                    <span id="performanceChange" class="positive">
                        <i class="fas fa-arrow-up"></i> <span id="performanceChangeValue">0%</span> from last week
                    </span>
                </div>
            </div>

           <div class="summary-stat-card fade-in" style="animation-delay: 0.2s;">
                <div class="stat-header">
                    <h3 class="stat-title">Resolution Trend
                        <span class="info-tooltip">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltip-text">Tingkat resolusi keseluruhan (laporan terselesaikan / total laporan)</span>
                        </span>
                    </h3>
                    <div class="stat-icon trend">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="stat-value" id="resolutionRate">0%</div>
                <div class="stat-description">
                    <span id="trendChange" class="positive">
                        <i class="fas fa-arrow-up-right-dots"></i> <span id="trendChangeValue">0%</span> improvement
                    </span>
                </div>
            </div>

            <div class="summary-stat-card fade-in" style="animation-delay: 0.3s;">
                <div class="stat-header">
                    <h3 class="stat-title">Top Brand by Reports
                        <span class="info-tooltip">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltip-text">Brand dengan jumlah laporan terbanyak</span>
                        </span>
                    </h3>
                    <div class="stat-icon comparison">
                        <i class="fas fa-crown"></i>
                    </div>
                </div>
                <div class="stat-value" id="topBrand">-</div>
                <div class="stat-description">
                    <span id="topBrandCount">0</span> reports this month
                </div>
            </div>
        </div>

<div class="additional-stats fade-in" style="animation-delay: 0.4s;">
    <div class="additional-stats-grid">
        <div class="additional-stat-card summary-stat-card">
            <div class="additional-stat-value" id="totalReports">0</div>
            <div class="additional-stat-label">Total Reports</div>
        </div>
        <div class="additional-stat-card summary-stat-card solved">
            <div class="additional-stat-value" id="solvedReports">0</div>
            <div class="additional-stat-label">Solved Reports</div>
        </div>
        <div class="additional-stat-card summary-stat-card pending">
            <div class="additional-stat-value" id="pendingReports">0</div>
            <div class="additional-stat-label">Pending Reports</div>
        </div>
        <div class="additional-stat-card summary-stat-card maintenance">
            <div class="additional-stat-value" id="maintenanceReports">0</div>
            <div class="additional-stat-label">Maintenance Reports</div>
        </div>
                <div class="additional-stat-card">
                    <div class="additional-stat-value" id="solvedMaintenance">0</div>
                    <div class="additional-stat-label">Solved Maintenance</div>
                </div>
                <div class="additional-stat-card">
                    <div class="additional-stat-value" id="newGameReleases">0</div>
                    <div class="additional-stat-label">New Game Releases</div>
                </div>
                <div class="additional-stat-card">
                    <div class="additional-stat-value" id="newfeatureReleases">0</div>
                    <div class="additional-stat-label">New Feature Releases</div>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="summary-filters fade-in" style="animation-delay: 0.5s;">
            <!-- Filter Category -->
            <div class="filter-group">
                <label for="categoryFilter">Category</label>
                <select class="filter-select" id="categoryFilter">
                    <option value="all">All Categories</option>
                    <option value="Pending">Pending Report</option>
                    <option value="Solved">Solved Report</option>
                    <option value="Maintenance">Pending Maintenance</option>
                    <option value="Maintenance Solved">Solved Maintenance</option>
                    <option value="Releases New Feature">Releases New Feature</option>
                    <option value="Releases New Game">Releases New Game</option>
                    <option value="Report Autoqris PAVPG">Report Autoqris PAVPG</option>
                </select>
            </div>

            <!-- Filter Brand -->
            <div class="filter-group">
                <label for="brandFilter">Brand</label>
                <select class="filter-select" id="brandFilter">
                    <option value="all">All Brands</option>
                    <option value="CERIASLOT99 (D-GAMING)">CERIASLOT99 (D-GAMING)</option>
                                <option value="RAJASCATTER88 (D-GAMING)">RAJASCATTER88 (D-GAMING)</option>
                                <option value="MAHJONGJP88 (D-GAMING)">MAHJONGJP88 (D-GAMING)</option>
                                <option value="NAGAHOKI88 (D-GAMING)">NAGAHOKI88 (D-GAMING)</option>
                                <option value="SPACEMAN88 (D-GAMING)">SPACEMAN88 (D-GAMING)</option>
                                <option value="RAJAPANEN (D-GAMING)">RAJAPANEN (D-GAMING)</option>
                                <option value="BROTO88 (D-GAMING)">BROTO88 (D-GAMING)</option>
                                <option value="MEDUSA88 (GACHA)">MEDUSA88 (GACHA)</option>
                                <option value="ATHENA168 (GACHA)">ATHENA168 (GACHA)</option>
                                <option value="ARES GACOR (GACHA)">ARES GACOR (GACHA)</option>
                                <option value="RAJA MAHJONG (GACHA)">RAJA MAHJONG (GACHA)</option>
                                <option value="OLYMPUS1000 (GACHA)">OLYMPUS1000 (GACHA)</option>
                                <option value="CLICKBET (GACHA)">CBWL (GACHA)</option>
                                <option value="RAJA COVID (GACHA)">RAJA COVID (GACHA)</option>
                                <option value="BANG GACOR 88 (GACHA)">BANG GACOR 88 (GACHA)</option>
                                <option value="HACKSAW88 (GACHA)">HACKSAW88 (GACHA)</option>
                                <option value="GACHA99 (GACHA)">GACHA99 (GACHA)</option>
                                <option value="UJANGBET (BREM)">UJANGBET (BREM)</option>
                                <option value="EPISODEBET (BREM)">EPISODEBET (BREM)</option>
                                <option value="FOKUSBET88 (89ENGINE)">FOKUSBET88 (89ENGINE)</option>
                                <option value="RAJAKING88 (89ENGINE)">RAJAKING88 (89ENGINE)</option>
                                <option value="RAJANAGA99 (89ENGINE)">RAJANAGA99 (89ENGINE)</option>
                                <option value="KUDAHOKI88 (89ENGINE)">KUDAHOKI88 (89ENGINE)</option>
                                <option value="MAPAN99 (89ENGINE)">MAPAN99 (89ENGINE)</option>
                                <option value="JOIN999 (LUXION)">JOIN999 (LUXION)</option>
                </select>
            </div>

            <!-- Filter Date Range -->
            <div class="filter-group">
                <label for="startDate">Date Range</label>
                <div class="date-range-inputs">
                    <input type="date" class="filter-select" id="startDate" aria-label="Start date">
                    <span>to</span>
                    <input type="date" class="filter-select" id="endDate" aria-label="End date">
                </div>
            </div>

            <!-- Filter Actions -->
            <div class="filter-actions">
                <button class="btn btn-primary" id="applyFilters">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
                <button class="btn btn-outline" id="resetFilters">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-container">
            <div class="chart-card fade-in" style="animation-delay: 0.6s;">
                <div class="chart-header">
                    <h3 class="chart-title">Reports by Status</h3>
                    <div class="chart-actions">
                        <button class="btn-icon" onclick="expandChart('statusChart')">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="statusChart" class="chart-canvas"></canvas>
                </div>
            </div>
            
            <div class="chart-card fade-in" style="animation-delay: 0.7s;">
                <div class="chart-header">
                    <h3 class="chart-title">Weekly Resolution Trend</h3>
                    <div class="chart-actions">
                        <button class="btn-icon" onclick="expandChart('trendChart')">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="trendChart" class="chart-canvas"></canvas>
                </div>
            </div>
            
            <div class="chart-card fade-in" style="animation-delay: 0.8s;">
                <div class="chart-header">
                    <h3 class="chart-title">Reports by Category</h3>
                    <div class="chart-actions">
                        <button class="btn-icon" onclick="expandChart('categoryChart')">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="categoryChart" class="chart-canvas"></canvas>
                </div>
            </div>
            
            <div class="chart-card fade-in" style="animation-delay: 0.9s;">
                <div class="chart-header">
                    <h3 class="chart-title">Reports by Brand</h3>
                    <div class="chart-actions">
                        <button class="btn-icon" onclick="expandChart('brandChart')">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="brandChart" class="chart-canvas"></canvas>
                </div>
            </div>
            
            <div class="chart-card fade-in" style="animation-delay: 1.0s;">
                <div class="chart-header">
                    <h3 class="chart-title">New Game Releases</h3>
                    <div class="chart-actions">
                        <button class="btn-icon" onclick="expandChart('gameReleasesChart')">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="gameReleasesChart" class="chart-canvas"></canvas>
                </div>
            </div>
            
            <div class="chart-card fade-in" style="animation-delay: 1.1s;">
                <div class="chart-header">
                    <h3 class="chart-title">New Feature Releases</h3>
                    <div class="chart-actions">
                        <button class="btn-icon" onclick="expandChart('featureReleasesChart')">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="featureReleasesChart" class="chart-canvas"></canvas>
                </div>
            </div>
        </div>

        <!-- Summary Table Section -->
        <div class="summary-table-section fade-in" style="animation-delay: 1.2s;">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-table"></i> All Reports
                    <span class="badge" id="totalReportsCount">0</span>
                </h2>
                <div class="section-actions">
                    <button class="btn-export" id="exportBtn">
                        <i class="fas fa-file-export"></i> Export Data
                    </button>
                </div>
            </div>
            
            <div class="summary-table-container">
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Report ID</th>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Brand</th>
                            <th>Resolution Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                        <!-- Data akan dimasukkan oleh JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Empty State -->
            <div class="empty-state" id="noSummaryData" style="display: none;">
                <i class="fas fa-clipboard-list"></i>
                <h3>No Reports Found</h3>
                <p>No reports match your current filters.</p>
            </div>
            
            <!-- Pagination -->
            <div class="pagination">
                <button class="btn btn-outline" id="prevPage" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span class="page-numbers" id="pageNumbers">Page 1 of 1</span>
                <button class="btn btn-outline" id="nextPage" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="sidebar-loader.js"></script>
    <script src="user-profile.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>


    <script>
    // ========== KONFIGURASI FIREBASE ==========
    const firebaseConfig = {
        apiKey: "AIzaSyDUZka4FZyLi_cv6X_5D4zeRsfkpqOlBpY",
        authDomain: "dashboard-css.firebaseapp.com",
        databaseURL: "https://dashboard-css-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "dashboard-css",
        storageBucket: "dashboard-css.appspot.com",
        messagingSenderId: "771131792881",
        appId: "1:771131792881:web:ad634424225bd7de847850",
        measurementId: "G-3CYBC5B101"
    };

    // Inisialisasi Firebase
    try {
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase initialized successfully");
    } catch (error) {
        console.error("Firebase initialization error:", error);
    }

    const db = firebase.firestore();
    const auth = firebase.auth();

    // ========== VARIABEL GLOBAL ==========
    let allReportsData = [];
    let filteredReportsData = [];
    let reportsListener = null;
    let newGamesListener = null;
    let currentPage = 1;
    const itemsPerPage = 10;
    let totalPages = 1;
    let currentSearchTerm = '';
    
    // Filter state
    let activeFilters = {
        category: 'all',
        brand: 'all',
        startDate: '',
        endDate: ''
    };

    // Chart instances
    let statusChartInstance = null;
    let trendChartInstance = null;
    let categoryChartInstance = null;
    let brandChartInstance = null;
    let gameReleasesChartInstance = null;
    let featureReleasesChartInstance = null;

    // ========== FUNGSI UTAMA ==========

    // Fungsi untuk setup listener data laporan
    function setupReportsListener() {
        console.log("Setting up reports listener");
        
        // Hentikan listener sebelumnya jika ada
        if (reportsListener) {
            reportsListener();
        }
        
        // Setup listener untuk semua jenis data tanpa filter tanggal
        const pendingQuery = db.collection('pendingReports');
        const solvedQuery = db.collection('solvedReports');
        const maintenanceQuery = db.collection('maintenanceReports');
        const solvedMaintenanceQuery = db.collection('solvedMaintenance');
        
        // Simpan unsubscribe functions
        const unsubscribeFunctions = [];
        
        // Listener untuk pending reports
        const pendingUnsubscribe = pendingQuery.onSnapshot(
            (snapshot) => {
                console.log(`[PENDING]  Snapshot received: ${snapshot.docs.length} documents`);
                processPendingSnapshot(snapshot);
                updateCombinedReports();
            },
            (error) => {
                console.error("[PENDING]  Error:", error);
                showNotification('Gagal memuat data pending reports', 'error');
            }
        );
        unsubscribeFunctions.push(pendingUnsubscribe);

        // Listener untuk solved reports
        const solvedUnsubscribe = solvedQuery.onSnapshot(
            (snapshot) => {
                console.log(`[SOLVED]  Snapshot received: ${snapshot.docs.length} documents`);
                processSolvedSnapshot(snapshot);
                updateCombinedReports();
            },
            (error) => {
                console.error("[SOLVED]  Error:", error);
                showNotification('Gagal memuat data solved reports', 'error');
            }
        );
        unsubscribeFunctions.push(solvedUnsubscribe);
        
        // Listener untuk maintenance reports
        const maintenanceUnsubscribe = maintenanceQuery.onSnapshot(
            (snapshot) => {
                console.log("[MAINTENANCE]  Snapshot received:", snapshot.docs.length, "documents");
                processMaintenanceSnapshot(snapshot);
                updateCombinedReports();
            },
            (error) => {
                console.error("[MAINTENANCE]  Error:", error);
                showNotification('Gagal memuat data maintenance', 'error');
            }
        );
        unsubscribeFunctions.push(maintenanceUnsubscribe);
        
        // Listener untuk solved maintenance
        const solvedMaintenanceUnsubscribe = solvedMaintenanceQuery.onSnapshot(
            (snapshot) => {
                console.log("[SOLVED MAINTENANCE]  Snapshot received:", snapshot.docs.length, "documents");
                processSolvedMaintenanceSnapshot(snapshot);
                updateCombinedReports();
            },
            (error) => {
                console.error("[SOLVED MAINTENANCE]  Error:", error);
                showNotification('Gagal memuat data solved maintenance', 'error');
            }
        );
        unsubscribeFunctions.push(solvedMaintenanceUnsubscribe);
        
        // Kembalikan fungsi untuk unsubscribe semua listener
        reportsListener = () => {
            unsubscribeFunctions.forEach(unsubscribe => unsubscribe());
            console.log("Reports listeners removed");
        };
    }

    // Proses snapshot pending reports
    function processPendingSnapshot(snapshot) {
        const pendingReports = snapshot.docs.map(doc => {
            const data = doc.data();
            
            return { 
                id: doc.id, 
                ...data,
                status: 'Pending',
                collection: 'pendingReports',
                date: data.dateCreated || new Date(),
                dateCreated: data.dateCreated || new Date(),
                isSolved: false,
                category: 'Pending Report',
                type: 'Report'
            };
        });
        
        window.pendingReportsCache = pendingReports;
        console.log(`[PENDING]  Cached: ${pendingReports.length} reports`);
    }

    // Proses snapshot solved reports
    function processSolvedSnapshot(snapshot) {
        const solvedReports = snapshot.docs.map(doc => {
            const data = doc.data();
            
            return { 
                id: doc.id, 
                ...data,
                status: 'Solved',
                collection: 'solvedReports',
                date: data.dateCreated || data.dateSolved || new Date(),
                dateCreated: data.dateCreated || data.dateSolved || new Date(),
                dateSolved: data.dateSolved || new Date(),
                isSolved: true,
                category: 'Solved Report',
                type: 'Report',
                resolutionTime: calculateResolutionTime(data.dateCreated, data.dateSolved)
            };
        });
        
        window.solvedReportsCache = solvedReports;
        console.log(`[SOLVED]  Cached: ${solvedReports.length} reports`);
    }

    // Proses snapshot maintenance reports
    function processMaintenanceSnapshot(snapshot) {
        const maintenanceReports = snapshot.docs.map(doc => {
            const data = doc.data();
            
            return { 
                id: doc.id, 
                ...data,
                status: 'Maintenance',
                collection: 'maintenanceReports',
                date: data.dateCreated || new Date(),
                dateCreated: data.dateCreated || new Date(),
                isSolved: false,
                category: 'Pending Maintenance',
                type: 'Maintenance'
            };
        });
        
        window.maintenanceReportsCache = maintenanceReports;
        console.log(`[MAINTENANCE]  Cached: ${maintenanceReports.length} reports`);
    }

    // Proses snapshot solved maintenance
    function processSolvedMaintenanceSnapshot(snapshot) {
        const solvedMaintenanceReports = snapshot.docs.map(doc => {
            const data = doc.data();
            
            return { 
                id: doc.id, 
                ...data,
                status: 'Maintenance Solved',
                collection: 'solvedMaintenance',
                date: data.dateCompleted || data.dateCreated || new Date(),
                dateCreated: data.dateCreated || new Date(),
                dateCompleted: data.dateCompleted || new Date(),
                isSolved: true,
                category: 'Solved Maintenance',
                type: 'Maintenance',
                resolutionTime: calculateResolutionTime(data.dateCreated, data.dateCompleted)
            };
        });
        
        window.solvedMaintenanceCache = solvedMaintenanceReports;
        console.log(`[SOLVED MAINTENANCE]  Cached: ${solvedMaintenanceReports.length} reports`);
    }

    // Hitung waktu resolusi dalam menit
    function calculateResolutionTime(startDate, endDate) {
        if (!startDate || !endDate) {
            return 0;
        }
        
        try {
            const start = startDate.toDate ? startDate.toDate() : new Date(startDate);
            const end = endDate.toDate ? endDate.toDate() : new Date(endDate);
            
            if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                return 0;
            }
            
            const diffMs = end - start;
            return Math.round(diffMs / (1000 * 60));
            
        } catch (error) {
            console.error("Error calculating resolution time:", error);
            return 0;
        }
    }

    function updateCombinedReports() {
        const pending = window.pendingReportsCache || [];
        const solved = window.solvedReportsCache || [];
        const maintenance = window.maintenanceReportsCache || [];
        const solvedMaintenance = window.solvedMaintenanceCache || [];
        const newGames = window.newGamesData || [];
        const newFeatures = window.featuresData || [];
        
        // Tambahkan new games dan features sebagai laporan khusus
        const gameReleases = newGames.map(game => ({
            id: game.id,
            ...game,
            status: 'Released',
            collection: 'newGame',
            date: game.dateCreated || new Date(),
            dateCreated: game.dateCreated || new Date(),
            category: 'Releases New Game',
            type: 'Release',
            brand: game.brand || 'Unknown'
        }));
        
        const featureReleases = newFeatures.map(feature => ({
            id: feature.id,
            ...feature,
            status: 'Released',
            collection: 'releases',
            date: feature.dateCreated || new Date(),
            dateCreated: feature.dateCreated || new Date(),
            category: 'Releases New Feature',
            type: 'Release',
            brand: feature.brand || 'Unknown'
        }));
        
        // Gabungkan semua laporan
        allReportsData = [...pending, ...solved, ...maintenance, ...solvedMaintenance, ...gameReleases, ...featureReleases];
        
        console.log(` Total combined reports: ${allReportsData.length}`);
        
        // Terapkan filter saat ini
        applyCurrentFilters();
    }

    // ========== FUNGSI FILTER ==========

function applyCurrentFilters() {
    let filtered = [...allReportsData];
    
    // Filter berdasarkan kategori
    if (activeFilters.category !== 'all') {
        filtered = filtered.filter(report => {
                if (activeFilters.category === 'Pending') {
                    return report.category === 'Pending Report';
                } else if (activeFilters.category === 'Solved') {
                    return report.category === 'Solved Report';
                } else if (activeFilters.category === 'Maintenance') {
                    return report.category === 'Pending Maintenance';
                } else if (activeFilters.category === 'Maintenance Solved') {
                    return report.category === 'Solved Maintenance';
                } else if (activeFilters.category === 'Releases New Feature') {
                    return report.category === 'Releases New Feature';
                } else if (activeFilters.category === 'Releases New Game') {
                    return report.category === 'Releases New Game';
                }
                return true;
            });
        }
        
        // Filter berdasarkan brand
        if (activeFilters.brand !== 'all') {
            filtered = filtered.filter(report => 
                report.brand === activeFilters.brand
            );
        }
        
        // Filter berdasarkan tanggal
        if (activeFilters.startDate) {
            const startDate = new Date(activeFilters.startDate);
            startDate.setHours(0, 0, 0, 0);
            
            filtered = filtered.filter(report => {
                const reportDate = report.date?.toDate ? report.date.toDate() : new Date(report.date);
                return reportDate >= startDate;
            });
        }
        
        if (activeFilters.endDate) {
            const endDate = new Date(activeFilters.endDate);
            endDate.setHours(23, 59, 59, 999);
            
            filtered = filtered.filter(report => {
                const reportDate = report.date?.toDate ? report.date.toDate() : new Date(report.date);
                return reportDate <= endDate;
            });
        }
        
        // Terapkan pencarian jika ada
        if (currentSearchTerm) {
            filtered = filterDataBySearch(filtered, currentSearchTerm);
        }
        
    filteredReportsData = filtered;
    
    // Bersihkan chart sebelum update
    cleanupAllCharts();
    
    // Update UI dengan data yang difilter
    updateDashboardStats(filteredReportsData);
    updateCharts(filteredReportsData);
    updateSummaryTable(filteredReportsData);
    
    console.log(` Applied filters: ${filtered.length} reports match criteria`);
}

    function handleFilterChange() {
        const categoryFilter = document.getElementById('categoryFilter');
        const brandFilter = document.getElementById('brandFilter');
        const startDate = document.getElementById('startDate');
        const endDate = document.getElementById('endDate');
        
        activeFilters = {
            category: categoryFilter.value,
            brand: brandFilter.value,
            startDate: startDate.value,
            endDate: endDate.value
        };
        
        currentPage = 1;
        applyCurrentFilters();
    }

    function resetFilters() {
        document.getElementById('categoryFilter').value = 'all';
        document.getElementById('brandFilter').value = 'all';
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        
        activeFilters = {
            category: 'all',
            brand: 'all',
            startDate: '',
            endDate: ''
        };
        
        currentPage = 1;
        applyCurrentFilters();
    }

    // ========== FUNGSI STATISTIK & UI UPDATE ==========

    // Fungsi untuk menghitung statistik dashboard
    function calculateRealStats(reports) {
        const totalReports = reports.length;
        
        // Hitung berdasarkan kategori
        const pendingReports = reports.filter(report => 
            report.category === 'Pending Report'
        ).length;
        
        const solvedReports = reports.filter(report => 
            report.category === 'Solved Report'
        ).length;
        
        const maintenanceReports = reports.filter(report => 
            report.category === 'Pending Maintenance'
        ).length;
        
        const solvedMaintenance = reports.filter(report => 
            report.category === 'Solved Maintenance'
        ).length;
        
        const newGameReleases = reports.filter(report => 
            report.category === 'Releases New Game'
        ).length;
        
        const newFeatureReleases = reports.filter(report => 
            report.category === 'Releases New Feature'
        ).length;
        
        // Hitung resolution rate (hanya dari reports biasa)
        const regularReports = reports.filter(report => 
            report.type === 'Report'
        );
        
        const solvedRegularReports = regularReports.filter(report => 
            report.isSolved
        ).length;
        
        const resolutionRate = regularReports.length > 0 ? 
            Math.round((solvedRegularReports / regularReports.length) * 100) : 0;
        
        // Hitung weekly performance (laporan diselesaikan dalam 7 hari terakhir)
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        
        const recentSolvedReports = regularReports.filter(report => {
            if (!report.isSolved) return false;
            
            const solvedDate = report.dateSolved?.toDate ? report.dateSolved.toDate() : 
                             report.dateCompleted?.toDate ? report.dateCompleted.toDate() : 
                             new Date(report.date);
            
            return solvedDate >= sevenDaysAgo;
        }).length;
        
        const weeklyPerformance = regularReports.length > 0 ?
            Math.round((recentSolvedReports / regularReports.length) * 100) : 0;
        
        // Hitung reports per brand
        const brandCounts = {};
        reports.forEach(report => {
            if (report.brand) {
                const brandName = report.brand;
                brandCounts[brandName] = (brandCounts[brandName] || 0) + 1;
            }
        });
        
        // Temukan brand dengan laporan terbanyak
        let topBrand = { name: "None", count: 0 };
        for (const brand in brandCounts) {
            if (brandCounts[brand] > topBrand.count) {
                topBrand = { name: brand, count: brandCounts[brand] };
            }
        }
        
        // Hitung reports per kategori untuk chart
        const categoryCounts = {
            'Pending Report': pendingReports,
            'Solved Report': solvedReports,
            'Pending Maintenance': maintenanceReports,
            'Solved Maintenance': solvedMaintenance,
            'Releases New Game': newGameReleases,
            'Releases New Feature': newFeatureReleases
        };
        
        // Hitung reports per status untuk chart
        const statusCounts = {
            'Pending': pendingReports,
            'Solved': solvedReports,
            'Maintenance': maintenanceReports,
            'Maintenance Solved': solvedMaintenance,
            'Released': newGameReleases + newFeatureReleases
        };
        
        return {
            totalReports,
            pendingReports,
            solvedReports,
            maintenanceReports,
            solvedMaintenance,
            newGameReleases,
            newFeatureReleases,
            resolutionRate,
            weeklyPerformance,
            topBrand,
            categoryCounts,
            statusCounts,
            brandCounts
        };
    }

    // Fungsi untuk memperbarui statistik dashboard
    function updateDashboardStats(reports) {
        const stats = calculateRealStats(reports);
        
        // Update main stats
        document.getElementById('weeklyPerformance').textContent = `${stats.weeklyPerformance}%`;
        document.getElementById('resolutionRate').textContent = `${stats.resolutionRate}%`;
        document.getElementById('topBrand').textContent = stats.topBrand.name;
        document.getElementById('topBrandCount').textContent = stats.topBrand.count;
        
        // Update additional stats
        document.getElementById('totalReports').textContent = stats.totalReports;
        document.getElementById('solvedReports').textContent = stats.solvedReports;
        document.getElementById('pendingReports').textContent = stats.pendingReports;
        document.getElementById('maintenanceReports').textContent = stats.maintenanceReports;
        document.getElementById('solvedMaintenance').textContent = stats.solvedMaintenance;
        document.getElementById('newGameReleases').textContent = stats.newGameReleases;
        document.getElementById('newfeatureReleases').textContent = stats.newFeatureReleases;
        
        // Update table header count
        document.getElementById('totalReportsCount').textContent = reports.length;
    }

    // Fungsi untuk memperbarui semua chart
    function updateCharts(reports) {
        const stats = calculateRealStats(reports);
        
        // Update Status Chart
        updateStatusChart(stats);
        
        // Update Trend Chart
        updateTrendChart(reports);
        
        // Update Category Chart
        updateCategoryChart(stats);
        
        // Update Brand Chart
        updateBrandChart(stats);
        
        // Update Game Releases Chart
        updateGameReleasesChart(reports);
        
        // Update Feature Releases Chart
        updateFeatureReleasesChart(reports);
    }

    function updateStatusChart(stats) {
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        
        if (statusChartInstance) {
            statusChartInstance.destroy();
        }
        
        statusChartInstance = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Solved', 'Pending', 'Maintenance', 'Maintenance Solved', 'Released'],
                datasets: [{
                    data: [
                        stats.statusCounts.Solved,
                        stats.statusCounts.Pending,
                        stats.statusCounts.Maintenance,
                        stats.statusCounts['Maintenance Solved'],
                        stats.statusCounts.Released
                    ],
                    backgroundColor: ['#4cc9f0', '#f72585', '#4895ef', '#3a0ca3', '#7209b7'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw} reports`;
                            }
                        }
                    }
                }
            }
        });
    }

    function updateTrendChart(reports) {
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        
        // Hitung trend mingguan (7 hari terakhir)
        const dates = [];
        const solvedCounts = [];
        const pendingCounts = [];
        
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const dateStr = date.toLocaleDateString('id-ID', { weekday: 'short' });
            dates.push(dateStr);
            
            const dayStart = new Date(date);
            dayStart.setHours(0, 0, 0, 0);
            const dayEnd = new Date(date);
            dayEnd.setHours(23, 59, 59, 999);
            
            const dayReports = reports.filter(report => {
                const reportDate = report.date?.toDate ? report.date.toDate() : new Date(report.date);
                return reportDate >= dayStart && reportDate <= dayEnd;
            });
            
            solvedCounts.push(dayReports.filter(r => r.isSolved).length);
            pendingCounts.push(dayReports.filter(r => !r.isSolved && r.type === 'Report').length);
        }
        
        if (trendChartInstance) {
            trendChartInstance.destroy();
        }
        
        trendChartInstance = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'Solved',
                        data: solvedCounts,
                        borderColor: '#4cc9f0',
                        backgroundColor: 'rgba(76, 201, 240, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Pending',
                        data: pendingCounts,
                        borderColor: '#f72585',
                        backgroundColor: 'rgba(247, 37, 133, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Reports'
                        }
                    }
                }
            }
        });
    }

    function updateCategoryChart(stats) {
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        
        if (categoryChartInstance) {
            categoryChartInstance.destroy();
        }
        
        categoryChartInstance = new Chart(categoryCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(stats.categoryCounts),
                datasets: [{
                    label: 'Reports by Category',
                    data: Object.values(stats.categoryCounts),
                    backgroundColor: [
                        '#f72585', '#4cc9f0', '#4895ef', 
                        '#3a0ca3', '#7209b7', '#4361ee'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Reports'
                        }
                    }
                }
            }
        });
    }

    function updateBrandChart(stats) {
    const brandCtx = document.getElementById('brandChart').getContext('2d');
    
    // Hancurkan chart sebelumnya jika ada
    if (brandChartInstance) {
        try {
            brandChartInstance.destroy();
            brandChartInstance = null;
        } catch (error) {
            console.warn("Error destroying previous brand chart:", error);
        }
    }
    
    // Ambil top 10 brands
    const brandEntries = Object.entries(stats.brandCounts);
    brandEntries.sort((a, b) => b[1] - a[1]);
    const topBrands = brandEntries.slice(0, 10);
    
    // Ganti 'horizontalBar' dengan 'bar' dan gunakan indexAxis
    brandChartInstance = new Chart(brandCtx, {
        type: 'bar', // Ganti dari 'horizontalBar'
        data: {
            labels: topBrands.map(b => b[0]),
            datasets: [{
                label: 'Number of Reports',
                data: topBrands.map(b => b[1]),
                backgroundColor: '#4895ef',
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y', // Ini yang membuat chart horizontal
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Reports'
                    }
                }
            }
        }
    });
}

    function updateGameReleasesChart(reports) {
        const gameCtx = document.getElementById('gameReleasesChart').getContext('2d');
        
        const gameReleases = reports.filter(r => r.category === 'Releases New Game');
        
        // Group by month
        const monthlyData = {};
        gameReleases.forEach(release => {
            const date = release.date?.toDate ? release.date.toDate() : new Date(release.date);
            const monthYear = date.toLocaleDateString('id-ID', { month: 'short', year: 'numeric' });
            
            if (!monthlyData[monthYear]) {
                monthlyData[monthYear] = 0;
            }
            monthlyData[monthYear]++;
        });
        
        if (gameReleasesChartInstance) {
            gameReleasesChartInstance.destroy();
        }
        
        gameReleasesChartInstance = new Chart(gameCtx, {
            type: 'line',
            data: {
                labels: Object.keys(monthlyData),
                datasets: [{
                    label: 'New Game Releases',
                    data: Object.values(monthlyData),
                    borderColor: '#7209b7',
                    backgroundColor: 'rgba(114, 9, 183, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Releases'
                        }
                    }
                }
            }
        });
    }

    function updateFeatureReleasesChart(reports) {
        const featureCtx = document.getElementById('featureReleasesChart').getContext('2d');
        
        const featureReleases = reports.filter(r => r.category === 'Releases New Feature');
        
        // Group by month
        const monthlyData = {};
        featureReleases.forEach(release => {
            const date = release.date?.toDate ? release.date.toDate() : new Date(release.date);
            const monthYear = date.toLocaleDateString('id-ID', { month: 'short', year: 'numeric' });
            
            if (!monthlyData[monthYear]) {
                monthlyData[monthYear] = 0;
            }
            monthlyData[monthYear]++;
        });
        
        if (featureReleasesChartInstance) {
            featureReleasesChartInstance.destroy();
        }
        
        featureReleasesChartInstance = new Chart(featureCtx, {
            type: 'line',
            data: {
                labels: Object.keys(monthlyData),
                datasets: [{
                    label: 'New Feature Releases',
                    data: Object.values(monthlyData),
                    borderColor: '#4361ee',
                    backgroundColor: 'rgba(67, 97, 238, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Releases'
                        }
                    }
                }
            }
        });
    }

    // ========== FUNGSI PAGINATION ==========

    function setupPagination(reports) {
        const searchedReports = filterDataBySearch(reports, currentSearchTerm);
        totalPages = Math.ceil(searchedReports.length / itemsPerPage);
        
        // Update teks halaman
        document.getElementById('pageNumbers').textContent = `Page ${currentPage} of ${totalPages}`;
        
        // Enable/disable tombol
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
        
        // Tampilkan data untuk halaman saat ini
        displayPageData(searchedReports);
    }

    function displayPageData(reports) {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = reports.slice(startIndex, endIndex);
        
        renderTableData(pageData);
    }

    function renderTableData(reports) {
    const tableBody = document.getElementById('summaryTableBody');
    const emptyState = document.getElementById('noSummaryData');
    
    tableBody.innerHTML = '';
    
    if (reports.length === 0) {
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    reports.forEach((report, index) => {
        const row = document.createElement('tr');
        
        // Format tanggal
        let reportDate;
        try {
            let dateToFormat;
            
            if (report.dateCreated) {
                dateToFormat = report.dateCreated.toDate ? report.dateCreated.toDate() : new Date(report.dateCreated);
            } else if (report.date) {
                dateToFormat = report.date.toDate ? report.date.toDate() : new Date(report.date);
            } else {
                dateToFormat = new Date();
            }
            
            // Format ke waktu Indonesia
            reportDate = dateToFormat.toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
        } catch (error) {
            reportDate = 'N/A';
        }
        
        // Format resolution time
        let resolutionTime = 'N/A';
        if (report.resolutionTime && report.resolutionTime > 0) {
            const hours = Math.floor(report.resolutionTime / 60);
            const minutes = report.resolutionTime % 60;
            resolutionTime = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
        }
        
        // Tentukan status dan class-nya
        let statusClass = 'status-pending';
        let statusText = report.status || 'Pending';
        
        if (statusText === 'Solved' || report.isSolved) {
            statusClass = 'status-solved';
        } else if (statusText.includes('Maintenance')) {
            statusClass = 'status-maintenance';
        } else if (statusText === 'Released') {
            statusClass = 'status-solved';
        }
        
        // Pastikan report memiliki ID dan collection
        const reportId = report.id || `report-${index}`;
        const collectionName = report.collection || 'pendingReports';
        
        console.log(` Rendering row ${index}:`, { 
            id: reportId, 
            collection: collectionName,
            category: report.category 
        });
        
        row.innerHTML = `
            <td>${reportDate}</td>
            <td>${reportId}</td>
            <td>${report.category || 'N/A'}</td>
            <td><span class="${statusClass}">${statusText}</span></td>
            <td>${report.brand || 'N/A'}</td>
            <td>${resolutionTime}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-icon view" title="View Details" 
                            onclick="viewReportDetails('${reportId}', '${collectionName}')"
                            data-id="${reportId}" 
                            data-collection="${collectionName}">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
    
    // Tambahkan event listener untuk debugging tombol mata
    document.querySelectorAll('.btn-icon.view').forEach(button => {
        button.addEventListener('click', function(e) {
            console.log(" Button clicked via event listener:", {
                id: this.getAttribute('data-id'),
                collection: this.getAttribute('data-collection')
            });
        });
    });
}

    // ========== FUNGSI PENCARIAN ==========

    function filterDataBySearch(reports, searchTerm) {
        if (!searchTerm || searchTerm.trim() === '') {
            return reports;
        }
        
        const term = searchTerm.toLowerCase().trim();
        
        return reports.filter(report => {
            return (
                (report.id && report.id.toLowerCase().includes(term)) ||
                (report.category && report.category.toLowerCase().includes(term)) ||
                (report.status && report.status.toLowerCase().includes(term)) ||
                (report.brand && report.brand.toLowerCase().includes(term)) ||
                (report.description && report.description.toLowerCase().includes(term))
            );
        });
    }

    function handleSearch() {
        const searchInput = document.getElementById('summarySearch');
        if (!searchInput) return;
        
        currentSearchTerm = searchInput.value;
        currentPage = 1;
        applyCurrentFilters();
    }

    // ========== FUNGSI UNTUK NEW GAMES & FEATURES ==========

    function setupNewReleasesListener() {
        console.log(" Setting up new releases listener...");
        
        if (newGamesListener) {
            newGamesListener();
        }
        
        try {
            // Listener untuk new game releases
            const unsubscribeGames = db.collection('newGame').onSnapshot(snapshot => {
                const gamesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.newGamesData = gamesData;
                updateCombinedReports();
                console.log(` New Game Releases: ${gamesData.length} games`);
            }, error => {
                console.error(" Error fetching new games:", error);
                window.newGamesData = [];
            });

            // Listener untuk new feature releases
            const unsubscribeFeatures = db.collection('releases').onSnapshot(snapshot => {
                const featuresData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.featuresData = featuresData;
                updateCombinedReports();
                console.log(` New Feature Releases: ${featuresData.length} features`);
            }, error => {
                console.error(" Error fetching new features:", error);
                window.featuresData = [];
            });

            newGamesListener = () => {
                unsubscribeGames();
                unsubscribeFeatures();
                console.log("New releases listeners removed");
            };
            
            return newGamesListener;
            
        } catch (error) {
            console.error("Error setting up new releases listener:", error);
            window.newGamesData = [];
            window.featuresData = [];
            return () => {};
        }
    }

    // ========== FUNGSI UTILITAS ==========

    function showNotification(message, type = 'info') {
        const notificationContainer = document.getElementById('notificationContainer');
        if (!notificationContainer) return;

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        const icon = type === 'success' ? 'fa-check-circle' : 
                    type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
        
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            </div>
        `;

        notificationContainer.appendChild(notification);

        setTimeout(() => notification.classList.add('show'), 100);

        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                notificationContainer.removeChild(notification);
            }, 300);
        }, 5000);
    }

    function viewReportDetails(reportId, collection) {
        if (collection === 'pendingReports') {
            window.location.href = `pending-report.html?id=${reportId}`;
        } else if (collection === 'solvedReports') {
            window.location.href = `solved-report.html?id=${reportId}`;
        } else if (collection === 'maintenanceReports') {
            window.location.href = `maintenance.html?id=${reportId}`;
        } else if (collection === 'solvedMaintenance') {
            window.location.href = `solved-report.html?id=${reportId}`;
        } else if (collection === 'newGame') {
            // Redirect ke halaman detail game release jika ada
            showNotification('Game release details not implemented yet', 'info');
        } else if (collection === 'releases') {
            // Redirect ke halaman detail feature release jika ada
            showNotification('Feature release details not implemented yet', 'info');
        } else {
            showNotification('Cannot view details for this report type', 'error');
        }
    }

    function updateSummaryTable(reports) {
        setupPagination(reports);
    }

    function expandChart(chartId) {
        const chartCard = document.querySelector(`#${chartId}`).closest('.chart-card');
        chartCard.classList.toggle('expanded');
    }

    function exportData() {
    try {
        if (filteredReportsData.length === 0) {
            showNotification('No data to export', 'info');
            return;
        }

        console.log(` Preparing to export ${filteredReportsData.length} records to Excel...`);

        // Siapkan data untuk Excel
        const excelData = filteredReportsData.map(report => {
            // Format tanggal SAMA PERSIS dengan tabel HTML
            let reportDate;
            try {
                let dateToFormat;
                
                // Logika yang sama dengan renderTableData()
                if (report.dateCreated) {
                    dateToFormat = report.dateCreated.toDate ? report.dateCreated.toDate() : new Date(report.dateCreated);
                } else if (report.date) {
                    dateToFormat = report.date.toDate ? report.date.toDate() : new Date(report.date);
                } else {
                    dateToFormat = new Date();
                }
                
                // Format ke waktu Indonesia SAMA PERSIS dengan tabel
                reportDate = dateToFormat.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
            } catch (error) {
                reportDate = 'N/A';
                console.error('Error formatting date:', error);
            }
            
            // Format resolution time SAMA PERSIS dengan tabel
            let resolutionTime = 'N/A';
            if (report.resolutionTime && report.resolutionTime > 0) {
                const hours = Math.floor(report.resolutionTime / 60);
                const minutes = report.resolutionTime % 60;
                resolutionTime = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
            }
            
            // Return object dengan struktur kolom yang sama dengan tabel HTML
            return {
                'Date': reportDate,
                'Report ID': report.id || 'N/A',
                'Category': report.category || 'N/A',
                'Status': report.status || 'N/A',
                'Brand': report.brand || 'N/A',
                'Resolution Time': resolutionTime
            };
        });

        console.log(' Data prepared for Excel:', excelData.slice(0, 3)); // Log first 3 rows

        // Buat worksheet dari data
        const ws = XLSX.utils.json_to_sheet(excelData);
        
        // Atur lebar kolom otomatis
        const wscols = [
            { wch: 12 }, // Date
            { wch: 25 }, // Report ID
            { wch: 20 }, // Category
            { wch: 15 }, // Status
            { wch: 30 }, // Brand
            { wch: 18 }  // Resolution Time
        ];
        ws['!cols'] = wscols;
        
        // Buat workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Reports");
        
        // Tambahkan sheet untuk metadata
        const metadataWs = XLSX.utils.aoa_to_sheet([
            ["Report Export Metadata"],
            ["Generated On", new Date().toLocaleString('id-ID')],
            ["Total Records", filteredReportsData.length],
            ["Export Filter", JSON.stringify(activeFilters)],
            ["", ""],
            ["Column Descriptions:"],
            ["Date", "Tanggal laporan dibuat"],
            ["Report ID", "ID unik laporan"],
            ["Category", "Kategori laporan"],
            ["Status", "Status laporan"],
            ["Brand", "Brand/platform"],
            ["Resolution Time", "Waktu penyelesaian (h:m)"]
        ]);
        XLSX.utils.book_append_sheet(wb, metadataWs, "Metadata");
        
        // Generate nama file dengan timestamp
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
        const fileName = `Reports_Export_${timestamp}.xlsx`;
        
        // Download file
        XLSX.writeFile(wb, fileName);
        
        console.log(` Excel file "${fileName}" created successfully`);
        showNotification(`Data exported successfully to ${fileName}`, 'success');
        
    } catch (error) {
        console.error(' Export error:', error);
        showNotification('Failed to export data: ' + error.message, 'error');
    }
}

    // ========== EVENT LISTENERS ==========

    document.addEventListener('DOMContentLoaded', function() {
        console.log(" Dashboard initialized");
        
        // Inisialisasi cache
        window.pendingReportsCache = [];
        window.solvedReportsCache = [];
        window.maintenanceReportsCache = [];
        window.solvedMaintenanceCache = [];
        window.newGamesData = [];
        window.featuresData = [];

        // Setup listeners setelah delay kecil
        setTimeout(() => {
            console.log(" Setting up Firebase listeners...");
            setupReportsListener();
            setupNewReleasesListener();
        }, 1000);

        // Setup search listener
        const searchInput = document.getElementById('summarySearch');
        if (searchInput) {
            searchInput.addEventListener('input', handleSearch);
        }
        
        // Setup filter listeners
        document.getElementById('categoryFilter').addEventListener('change', handleFilterChange);
        document.getElementById('brandFilter').addEventListener('change', handleFilterChange);
        document.getElementById('startDate').addEventListener('change', handleFilterChange);
        document.getElementById('endDate').addEventListener('change', handleFilterChange);
        document.getElementById('applyFilters').addEventListener('click', handleFilterChange);
        document.getElementById('resetFilters').addEventListener('click', resetFilters);
        
        // Setup pagination listeners
        document.getElementById('prevPage').addEventListener('click', () => goToPage(currentPage - 1));
        document.getElementById('nextPage').addEventListener('click', () => goToPage(currentPage + 1));
        
        // Setup export button
        document.getElementById('exportBtn').addEventListener('click', exportData);
        
        // Setup auth state listener
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                console.log(` User authenticated: ${user.email}`);
            }
        });
        
        // Set default dates (last 30 days)
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 30);
        
        document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        
        // Apply default filters
        handleFilterChange();
    });

    // ========== CLEANUP FUNCTIONS ==========

    window.addEventListener('beforeunload', function() {
        if (reportsListener) {
            reportsListener();
        }
        if (newGamesListener) {
            newGamesListener();
        }
    });

    // Tambahkan fungsi ini untuk manual refresh
    function refreshDashboard() {
        console.log(" Manually refreshing dashboard...");
        
        if (reportsListener) {
            reportsListener();
        }
        
        // Clear caches
        window.pendingReportsCache = [];
        window.solvedReportsCache = [];
        window.maintenanceReportsCache = [];
        window.solvedMaintenanceCache = [];
        window.newGamesData = [];
        window.featuresData = [];
        allReportsData = [];
        filteredReportsData = [];
        
        // Setup listeners again
        setupReportsListener();
        setupNewReleasesListener();
        
        showNotification('Dashboard refreshed', 'info');
    }

    // Ekspos fungsi untuk debugging di console
    window.refreshDashboard = refreshDashboard;
    window.showAllData = function() {
        console.log("=== ALL REPORTS DATA ===");
        console.log(`Total: ${allReportsData.length}`);
        console.log(allReportsData);
        console.log("========================");
    };
function cleanupAllCharts() {
    const chartInstances = [
        statusChartInstance,
        trendChartInstance,
        categoryChartInstance,
        brandChartInstance,
        gameReleasesChartInstance,
        featureReleasesChartInstance
    ];
    
    chartInstances.forEach((chart, index) => {
        if (chart) {
            try {
                chart.destroy();
                if (index === 0) statusChartInstance = null;
                if (index === 1) trendChartInstance = null;
                if (index === 2) categoryChartInstance = null;
                if (index === 3) brandChartInstance = null;
                if (index === 4) gameReleasesChartInstance = null;
                if (index === 5) featureReleasesChartInstance = null;
            } catch (error) {
                console.warn(`Error destroying chart ${index}:`, error);
            }
        }
    });
}

function viewReportDetails(reportId, collection) {
    console.log(" View Report Details:", { reportId, collection });
    
    if (!reportId || !collection) {
        console.error("Missing reportId or collection");
        showNotification('Cannot view details: missing information', 'error');
        return;
    }
    
    try {
        // Cek tipe koleksi dan redirect ke halaman yang sesuai
        if (collection === 'pendingReports') {
            window.location.href = `pending-report.html?id=${encodeURIComponent(reportId)}`;
        } else if (collection === 'solvedReports') {
            window.location.href = `solved-report.html?id=${encodeURIComponent(reportId)}`;
        } else if (collection === 'maintenanceReports') {
            window.location.href = `maintenance.html?id=${encodeURIComponent(reportId)}`;
        } else if (collection === 'solvedMaintenance') {
            window.location.href = `completed-maintenance.html?id=${encodeURIComponent(reportId)}`;
        } else if (collection === 'newGame') {
            // Cek apakah file detail-game.html ada
            if (confirm('View game release details?')) {
                window.location.href = `releases-newgame.html?id=${encodeURIComponent(reportId)}`;
            }
        } else if (collection === 'releases') {
            // Cek apakah file detail-feature.html ada
            if (confirm('View feature release details?')) {
                window.location.href = `releases-newfeature.html?id=${encodeURIComponent(reportId)}`;
            }
        } else {
            console.error('Unknown collection:', collection);
            showNotification('Cannot view details for this type of report', 'error');
        }
    } catch (error) {
        console.error('Error viewing report details:', error);
        showNotification('Error opening report details', 'error');
    }
}
// ========== FUNGSI PAGINATION ==========

function setupPagination(reports) {
    const searchedReports = filterDataBySearch(reports, currentSearchTerm);
    totalPages = Math.ceil(searchedReports.length / itemsPerPage);
    
    // Update teks halaman
    document.getElementById('pageNumbers').textContent = `Page ${currentPage} of ${totalPages}`;
    
    // Enable/disable tombol
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
    
    // Tampilkan data untuk halaman saat ini
    displayPageData(searchedReports);
}

// TAMBAHKAN FUNGSI INI 
function goToPage(page) {
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    setupPagination(filteredReportsData);
}

function displayPageData(reports) {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageData = reports.slice(startIndex, endIndex);
    
    renderTableData(pageData);
}
// Versi dengan loading indicator
async function exportData() {
    const exportBtn = document.getElementById('exportBtn');
    const originalText = exportBtn.innerHTML;
    
    try {
        // Tampilkan loading
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
        exportBtn.disabled = true;
        
        if (filteredReportsData.length === 0) {
            showNotification('No data to export', 'info');
            return;
        }

        console.log(` Preparing to export ${filteredReportsData.length} records to Excel...`);

        // Siapkan data untuk Excel
        const excelData = filteredReportsData.map((report, index) => {
            // Format tanggal
            let reportDate;
            try {
                let dateToFormat;
                
                if (report.dateCreated) {
                    dateToFormat = report.dateCreated.toDate ? report.dateCreated.toDate() : new Date(report.dateCreated);
                } else if (report.date) {
                    dateToFormat = report.date.toDate ? report.date.toDate() : new Date(report.date);
                } else {
                    dateToFormat = new Date();
                }
                
                reportDate = dateToFormat.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
            } catch (error) {
                reportDate = 'N/A';
            }
            
            // Format resolution time
            let resolutionTime = 'N/A';
            if (report.resolutionTime && report.resolutionTime > 0) {
                const hours = Math.floor(report.resolutionTime / 60);
                const minutes = report.resolutionTime % 60;
                resolutionTime = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
            }
            
            return {
                'No.': index + 1,
                'Date': reportDate,
                'Report ID': report.id || 'N/A',
                'Category': report.category || 'N/A',
                'Status': report.status || 'N/A',
                'Brand': report.brand || 'N/A',
                'Resolution Time': resolutionTime
            };
        });

        // Buat worksheet
        const ws = XLSX.utils.json_to_sheet(excelData);
        
        // Atur lebar kolom
        const wscols = [
            { wch: 5 },  // No.
            { wch: 12 }, // Date
            { wch: 25 }, // Report ID
            { wch: 20 }, // Category
            { wch: 15 }, // Status
            { wch: 30 }, // Brand
            { wch: 18 }  // Resolution Time
        ];
        ws['!cols'] = wscols;
        
        // Buat workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Reports");
        
        // Generate nama file
        const timestamp = new Date().toISOString().split('T')[0];
        const fileName = `Reports_Export_${timestamp}.xlsx`;
        
        // Download file
        XLSX.writeFile(wb, fileName);
        
        showNotification(` Exported ${filteredReportsData.length} records to Excel`, 'success');
        
    } catch (error) {
        console.error('Export error:', error);
        showNotification('Failed to export data', 'error');
    } finally {
        // Reset tombol
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
    }
}
    </script>
</body>
</html>
