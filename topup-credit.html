<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top Up Credit - Dashboard Admin CSS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="global.css">
    <script src="global-time.js"></script>
        <link rel="stylesheet" href="stylemobile.css">
    <style>
        /* ========== VARIABEL CSS YANG DIPERLUKAN ========== */
        :root {
            --primary-gradient: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            --success-gradient: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
            --warning-gradient: linear-gradient(135deg, #f72585 0%, #7209b7 100%);
            --info-gradient: linear-gradient(135deg, #4895ef 0%, #3f37c9 100%);
        }

        /* ========== PERBAIKAN UTAMA UNTUK LAYOUT ========== */
        .main-content {
            padding: var(--space-lg);
            background-color: var(--bg-secondary);
            min-height: 100vh;
        }

        .header {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        /* ========== PERBAIKAN STATISTIC CARDS ========== */
        .credit-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .credit-stat-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .credit-stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .credit-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }

        .stat-title {
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--text-secondary);
            margin: 0;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        /* Perbaikan class untuk stat-icon agar sesuai dengan 6 kategori */
.stat-icon.d-gaming {
    background-color: rgba(59, 130, 246, 0.1);
    color: var(--info);
}

.stat-icon.gacha {
    background-color: rgba(139, 92, 246, 0.1);
    color: var(--purple);
}

.stat-icon.brem {
    background-color: rgba(156, 163, 175, 0.1);
    color: var(--text-secondary);
}

.stat-icon.cbwl {
    background-color: rgba(74, 144, 226, 0.1);
    color: var(--info);
}

.stat-icon.engine-89 {
    background-color: rgba(245, 158, 11, 0.1);
    color: var(--warning);
}

.stat-icon.luxion {
    background-color: rgba(239, 68, 68, 0.1);
    color: var(--danger);
}

        .stat-icon.custom {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: var(--font-bold);
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
            line-height: 1;
        }

        .stat-description {
            font-size: var(--text-xs);
            color: var(--text-secondary);
        }

        /* ========== TOP UP FORM ========== */
        .topup-section {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-bottom: var(--space-xl);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border-color);
        }

        .section-title {
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin: 0;
        }

        .topup-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .form-group label {
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--text-secondary);
        }

        .form-select, .form-input {
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--input-bg);
            color: var(--text-primary);
            font-size: var(--text-sm);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
            height: 42px;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-actions {
            grid-column: span 2;
            display: flex;
            justify-content: flex-end;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }

        /* ========== MASTERAGENT FORM ========== */
        .masteragent-section {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-bottom: var(--space-xl);
        }

        .masteragent-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
        }

        /* ========== HISTORY SECTION ========== */
        .history-section {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-bottom: var(--space-xl);
        }

        .history-table-container {
            overflow-x: auto;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }

       /* TAMBAHKAN CSS INI: */

/* Perbaikan alignment tabel */
.history-table {
    margin: 0;
    width: 100%;
    border-collapse: collapse;
    min-width: 700px;
    font-family: 'Poppins', sans-serif; /* Tetap gunakan Poppins */
    table-layout: fixed;
}

/* Lebar kolom yang presisi */
/* Lebar kolom yang presisi */
.history-table th:nth-child(1),
.history-table td:nth-child(1) {
    width: 160px;
    min-width: 160px;
    white-space: nowrap;
}

.history-table th:nth-child(2),
.history-table td:nth-child(2) {
    width: 150px;
    min-width: 150px;
    white-space: nowrap;
}

.history-table th:nth-child(3),
.history-table td:nth-child(3) {
    width: 200px;
    min-width: 200px;
    white-space: nowrap;
}

/* Kolom angka - rata kanan dengan font yang konsisten */
.history-table th:nth-child(4),
.history-table td:nth-child(4),
.history-table th:nth-child(5),
.history-table td:nth-child(5),
.history-table th:nth-child(6),
.history-table td:nth-child(6) {
    width: 150px;
    min-width: 150px;
    text-align: right;
    font-family: 'Poppins', sans-serif;
    font-weight: var(--font-semibold);
    font-variant-numeric: tabular-nums;
}

/* Kolom aksi */
.history-table th:nth-child(7),
.history-table td:nth-child(7) {
    width: 150px;
    min-width: 150px;
    text-align: center;
}

/* Container untuk tombol aksi */
.action-buttons {
    display: flex;
    gap: 6px;
    justify-content: center;
    align-items: center;
}

/* Tombol kecil untuk aksi */
.btn-sm {
    padding: 4px 8px;
    font-size: var(--text-xs);
    height: 28px;
    min-width: 50px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
}

.btn-sm i {
    font-size: 0.7rem;
}

        .empty-state {
            text-align: center;
            padding: var(--space-xl) var(--space-lg);
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            border: 2px dashed var(--border-color);
            margin: var(--space-lg) 0;
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--text-tertiary);
            margin-bottom: var(--space-md);
        }

        .empty-state h3 {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
        }

        .empty-state p {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-lg);
        }

        /* ========== RESPONSIVE ADJUSTMENTS ========== */
        @media (max-width: 768px) {
            .topup-form,
            .masteragent-form {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                grid-column: span 1;
            }
            
            .credit-stats {
                grid-template-columns: 1fr;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .credit-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1025px) {
            .credit-stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* ========== ANIMATIONS ========== */
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

       /* Toast Notification Styles */
.toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: var(--radius-md, 8px);
    color: white;
    z-index: var(--z-modal, 9999);
    max-width: 320px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    opacity: 0;
    transform: translateY(-20px) scale(0.95);
    pointer-events: none;
    animation: toast-in 0.5s ease forwards;
    font-family: sans-serif;
    font-size: 0.95rem;
    line-height: 1.4;
    transition: all 0.3s ease;
}

/* Slide, Fade & Scale In */
@keyframes toast-in {
    0% {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Slide, Fade & Scale Out */
@keyframes toast-out {
    0% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
    100% {
        opacity: 0;
        transform: translateY(-15px) scale(0.95);
    }
}

.toast-notification.hide {
    animation: toast-out 0.4s ease forwards;
}

/* Type colors with fallbacks */
.toast-notification.success {
    background-color: var(--success, #28a745);
}

.toast-notification.error {
    background-color: var(--danger, #dc3545);
}

.toast-notification.info {
    background-color: var(--info, #007bff);
}


        .toast-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            transform: translateY(20px);
            transition: transform var(--transition-normal);
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: background-color var(--transition-fast);
        }

        .modal-close:hover {
            background-color: var(--hover-color);
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--space-lg);
        }

        .modal-footer {
            padding: var(--space-lg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-sm);
        }

        /* Tab styles */
        .tabs {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: var(--space-sm) var(--space-lg);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all var(--transition-fast);
            font-weight: var(--font-medium);
            color: var(--text-secondary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        .error-message {
    color: var(--danger);
    display: none;
    font-size: var(--text-xs);
    margin-top: 5px;
}

.modal-footer {
    display: none;
}
/* Perbaikan untuk modal footer yang tersembunyi */
.modal-footer {
    display: flex !important;
    justify-content: flex-end;
    gap: var(--space-sm);
    padding: var(--space-lg);
    border-top: 1px solid var(--border-color);
}
/* Gaya untuk search bar */
.search-bar {
    position: relative;
    display: flex;
    align-items: center;
}

.search-bar input {
    padding-right: 40px; /* Ruang untuk tombol clear */
}

.clear-search {
    position: absolute;
    right: 10px;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    transition: background-color 0.2s;
}

.clear-search:hover {
    background-color: var(--hover-color);
    color: var(--text-primary);
}

/* Highlight untuk hasil pencarian */
.highlight {
    background-color: rgba(79, 70, 229, 0.1);
    font-weight: var(--font-semibold);
}
/* Pagination Styles */
.pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--space-md);
    margin-top: var(--space-lg);
    padding: var(--space-md);
    background-color: var(--card-bg);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
}

.pagination-controls span {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    font-weight: var(--font-medium);
}
/* GANTI kode CSS ini: */
.history-table th:nth-child(6),
.history-table td:nth-child(6) {
    display: none;
}

/* DENGAN: */
/* SEMBUNYIKAN KOLOM AKSI UNTUK USER BIASA */
body.user-mode .history-table th:nth-child(7),
body.user-mode .history-table td:nth-child(7) {
    display: none;
}

body.admin-mode .history-table th:nth-child(7),
body.admin-mode .history-table td:nth-child(7) {
    display: table-cell;
    width: 150px;
    min-width: 150px;
    text-align: center;
}

/* Untuk masteragent history - kolom aksi juga di child ke-7 */
body.user-mode .masteragent-history-table th:nth-child(7),
body.user-mode .masteragent-history-table td:nth-child(7) {
    display: none;
}

body.admin-mode .masteragent-history-table th:nth-child(7),
body.admin-mode .masteragent-history-table td:nth-child(7) {
    display: table-cell;
    width: 150px;
    min-width: 150px;
    text-align: center;
}
    </style>
</head>
<body>
    <!-- Container untuk sidebar yang akan dimuat oleh sidebar-loader.js -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <h1><i class="fas fa-coins"></i> Top Up Credit</h1>
            <div class="header-actions">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Cari..." id="dashboardSearch">
                </div>
                
                <div class="user-profile">
                    <img class="profile-img" src="https://iili.io/Fpiva7S.png" alt="Profile">
                    <div class="user-info">
                        <h4>Nama Masing Masing</h4>
                        <p>Customer Service Support</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Credit Statistics Cards -->
        <div class="credit-stats" id="creditStatsContainer">
            <!-- Cards will be generated dynamically -->
        </div>

        <!-- Tabs for Regular Top Up and Masteragent -->
<div class="tabs">
    <div class="tab active" data-tab="regular">Form Top Up Credit Agent</div>
    <div class="tab" data-tab="masteragent">Form Top Up Credit Masteragent</div>
</div>

<!-- Regular Top Up Form Section -->
<div id="regularTab" class="tab-content active">
    <div class="topup-section fade-in" style="animation-delay: 0.2s;">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-money-bill-wave"></i> Form Top Up Credit Agent</h2>
        </div>
        
        <form id="topupForm" class="topup-form">
            <div class="form-group">
                <label for="brandSelect">Pilih Brand</label>
                <select id="brandSelect" class="form-select" required>
                    <option value="">Select Brand</option>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="currentCredit">Credit Saat Ini</label>
                <input type="text" id="currentCredit" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label for="topupAmount">Jumlah Top Up</label>
                <input type="number" id="topupAmount" class="form-input" placeholder="Masukkan jumlah top up" min="1" required>
            </div>
            
            <div class="form-group">
                <label for="newCredit">Credit Setelah Top Up</label>
                <input type="text" id="newCredit" class="form-input" readonly>
            </div>
            
            <div class="form-actions">
                <button type="reset" class="btn btn-outline">Reset</button>
                <button type="submit" class="btn btn-primary">Proses Top Up</button>
            </div>
        </form>
    </div>

    <!-- Regular History Section -->
    <div class="history-section fade-in" style="animation-delay: 0.3s;">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-history"></i> Riwayat Top Up</h2>
            <div class="section-actions">
                <button class="btn btn-outline" id="refreshHistory">
                    <i class="fas fa-sync-alt"></i> Muat Ulang
                </button>
            </div>
        </div>
        
        <div class="history-table-container">
            <table class="history-table">
<thead>
    <tr>
        <th>Tanggal</th>
        <th>User</th> <!-- KOLOM BARU -->
        <th>Brand</th>
        <th>Jumlah Top Up</th>
        <th>Credit Sebelum</th>
        <th>Credit Sesudah</th>
        <th class="action-column">Aksi</th>
    </tr>
</thead>
                <tbody id="historyTableBody">
                    <!-- Data history akan dimuat di sini -->
                </tbody>
            </table>
        </div>
        <div id="noHistory" class="empty-state" style="display: none;">
            <i class="fas fa-history"></i>
            <h3>Tidak Ada Riwayat</h3>
            <p>Belum ada riwayat top up untuk ditampilkan.</p>
        </div>
    </div>
</div>

<!-- Masteragent Top Up Form Section -->
<div id="masteragentTab" class="tab-content">
    <div class="masteragent-section fade-in" style="animation-delay: 0.1s;">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-crown"></i> Form Top Up Credit Masteragent</h2>
        </div>
        
        <form id="masteragentForm" class="masteragent-form">
            <div class="form-group">
                <label for="masteragentCategory">Kategori</label>
                <select id="masteragentCategory" class="form-control" required>
                    <option value="">Select Category</option>
                    <option value="D-GAMING">D-GAMING</option>
                    <option value="GACHA">GACHA</option>
                    <option value="BREM">BREM</option>
                    <option value="CBWL">CBWL</option>
                    <option value="89ENGINE">89ENGINE</option>
                    <option value="LUXION">LUXION</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="masteragentCurrentCredit">Credit Saat Ini</label>
                <input type="text" id="masteragentCurrentCredit" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label for="masteragentCredit">Jumlah Top Up</label>
                <input type="number" id="masteragentCredit" class="form-input" placeholder="Masukkan jumlah top up" min="1" required>
            </div>
            
            <div class="form-group">
                <label for="masteragentNewCredit">Credit Setelah Top Up</label>
                <input type="text" id="masteragentNewCredit" class="form-input" readonly>
            </div>
            
            <div class="form-actions">
                <button type="reset" class="btn btn-outline">Reset</button>
                <button type="submit" class="btn btn-primary">Proses Top Up</button>
            </div>
        </form>
    </div>

    <!-- Masteragent History Section -->
    <!-- Masteragent History Section -->
<div class="history-section fade-in" style="animation-delay: 0.3s;">
    <div class="section-header">
        <h2 class="section-title"><i class="fas fa-history"></i> Riwayat Top Up Masteragent</h2>
        <div class="section-actions">
            <button class="btn btn-outline" id="refreshMasteragentHistory">
                <i class="fas fa-sync-alt"></i> Muat Ulang
            </button>
        </div>
    </div>
    
    <div class="history-table-container">
        <table class="history-table masteragent-history-table">
            <thead>
                <tr>
                    <th>Tanggal</th>
                    <th>User</th> <!-- ✅ TAMBAHKAN INI -->
                    <th>Kategori</th>
                    <th>Jumlah Top Up</th>
                    <th>Credit Sebelum</th>
                    <th>Credit Sesudah</th>
                    <th class="action-column">Aksi</th>
                </tr>
            </thead>
            <tbody id="masteragentHistoryTableBody">
                <!-- Data history masteragent akan dimuat di sini -->
            </tbody>
        </table>
    </div>
    <div id="noMasteragentHistory" class="empty-state" style="display: none;">
        <i class="fas fa-history"></i>
        <h3>Tidak Ada Riwayat</h3>
        <p>Belum ada riwayat top up masteragent untuk ditampilkan.</p>
    </div>
</div>
</div>

<!-- SATU PAGINATION CONTROLS UNTUK SEMUA -->
<div class="pagination-controls" id="paginationControls" style="display: none;">
    <button class="btn btn-outline" id="prevPage">
        <i class="fas fa-chevron-left"></i> Previous
    </button>
    <span id="pageInfo">Page 1 of 1</span>
    <button class="btn btn-outline" id="nextPage">
        Next <i class="fas fa-chevron-right"></i>
    </button>
</div>

    <!-- Toast Notification -->
    <div id="toastNotification" class="toast-notification" style="display: none;">
        <div class="toast-content">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage"></span>
        </div>
        <div class="toast-notification success">
    ✅ Data berhasil disimpan!
</div>
    </div>
<!-- Modal untuk Edit Credit (Super Admin) -->
<div id="editCreditModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-edit"></i> Edit Credit</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div id="editCreditContainer">
                <!-- Form edit credit akan diisi secara dinamis -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="document.getElementById('editCreditModal').classList.remove('active')">Batal</button>
            <button class="btn btn-primary" id="saveCreditChanges">Simpan Perubahan</button>
        </div>
    </div>
</div>

<!-- Modal untuk Edit History (Super Admin) -->
<div id="editHistoryModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-edit"></i> Edit Riwayat</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div id="editHistoryContainer">
                <!-- Form edit history akan diisi secara dinamis -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="document.getElementById('editHistoryModal').classList.remove('active')">Batal</button>
            <button class="btn btn-primary" id="saveHistoryChanges">Simpan Perubahan</button>
        </div>
    </div>
</div>
    <script src="sidebar-loader.js"></script>
    <script src="user-profile.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
    // Konfigurasi Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDUZka4FZyLi_cv6X_5D4zeRsfkpqOlBpY",
        authDomain: "dashboard-css.firebaseapp.com",
        databaseURL: "https://dashboard-css-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "dashboard-css",
        storageBucket: "dashboard-css.appspot.com",
        messagingSenderId: "771131792881",
        appId: "1:771131792881:web:ad634424225bd7de847850",
        measurementId: "G-3CYBC5B101"
    };

    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Data default untuk brand
    const defaultBrands = {
        "D-GAMING": {
            credit: 2167067148,
            brands: [
                "CINTAWIN88 (D-GAMING)",
                "CERIASLOT99 (D-GAMING)",
                "RAJASCATTER88 (D-GAMING)",
                "MAHJONGJP88 (D-GAMING)",
                "NAGAHOKI88 (D-GAMING)",
                "SPACEMAN88 (D-GAMING)",
                "RAJAPANEN (D-GAMING)",
                "BROTO88 (D-GAMING)"
            ]
        },
        "GACHA": {
            credit: 5004281403,
            brands: [
                "MEDUSA88 (GACHA)",
                "ATHENA168 (GACHA)",
                "ARES GACOR (GACHA)",
                "RAJA MAHJONG (GACHA)",
                "OLYMPUS1000 (GACHA)",
                "GACHA99 (GACHA)",
                "BANGGACOR88 (GACHA)",
                "RAJA COVID (GACHA)",
                "HACKSAW88 (GACHA)"
            ]
        },
        "BREM": {
            credit: 155000000,
            brands: [
                "UJANGBET (BREM)",
                "EPISODEBET (BREM)"
            ]
        },
        "CBWL": {
            credit: 155000000,
            brands: [
                "CBWL (CBWL)",
            ]
        },
        "89ENGINE": {
            credit: 500000000,
            brands: [
                "FOKUSBET88 (89ENGINE)",
                "RAJAKING88 (89ENGINE)",
                "RAJANAGA99 (89ENGINE)"
            ]
        },
        "LUXION": {
            credit: 100000000,
            brands: [
                "JOIN999 (LUXION)"
            ]
        }
    };

    // Deklarasi variabel global
    let creditData = {};
    let topupHistory = [];
    let masteragentHistory = [];
    let unsubscribeCreditData = null;
    let unsubscribeTopupHistory = null;
    let unsubscribeMasteragentHistory = null;

    // State aplikasi
    let isSuperAdminUser = false;

    // Variabel untuk pagination
    const itemsPerPage = 15;
    let currentRegularPage = 1;
    let currentMasteragentPage = 1;
    let filteredRegularHistory = [];
    let filteredMasteragentHistory = [];

    // ========== FUNGSI SUPER ADMIN ==========

    // Fungsi untuk memeriksa dan setup super admin
    async function checkAndSetupSuperAdmin() {
    try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) {
            console.log('No user logged in');
            // Pastikan tombol disembunyikan jika tidak ada user
            hideAdminButtonsOnInit();
            return false;
        }
        
        console.log('🔄 Checking admin role for user:', currentUser.uid, currentUser.email);
        
        const db = firebase.firestore();
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            console.log('📊 User data from Firestore:', userData);
            
            // Check role dengan berbagai kemungkinan field
            const isAdmin = userData.role === 'super_admin' || 
                          userData.isSuperAdmin === true ||
                          userData.isAdmin === true ||
                          (userData.email && userData.email.includes('admin')) ||
                          userData.email === 'superadmin@gachaengine.com';
            
            console.log('✅ Final admin determination:', isAdmin);
            
            if (isAdmin) {
                setupAdminUI(true);
                isSuperAdminUser = true;
                return true;
            }
        }
        
        // Jika bukan admin, setup UI user biasa
        setupAdminUI(false);
        isSuperAdminUser = false;
        return false;
        
    } catch (error) {
        console.error('❌ Error checking super admin:', error);
        // Jika error, asumsikan bukan admin
        setupAdminUI(false);
        isSuperAdminUser = false;
        return false;
    }
}

    // Fungsi untuk setup UI admin
    function setupAdminUI(isAdmin) {
        console.log('Setting up admin UI, isAdmin:', isAdmin);
        
        const headerActions = document.querySelector('.header-actions');
        if (!headerActions) {
            console.error('Header actions element not found');
            return;
        }
        
        // Hapus tombol edit credit yang sudah ada jika ada
        const existingEditButton = document.querySelector('.edit-credit-btn');
        if (existingEditButton) {
            existingEditButton.remove();
        }
        
        // TAMBAHKAN CLASS PADA BODY
        if (isAdmin) {
            document.body.classList.add('admin-mode');
            document.body.classList.remove('user-mode');
            
            // Tambahkan tombol Edit Credit untuk super admin
            const editButton = document.createElement('button');
            editButton.className = 'btn btn-primary edit-credit-btn';
            editButton.innerHTML = '<i class="fas fa-edit"></i> Edit Credit';
            editButton.style.marginRight = '10px';
            editButton.onclick = showEditCreditModal;
            
            headerActions.insertBefore(editButton, headerActions.firstChild);
            
            isSuperAdminUser = true;
            console.log('Admin UI setup completed - Edit Credit button visible');
        } else {
            document.body.classList.add('user-mode');
            document.body.classList.remove('admin-mode');
            isSuperAdminUser = false;
            console.log('Regular user UI setup completed - Edit Credit button hidden');
        }
    }

    // ========== FUNGSI UTILITAS ==========
// Fungsi untuk mendapatkan data user yang sedang login
// Fungsi untuk mendapatkan data user yang sedang login - VERSI DIPERBAIKI
async function getCurrentUserData() {
    try {
        const user = firebase.auth().currentUser;
        if (!user) {
            console.warn('No user logged in');
            return { 
                name: 'Unknown User', 
                email: 'Unknown',
                uid: 'unknown'
            };
        }
        
        console.log('🔍 Getting user data for:', user.uid, user.email);
        
        // Cek di Firestore untuk data user lengkap
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            console.log('📋 User data from Firestore:', userData);
            
            // Prioritaskan nama dalam urutan: displayName -> name -> email
            const userName = userData.displayName || 
                           userData.name || 
                           user.displayName || 
                           user.email.split('@')[0] || // Ambil bagian sebelum @
                           user.email;
            
            return {
                name: userName,
                email: userData.email || user.email,
                uid: user.uid
            };
        }
        
        console.log('📝 No user document in Firestore, using auth data');
        
        // Fallback ke data dari auth dengan formatting yang lebih baik
        const fallbackName = user.displayName || 
                           user.email.split('@')[0] || // Format: john.doe@gmail.com -> john.doe
                           user.email;
        
        return {
            name: fallbackName,
            email: user.email,
            uid: user.uid
        };
        
    } catch (error) {
        console.error('❌ Error getting user data:', error);
        
        // Fallback yang lebih aman
        const user = firebase.auth().currentUser;
        if (user) {
            return {
                name: user.email.split('@')[0] || user.email,
                email: user.email,
                uid: user.uid
            };
        }
        
        return {
            name: 'Unknown User',
            email: 'Unknown',
            uid: 'unknown'
        };
    }
}
    // Format angka dengan pemisah ribuan
    function formatNumber(num) {
        if (isNaN(num) || num === null || num === undefined) {
            return '0';
        }
        return new Intl.NumberFormat('id-ID').format(num);
    }

    // Parse angka dari format dengan pemisah
    function parseFormattedNumber(formattedNum) {
        if (!formattedNum) return 0;
        return parseInt(formattedNum.toString().replace(/\./g, ''), 10) || 0;
    }

    // Tampilkan notifikasi toast
    function showToast(message, type = 'success') {
        // Hapus toast yang sudah ada
        const existingToasts = document.querySelectorAll('.toast-notification');
        existingToasts.forEach(toast => toast.remove());
        
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(toast);

        // Tampilkan toast
        setTimeout(() => {
            toast.classList.add('hide');
        }, 3000);

        toast.addEventListener('animationend', () => {
            if (toast.classList.contains('hide')) {
                toast.remove();
            }
        });
    }

    // ========== FUNGSI FIRESTORE ==========

    // Fungsi untuk memuat data dari Firestore
    function setupFirestoreListeners() {
        console.log("Setting up Firestore listeners...");
        
        // Setup listener untuk creditData
        if (unsubscribeCreditData) {
            unsubscribeCreditData();
        }
        
        unsubscribeCreditData = db.collection('creditData').doc('brands')
            .onSnapshot((doc) => {
                if (doc.exists) {
                    creditData = doc.data();
                    console.log("Credit data loaded from Firestore:", creditData);
                    updateCreditStats();
                    updateBrandDropdown();
                } else {
                    // Jika dokumen tidak ada, buat dengan data default
                    console.log("No credit data found, creating with defaults");
                    creditData = defaultBrands;
                    db.collection('creditData').doc('brands').set(defaultBrands)
                        .then(() => {
                            console.log("Default credit data saved to Firestore");
                            updateCreditStats();
                            updateBrandDropdown();
                        })
                        .catch((error) => {
                            console.error("Error saving default credit data:", error);
                            showToast("Error initializing credit data", "error");
                        });
                }
            }, (error) => {
                console.error("Error loading credit data:", error);
                showToast("Error loading credit data", "error");
                
                // Fallback ke localStorage
                const localData = localStorage.getItem('creditData');
                if (localData) {
                    creditData = JSON.parse(localData);
                    updateCreditStats();
                    updateBrandDropdown();
                } else {
                    creditData = defaultBrands;
                    updateCreditStats();
                    updateBrandDropdown();
                }
            });

        // Setup listener untuk topupHistory
        if (unsubscribeTopupHistory) {
            unsubscribeTopupHistory();
        }
        
        unsubscribeTopupHistory = db.collection('topupHistory')
            .orderBy('timestamp', 'desc')
            .onSnapshot((snapshot) => {
                topupHistory = [];
                snapshot.forEach((doc) => {
                    const historyItem = doc.data();
                    historyItem.id = doc.id;
                    topupHistory.push(historyItem);
                });
                console.log("Topup history loaded:", topupHistory.length, "items");
                updateHistoryTable();
            }, (error) => {
                console.error("Error loading topup history:", error);
                showToast("Error loading topup history", "error");
                
                // Fallback ke localStorage
                const localHistory = localStorage.getItem('topupHistory');
                if (localHistory) {
                    topupHistory = JSON.parse(localHistory);
                    updateHistoryTable();
                }
            });

        // Setup listener untuk masteragentHistory
        if (unsubscribeMasteragentHistory) {
            unsubscribeMasteragentHistory();
        }
        
        unsubscribeMasteragentHistory = db.collection('masteragentHistory')
            .orderBy('timestamp', 'desc')
            .onSnapshot((snapshot) => {
                masteragentHistory = [];
                snapshot.forEach((doc) => {
                    const historyItem = doc.data();
                    historyItem.id = doc.id;
                    masteragentHistory.push(historyItem);
                });
                console.log("Masteragent history loaded:", masteragentHistory.length, "items");
                updateMasteragentHistoryTable();
            }, (error) => {
                console.error("Error loading masteragent history:", error);
                showToast("Error loading masteragent history", "error");
                
                // Fallback ke localStorage
                const localHistory = localStorage.getItem('masteragentHistory');
                if (localHistory) {
                    masteragentHistory = JSON.parse(localHistory);
                    updateMasteragentHistoryTable();
                }
            });
    }

    // ========== FUNGSI UI UPDATE ==========

    // Update tampilan credit stats cards
    function updateCreditStats() {
        const container = document.getElementById('creditStatsContainer');
        if (!container) return;
        
        let html = '';
        
        // Add all category cards (6 brand)
        const categories = Object.keys(creditData);
        
        categories.forEach(category => {
            if (creditData[category]) {
                // Tentukan class icon berdasarkan kategori
                let iconClass = category.toLowerCase();
                if (iconClass === '89engine') iconClass = 'engine-89';
                
                html += `
                    <div class="credit-stat-card fade-in">
                        <div class="stat-header">
                            <h3 class="stat-title">${category} Credit</h3>
                            <div class="stat-icon ${iconClass}">
                                <i class="fas fa-coins"></i>
                            </div>
                        </div>
                        <div class="stat-value">${formatNumber(creditData[category].credit)}</div>
                        <div class="stat-description">Available Credit</div>
                    </div>
                `;
            }
        });
        
        container.innerHTML = html;
    }

    // Update dropdown pilihan brand
    function updateBrandDropdown() {
        const brandSelect = document.getElementById('brandSelect');
        if (!brandSelect) return;
        
        let html = '<option value="">Select Brand</option>';
        
        // Add all brands from the 6 categories
        for (const [category, data] of Object.entries(creditData)) {
            data.brands.forEach(brand => {
                html += `<option value="${brand}" data-category="${category}">${brand}</option>`;
            });
        }
        
        brandSelect.innerHTML = html;
    }

    // Fungsi untuk setup event listeners aksi history
    function setupHistoryActionListeners() {
        console.log('🔧 Setting up history action listeners...');
        
        // Event listeners untuk tombol edit
        document.querySelectorAll('.edit-history-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const historyId = this.dataset.id;
                const historyType = this.dataset.type;
                console.log('✏️ Edit history clicked:', historyId, historyType);
                editHistoryItem(historyId, historyType);
            });
        });
        
        // Event listeners untuk tombol hapus
        document.querySelectorAll('.delete-history-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const historyId = this.dataset.id;
                const historyType = this.dataset.type;
                console.log('🗑️ Delete history clicked:', historyId, historyType);
                deleteHistoryItem(historyId, historyType);
            });
        });
        
        console.log('✅ History action listeners setup completed');
    }

    // Update history table dengan tombol edit untuk super admin
    function updateHistoryTable() {
        const historyTableBody = document.getElementById('historyTableBody');
        const noHistory = document.getElementById('noHistory');
        const searchTerm = document.getElementById('dashboardSearch')?.value.toLowerCase().trim() || '';
        
        // Reset filtered data
        filteredRegularHistory = [];
        
        if (topupHistory.length === 0 && searchTerm === '') {
            if (noHistory) noHistory.style.display = 'block';
            if (historyTableBody) historyTableBody.innerHTML = '';
            const regularPagination = document.getElementById('regularPagination');
            if (regularPagination) regularPagination.style.display = 'none';
            return;
        }
        
        if (noHistory) noHistory.style.display = 'none';
        
        // Filter data berdasarkan pencarian
        if (searchTerm !== '') {
            filteredRegularHistory = topupHistory.filter(history => {
                return Object.values(history).some(value => 
                    value && value.toString().toLowerCase().includes(searchTerm)
                );
            });
        }
        
        // Render history table dengan tombol edit untuk super admin
        if (historyTableBody) {
            const dataToDisplay = filteredRegularHistory.length > 0 ? filteredRegularHistory : topupHistory;
            const startIndex = (currentRegularPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, dataToDisplay.length);
            const paginatedData = dataToDisplay.slice(startIndex, endIndex);
            
            historyTableBody.innerHTML = paginatedData.map(history => `
    <tr>
        <td>${history.date || 'N/A'}</td>
        <td>${history.user || 'Unknown User'}</td> <!-- ✅ TAMPILKAN USER -->
        <td>${history.brand || 'N/A'}</td>
        <td>${formatNumber(history.amount)}</td>
        <td>${formatNumber(history.before)}</td>
        <td>${formatNumber(history.after)}</td>
        <td>
            ${isSuperAdminUser ? `
            <div class="action-buttons">
                <button class="btn btn-sm btn-outline edit-history-btn" data-id="${history.id}" data-type="regular">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-sm btn-danger delete-history-btn" data-id="${history.id}" data-type="regular">
                    <i class="fas fa-trash"></i> Hapus
                </button>
            </div>
            ` : ''}
        </td>
    </tr>
`).join('');
            
            // Setup event listeners untuk tombol aksi
            setupHistoryActionListeners();
        }
        
        // Update pagination
        updatePaginationUI('regular');
    }

    // Update masteragent history table dengan tombol edit untuk super admin
    function updateMasteragentHistoryTable() {
        const historyTableBody = document.getElementById('masteragentHistoryTableBody');
        const noHistory = document.getElementById('noMasteragentHistory');
        const searchTerm = document.getElementById('dashboardSearch')?.value.toLowerCase().trim() || '';
        
        // Reset filtered data
        filteredMasteragentHistory = [];
        
        if (masteragentHistory.length === 0 && searchTerm === '') {
            if (noHistory) noHistory.style.display = 'block';
            if (historyTableBody) historyTableBody.innerHTML = '';
            const masteragentPagination = document.getElementById('masteragentPagination');
            if (masteragentPagination) masteragentPagination.style.display = 'none';
            return;
        }
        
        if (noHistory) noHistory.style.display = 'none';
        
        // Filter data berdasarkan pencarian
        if (searchTerm !== '') {
            filteredMasteragentHistory = masteragentHistory.filter(history => {
                return Object.values(history).some(value => 
                    value && value.toString().toLowerCase().includes(searchTerm)
                );
            });
        }
        
        // Render history table dengan tombol edit untuk super admin
        if (historyTableBody) {
            const dataToDisplay = filteredMasteragentHistory.length > 0 ? filteredMasteragentHistory : masteragentHistory;
            const startIndex = (currentMasteragentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, dataToDisplay.length);
            const paginatedData = dataToDisplay.slice(startIndex, endIndex);
            
            historyTableBody.innerHTML = paginatedData.map(history => `
    <tr>
        <td>${history.date || 'N/A'}</td>
        <td>${history.user || 'Unknown User'}</td> <!-- ✅ TAMPILKAN USER -->
        <td>${history.category || 'N/A'}</td>
        <td>${formatNumber(history.amount)}</td>
        <td>${formatNumber(history.before)}</td>
        <td>${formatNumber(history.after)}</td>
        <td>
            ${isSuperAdminUser ? `
            <div class="action-buttons">
                <button class="btn btn-sm btn-outline edit-history-btn" data-id="${history.id}" data-type="masteragent">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-sm btn-danger delete-history-btn" data-id="${history.id}" data-type="masteragent">
                    <i class="fas fa-trash"></i> Hapus
                </button>
            </div>
            ` : ''}
        </td>
    </tr>
`).join('');
            
            // Setup event listeners untuk tombol aksi
            setupHistoryActionListeners();
        }
        
        // Update pagination
        updatePaginationUI('masteragent');
    }

    // Fungsi pagination yang diperbaiki - SATU UNTUK SEMUA
    function updatePaginationUI() {
        const currentTab = document.querySelector('.tab.active').dataset.tab;
        
        let historyData, filteredData;
        let currentPage, totalPages;
        
        if (currentTab === 'regular') {
            historyData = topupHistory;
            filteredData = filteredRegularHistory.length > 0 ? filteredRegularHistory : historyData;
            currentPage = currentRegularPage;
        } else {
            historyData = masteragentHistory;
            filteredData = filteredMasteragentHistory.length > 0 ? filteredMasteragentHistory : historyData;
            currentPage = currentMasteragentPage;
        }
        
        totalPages = Math.ceil(filteredData.length / itemsPerPage);
        
        const pageInfo = document.getElementById('pageInfo');
        const paginationControls = document.getElementById('paginationControls');
        
        if (filteredData.length === 0) {
            if (pageInfo) pageInfo.textContent = 'Tidak ada data';
            if (paginationControls) paginationControls.style.display = 'none';
            return;
        }
        
        // Update info halaman
        if (pageInfo) {
            pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages} (Total: ${filteredData.length} data)`;
        }
        
        // Update tampilan pagination controls
        if (paginationControls) {
            paginationControls.style.display = 'flex';
            
            const prevButton = document.getElementById('prevPage');
            const nextButton = document.getElementById('nextPage');
            
            if (prevButton) {
                prevButton.disabled = currentPage === 1;
                prevButton.onclick = function() {
                    if (currentPage > 1) {
                        if (currentTab === 'regular') {
                            currentRegularPage--;
                            updateHistoryTable();
                        } else {
                            currentMasteragentPage--;
                            updateMasteragentHistoryTable();
                        }
                    }
                };
            }
            
            if (nextButton) {
                nextButton.disabled = currentPage === totalPages;
                nextButton.onclick = function() {
                    if (currentPage < totalPages) {
                        if (currentTab === 'regular') {
                            currentRegularPage++;
                            updateHistoryTable();
                        } else {
                            currentMasteragentPage++;
                            updateMasteragentHistoryTable();
                        }
                    }
                };
            }
        }
    }

    // ========== FUNGSI EDIT CREDIT ==========

    // Fungsi untuk menampilkan modal edit credit
    function showEditCreditModal() {
        console.log('📋 Showing edit credit modal...');
        
        if (!isSuperAdminUser) {
            showToast('Hanya Super Admin yang dapat mengedit credit', 'error');
            return;
        }
        
        const modal = document.getElementById('editCreditModal');
        const container = document.getElementById('editCreditContainer');
        
        if (!modal || !container) {
            console.error('❌ Modal or container not found');
            showToast('Error: Modal tidak ditemukan', 'error');
            return;
        }
        
        // Kosongkan container terlebih dahulu
        container.innerHTML = '';
        
        console.log('📝 Populating credit edit form...');
        
        // Buat form input untuk setiap kategori
        for (const [category, data] of Object.entries(creditData)) {
            const div = document.createElement('div');
            div.className = 'form-group';
            
            div.innerHTML = `
                <label for="edit-${category}">${category} Credit</label>
                <input type="number" id="edit-${category}" class="form-input" 
                       value="${data.credit}" min="0" style="width: 100%;">
            `;
            
            container.appendChild(div);
        }
        
        // Tampilkan modal
        modal.classList.add('active');
        console.log('✅ Edit credit modal shown');
    }

    // Fungsi untuk menyimpan perubahan credit
    async function saveCreditChanges() {
        console.log('💾 Saving credit changes...');
        
        if (!isSuperAdminUser) {
            showToast('Hanya Super Admin yang dapat mengedit credit', 'error');
            return;
        }
        
        // Kumpulkan semua perubahan
        const changes = {};
        let hasChanges = false;
        
        for (const [category, data] of Object.entries(creditData)) {
            const input = document.getElementById(`edit-${category}`);
            if (input) {
                const newValue = parseInt(input.value) || 0;
                const oldValue = data.credit;
                
                if (newValue >= 0 && newValue !== oldValue) {
                    changes[category] = {
                        oldValue: oldValue,
                        newValue: newValue
                    };
                    hasChanges = true;
                    console.log(`📝 ${category}: ${oldValue} → ${newValue}`);
                }
            }
        }
        
        if (!hasChanges) {
            showToast('Tidak ada perubahan yang dilakukan', 'info');
            return;
        }
        
        try {
            console.log('💾 Applying credit changes to local data...');
            
            // Update data lokal
            for (const [category, change] of Object.entries(changes)) {
                creditData[category].credit = change.newValue;
            }
            
            console.log('🔥 Saving to Firestore...');
            // Simpan ke Firestore
            await db.collection('creditData').doc('brands').set(creditData);
            
            // Update UI
            updateCreditStats();
            updateBrandDropdown();
            
            // Tutup modal
            const modal = document.getElementById('editCreditModal');
            if (modal) {
                modal.classList.remove('active');
            }
            
            showToast('Nominal credit berhasil diperbarui!', 'success');
            console.log('✅ Credit changes saved successfully');
            
        } catch (error) {
            console.error("❌ Error saving credit changes:", error);
            showToast("Gagal menyimpan perubahan ke server", "error");
            
            // Fallback ke localStorage
            try {
                localStorage.setItem('creditData', JSON.stringify(creditData));
                updateCreditStats();
                updateBrandDropdown();
                
                const modal = document.getElementById('editCreditModal');
                if (modal) {
                    modal.classList.remove('active');
                }
                
                showToast('Nominal credit berhasil diperbarui (offline mode)', 'success');
            } catch (fallbackError) {
                console.error("❌ Fallback also failed:", fallbackError);
                showToast("Gagal menyimpan perubahan", "error");
            }
        }
    }

    // ========== FUNGSI EDIT HISTORY ==========

    // Fungsi untuk mengedit item riwayat
    function editHistoryItem(historyId, historyType) {
        if (!isSuperAdminUser) {
            showToast('Hanya Super Admin yang dapat mengedit riwayat', 'error');
            return;
        }
        
        const historyData = historyType === 'regular' ? topupHistory : masteragentHistory;
        const historyItem = historyData.find(item => item.id === historyId);
        
        if (!historyItem) {
            showToast('Data riwayat tidak ditemukan', 'error');
            return;
        }
        
        // Tampilkan modal edit
        const modal = document.getElementById('editHistoryModal');
        const container = document.getElementById('editHistoryContainer');
        
        if (!modal || !container) {
            showToast('Modal edit tidak ditemukan', 'error');
            return;
        }
        
        // Format angka untuk display (hilangkan pemisah ribuan untuk input)
        const formatForInput = (num) => {
            if (!num) return '0';
            return num.toString().replace(/\./g, '');
        };
        
        // Isi form dengan data yang ada
        let formHTML = '';
        
        if (historyType === 'regular') {
            formHTML = `
                <div class="form-group">
                    <label for="edit-history-date">Tanggal</label>
                    <input type="text" id="edit-history-date" class="form-input" value="${historyItem.date || ''}">
                </div>
                <div class="form-group">
                    <label for="edit-history-brand">Brand</label>
                    <input type="text" id="edit-history-brand" class="form-input" value="${historyItem.brand || ''}">
                </div>
                <div class="form-group">
                    <label for="edit-history-amount">Jumlah Top Up</label>
                    <input type="text" id="edit-history-amount" class="form-input formatted-input" 
                           value="${formatForInput(historyItem.amount)}" 
                           oninput="formatNumberInput(this)">
                    <small class="input-hint">Format: 1000000 (tanpa titik)</small>
                </div>
                <div class="form-group">
                    <label for="edit-history-before">Credit Sebelum</label>
                    <input type="text" id="edit-history-before" class="form-input formatted-input" 
                           value="${formatForInput(historyItem.before)}" 
                           oninput="formatNumberInput(this)">
                    <small class="input-hint">Format: 1000000 (tanpa titik)</small>
                </div>
                <div class="form-group">
                    <label for="edit-history-after">Credit Sesudah</label>
                    <input type="text" id="edit-history-after" class="form-input formatted-input" 
                           value="${formatForInput(historyItem.after)}" 
                           oninput="formatNumberInput(this)">
                    <small class="input-hint">Format: 1000000 (tanpa titik)</small>
                </div>
            `;
        } else {
            formHTML = `
                <div class="form-group">
                    <label for="edit-history-date">Tanggal</label>
                    <input type="text" id="edit-history-date" class="form-input" value="${historyItem.date || ''}">
                </div>
                <div class="form-group">
                    <label for="edit-history-category">Kategori</label>
                    <input type="text" id="edit-history-category" class="form-input" value="${historyItem.category || ''}">
                </div>
                <div class="form-group">
                    <label for="edit-history-amount">Jumlah Top Up</label>
                    <input type="text" id="edit-history-amount" class="form-input formatted-input" 
                           value="${formatForInput(historyItem.amount)}" 
                           oninput="formatNumberInput(this)">
                    <small class="input-hint">Format: 1000000 (tanpa titik)</small>
                </div>
                <div class="form-group">
                    <label for="edit-history-before">Credit Sebelum</label>
                    <input type="text" id="edit-history-before" class="form-input formatted-input" 
                           value="${formatForInput(historyItem.before)}" 
                           oninput="formatNumberInput(this)">
                    <small class="input-hint">Format: 1000000 (tanpa titik)</small>
                </div>
                <div class="form-group">
                    <label for="edit-history-after">Credit Sesudah</label>
                    <input type="text" id="edit-history-after" class="form-input formatted-input" 
                           value="${formatForInput(historyItem.after)}" 
                           oninput="formatNumberInput(this)">
                    <small class="input-hint">Format: 1000000 (tanpa titik)</small>
                </div>
            `;
        }
        
        container.innerHTML = formHTML;
        
        // Simpan data untuk update
        modal.dataset.historyId = historyId;
        modal.dataset.historyType = historyType;
        
        modal.classList.add('active');
    }

    // Fungsi untuk memformat input angka
    function formatNumberInput(input) {
        // Hapus semua karakter non-digit
        let value = input.value.replace(/[^\d]/g, '');
        
        // Simpan nilai asli tanpa format
        input.dataset.rawValue = value;
        
        // Format dengan pemisah ribuan untuk preview (opsional)
        const formatted = formatNumber(parseInt(value) || 0);
        input.style.borderColor = value ? 'var(--success)' : 'var(--border-color)';
    }

    // Fungsi untuk update credit data berdasarkan perubahan history
    // Fungsi untuk update credit data berdasarkan perubahan history - VERSI DIPERBAIKI
// Fungsi untuk update credit data berdasarkan perubahan history - VERSI DIPERBAIKI
async function updateCreditFromHistoryChange(historyId, historyType, updatedData) {
    if (!isSuperAdminUser) return;
    
    try {
        const collectionName = historyType === 'regular' ? 'topupHistory' : 'masteragentHistory';
        
        // 🔴 PROBLEM: Kita perlu mendapatkan data LAMA sebelum update
        // Tapi kita sudah update history sebelumnya, jadi oldData sudah berubah
        // SOLUSI: Simpan oldData sebelum update
        
        // Untuk sekarang, kita hitung berdasarkan perubahan amount langsung
        console.log('🔄 Calculating credit change from amount difference');
        
        // Cara alternatif: Hitung dari perubahan amount
        const oldAmount = await getOldHistoryAmount(historyId, historyType);
        const newAmount = updatedData.amount;
        
        console.log('💾 Amount change:', { oldAmount, newAmount });
        
        const amountDifference = newAmount - oldAmount;
        
        if (amountDifference === 0) {
            console.log('ℹ️ No amount change detected');
            return;
        }
        
        let categoryToUpdate = '';
        let creditDifference = 0;
        
        if (historyType === 'regular') {
            // ✅ REGULAR TOPUP: Credit BERKURANG saat topup
            // Jika amount bertambah → credit berkurang lebih banyak (difference NEGATIF)
            // Jika amount berkurang → credit bertambah (difference POSITIF)
            creditDifference = -amountDifference; // Tanda negatif karena credit berkurang
            
            // Cari kategori berdasarkan brand
            for (const [category, data] of Object.entries(creditData)) {
                if (data.brands.includes(updatedData.brand)) {
                    categoryToUpdate = category;
                    break;
                }
            }
        } else {
            // ✅ MASTERAGENT: Credit BERTAMBAH saat topup  
            // Jika amount bertambah → credit bertambah lebih banyak (difference POSITIF)
            // Jika amount berkurang → credit berkurang (difference NEGATIF)
            creditDifference = amountDifference; // Tanda positif karena credit bertambah
            categoryToUpdate = updatedData.category;
        }
        
        console.log(`📊 Final credit difference: ${creditDifference}`);
        
        if (categoryToUpdate && creditData[categoryToUpdate]) {
            // Update credit data
            const oldCredit = creditData[categoryToUpdate].credit;
            creditData[categoryToUpdate].credit += creditDifference;
            
            // Validasi tidak boleh minus
            if (creditData[categoryToUpdate].credit < 0) {
                console.error('❌ Credit cannot be negative');
                creditData[categoryToUpdate].credit = oldCredit; // Rollback
                throw new Error('Credit cannot be negative');
            }
            
            // Simpan ke Firestore
            await db.collection('creditData').doc('brands').set(creditData);
            
            console.log(`✅ Credit updated for ${categoryToUpdate}: ${oldCredit} → ${creditData[categoryToUpdate].credit} (change: ${creditDifference})`);
            
            // Update UI immediately
            updateCreditStats();
        } else {
            console.error('❌ Category not found for update:', categoryToUpdate);
        }
        
    } catch (error) {
        console.error('Error updating credit from history change:', error);
        throw error;
    }
}

// Fungsi untuk mendapatkan amount lama dari history
async function getOldHistoryAmount(historyId, historyType) {
    try {
        const collectionName = historyType === 'regular' ? 'topupHistory' : 'masteragentHistory';
        const historyDoc = await db.collection(collectionName).doc(historyId).get();
        
        if (historyDoc.exists) {
            return historyDoc.data().amount || 0;
        }
        return 0;
    } catch (error) {
        console.error('Error getting old history amount:', error);
        return 0;
    }
}

    // Fungsi untuk menyimpan perubahan riwayat
    async function saveHistoryChanges() {
    if (!isSuperAdminUser) {
        showToast('Hanya Super Admin yang dapat mengedit riwayat', 'error');
        return;
    }
    
    const modal = document.getElementById('editHistoryModal');
    const historyId = modal.dataset.historyId;
    const historyType = modal.dataset.historyType;
    
    if (!historyId || !historyType) {
        showToast('Data tidak valid', 'error');
        return;
    }
    
    try {
        // 🔴 DAPATKAN OLD DATA SEBELUM UPDATE
        const oldAmount = await getOldHistoryAmount(historyId, historyType);
        
        // Ambil nilai dari input (gunakan raw value jika ada)
        const getRawValue = (inputId) => {
            const input = document.getElementById(inputId);
            return input.dataset.rawValue ? parseInt(input.dataset.rawValue) : 
                   parseInt(input.value.replace(/[^\d]/g, '')) || 0;
        };
        
// ✅ KODE BARU (BENAR):
// Dapatkan data history item yang akan diupdate
const historyData = historyType === 'regular' ? topupHistory : masteragentHistory;
const historyItem = historyData.find(item => item.id === historyId);

if (!historyItem) {
    showToast('Data riwayat tidak ditemukan', 'error');
    return;
}

const updatedData = {
    date: document.getElementById('edit-history-date').value,
    user: historyItem.user, // ✅ historyItem sekarang terdefinisi
    userEmail: historyItem.userEmail,
    userId: historyItem.userId,
    amount: getRawValue('edit-history-amount'),
    before: getRawValue('edit-history-before'),
    after: getRawValue('edit-history-after'),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
};
        
        // Validasi data
        if (!updatedData.date || !updatedData.amount || !updatedData.before || !updatedData.after) {
            showToast('Semua field harus diisi dengan benar', 'error');
            return;
        }
        
        // Tambahkan field khusus berdasarkan tipe
        if (historyType === 'regular') {
            updatedData.brand = document.getElementById('edit-history-brand').value;
            if (!updatedData.brand) {
                showToast('Brand harus diisi', 'error');
                return;
            }
        } else {
            updatedData.category = document.getElementById('edit-history-category').value;
            if (!updatedData.category) {
                showToast('Kategori harus diisi', 'error');
                return;
            }
        }
        
        console.log('📝 History update data:', {
            oldAmount,
            newAmount: updatedData.amount,
            difference: updatedData.amount - oldAmount
        });
        
        const collectionName = historyType === 'regular' ? 'topupHistory' : 'masteragentHistory';
        
        // ✅ 1. UPDATE CREDIT DULU berdasarkan perubahan amount
        await updateCreditFromHistoryChange(historyId, historyType, updatedData);
        
        // ✅ 2. BARU UPDATE HISTORY
        await db.collection(collectionName).doc(historyId).update(updatedData);
        
        showToast('Riwayat berhasil diperbarui', 'success');
        modal.classList.remove('active');
        
        // Refresh semua UI
        updateCreditStats(); // ✅ Update top bar
        if (historyType === 'regular') {
            updateHistoryTable();
        } else {
            updateMasteragentHistoryTable();
        }
        
    } catch (error) {
        console.error('Error updating history:', error);
        showToast('Gagal memperbarui riwayat', 'error');
    }
}

    // ========== FUNGSI DELETE HISTORY ==========

    // Fungsi untuk menghapus item riwayat
    async function deleteHistoryItem(historyId, historyType) {
        if (!isSuperAdminUser) {
            showToast('Hanya Super Admin yang dapat menghapus riwayat', 'error');
            return;
        }
        
        const confirmation = confirm('Apakah Anda yakin ingin menghapus riwayat ini?');
        if (!confirmation) return;
        
        try {
            const collectionName = historyType === 'regular' ? 'topupHistory' : 'masteragentHistory';
            
            // Dapatkan data sebelum menghapus untuk update credit
            const historyDoc = await db.collection(collectionName).doc(historyId).get();
            if (historyDoc.exists) {
                const historyData = historyDoc.data();
                
                // Kembalikan credit ke keadaan semula
                await revertCreditFromHistory(historyData, historyType);
            }
            
            // Hapus dari Firestore
            await db.collection(collectionName).doc(historyId).delete();
            
            showToast('Riwayat berhasil dihapus', 'success');
            
            // Refresh tabel
            if (historyType === 'regular') {
                updateHistoryTable();
            } else {
                updateMasteragentHistoryTable();
            }
            
        } catch (error) {
            console.error('Error deleting history:', error);
            showToast('Gagal menghapus riwayat', 'error');
        }
    }

    // Fungsi untuk mengembalikan credit saat menghapus history
    // Fungsi untuk mengembalikan credit saat menghapus history - VERSI DIPERBAIKI
// Fungsi untuk mengembalikan credit saat menghapus history - VERSI DIPERBAIKI
async function revertCreditFromHistory(historyData, historyType) {
    try {
        let categoryToUpdate = '';
        
        if (historyType === 'regular') {
            // Cari kategori berdasarkan brand
            for (const [category, data] of Object.entries(creditData)) {
                if (data.brands.includes(historyData.brand)) {
                    categoryToUpdate = category;
                    break;
                }
            }
            
            // ✅ REGULAR TOPUP: Credit awal berkurang, jadi saat hapus kita TAMBAHKAN kembali
            if (categoryToUpdate && creditData[categoryToUpdate]) {
                const creditDifference = historyData.amount; // Jumlah yang dikurangi sebelumnya
                const oldCredit = creditData[categoryToUpdate].credit;
                creditData[categoryToUpdate].credit += creditDifference; // ✅ TAMBAH kembali
                
                // Simpan ke Firestore
                await db.collection('creditData').doc('brands').set(creditData);
                
                console.log(`✅ Regular topup reverted: ${oldCredit} → ${creditData[categoryToUpdate].credit} (added back: ${creditDifference})`);
                
                // Update UI immediately
                updateCreditStats();
            }
            
        } else {
            // ✅ MASTERAGENT: Credit awal bertambah, jadi saat hapus kita KURANGI kembali
            categoryToUpdate = historyData.category;
            
            if (categoryToUpdate && creditData[categoryToUpdate]) {
                const creditDifference = historyData.amount; // Jumlah yang ditambah sebelumnya
                const oldCredit = creditData[categoryToUpdate].credit;
                creditData[categoryToUpdate].credit -= creditDifference; // ✅ KURANGI kembali
                
                // Simpan ke Firestore
                await db.collection('creditData').doc('brands').set(creditData);
                
                console.log(`✅ Masteragent reverted: ${oldCredit} → ${creditData[categoryToUpdate].credit} (removed: ${creditDifference})`);
                
                // Update UI immediately
                updateCreditStats();
            }
        }
        
    } catch (error) {
        console.error('Error reverting credit:', error);
        throw error;
    }
}

    // ========== FUNGSI EVENT LISTENERS ==========

    // Fungsi untuk setup semua event listeners
    function setupEventListeners() {
        console.log('🔧 Setting up event listeners...');
        
        // Event listener untuk save credit changes
        const saveCreditBtn = document.getElementById('saveCreditChanges');
        if (saveCreditBtn) {
            console.log('✅ Found saveCreditChanges button');
            saveCreditBtn.addEventListener('click', saveCreditChanges);
        } else {
            console.error('❌ saveCreditChanges button not found!');
        }
        
        // Event listener untuk save history changes
        const saveHistoryBtn = document.getElementById('saveHistoryChanges');
        if (saveHistoryBtn) {
            console.log('✅ Found saveHistoryChanges button');
            saveHistoryBtn.addEventListener('click', saveHistoryChanges);
        } else {
            console.error('❌ saveHistoryChanges button not found!');
        }
        
        // Event listener untuk menutup modal
        document.querySelectorAll('.modal-close').forEach(button => {
            button.addEventListener('click', function() {
                const modal = this.closest('.modal-overlay');
                if (modal) {
                    modal.classList.remove('active');
                }
            });
        });
        
        // Event listener untuk menutup modal saat klik di luar
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
        
        // Event listener untuk refresh history
        const refreshHistoryBtn = document.getElementById('refreshHistory');
        if (refreshHistoryBtn) {
            refreshHistoryBtn.addEventListener('click', function() {
                updateHistoryTable();
                showToast('Riwayat diperbarui', 'info');
            });
        }
        
        // Event listener untuk refresh masteragent history
        const refreshMasteragentHistoryBtn = document.getElementById('refreshMasteragentHistory');
        if (refreshMasteragentHistoryBtn) {
            refreshMasteragentHistoryBtn.addEventListener('click', function() {
                updateMasteragentHistoryTable();
                showToast('Riwayat masteragent diperbarui', 'info');
            });
        }
        
        // Event listener untuk tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show active content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabId}Tab`).classList.add('active');
                
                // Reset pagination saat ganti tab
                if (tabId === 'regular') {
                    currentRegularPage = 1;
                    updateHistoryTable();
                } else {
                    currentMasteragentPage = 1;
                    updateMasteragentHistoryTable();
                }
            });
        });
        
        // Event listener untuk form input changes
        document.getElementById('masteragentCategory')?.addEventListener('change', function() {
            const category = this.value;
            const currentCreditInput = document.getElementById('masteragentCurrentCredit');
            const topupAmountInput = document.getElementById('masteragentCredit');
            const newCreditInput = document.getElementById('masteragentNewCredit');
            
            if (category && creditData[category]) {
                currentCreditInput.value = formatNumber(creditData[category].credit);
                topupAmountInput.value = '';
                newCreditInput.value = formatNumber(creditData[category].credit);
            } else {
                currentCreditInput.value = '';
                topupAmountInput.value = '';
                newCreditInput.value = '';
            }
        });
        
        document.getElementById('masteragentCredit')?.addEventListener('input', function() {
            const categorySelect = document.getElementById('masteragentCategory');
            const currentCreditInput = document.getElementById('masteragentCurrentCredit');
            const newCreditInput = document.getElementById('masteragentNewCredit');
            
            if (categorySelect.value && currentCreditInput.value) {
                const currentCredit = parseFormattedNumber(currentCreditInput.value);
                const topupAmount = parseInt(this.value) || 0;
                
                const newCredit = currentCredit + topupAmount;
                newCreditInput.value = formatNumber(newCredit);
                newCreditInput.style.color = "var(--text-primary)";
            }
        });
        
        document.getElementById('brandSelect')?.addEventListener('change', function() {
            const brand = this.value;
            const category = this.options[this.selectedIndex]?.dataset.category;
            const currentCreditInput = document.getElementById('currentCredit');
            const topupAmountInput = document.getElementById('topupAmount');
            const newCreditInput = document.getElementById('newCredit');
            
            if (brand && category && creditData[category]) {
                currentCreditInput.value = formatNumber(creditData[category].credit);
                topupAmountInput.value = '';
                newCreditInput.value = formatNumber(creditData[category].credit);
                newCreditInput.style.color = "var(--text-primary)";
            } else {
                currentCreditInput.value = '';
                topupAmountInput.value = '';
                newCreditInput.value = '';
            }
        });
        
        document.getElementById('topupAmount')?.addEventListener('input', function() {
            const brandSelect = document.getElementById('brandSelect');
            const category = brandSelect.options[brandSelect.selectedIndex]?.dataset.category;
            const currentCreditInput = document.getElementById('currentCredit');
            const newCreditInput = document.getElementById('newCredit');
            
            if (brandSelect.value && currentCreditInput.value && category) {
                const currentCredit = parseFormattedNumber(currentCreditInput.value);
                const topupAmount = parseInt(this.value) || 0;
                
                if (topupAmount > currentCredit) {
                    newCreditInput.value = "Credit tidak mencukupi!";
                    newCreditInput.style.color = "var(--danger)";
                } else {
                    const newCredit = currentCredit - topupAmount;
                    newCreditInput.value = formatNumber(newCredit);
                    newCreditInput.style.color = "var(--text-primary)";
                }
            }
        });
        
        // Event listener untuk form submissions
        document.getElementById('masteragentForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const category = document.getElementById('masteragentCategory').value;
            const credit = parseInt(document.getElementById('masteragentCredit').value);
            
            if (!category || isNaN(credit) || credit <= 0) {
                showToast('Semua field harus diisi dengan benar', 'error');
                return;
            }
            
            // Tambahkan credit ke kategori yang dipilih
            if (creditData[category]) {
                const currentCredit = creditData[category].credit;
                creditData[category].credit += credit;
                
                try {
                    // Simpan ke Firestore
                    await db.collection('creditData').doc('brands').set(creditData);
                    
                    // Tambahkan ke history masteragent
                    // Dapatkan data user yang sedang login
const userData = await getCurrentUserData();

// Tambahkan ke history
// ✅ KODE BARU (BENAR):
const historyEntry = {
    date: new Date().toLocaleString('id-ID'),
    user: userData.name,
    userEmail: userData.email,
    userId: userData.uid,
    category: category, // ✅ BENAR - untuk masteragent
    amount: credit, // ✅ BENAR - variable yang benar
    before: currentCredit,
    after: currentCredit + credit, // ✅ BENAR - masteragent credit BERTAMBAH
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
};
                    
                    // Simpan ke Firestore
                    await db.collection('masteragentHistory').add(historyEntry);
                    
                    // Update UI
                    updateCreditStats();
                    
                    // Reset form
                    this.reset();
                    document.getElementById('masteragentCurrentCredit').value = '';
                    document.getElementById('masteragentNewCredit').value = '';
                    
                    showToast(`Top up masteragent berhasil! ${formatNumber(credit)} credit ditambahkan ke kategori ${category}`);
                } catch (error) {
                    console.error("Error saving masteragent topup:", error);
                    showToast("Gagal menyimpan data ke server", "error");
                }
            } else {
                showToast('Kategori tidak valid', 'error');
            }
        });
        
        document.getElementById('topupForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const brandSelect = document.getElementById('brandSelect');
            const brand = brandSelect.value;
            const category = brandSelect.options[brandSelect.selectedIndex]?.dataset.category;
            const amount = parseInt(document.getElementById('topupAmount').value);
            
            if (!brand || !category || isNaN(amount) || amount <= 0) {
                showToast('Semua field harus diisi dengan benar', 'error');
                return;
            }
            
            // Kurangi credit dari kategori yang dipilih
            if (creditData[category].credit >= amount) {
                const currentCredit = creditData[category].credit;
                creditData[category].credit -= amount;
                
                try {
                    // Simpan ke Firestore
                    await db.collection('creditData').doc('brands').set(creditData);
                    
                    // Tambahkan ke history
                    // Dapatkan data user yang sedang login
const userData = await getCurrentUserData();

// Tambahkan ke history masteragent
// ✅ KODE BARU (BENAR):
const historyEntry = {
    date: new Date().toLocaleString('id-ID'),
    user: userData.name,
    userEmail: userData.email,
    userId: userData.uid,
    brand: brand, // ✅ BENAR - untuk regular topup
    amount: amount, // ✅ BENAR - variable yang benar
    before: currentCredit,
    after: currentCredit - amount, // ✅ BENAR - regular credit BERKURANG
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
};
                    
                    // Simpan ke Firestore
                    await db.collection('topupHistory').add(historyEntry);
                    
                    // Update UI
                    updateCreditStats();
                    
                    // Reset form
                    this.reset();
                    document.getElementById('currentCredit').value = '';
                    document.getElementById('newCredit').value = '';
                    
                    showToast(`Top up berhasil! ${formatNumber(amount)} credit dikurangi dari ${brand}`);
                } catch (error) {
                    console.error("Error saving topup:", error);
                    showToast("Gagal menyimpan data ke server", "error");
                }
            } else {
                showToast('Credit tidak mencukupi untuk melakukan top up', 'error');
            }
        });
        
        // Event listener untuk pencarian
        document.getElementById('dashboardSearch')?.addEventListener('input', function() {
            currentRegularPage = 1;
            currentMasteragentPage = 1;
            updateHistoryTable();
            updateMasteragentHistoryTable();
        });
        
        console.log('✅ All event listeners setup completed');
    }

    // ========== INISIALISASI APLIKASI ==========

    // Inisialisasi aplikasi saat halaman dimuat
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Initializing Top Up Credit Dashboard...');
        
        // Setup authentication state observer
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                console.log('✅ User is signed in:', user.email);
                
                // Check super admin status
                await checkAndSetupSuperAdmin();
                
                // Setup Firestore listeners
                setupFirestoreListeners();
                
            } else {
                console.log('❌ No user signed in');
                
                // Clear listeners
                if (unsubscribeCreditData) unsubscribeCreditData();
                if (unsubscribeTopupHistory) unsubscribeTopupHistory();
                if (unsubscribeMasteragentHistory) unsubscribeMasteragentHistory();
                
                // Load data from localStorage sebagai fallback
                const localData = localStorage.getItem('creditData');
                if (localData) {
                    creditData = JSON.parse(localData);
                    updateCreditStats();
                    updateBrandDropdown();
                } else {
                    creditData = defaultBrands;
                    updateCreditStats();
                    updateBrandDropdown();
                }
                
                const localHistory = localStorage.getItem('topupHistory');
                if (localHistory) {
                    topupHistory = JSON.parse(localHistory);
                    updateHistoryTable();
                }
                
                const localMasteragentHistory = localStorage.getItem('masteragentHistory');
                if (localMasteragentHistory) {
                    masteragentHistory = JSON.parse(localMasteragentHistory);
                    updateMasteragentHistoryTable();
                }
            }
        });
        
        // Setup semua event listeners
        setupEventListeners();
        
        console.log('✅ Top Up Credit Dashboard initialized successfully');
    });

    // ========== FUNGSI DEBUG ==========

    // Fungsi debug untuk testing
    window.debugTopup = function() {
        console.log('=== DEBUG TOPUP CREDIT ===');
        console.log('Current User:', firebase.auth().currentUser);
        console.log('Is Super Admin:', isSuperAdminUser);
        console.log('Credit Data:', creditData);
        console.log('Topup History:', topupHistory);
        console.log('Masteragent History:', masteragentHistory);
        console.log('Modal Elements:', {
            editCreditModal: document.getElementById('editCreditModal'),
            editHistoryModal: document.getElementById('editHistoryModal'),
            saveCreditChanges: document.getElementById('saveCreditChanges'),
            saveHistoryChanges: document.getElementById('saveHistoryChanges')
        });
    };

    // Force enable super admin untuk testing
    window.forceSuperAdminTopup = function() {
        isSuperAdminUser = true;
        setupAdminUI(true);
        console.log('🔓 Super admin forced enabled for topup');
        showToast('Super Admin mode diaktifkan secara manual', 'info');
    };
    // ========== TRANSLATIONS FOR TOPUP CREDIT ==========
const topupCreditTranslations = {
    id: {
        // Header
        "pageTitle": "Top Up Credit",
        "searchPlaceholder": "Cari...",
        
        // Credit Statistics
        "dGamingCredit": "D-GAMING Credit",
        "gachaCredit": "GACHA Credit", 
        "bremCredit": "BREM Credit",
        "cbwlCredit": "CBWL Credit",
        "engine89Credit": "89ENGINE Credit",
        "luxionCredit": "LUXION Credit",
        "availableCredit": "Available Credit",
        
        // Tabs
        "regularTab": "Form Top Up Credit Agent",
        "masteragentTab": "Form Top Up Credit Masteragent",
        
        // Regular Top Up Form
        "regularFormTitle": "Form Top Up Credit Agent",
        "selectBrand": "Select Brand",
        "currentCredit": "Credit Saat Ini",
        "topupAmount": "Jumlah Top Up",
        "topupAmountPlaceholder": "Masukkan jumlah top up",
        "newCredit": "Credit Setelah Top Up",
        "resetButton": "Reset",
        "processTopup": "Proses Top Up",
        "insufficientCredit": "Credit tidak mencukupi!",
        
        // Masteragent Top Up Form
        "masteragentFormTitle": "Form Top Up Credit Masteragent",
        "selectCategory": "Select Category",
        "masteragentCurrentCredit": "Credit Saat Ini",
        "masteragentTopupAmount": "Jumlah Top Up",
        "masteragentTopupAmountPlaceholder": "Masukkan jumlah top up",
        "masteragentNewCredit": "Credit Setelah Top Up",
        
        // History Sections
        "regularHistoryTitle": "Riwayat Top Up",
        "masteragentHistoryTitle": "Riwayat Top Up Masteragent",
        "refreshButton": "Muat Ulang",
        "noHistory": "Tidak Ada Riwayat",
        "noHistoryMessage": "Belum ada riwayat top up untuk ditampilkan.",
        "noMasteragentHistoryMessage": "Belum ada riwayat top up masteragent untuk ditampilkan.",
        
        // Table Headers
        "date": "Tanggal",
        "user": "User",
        "brand": "Brand",
        "category": "Kategori",
        "topupAmountCol": "Jumlah Top Up",
        "creditBefore": "Credit Sebelum",
        "creditAfter": "Credit Sesudah",
        "actions": "Aksi",
        
        // Action Buttons
        "edit": "Edit",
        "delete": "Hapus",
        
        // Pagination
        "pageInfo": "Halaman {current} dari {total} (Total: {count} data)",
        "noData": "Tidak ada data",
        "previous": "Previous",
        "next": "Next",
        
        // Modal Titles
        "editCredit": "Edit Credit",
        "editHistory": "Edit Riwayat",
        
        // Modal Buttons
        "cancel": "Batal",
        "saveChanges": "Simpan Perubahan",
        "saveCreditChanges": "Simpan Perubahan Credit",
        "saveHistoryChanges": "Simpan Perubahan Riwayat",
        
        // Form Labels
        "creditAmount": "Credit",
        "amount": "Jumlah",
        "before": "Sebelum",
        "after": "Sesudah",
        
        // Input Hints
        "inputHint": "Format: 1000000 (tanpa titik)",
        
        // Notifications
        "topupSuccess": "Top up berhasil! {amount} credit dikurangi dari {brand}",
        "masteragentTopupSuccess": "Top up masteragent berhasil! {amount} credit ditambahkan ke kategori {category}",
        "creditUpdated": "Nominal credit berhasil diperbarui!",
        "historyUpdated": "Riwayat berhasil diperbarui",
        "historyDeleted": "Riwayat berhasil dihapus",
        "refreshSuccess": "Riwayat diperbarui",
        "masteragentRefreshSuccess": "Riwayat masteragent diperbarui",
        "noChanges": "Tidak ada perubahan yang dilakukan",
        "allFieldsRequired": "Semua field harus diisi dengan benar",
        "invalidCategory": "Kategori tidak valid",
        "insufficientCreditError": "Credit tidak mencukupi untuk melakukan top up",
        "invalidData": "Data tidak valid",
        "historyNotFound": "Data riwayat tidak ditemukan",
        "saveError": "Gagal menyimpan data ke server",
        "updateError": "Gagal memperbarui riwayat",
        "deleteError": "Gagal menghapus riwayat",
        "adminOnly": "Hanya Super Admin yang dapat mengedit credit",
        "historyAdminOnly": "Hanya Super Admin yang dapat mengedit riwayat",
        "deleteAdminOnly": "Hanya Super Admin yang dapat menghapus riwayat",
        
        // Confirmation Messages
        "confirmDelete": "Apakah Anda yakin ingin menghapus riwayat ini?",
        "confirmReset": "Apakah Anda yakin ingin mereset form?",
        
        // User Roles
        "superAdmin": "Super Administrator",
        "customerSupport": "Customer Service Support",
        "localStorageMode": "Mode Local Storage"
    },
    
    en: {
        // Header
        "pageTitle": "Top Up Credit",
        "searchPlaceholder": "Search...",
        
        // Credit Statistics
        "dGamingCredit": "D-GAMING Credit",
        "gachaCredit": "GACHA Credit",
        "bremCredit": "BREM Credit",
        "cbwlCredit": "CBWL Credit",
        "engine89Credit": "89ENGINE Credit",
        "luxionCredit": "LUXION Credit",
        "availableCredit": "Available Credit",
        
        // Tabs
        "regularTab": "Agent Credit Top Up Form",
        "masteragentTab": "Masteragent Credit Top Up Form",
        
        // Regular Top Up Form
        "regularFormTitle": "Agent Credit Top Up Form",
        "selectBrand": "Select Brand",
        "currentCredit": "Current Credit",
        "topupAmount": "Top Up Amount",
        "topupAmountPlaceholder": "Enter top up amount",
        "newCredit": "Credit After Top Up",
        "resetButton": "Reset",
        "processTopup": "Process Top Up",
        "insufficientCredit": "Insufficient credit!",
        
        // Masteragent Top Up Form
        "masteragentFormTitle": "Masteragent Credit Top Up Form",
        "selectCategory": "Select Category",
        "masteragentCurrentCredit": "Current Credit",
        "masteragentTopupAmount": "Top Up Amount",
        "masteragentTopupAmountPlaceholder": "Enter top up amount",
        "masteragentNewCredit": "Credit After Top Up",
        
        // History Sections
        "regularHistoryTitle": "Top Up History",
        "masteragentHistoryTitle": "Masteragent Top Up History",
        "refreshButton": "Refresh",
        "noHistory": "No History",
        "noHistoryMessage": "No top up history to display.",
        "noMasteragentHistoryMessage": "No masteragent top up history to display.",
        
        // Table Headers
        "date": "Date",
        "user": "User",
        "brand": "Brand",
        "category": "Category",
        "topupAmountCol": "Top Up Amount",
        "creditBefore": "Credit Before",
        "creditAfter": "Credit After",
        "actions": "Actions",
        
        // Action Buttons
        "edit": "Edit",
        "delete": "Delete",
        
        // Pagination
        "pageInfo": "Page {current} of {total} (Total: {count} items)",
        "noData": "No data",
        "previous": "Previous",
        "next": "Next",
        
        // Modal Titles
        "editCredit": "Edit Credit",
        "editHistory": "Edit History",
        
        // Modal Buttons
        "cancel": "Cancel",
        "saveChanges": "Save Changes",
        "saveCreditChanges": "Save Credit Changes",
        "saveHistoryChanges": "Save History Changes",
        
        // Form Labels
        "creditAmount": "Credit",
        "amount": "Amount",
        "before": "Before",
        "after": "After",
        
        // Input Hints
        "inputHint": "Format: 1000000 (no separators)",
        
        // Notifications
        "topupSuccess": "Top up successful! {amount} credit deducted from {brand}",
        "masteragentTopupSuccess": "Masteragent top up successful! {amount} credit added to {category} category",
        "creditUpdated": "Credit amounts updated successfully!",
        "historyUpdated": "History updated successfully",
        "historyDeleted": "History deleted successfully",
        "refreshSuccess": "History refreshed",
        "masteragentRefreshSuccess": "Masteragent history refreshed",
        "noChanges": "No changes made",
        "allFieldsRequired": "All fields must be filled correctly",
        "invalidCategory": "Invalid category",
        "insufficientCreditError": "Insufficient credit to process top up",
        "invalidData": "Invalid data",
        "historyNotFound": "History data not found",
        "saveError": "Failed to save data to server",
        "updateError": "Failed to update history",
        "deleteError": "Failed to delete history",
        "adminOnly": "Only Super Admin can edit credit",
        "historyAdminOnly": "Only Super Admin can edit history",
        "deleteAdminOnly": "Only Super Admin can delete history",
        
        // Confirmation Messages
        "confirmDelete": "Are you sure you want to delete this history?",
        "confirmReset": "Are you sure you want to reset the form?",
        
        // User Roles
        "superAdmin": "Super Administrator",
        "customerSupport": "Customer Service Support",
        "localStorageMode": "Local Storage Mode"
    },
    
    ja: {
        // Header
        "pageTitle": "クレジットチャージ",
        "searchPlaceholder": "検索...",
        
        // Credit Statistics
        "dGamingCredit": "D-GAMING クレジット",
        "gachaCredit": "GACHA クレジット",
        "bremCredit": "BREM クレジット",
        "cbwlCredit": "CBWL クレジット",
        "engine89Credit": "89ENGINE クレジット",
        "luxionCredit": "LUXION クレジット",
        "availableCredit": "利用可能クレジット",
        
        // Tabs
        "regularTab": "エージェントチャージフォーム",
        "masteragentTab": "マスターエージェントチャージフォーム",
        
        // Regular Top Up Form
        "regularFormTitle": "エージェントクレジットチャージフォーム",
        "selectBrand": "ブランドを選択",
        "currentCredit": "現在のクレジット",
        "topupAmount": "チャージ金額",
        "topupAmountPlaceholder": "チャージ金額を入力",
        "newCredit": "チャージ後のクレジット",
        "resetButton": "リセット",
        "processTopup": "チャージ実行",
        "insufficientCredit": "クレジットが不足しています！",
        
        // Masteragent Top Up Form
        "masteragentFormTitle": "マスターエージェントチャージフォーム",
        "selectCategory": "カテゴリを選択",
        "masteragentCurrentCredit": "現在のクレジット",
        "masteragentTopupAmount": "チャージ金額",
        "masteragentTopupAmountPlaceholder": "チャージ金額を入力",
        "masteragentNewCredit": "チャージ後のクレジット",
        
        // History Sections
        "regularHistoryTitle": "チャージ履歴",
        "masteragentHistoryTitle": "マスターエージェントチャージ履歴",
        "refreshButton": "更新",
        "noHistory": "履歴がありません",
        "noHistoryMessage": "表示するチャージ履歴がありません。",
        "noMasteragentHistoryMessage": "表示するマスターエージェントチャージ履歴がありません。",
        
        // Table Headers
        "date": "日付",
        "user": "ユーザー",
        "brand": "ブランド",
        "category": "カテゴリ",
        "topupAmountCol": "チャージ金額",
        "creditBefore": "チャージ前クレジット",
        "creditAfter": "チャージ後クレジット",
        "actions": "操作",
        
        // Action Buttons
        "edit": "編集",
        "delete": "削除",
        
        // Pagination
        "pageInfo": "{current}/{total}ページ (合計: {count}件)",
        "noData": "データがありません",
        "previous": "前へ",
        "next": "次へ",
        
        // Modal Titles
        "editCredit": "クレジット編集",
        "editHistory": "履歴編集",
        
        // Modal Buttons
        "cancel": "キャンセル",
        "saveChanges": "変更を保存",
        "saveCreditChanges": "クレジット変更を保存",
        "saveHistoryChanges": "履歴変更を保存",
        
        // Form Labels
        "creditAmount": "クレジット",
        "amount": "金額",
        "before": "前",
        "after": "後",
        
        // Input Hints
        "inputHint": "形式: 1000000 (区切り文字なし)",
        
        // Notifications
        "topupSuccess": "チャージ成功！ {brand} から {amount} クレジットを差し引きました",
        "masteragentTopupSuccess": "マスターエージェントチャージ成功！ {category} カテゴリに {amount} クレジットを追加しました",
        "creditUpdated": "クレジット額が正常に更新されました！",
        "historyUpdated": "履歴が正常に更新されました",
        "historyDeleted": "履歴が正常に削除されました",
        "refreshSuccess": "履歴を更新しました",
        "masteragentRefreshSuccess": "マスターエージェント履歴を更新しました",
        "noChanges": "変更はありません",
        "allFieldsRequired": "すべてのフィールドを正しく入力してください",
        "invalidCategory": "無効なカテゴリです",
        "insufficientCreditError": "チャージ処理に十分なクレジットがありません",
        "invalidData": "無効なデータです",
        "historyNotFound": "履歴データが見つかりません",
        "saveError": "サーバーへのデータ保存に失敗しました",
        "updateError": "履歴の更新に失敗しました",
        "deleteError": "履歴の削除に失敗しました",
        "adminOnly": "クレジット編集はスーパー管理者のみ可能です",
        "historyAdminOnly": "履歴編集はスーパー管理者のみ可能です",
        "deleteAdminOnly": "履歴削除はスーパー管理者のみ可能です",
        
        // Confirmation Messages
        "confirmDelete": "この履歴を削除してもよろしいですか？",
        "confirmReset": "フォームをリセットしてもよろしいですか？",
        
        // User Roles
        "superAdmin": "スーパー管理者",
        "customerSupport": "カスタマーサービスサポート",
        "localStorageMode": "ローカルストレージモード"
    },
    
    zh: {
        // Header
        "pageTitle": "充值信用额",
        "searchPlaceholder": "搜索...",
        
        // Credit Statistics
        "dGamingCredit": "D-GAMING 信用额",
        "gachaCredit": "GACHA 信用额",
        "bremCredit": "BREM 信用额",
        "cbwlCredit": "CBWL 信用额",
        "engine89Credit": "89ENGINE 信用额",
        "luxionCredit": "LUXION 信用额",
        "availableCredit": "可用信用额",
        
        // Tabs
        "regularTab": "代理充值表单",
        "masteragentTab": "总代理充值表单",
        
        // Regular Top Up Form
        "regularFormTitle": "代理信用额充值表单",
        "selectBrand": "选择品牌",
        "currentCredit": "当前信用额",
        "topupAmount": "充值金额",
        "topupAmountPlaceholder": "输入充值金额",
        "newCredit": "充值后信用额",
        "resetButton": "重置",
        "processTopup": "处理充值",
        "insufficientCredit": "信用额不足！",
        
        // Masteragent Top Up Form
        "masteragentFormTitle": "总代理信用额充值表单",
        "selectCategory": "选择类别",
        "masteragentCurrentCredit": "当前信用额",
        "masteragentTopupAmount": "充值金额",
        "masteragentTopupAmountPlaceholder": "输入充值金额",
        "masteragentNewCredit": "充值后信用额",
        
        // History Sections
        "regularHistoryTitle": "充值历史",
        "masteragentHistoryTitle": "总代理充值历史",
        "refreshButton": "刷新",
        "noHistory": "无历史记录",
        "noHistoryMessage": "暂无充值历史记录。",
        "noMasteragentHistoryMessage": "暂无总代理充值历史记录。",
        
        // Table Headers
        "date": "日期",
        "user": "用户",
        "brand": "品牌",
        "category": "类别",
        "topupAmountCol": "充值金额",
        "creditBefore": "充值前信用额",
        "creditAfter": "充值后信用额",
        "actions": "操作",
        
        // Action Buttons
        "edit": "编辑",
        "delete": "删除",
        
        // Pagination
        "pageInfo": "第 {current} 页，共 {total} 页 (总计: {count} 条数据)",
        "noData": "无数据",
        "previous": "上一页",
        "next": "下一页",
        
        // Modal Titles
        "editCredit": "编辑信用额",
        "editHistory": "编辑历史记录",
        
        // Modal Buttons
        "cancel": "取消",
        "saveChanges": "保存更改",
        "saveCreditChanges": "保存信用额更改",
        "saveHistoryChanges": "保存历史记录更改",
        
        // Form Labels
        "creditAmount": "信用额",
        "amount": "金额",
        "before": "之前",
        "after": "之后",
        
        // Input Hints
        "inputHint": "格式: 1000000 (无分隔符)",
        
        // Notifications
        "topupSuccess": "充值成功！从 {brand} 扣除 {amount} 信用额",
        "masteragentTopupSuccess": "总代理充值成功！向 {category} 类别添加 {amount} 信用额",
        "creditUpdated": "信用额已成功更新！",
        "historyUpdated": "历史记录已成功更新",
        "historyDeleted": "历史记录已成功删除",
        "refreshSuccess": "历史记录已刷新",
        "masteragentRefreshSuccess": "总代理历史记录已刷新",
        "noChanges": "未进行任何更改",
        "allFieldsRequired": "所有字段必须正确填写",
        "invalidCategory": "无效类别",
        "insufficientCreditError": "信用额不足以处理充值",
        "invalidData": "无效数据",
        "historyNotFound": "未找到历史记录数据",
        "saveError": "保存数据到服务器失败",
        "updateError": "更新历史记录失败",
        "deleteError": "删除历史记录失败",
        "adminOnly": "只有超级管理员可以编辑信用额",
        "historyAdminOnly": "只有超级管理员可以编辑历史记录",
        "deleteAdminOnly": "只有超级管理员可以删除历史记录",
        
        // Confirmation Messages
        "confirmDelete": "您确定要删除此历史记录吗？",
        "confirmReset": "您确定要重置表单吗？",
        
        // User Roles
        "superAdmin": "超级管理员",
        "customerSupport": "客户服务支持",
        "localStorageMode": "本地存储模式"
    }
};

// ========== TRANSLATION FUNCTIONS ==========

// Fungsi untuk menerapkan terjemahan ke halaman topup credit
function applyTopupCreditTranslations(language) {
    const lang = topupCreditTranslations[language] || topupCreditTranslations['id'];
    
    if (!lang) return;

    console.log("Applying topup credit translations for:", language);

    // Terjemahkan elemen utama
    const elements = {
        'pageTitle': '.header h1',
        'searchPlaceholder': '#dashboardSearch',
        'regularTab': '.tab[data-tab="regular"]',
        'masteragentTab': '.tab[data-tab="masteragent"]',
        'regularFormTitle': '#regularTab .section-title',
        'masteragentFormTitle': '#masteragentTab .masteragent-section .section-title',
        'regularHistoryTitle': '#regularTab .history-section .section-title',
        'masteragentHistoryTitle': '#masteragentTab .history-section .section-title',
        'refreshButton': '#refreshHistory',
        'masteragentRefreshButton': '#refreshMasteragentHistory',
        'noHistory': '#noHistory h3, #noMasteragentHistory h3',
        'noHistoryMessage': '#noHistory p',
        'noMasteragentHistoryMessage': '#noMasteragentHistory p'
    };

    Object.keys(elements).forEach(key => {
        const element = document.querySelector(elements[key]);
        if (element && lang[key]) {
            if (key === 'searchPlaceholder') {
                element.placeholder = lang[key];
            } else if (key.includes('Button')) {
                // Handle buttons with icons
                const icon = element.querySelector('i');
                if (icon) {
                    element.innerHTML = icon.outerHTML + ' ' + lang[key];
                } else {
                    element.textContent = lang[key];
                }
            } else {
                // Handle elements with icons
                const iconMatch = element.innerHTML.match(/(<i[^>]*><\/i>)/);
                if (iconMatch) {
                    element.innerHTML = iconMatch[0] + ' ' + lang[key];
                } else {
                    element.textContent = lang[key];
                }
            }
        }
    });

    // Update form labels dan placeholders
    updateTopupCreditFormTranslations(language);
    
    // Update tabel headers
    updateTopupCreditTableTranslations(language);
    
    // Update modal dan tombol
    updateTopupCreditModalTranslations(language);
    
    // Update stat cards
    updateTopupCreditStatsTranslations(language);
    
    // Update user role display
    updateTopupCreditUserRoleTranslations(language);
}

// Update terjemahan form
function updateTopupCreditFormTranslations(language) {
    const lang = topupCreditTranslations[language] || topupCreditTranslations['id'];
    
    // Regular form labels
    const regularLabels = {
        'brandSelect': 'label[for="brandSelect"]',
        'currentCredit': 'label[for="currentCredit"]',
        'topupAmount': 'label[for="topupAmount"]',
        'newCredit': 'label[for="newCredit"]'
    };
    
    Object.keys(regularLabels).forEach(key => {
        const element = document.querySelector(regularLabels[key]);
        if (element && lang[key]) {
            element.textContent = lang[key];
        }
    });
    
    // Regular form placeholders
    const topupAmountInput = document.getElementById('topupAmount');
    if (topupAmountInput && lang.topupAmountPlaceholder) {
        topupAmountInput.placeholder = lang.topupAmountPlaceholder;
    }
    
    // Masteragent form labels
    const masteragentLabels = {
        'masteragentCategory': 'label[for="masteragentCategory"]',
        'masteragentCurrentCredit': 'label[for="masteragentCurrentCredit"]',
        'masteragentTopupAmount': 'label[for="masteragentCredit"]',
        'masteragentNewCredit': 'label[for="masteragentNewCredit"]'
    };
    
    Object.keys(masteragentLabels).forEach(key => {
        const element = document.querySelector(masteragentLabels[key]);
        if (element && lang[key]) {
            element.textContent = lang[key];
        }
    });
    
    // Masteragent form placeholders
    const masteragentTopupInput = document.getElementById('masteragentCredit');
    if (masteragentTopupInput && lang.masteragentTopupAmountPlaceholder) {
        masteragentTopupInput.placeholder = lang.masteragentTopupAmountPlaceholder;
    }
    
    // Form buttons
    const resetButtons = document.querySelectorAll('.form-actions .btn-outline');
    const submitButtons = document.querySelectorAll('.form-actions .btn-primary');
    
    resetButtons.forEach(btn => {
        if (lang.resetButton) {
            btn.textContent = lang.resetButton;
        }
    });
    
    submitButtons.forEach(btn => {
        if (lang.processTopup) {
            btn.textContent = lang.processTopup;
        }
    });
    
    // Dropdown options
    const brandSelect = document.getElementById('brandSelect');
    if (brandSelect && lang.selectBrand) {
        const firstOption = brandSelect.querySelector('option[value=""]');
        if (firstOption) {
            firstOption.textContent = lang.selectBrand;
        }
    }
    
    const categorySelect = document.getElementById('masteragentCategory');
    if (categorySelect && lang.selectCategory) {
        const firstOption = categorySelect.querySelector('option[value=""]');
        if (firstOption) {
            firstOption.textContent = lang.selectCategory;
        }
    }
}

// Update terjemahan tabel
function updateTopupCreditTableTranslations(language) {
    const lang = topupCreditTranslations[language] || topupCreditTranslations['id'];
    
    // Update regular history table headers
    const regularTableHeaders = document.querySelectorAll('.history-table:not(.masteragent-history-table) th');
    if (regularTableHeaders.length >= 7) {
        if (lang.date) regularTableHeaders[0].textContent = lang.date;
        if (lang.user) regularTableHeaders[1].textContent = lang.user;
        if (lang.brand) regularTableHeaders[2].textContent = lang.brand;
        if (lang.topupAmountCol) regularTableHeaders[3].textContent = lang.topupAmountCol;
        if (lang.creditBefore) regularTableHeaders[4].textContent = lang.creditBefore;
        if (lang.creditAfter) regularTableHeaders[5].textContent = lang.creditAfter;
        if (lang.actions) regularTableHeaders[6].textContent = lang.actions;
    }
    
    // Update masteragent history table headers
    const masteragentTableHeaders = document.querySelectorAll('.masteragent-history-table th');
    if (masteragentTableHeaders.length >= 7) {
        if (lang.date) masteragentTableHeaders[0].textContent = lang.date;
        if (lang.user) masteragentTableHeaders[1].textContent = lang.user;
        if (lang.category) masteragentTableHeaders[2].textContent = lang.category;
        if (lang.topupAmountCol) masteragentTableHeaders[3].textContent = lang.topupAmountCol;
        if (lang.creditBefore) masteragentTableHeaders[4].textContent = lang.creditBefore;
        if (lang.creditAfter) masteragentTableHeaders[5].textContent = lang.creditAfter;
        if (lang.actions) masteragentTableHeaders[6].textContent = lang.actions;
    }
    
    // Update action buttons in tables
    document.querySelectorAll('.edit-history-btn').forEach(btn => {
        if (btn && lang.edit) {
            const icon = btn.querySelector('i');
            if (icon) {
                btn.innerHTML = icon.outerHTML + ' ' + lang.edit;
            }
        }
    });
    
    document.querySelectorAll('.delete-history-btn').forEach(btn => {
        if (btn && lang.delete) {
            const icon = btn.querySelector('i');
            if (icon) {
                btn.innerHTML = icon.outerHTML + ' ' + lang.delete;
            }
        }
    });
}

// Update terjemahan modal
function updateTopupCreditModalTranslations(language) {
    const lang = topupCreditTranslations[language] || topupCreditTranslations['id'];
    
    // Edit credit modal
    const editCreditModalTitle = document.querySelector('#editCreditModal .modal-title');
    if (editCreditModalTitle && lang.editCredit) {
        const icon = editCreditModalTitle.querySelector('i');
        if (icon) {
            editCreditModalTitle.innerHTML = icon.outerHTML + ' ' + lang.editCredit;
        } else {
            editCreditModalTitle.textContent = lang.editCredit;
        }
    }
    
    // Edit history modal
    const editHistoryModalTitle = document.querySelector('#editHistoryModal .modal-title');
    if (editHistoryModalTitle && lang.editHistory) {
        const icon = editHistoryModalTitle.querySelector('i');
        if (icon) {
            editHistoryModalTitle.innerHTML = icon.outerHTML + ' ' + lang.editHistory;
        } else {
            editHistoryModalTitle.textContent = lang.editHistory;
        }
    }
    
    // Modal buttons
    const cancelButtons = document.querySelectorAll('.modal-footer .btn-outline');
    const saveButtons = document.querySelectorAll('.modal-footer .btn-primary');
    
    cancelButtons.forEach(btn => {
        if (lang.cancel) {
            btn.textContent = lang.cancel;
        }
    });
    
    saveButtons.forEach(btn => {
        if (btn.id === 'saveCreditChanges' && lang.saveCreditChanges) {
            btn.textContent = lang.saveCreditChanges;
        } else if (btn.id === 'saveHistoryChanges' && lang.saveHistoryChanges) {
            btn.textContent = lang.saveHistoryChanges;
        } else if (lang.saveChanges) {
            btn.textContent = lang.saveChanges;
        }
    });
    
    // Edit history form labels
    const editHistoryContainer = document.getElementById('editHistoryContainer');
    if (editHistoryContainer) {
        const labels = editHistoryContainer.querySelectorAll('label');
        labels.forEach(label => {
            const forAttr = label.getAttribute('for');
            if (forAttr) {
                if (forAttr.includes('date') && lang.date) {
                    label.textContent = lang.date;
                } else if (forAttr.includes('brand') && lang.brand) {
                    label.textContent = lang.brand;
                } else if (forAttr.includes('category') && lang.category) {
                    label.textContent = lang.category;
                } else if (forAttr.includes('amount') && lang.amount) {
                    label.textContent = lang.amount;
                } else if (forAttr.includes('before') && lang.before) {
                    label.textContent = lang.before;
                } else if (forAttr.includes('after') && lang.after) {
                    label.textContent = lang.after;
                }
            }
        });
        
        // Update input hints
        const hints = editHistoryContainer.querySelectorAll('.input-hint');
        hints.forEach(hint => {
            if (lang.inputHint) {
                hint.textContent = lang.inputHint;
            }
        });
    }
}

// Update terjemahan stat cards
function updateTopupCreditStatsTranslations(language) {
    const lang = topupCreditTranslations[language] || topupCreditTranslations['id'];
    
    const statCards = document.querySelectorAll('.credit-stat-card');
    statCards.forEach(card => {
        const title = card.querySelector('.stat-title');
        const description = card.querySelector('.stat-description');
        
        if (title && description) {
            const titleText = title.textContent.trim();
            
            if (titleText.includes('D-GAMING') && lang.dGamingCredit) {
                title.textContent = lang.dGamingCredit;
            } else if (titleText.includes('GACHA') && lang.gachaCredit) {
                title.textContent = lang.gachaCredit;
            } else if (titleText.includes('BREM') && lang.bremCredit) {
                title.textContent = lang.bremCredit;
            } else if (titleText.includes('CBWL') && lang.cbwlCredit) {
                title.textContent = lang.cbwlCredit;
            } else if (titleText.includes('89ENGINE') && lang.engine89Credit) {
                title.textContent = lang.engine89Credit;
            } else if (titleText.includes('LUXION') && lang.luxionCredit) {
                title.textContent = lang.luxionCredit;
            }
            
            if (description && lang.availableCredit) {
                description.textContent = lang.availableCredit;
            }
        }
    });
}

// Update terjemahan peran pengguna
function updateTopupCreditUserRoleTranslations(language) {
    const lang = topupCreditTranslations[language] || topupCreditTranslations['id'];
    
    const userRoleElement = document.querySelector('.user-info p');
    if (userRoleElement) {
        const currentText = userRoleElement.textContent;
        if (currentText.includes('Customer Service Support') && lang.customerSupport) {
            userRoleElement.textContent = lang.customerSupport;
        } else if (currentText.includes('Super Administrator') && lang.superAdmin) {
            userRoleElement.textContent = lang.superAdmin;
        } else if (currentText.includes('Local Storage Mode') && lang.localStorageMode) {
            userRoleElement.textContent = lang.localStorageMode;
        }
    }
}

// ========== NOTIFICATION TRANSLATIONS ==========

// Fungsi untuk update notifikasi
function updateTopupCreditNotificationMessages(language) {
    const lang = topupCreditTranslations[language] || topupCreditTranslations['id'];
    
    // Simpan referensi ke fungsi showToast asli
    const originalShowToast = window.showToast;
    
    // Override fungsi showToast untuk menerjemahkan pesan tertentu
    window.showToast = function(message, type = 'success') {
        let translatedMessage = message;
        
        // Terjemahkan pesan-pesan umum
        if (message.includes('Top up berhasil!') || message.includes('Top up successful!')) {
            // Extract amount and brand from message
            const amountMatch = message.match(/(\d+(?:\.\d+)?)\s*credit/);
            const brandMatch = message.match(/from\s+([^!]+)/) || message.match(/dari\s+([^!]+)/);
            
            if (amountMatch && brandMatch) {
                const amount = amountMatch[1];
                const brand = brandMatch[1].trim();
                translatedMessage = lang.topupSuccess
                    .replace('{amount}', formatNumber(parseInt(amount)))
                    .replace('{brand}', brand);
            }
        } else if (message.includes('Top up masteragent berhasil!') || message.includes('Masteragent top up successful!')) {
            const amountMatch = message.match(/(\d+(?:\.\d+)?)\s*credit/);
            const categoryMatch = message.match(/kategori\s+([^!]+)/) || message.match(/category\s+([^!]+)/);
            
            if (amountMatch && categoryMatch) {
                const amount = amountMatch[1];
                const category = categoryMatch[1].trim();
                translatedMessage = lang.masteragentTopupSuccess
                    .replace('{amount}', formatNumber(parseInt(amount)))
                    .replace('{category}', category);
            }
        } else if (message.includes('Nominal credit berhasil diperbarui') || message.includes('Credit amounts updated successfully')) {
            translatedMessage = lang.creditUpdated;
        } else if (message.includes('Riwayat berhasil diperbarui') || message.includes('History updated successfully')) {
            translatedMessage = lang.historyUpdated;
        } else if (message.includes('Riwayat berhasil dihapus') || message.includes('History deleted successfully')) {
            translatedMessage = lang.historyDeleted;
        } else if (message.includes('Riwayat diperbarui') || message.includes('History refreshed')) {
            translatedMessage = lang.refreshSuccess;
        } else if (message.includes('Riwayat masteragent diperbarui') || message.includes('Masteragent history refreshed')) {
            translatedMessage = lang.masteragentRefreshSuccess;
        } else if (message.includes('Tidak ada perubahan') || message.includes('No changes made')) {
            translatedMessage = lang.noChanges;
        } else if (message.includes('Semua field harus diisi') || message.includes('All fields must be filled')) {
            translatedMessage = lang.allFieldsRequired;
        } else if (message.includes('Kategori tidak valid') || message.includes('Invalid category')) {
            translatedMessage = lang.invalidCategory;
        } else if (message.includes('Credit tidak mencukupi') || message.includes('Insufficient credit')) {
            translatedMessage = lang.insufficientCreditError;
        } else if (message.includes('Data tidak valid') || message.includes('Invalid data')) {
            translatedMessage = lang.invalidData;
        } else if (message.includes('Data riwayat tidak ditemukan') || message.includes('History data not found')) {
            translatedMessage = lang.historyNotFound;
        } else if (message.includes('Gagal menyimpan data') || message.includes('Failed to save data')) {
            translatedMessage = lang.saveError;
        } else if (message.includes('Gagal memperbarui riwayat') || message.includes('Failed to update history')) {
            translatedMessage = lang.updateError;
        } else if (message.includes('Gagal menghapus riwayat') || message.includes('Failed to delete history')) {
            translatedMessage = lang.deleteError;
        } else if (message.includes('Hanya Super Admin') || message.includes('Only Super Admin')) {
            if (message.includes('credit') || message.includes('edit credit')) {
                translatedMessage = lang.adminOnly;
            } else if (message.includes('riwayat') || message.includes('history')) {
                translatedMessage = lang.historyAdminOnly;
            } else if (message.includes('hapus') || message.includes('delete')) {
                translatedMessage = lang.deleteAdminOnly;
            }
        }
        
        // Panggil fungsi asli dengan pesan yang sudah diterjemahkan
        originalShowToast(translatedMessage, type);
    };
}

// ========== CONFIRMATION MESSAGES TRANSLATION ==========

// Fungsi untuk update pesan konfirmasi
function updateTopupCreditConfirmationMessages(language) {
    const lang = topupCreditTranslations[language] || topupCreditTranslations['id'];
    
    // Override confirm messages
    const originalConfirm = window.confirm;
    
    window.confirm = function(message) {
        let translatedMessage = message;
        
        if (message.includes('Apakah Anda yakin ingin menghapus riwayat ini') || 
            message.includes('Are you sure you want to delete this history')) {
            translatedMessage = lang.confirmDelete;
        } else if (message.includes('Apakah Anda yakin ingin mereset form') || 
                   message.includes('Are you sure you want to reset the form')) {
            translatedMessage = lang.confirmReset;
        }
        
        return originalConfirm(translatedMessage);
    };
}

// ========== PAGINATION TRANSLATION ==========

// Fungsi untuk update pagination
function updateTopupCreditPaginationTranslations(language) {
    const lang = topupCreditTranslations[language] || topupCreditTranslations['id'];
    
    // Override fungsi updatePaginationUI
    const originalUpdatePaginationUI = window.updatePaginationUI;
    
    window.updatePaginationUI = function() {
        // Panggil fungsi asli terlebih dahulu
        if (typeof originalUpdatePaginationUI === 'function') {
            originalUpdatePaginationUI();
        }
        
        // Update teks pagination
        const pageInfo = document.getElementById('pageInfo');
        const prevButton = document.getElementById('prevPage');
        const nextButton = document.getElementById('nextPage');
        
        if (pageInfo && lang.pageInfo) {
            const currentText = pageInfo.textContent;
            const matches = currentText.match(/(\d+).*?(\d+).*?(\d+)/);
            
            if (matches) {
                const currentPage = matches[1];
                const totalPages = matches[2];
                const totalItems = matches[3];
                
                const translatedText = lang.pageInfo
                    .replace('{current}', currentPage)
                    .replace('{total}', totalPages)
                    .replace('{count}', totalItems);
                
                pageInfo.textContent = translatedText;
            } else if (currentText.includes('Tidak ada data') || currentText.includes('No data')) {
                pageInfo.textContent = lang.noData;
            }
        }
        
        if (prevButton && lang.previous) {
            const icon = prevButton.querySelector('i');
            if (icon) {
                prevButton.innerHTML = icon.outerHTML + ' ' + lang.previous;
            }
        }
        
        if (nextButton && lang.next) {
            const icon = nextButton.querySelector('i');
            if (icon) {
                nextButton.innerHTML = lang.next + ' ' + icon.outerHTML;
            }
        }
    };
}

// ========== FORM VALIDATION MESSAGES ==========

// Fungsi untuk update pesan validasi form
function updateTopupCreditFormValidationMessages(language) {
    const lang = topupCreditTranslations[language] || topupCreditTranslations['id'];
    
    // Update pesan error untuk input new credit
    const newCreditInput = document.getElementById('newCredit');
    if (newCreditInput) {
        newCreditInput.dataset.insufficientMessage = lang.insufficientCredit;
    }
}

// ========== LANGUAGE INITIALIZATION ==========

// Fungsi inisialisasi bahasa untuk topup credit
function initializeTopupCreditLanguage() {
    const savedLanguage = localStorage.getItem('language') || 'id';
    console.log("Initializing topup credit with language:", savedLanguage);
    
    // Terapkan terjemahan
    applyTopupCreditTranslations(savedLanguage);
    updateTopupCreditNotificationMessages(savedLanguage);
    updateTopupCreditConfirmationMessages(savedLanguage);
    updateTopupCreditPaginationTranslations(savedLanguage);
    updateTopupCreditFormValidationMessages(savedLanguage);
    
    // Setup listener untuk perubahan bahasa
    window.addEventListener('languageChanged', function(event) {
        console.log("Language changed in topup credit to:", event.detail.language);
        applyTopupCreditTranslations(event.detail.language);
        updateTopupCreditNotificationMessages(event.detail.language);
        updateTopupCreditConfirmationMessages(event.detail.language);
        updateTopupCreditPaginationTranslations(event.detail.language);
        updateTopupCreditFormValidationMessages(event.detail.language);
        
        // Refresh UI components
        if (typeof updateCreditStats === 'function') {
            updateCreditStats();
        }
        if (typeof updateHistoryTable === 'function') {
            updateHistoryTable();
        }
        if (typeof updateMasteragentHistoryTable === 'function') {
            updateMasteragentHistoryTable();
        }
    });
}

// ========== INTEGRATION WITH EXISTING CODE ==========

// Fungsi untuk mengintegrasikan dengan kode yang sudah ada
function integrateTopupCreditWithLanguageSupport() {
    // Inisialisasi bahasa
    initializeTopupCreditLanguage();
    
    // Pastikan fungsi formatNumber tersedia untuk terjemahan
    if (typeof formatNumber === 'undefined') {
        window.formatNumber = function(num) {
            if (isNaN(num) || num === null || num === undefined) {
                return '0';
            }
            return new Intl.NumberFormat('id-ID').format(num);
        };
    }
}

// Panggil inisialisasi saat DOM ready
document.addEventListener('DOMContentLoaded', function() {
    // Tunggu sebentar untuk memastikan semua element sudah terload
    setTimeout(() => {
        integrateTopupCreditWithLanguageSupport();
    }, 100);
});

// Juga panggil saat halaman sepenuhnya loaded
window.addEventListener('load', function() {
    integrateTopupCreditWithLanguageSupport();
});
</script>
</body>
</html>
