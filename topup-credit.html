<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top Up Credit - Dashboard Admin CSS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="global.css">
        <link rel="stylesheet" href="stylemobile.css">
    <style>
        /* ========== VARIABEL CSS YANG DIPERLUKAN ========== */
        :root {
            --primary-gradient: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            --success-gradient: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
            --warning-gradient: linear-gradient(135deg, #f72585 0%, #7209b7 100%);
            --info-gradient: linear-gradient(135deg, #4895ef 0%, #3f37c9 100%);
        }

        /* ========== PERBAIKAN UTAMA UNTUK LAYOUT ========== */
        .main-content {
            padding: var(--space-lg);
            background-color: var(--bg-secondary);
            min-height: 100vh;
        }

        .header {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        /* ========== PERBAIKAN STATISTIC CARDS ========== */
        .credit-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .credit-stat-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .credit-stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .credit-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }

        .stat-title {
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--text-secondary);
            margin: 0;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        /* Perbaikan class untuk stat-icon agar sesuai dengan 6 kategori */
.stat-icon.d-gaming {
    background-color: rgba(59, 130, 246, 0.1);
    color: var(--info);
}

.stat-icon.gacha {
    background-color: rgba(139, 92, 246, 0.1);
    color: var(--purple);
}

.stat-icon.brem {
    background-color: rgba(156, 163, 175, 0.1);
    color: var(--text-secondary);
}

.stat-icon.cbwl {
    background-color: rgba(74, 144, 226, 0.1);
    color: var(--info);
}

.stat-icon.engine-89 {
    background-color: rgba(245, 158, 11, 0.1);
    color: var(--warning);
}

.stat-icon.luxion {
    background-color: rgba(239, 68, 68, 0.1);
    color: var(--danger);
}

        .stat-icon.custom {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: var(--font-bold);
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
            line-height: 1;
        }

        .stat-description {
            font-size: var(--text-xs);
            color: var(--text-secondary);
        }

        /* ========== TOP UP FORM ========== */
        .topup-section {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-bottom: var(--space-xl);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border-color);
        }

        .section-title {
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin: 0;
        }

        .topup-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .form-group label {
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--text-secondary);
        }

        .form-select, .form-input {
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--input-bg);
            color: var(--text-primary);
            font-size: var(--text-sm);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
            height: 42px;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-actions {
            grid-column: span 2;
            display: flex;
            justify-content: flex-end;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }

        /* ========== MASTERAGENT FORM ========== */
        .masteragent-section {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-bottom: var(--space-xl);
        }

        .masteragent-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
        }

        /* ========== HISTORY SECTION ========== */
        .history-section {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-bottom: var(--space-xl);
        }

        .history-table-container {
            overflow-x: auto;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }

        .history-table {
            margin: 0;
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 600px;
        }

        .history-table th {
            padding: var(--space-md) var(--space-lg);
            background: var(--table-header-bg);
            font-weight: var(--font-semibold);
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .history-table td {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: var(--text-sm);
            vertical-align: middle;
            line-height: 1.5;
        }

        .history-table tr:last-child td {
            border-bottom: none;
        }

        .history-table tr:hover {
            background-color: var(--hover-color);
            transition: background-color var(--transition-fast);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-xl) var(--space-lg);
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            border: 2px dashed var(--border-color);
            margin: var(--space-lg) 0;
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--text-tertiary);
            margin-bottom: var(--space-md);
        }

        .empty-state h3 {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
        }

        .empty-state p {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-lg);
        }

        /* ========== RESPONSIVE ADJUSTMENTS ========== */
        @media (max-width: 768px) {
            .topup-form,
            .masteragent-form {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                grid-column: span 1;
            }
            
            .credit-stats {
                grid-template-columns: 1fr;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .credit-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1025px) {
            .credit-stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* ========== ANIMATIONS ========== */
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

       /* Toast Notification Styles */
.toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: var(--radius-md, 8px);
    color: white;
    z-index: var(--z-modal, 9999);
    max-width: 320px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    opacity: 0;
    transform: translateY(-20px) scale(0.95);
    pointer-events: none;
    animation: toast-in 0.5s ease forwards;
    font-family: sans-serif;
    font-size: 0.95rem;
    line-height: 1.4;
    transition: all 0.3s ease;
}

/* Slide, Fade & Scale In */
@keyframes toast-in {
    0% {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Slide, Fade & Scale Out */
@keyframes toast-out {
    0% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
    100% {
        opacity: 0;
        transform: translateY(-15px) scale(0.95);
    }
}

.toast-notification.hide {
    animation: toast-out 0.4s ease forwards;
}

/* Type colors with fallbacks */
.toast-notification.success {
    background-color: var(--success, #28a745);
}

.toast-notification.error {
    background-color: var(--danger, #dc3545);
}

.toast-notification.info {
    background-color: var(--info, #007bff);
}


        .toast-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            transform: translateY(20px);
            transition: transform var(--transition-normal);
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: background-color var(--transition-fast);
        }

        .modal-close:hover {
            background-color: var(--hover-color);
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--space-lg);
        }

        .modal-footer {
            padding: var(--space-lg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-sm);
        }

        /* Tab styles */
        .tabs {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: var(--space-sm) var(--space-lg);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all var(--transition-fast);
            font-weight: var(--font-medium);
            color: var(--text-secondary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        .error-message {
    color: var(--danger);
    display: none;
    font-size: var(--text-xs);
    margin-top: 5px;
}

.modal-footer {
    display: none;
}
/* Gaya untuk search bar */
.search-bar {
    position: relative;
    display: flex;
    align-items: center;
}

.search-bar input {
    padding-right: 40px; /* Ruang untuk tombol clear */
}

.clear-search {
    position: absolute;
    right: 10px;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    transition: background-color 0.2s;
}

.clear-search:hover {
    background-color: var(--hover-color);
    color: var(--text-primary);
}

/* Highlight untuk hasil pencarian */
.highlight {
    background-color: rgba(79, 70, 229, 0.1);
    font-weight: var(--font-semibold);
}
/* Pagination Styles */
.pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--space-md);
    margin-top: var(--space-lg);
    padding: var(--space-md);
    background-color: var(--card-bg);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
}

.pagination-controls span {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    font-weight: var(--font-medium);
}
    </style>
</head>
<body>
    <!-- Container untuk sidebar yang akan dimuat oleh sidebar-loader.js -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <h1><i class="fas fa-coins"></i> Top Up Credit</h1>
            <div class="header-actions">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Cari..." id="dashboardSearch">
                </div>
                
                <div class="user-profile">
                    <img class="profile-img" src="https://iili.io/Fpiva7S.png" alt="Profile">
                    <div class="user-info">
                        <h4>Nama Masing Masing</h4>
                        <p>Customer Service Support</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Credit Statistics Cards -->
        <div class="credit-stats" id="creditStatsContainer">
            <!-- Cards will be generated dynamically -->
        </div>

        <!-- Tabs for Regular Top Up and Masteragent -->
<div class="tabs">
    <div class="tab active" data-tab="regular">Form Top Up Credit Agent</div>
    <div class="tab" data-tab="masteragent">Form Top Up Credit Masteragent</div>
</div>

<!-- Regular Top Up Form Section -->
<div id="regularTab" class="tab-content active">
    <div class="topup-section fade-in" style="animation-delay: 0.2s;">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-money-bill-wave"></i> Form Top Up Credit Agent</h2>
        </div>
        
        <form id="topupForm" class="topup-form">
            <div class="form-group">
                <label for="brandSelect">Pilih Brand</label>
                <select id="brandSelect" class="form-select" required>
                    <option value="">Select Brand</option>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="currentCredit">Credit Saat Ini</label>
                <input type="text" id="currentCredit" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label for="topupAmount">Jumlah Top Up</label>
                <input type="number" id="topupAmount" class="form-input" placeholder="Masukkan jumlah top up" min="1" required>
            </div>
            
            <div class="form-group">
                <label for="newCredit">Credit Setelah Top Up</label>
                <input type="text" id="newCredit" class="form-input" readonly>
            </div>
            
            <div class="form-actions">
                <button type="reset" class="btn btn-outline">Reset</button>
                <button type="submit" class="btn btn-primary">Proses Top Up</button>
            </div>
        </form>
    </div>

    <!-- Regular History Section -->
    <div class="history-section fade-in" style="animation-delay: 0.3s;">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-history"></i> Riwayat Top Up</h2>
            <div class="section-actions">
                <button class="btn btn-outline" id="refreshHistory">
                    <i class="fas fa-sync-alt"></i> Muat Ulang
                </button>
            </div>
        </div>
        
        <div class="history-table-container">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Brand</th>
                        <th>Jumlah Top Up</th>
                        <th>Credit Sebelum</th>
                        <th>Credit Sesudah</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <!-- Data history akan dimuat di sini -->
                </tbody>
            </table>
        </div>
        <div id="noHistory" class="empty-state" style="display: none;">
            <i class="fas fa-history"></i>
            <h3>Tidak Ada Riwayat</h3>
            <p>Belum ada riwayat top up untuk ditampilkan.</p>
        </div>
    </div>
</div>

<!-- Masteragent Top Up Form Section -->
<div id="masteragentTab" class="tab-content">
    <div class="masteragent-section fade-in" style="animation-delay: 0.1s;">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-crown"></i> Form Top Up Credit Masteragent</h2>
        </div>
        
        <form id="masteragentForm" class="masteragent-form">
            <div class="form-group">
                <label for="masteragentCategory">Kategori</label>
                <select id="masteragentCategory" class="form-control" required>
                    <option value="">Select Category</option>
                    <option value="D-GAMING">D-GAMING</option>
                    <option value="GACHA">GACHA</option>
                    <option value="BREM">BREM</option>
                    <option value="CBWL">CBWL</option>
                    <option value="89ENGINE">89ENGINE</option>
                    <option value="LUXION">LUXION</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="masteragentCurrentCredit">Credit Saat Ini</label>
                <input type="text" id="masteragentCurrentCredit" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label for="masteragentCredit">Jumlah Top Up</label>
                <input type="number" id="masteragentCredit" class="form-input" placeholder="Masukkan jumlah top up" min="1" required>
            </div>
            
            <div class="form-group">
                <label for="masteragentNewCredit">Credit Setelah Top Up</label>
                <input type="text" id="masteragentNewCredit" class="form-input" readonly>
            </div>
            
            <div class="form-actions">
                <button type="reset" class="btn btn-outline">Reset</button>
                <button type="submit" class="btn btn-primary">Proses Top Up</button>
            </div>
        </form>
    </div>

    <!-- Masteragent History Section -->
    <div class="history-section fade-in" style="animation-delay: 0.3s;">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-history"></i> Riwayat Top Up Masteragent</h2>
            <div class="section-actions">
                <button class="btn btn-outline" id="refreshMasteragentHistory">
                    <i class="fas fa-sync-alt"></i> Muat Ulang
                </button>
            </div>
        </div>
        
        <div class="history-table-container">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Kategori</th>
                        <th>Jumlah Top Up</th>
                        <th>Credit Sebelum</th>
                        <th>Credit Sesudah</th>
                    </tr>
                </thead>
                <tbody id="masteragentHistoryTableBody">
                    <!-- Data history masteragent akan dimuat di sini -->
                </tbody>
            </table>
        </div>
        <div id="noMasteragentHistory" class="empty-state" style="display: none;">
            <i class="fas fa-history"></i>
            <h3>Tidak Ada Riwayat</h3>
            <p>Belum ada riwayat top up masteragent untuk ditampilkan.</p>
        </div>
    </div>
</div>
<!-- Untuk regular history section -->
<div class="pagination-controls" id="regularPagination" style="display: none;">
    <button class="btn btn-outline" id="prevRegularPage">
        <i class="fas fa-chevron-left"></i> Previous
    </button>
    <span id="regularPageInfo">Page 1 of 1</span>
    <button class="btn btn-outline" id="nextRegularPage">
        Next <i class="fas fa-chevron-right"></i>
    </button>
</div>

<!-- Untuk masteragent history section -->
<div class="pagination-controls" id="masteragentPagination" style="display: none;">
    <button class="btn btn-outline" id="prevMasteragentPage">
        <i class="fas fa-chevron-left"></i> Previous
    </button>
    <span id="masteragentPageInfo">Page 1 of 1</span>
    <button class="btn btn-outline" id="nextMasteragentPage">
        Next <i class="fas fa-chevron-right"></i>
    </button>
</div>

    <!-- Toast Notification -->
    <div id="toastNotification" class="toast-notification" style="display: none;">
        <div class="toast-content">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage"></span>
        </div>
        <div class="toast-notification success">
    âœ… Data berhasil disimpan!
</div>
    </div>

    <script src="sidebar-loader.js"></script>
    <script src="user-profile.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
    // Konfigurasi Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDUZka4FZyLi_cv6X_5D4zeRsfkpqOlBpY",
        authDomain: "dashboard-css.firebaseapp.com",
        databaseURL: "https://dashboard-css-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "dashboard-css",
        storageBucket: "dashboard-css.appspot.com",
        messagingSenderId: "771131792881",
        appId: "1:771131792881:web:ad634424225bd7de847850",
        measurementId: "G-3CYBC5B101"
    };

    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Data default untuk brand
    const defaultBrands = {
        "D-GAMING": {
            credit: 2167067148,
            brands: [
                "CINTAWIN88 (D-GAMING)",
                "CERIASLOT99 (D-GAMING)",
                "RAJASCATTER88 (D-GAMING)",
                "MAHJONGJP88 (D-GAMING)",
                "NAGAHOKI88 (D-GAMING)",
                "SPACEMAN88 (D-GAMING)",
                "RAJAPANEN (D-GAMING)",
                "BROTO88 (D-GAMING)"
            ]
        },
        "GACHA": {
            credit: 5004281403,
            brands: [
                "MEDUSA88 (GACHA)",
                "ATHENA168 (GACHA)",
                "ARES GACOR (GACHA)",
                "RAJA MAHJONG (GACHA)",
                "OLYMPUS1000 (GACHA)",
                "GACHA99 (GACHA)"
            ]
        },
        "BREM": {
            credit: 155000000,
            brands: [
                "UJANGBET (BREM)",
                "EPISODEBET (BREM)"
            ]
        },
        "CBWL": {
            credit: 155000000,
            brands: [
                "CBWL (CBWL)",
            ]
        },
        "89ENGINE": {
            credit: 500000000,
            brands: [
                "FOKUSBET88 (89ENGINE)",
                "RAJAKING88 (89ENGINE)",
                "RAJANAGA99 (89ENGINE)"
            ]
        },
        "LUXION": {
            credit: 100000000,
            brands: [
                "JOIN999 (LUXION)"
            ]
        }
    };

    // Deklarasi variabel global
    let creditData = {};
    let topupHistory = [];
    let masteragentHistory = [];
    let unsubscribeCreditData = null;
    let unsubscribeTopupHistory = null;
    let unsubscribeMasteragentHistory = null;

    // Fungsi untuk memuat data dari Firestore
    function setupFirestoreListeners() {
        console.log("Setting up Firestore listeners...");
        
        // Setup listener untuk creditData
        if (unsubscribeCreditData) {
            unsubscribeCreditData();
        }
        
        unsubscribeCreditData = db.collection('creditData').doc('brands')
            .onSnapshot((doc) => {
                if (doc.exists) {
                    creditData = doc.data();
                    console.log("Credit data loaded from Firestore:", creditData);
                    updateCreditStats();
                    updateBrandDropdown();
                } else {
                    // Jika dokumen tidak ada, buat dengan data default
                    console.log("No credit data found, creating with defaults");
                    creditData = defaultBrands;
                    db.collection('creditData').doc('brands').set(defaultBrands)
                        .then(() => {
                            console.log("Default credit data saved to Firestore");
                            updateCreditStats();
                            updateBrandDropdown();
                        })
                        .catch((error) => {
                            console.error("Error saving default credit data:", error);
                            showToast("Error initializing credit data", "error");
                        });
                }
            }, (error) => {
                console.error("Error loading credit data:", error);
                showToast("Error loading credit data", "error");
                
                // Fallback ke localStorage
                const localData = localStorage.getItem('creditData');
                if (localData) {
                    creditData = JSON.parse(localData);
                    updateCreditStats();
                    updateBrandDropdown();
                } else {
                    creditData = defaultBrands;
                    updateCreditStats();
                    updateBrandDropdown();
                }
            });

        // Setup listener untuk topupHistory
        if (unsubscribeTopupHistory) {
            unsubscribeTopupHistory();
        }
        
        unsubscribeTopupHistory = db.collection('topupHistory')
            .orderBy('timestamp', 'desc')
            .onSnapshot((snapshot) => {
                topupHistory = [];
                snapshot.forEach((doc) => {
                    const historyItem = doc.data();
                    historyItem.id = doc.id;
                    topupHistory.push(historyItem);
                });
                console.log("Topup history loaded:", topupHistory.length, "items");
                updateHistoryTable();
            }, (error) => {
                console.error("Error loading topup history:", error);
                showToast("Error loading topup history", "error");
                
                // Fallback ke localStorage
                const localHistory = localStorage.getItem('topupHistory');
                if (localHistory) {
                    topupHistory = JSON.parse(localHistory);
                    updateHistoryTable();
                }
            });

        // Setup listener untuk masteragentHistory
        if (unsubscribeMasteragentHistory) {
            unsubscribeMasteragentHistory();
        }
        
        unsubscribeMasteragentHistory = db.collection('masteragentHistory')
            .orderBy('timestamp', 'desc')
            .onSnapshot((snapshot) => {
                masteragentHistory = [];
                snapshot.forEach((doc) => {
                    const historyItem = doc.data();
                    historyItem.id = doc.id;
                    masteragentHistory.push(historyItem);
                });
                console.log("Masteragent history loaded:", masteragentHistory.length, "items");
                updateMasteragentHistoryTable();
            }, (error) => {
                console.error("Error loading masteragent history:", error);
                showToast("Error loading masteragent history", "error");
                
                // Fallback ke localStorage
                const localHistory = localStorage.getItem('masteragentHistory');
                if (localHistory) {
                    masteragentHistory = JSON.parse(localHistory);
                    updateMasteragentHistoryTable();
                }
            });
    }

    // Format angka dengan pemisah ribuan
    function formatNumber(num) {
        return new Intl.NumberFormat('id-ID').format(num);
    }

    // Parse angka dari format dengan pemisah
    function parseFormattedNumber(formattedNum) {
        return parseInt(formattedNum.replace(/\./g, ''), 10);
    }

    // Tampilkan notifikasi toast
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toastNotification');
        const toastMessage = document.getElementById('toastMessage');
        
        if (!toast || !toastMessage) {
            console.log("Toast elements not found");
            return;
        }
        
        toast.className = `toast-notification ${type}`;
        toastMessage.textContent = message;
        toast.style.display = 'block';
        
        setTimeout(() => {
            toast.classList.add('hide');
            setTimeout(() => {
                toast.style.display = 'none';
                toast.classList.remove('hide');
            }, 400);
        }, 3000);
    }

    // Update tampilan credit stats cards
    function updateCreditStats() {
        const container = document.getElementById('creditStatsContainer');
        if (!container) return;
        
        let html = '';
        
        // Add all category cards (6 brand)
        const categories = Object.keys(creditData);
        
        categories.forEach(category => {
            if (creditData[category]) {
                // Tentukan class icon berdasarkan kategori
                let iconClass = category.toLowerCase();
                if (iconClass === '89engine') iconClass = 'engine-89';
                
                html += `
                    <div class="credit-stat-card fade-in">
                        <div class="stat-header">
                            <h3 class="stat-title">${category} Credit</h3>
                            <div class="stat-icon ${iconClass}">
                                <i class="fas fa-coins"></i>
                            </div>
                        </div>
                        <div class="stat-value">${formatNumber(creditData[category].credit)}</div>
                        <div class="stat-description">Available Credit</div>
                    </div>
                `;
            }
        });
        
        container.innerHTML = html;
    }

    // Update dropdown pilihan brand
    function updateBrandDropdown() {
        const brandSelect = document.getElementById('brandSelect');
        if (!brandSelect) return;
        
        let html = '<option value="">Select Brand</option>';
        
        // Add all brands from the 6 categories
        for (const [category, data] of Object.entries(creditData)) {
            data.brands.forEach(brand => {
                html += `<option value="${brand}" data-category="${category}">${brand}</option>`;
            });
        }
        
        brandSelect.innerHTML = html;
    }

    // Update nilai credit saat kategori masteragent dipilih
    document.getElementById('masteragentCategory').addEventListener('change', function() {
        const category = this.value;
        const currentCreditInput = document.getElementById('masteragentCurrentCredit');
        const topupAmountInput = document.getElementById('masteragentCredit');
        const newCreditInput = document.getElementById('masteragentNewCredit');
        
        if (category && creditData[category]) {
            currentCreditInput.value = formatNumber(creditData[category].credit);
            topupAmountInput.value = '';
            newCreditInput.value = formatNumber(creditData[category].credit);
        } else {
            currentCreditInput.value = '';
            topupAmountInput.value = '';
            newCreditInput.value = '';
        }
    });

    // Hitung credit baru saat jumlah top up masteragent diinput
    document.getElementById('masteragentCredit').addEventListener('input', function() {
        const categorySelect = document.getElementById('masteragentCategory');
        const currentCreditInput = document.getElementById('masteragentCurrentCredit');
        const newCreditInput = document.getElementById('masteragentNewCredit');
        
        if (categorySelect.value && currentCreditInput.value) {
            const currentCredit = parseFormattedNumber(currentCreditInput.value);
            const topupAmount = parseInt(this.value) || 0;
            
            const newCredit = currentCredit + topupAmount;
            newCreditInput.value = formatNumber(newCredit);
            newCreditInput.style.color = "var(--text-primary)";
        }
    });

    // Update nilai credit saat brand dipilih
    document.getElementById('brandSelect').addEventListener('change', function() {
        const brand = this.value;
        const category = this.options[this.selectedIndex]?.dataset.category;
        const currentCreditInput = document.getElementById('currentCredit');
        const topupAmountInput = document.getElementById('topupAmount');
        const newCreditInput = document.getElementById('newCredit');
        
        if (brand && category && creditData[category]) {
            currentCreditInput.value = formatNumber(creditData[category].credit);
            topupAmountInput.value = '';
            newCreditInput.value = formatNumber(creditData[category].credit);
            newCreditInput.style.color = "var(--text-primary)";
        } else {
            currentCreditInput.value = '';
            topupAmountInput.value = '';
            newCreditInput.value = '';
        }
    });

    // Hitung credit baru saat jumlah top up diinput
    document.getElementById('topupAmount').addEventListener('input', function() {
        const brandSelect = document.getElementById('brandSelect');
        const category = brandSelect.options[brandSelect.selectedIndex]?.dataset.category;
        const currentCreditInput = document.getElementById('currentCredit');
        const newCreditInput = document.getElementById('newCredit');
        
        if (brandSelect.value && currentCreditInput.value && category) {
            const currentCredit = parseFormattedNumber(currentCreditInput.value);
            const topupAmount = parseInt(this.value) || 0;
            
            if (topupAmount > currentCredit) {
                newCreditInput.value = "Credit tidak mencukupi!";
                newCreditInput.style.color = "var(--danger)";
            } else {
                const newCredit = currentCredit - topupAmount;
                newCreditInput.value = formatNumber(newCredit);
                newCreditInput.style.color = "var(--text-primary)";
            }
        }
    });

    // Update history table
    function updateHistoryTable() {
        const historyTableBody = document.getElementById('historyTableBody');
        const noHistory = document.getElementById('noHistory');
        
        if (topupHistory.length === 0) {
            if (noHistory) noHistory.style.display = 'block';
            if (historyTableBody) historyTableBody.innerHTML = '';
            return;
        }
        
        if (noHistory) noHistory.style.display = 'none';
        
        // Render history table
        if (historyTableBody) {
            historyTableBody.innerHTML = topupHistory.map(history => `
                <tr>
                    <td>${history.date || 'N/A'}</td>
                    <td>${history.brand || 'N/A'}</td>
                    <td>${formatNumber(history.amount)}</td>
                    <td>${formatNumber(history.before)}</td>
                    <td>${formatNumber(history.after)}</td>
                </tr>
            `).join('');
        }
    }

    // Update masteragent history table
    function updateMasteragentHistoryTable() {
        const historyTableBody = document.getElementById('masteragentHistoryTableBody');
        const noHistory = document.getElementById('noMasteragentHistory');
        
        if (masteragentHistory.length === 0) {
            if (noHistory) noHistory.style.display = 'block';
            if (historyTableBody) historyTableBody.innerHTML = '';
            return;
        }
        
        if (noHistory) noHistory.style.display = 'none';
        
        // Render history table
        if (historyTableBody) {
            historyTableBody.innerHTML = masteragentHistory.map(history => `
                <tr>
                    <td>${history.date || 'N/A'}</td>
                    <td>${history.category || 'N/A'}</td>
                    <td>${formatNumber(history.amount)}</td>
                    <td>${formatNumber(history.before)}</td>
                    <td>${formatNumber(history.after)}</td>
                </tr>
            `).join('');
        }
    }

    // Proses form masteragent top up
    document.getElementById('masteragentForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const category = document.getElementById('masteragentCategory').value;
        const credit = parseInt(document.getElementById('masteragentCredit').value);
        
        if (!category || isNaN(credit) || credit <= 0) {
            showToast('Semua field harus diisi dengan benar', 'error');
            return;
        }
        
        // Tambahkan credit ke kategori yang dipilih
        if (creditData[category]) {
            const currentCredit = creditData[category].credit;
            creditData[category].credit += credit;
            
            try {
                // Simpan ke Firestore
                await db.collection('creditData').doc('brands').set(creditData);
                
                // Tambahkan ke history masteragent
                const historyEntry = {
                    date: new Date().toLocaleString('id-ID'),
                    category: category,
                    amount: credit,
                    before: currentCredit,
                    after: currentCredit + credit,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Simpan ke Firestore
                await db.collection('masteragentHistory').add(historyEntry);
                
                // Update UI
                updateCreditStats();
                
                // Reset form
                this.reset();
                document.getElementById('masteragentCurrentCredit').value = '';
                document.getElementById('masteragentNewCredit').value = '';
                
                showToast(`Top up masteragent berhasil! ${formatNumber(credit)} credit ditambahkan ke kategori ${category}`);
            } catch (error) {
                console.error("Error saving masteragent topup:", error);
                showToast("Gagal menyimpan data ke server", "error");
                
                // Simpan ke localStorage sebagai fallback
                localStorage.setItem('creditData', JSON.stringify(creditData));
                
                // Tambahkan ke history lokal
                masteragentHistory.push({
                    date: new Date().toLocaleString('id-ID'),
                    category: category,
                    amount: credit,
                    before: currentCredit,
                    after: currentCredit + credit
                });
                localStorage.setItem('masteragentHistory', JSON.stringify(masteragentHistory));
                
                updateCreditStats();
                updateMasteragentHistoryTable();
                
                showToast(`Top up masteragent berhasil (offline mode)! ${formatNumber(credit)} credit ditambahkan ke kategori ${category}`);
            }
        } else {
            showToast('Kategori tidak valid', 'error');
        }
    });

    // Proses form top up
    document.getElementById('topupForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const brandSelect = document.getElementById('brandSelect');
        const brand = brandSelect.value;
        const category = brandSelect.options[brandSelect.selectedIndex]?.dataset.category;
        const amount = parseInt(document.getElementById('topupAmount').value);
        
        if (!brand || !category || isNaN(amount) || amount <= 0) {
            showToast('Semua field harus diisi dengan benar', 'error');
            return;
        }
        
        // Kurangi credit dari kategori yang dipilih
        if (creditData[category].credit >= amount) {
            const currentCredit = creditData[category].credit;
            creditData[category].credit -= amount;
            
            try {
                // Simpan ke Firestore
                await db.collection('creditData').doc('brands').set(creditData);
                
                // Tambahkan ke history
                const historyEntry = {
                    date: new Date().toLocaleString('id-ID'),
                    brand: brand,
                    amount: amount,
                    before: currentCredit,
                    after: currentCredit - amount,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Simpan ke Firestore
                await db.collection('topupHistory').add(historyEntry);
                
                // Update UI
                updateCreditStats();
                
                // Reset form
                this.reset();
                document.getElementById('currentCredit').value = '';
                document.getElementById('newCredit').value = '';
                
                showToast(`Top up berhasil! ${formatNumber(amount)} credit dikurangi dari ${brand}`);
            } catch (error) {
                console.error("Error saving topup:", error);
                showToast("Gagal menyimpan data ke server", "error");
                
                // Simpan ke localStorage sebagai fallback
                localStorage.setItem('creditData', JSON.stringify(creditData));
                
                // Tambahkan ke history lokal
                topupHistory.push({
                    date: new Date().toLocaleString('id-ID'),
                    brand: brand,
                    amount: amount,
                    before: currentCredit,
                    after: currentCredit - amount
                });
                localStorage.setItem('topupHistory', JSON.stringify(topupHistory));
                
                updateCreditStats();
                updateHistoryTable();
                
                showToast(`Top up berhasil (offline mode)! ${formatNumber(amount)} credit dikurangi dari ${brand}`);
            }
        } else {
            showToast('Credit tidak mencukupi untuk melakukan top up', 'error');
        }
    });

    // Refresh history
    document.getElementById('refreshHistory')?.addEventListener('click', function() {
        updateHistoryTable();
        showToast('Riwayat diperbarui', 'info');
    });


    // Refresh masteragent history
    document.getElementById('refreshMasteragentHistory')?.addEventListener('click', function() {
        updateMasteragentHistoryTable();
        showToast('Riwayat masteragent diperbarui', 'info');
    });



    // Tab functionality
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Show active content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabId}Tab`).classList.add('active');
        });
    });

    // Fungsi untuk menampilkan modal edit credit
    function showEditCreditModal() {
        const modal = document.getElementById('editCreditModal');
        const container = document.getElementById('editCreditContainer');
        
        // Kosongkan container terlebih dahulu
        container.innerHTML = '';
        
        // Buat form input untuk setiap kategori
        for (const [category, data] of Object.entries(creditData)) {
            const div = document.createElement('div');
            div.className = 'form-group';
            
            div.innerHTML = `
                <label for="edit-${category}">${category} Credit</label>
                <input type="number" id="edit-${category}" class="form-input" 
                       value="${data.credit}" min="0">
            `;
            
            container.appendChild(div);
        }
        
        // Tampilkan modal
        modal.classList.add('active');
    }

    // Fungsi untuk menyimpan perubahan credit
    async function saveCreditChanges() {
        for (const [category, data] of Object.entries(creditData)) {
            const input = document.getElementById(`edit-${category}`);
            if (input) {
                const newValue = parseInt(input.value) || 0;
                if (newValue >= 0) {
                    creditData[category].credit = newValue;
                }
            }
        }
        
        try {
            // Simpan ke Firestore
            await db.collection('creditData').doc('brands').set(creditData);
            
            // Update UI
            updateCreditStats();
            updateBrandDropdown();
            
            // Tutup modal
            document.getElementById('editCreditModal').classList.remove('active');
            
            showToast('Nominal credit berhasil diperbarui');
        } catch (error) {
            console.error("Error saving credit changes:", error);
            showToast("Gagal menyimpan perubahan ke server", "error");
            
            // Simpan ke localStorage sebagai fallback
            localStorage.setItem('creditData', JSON.stringify(creditData));
            
            // Update UI
            updateCreditStats();
            updateBrandDropdown();
            
            // Tutup modal
            document.getElementById('editCreditModal').classList.remove('active');
            
            showToast('Nominal credit berhasil diperbarui (offline mode)');
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Setup Firestore listeners
        setupFirestoreListeners();
        
        // Tambahkan tombol Edit Credit di header
        const header = document.querySelector('.header');
        if (header) {
            const editButton = document.createElement('button');
            editButton.className = 'btn btn-outline';
            editButton.innerHTML = '<i class="fas fa-edit"></i> Edit Credit';
            editButton.style.marginRight = '10px';
            editButton.onclick = showEditCreditModal;
            
            // Sisipkan tombol sebelum user profile
            const headerActions = document.querySelector('.header-actions');
            if (headerActions) {
                headerActions.insertBefore(editButton, headerActions.firstChild);
            }
        }
        
        // Buat modal untuk edit credit
        const modalHTML = `
<!-- Ganti modal HTML yang sudah ada dengan yang ini -->
<div id="editCreditModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-edit"></i> Edit Nominal Credit</h3>
            <button class="modal-close" onclick="document.getElementById('editCreditModal').classList.remove('active')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Password verification section -->
            <div id="passwordSection">
                <div class="form-group">
                    <label for="adminPassword">Password Admin</label>
                    <input type="password" id="adminPassword" class="form-input" placeholder="Masukkan password admin">
                    <p class="error-message" id="passwordError" style="color: var(--danger); display: none; font-size: var(--text-xs); margin-top: 5px;">
                        Password salah!
                    </p>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="verifyPassword()">
                        Verifikasi Password
                    </button>
                </div>
            </div>
            
            <!-- Credit edit section (initially hidden) -->
            <div id="creditEditSection" style="display: none;">
                <div id="editCreditContainer"></div>
            </div>
        </div>
        <div class="modal-footer" id="editModalFooter" style="display: none;">
            <button class="btn btn-outline" onclick="document.getElementById('editCreditModal').classList.remove('active')">
                Batal
            </button>
            <button class="btn btn-primary" onclick="saveCreditChanges()">
                Simpan Perubahan
            </button>
        </div>
    </div>
</div>
        `;
        
        // Tambahkan modal ke body
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    });
    // Password yang diharapkan (dalam aplikasi nyata, ini harus disimpan dengan aman)
const ADMIN_PASSWORD = "167669123"; // Ganti dengan password yang diinginkan

// Fungsi untuk verifikasi password
function verifyPassword() {
    const passwordInput = document.getElementById('adminPassword');
    const passwordError = document.getElementById('passwordError');
    const passwordSection = document.getElementById('passwordSection');
    const creditEditSection = document.getElementById('creditEditSection');
    const editModalFooter = document.getElementById('editModalFooter');
    
    if (passwordInput.value === ADMIN_PASSWORD) {
        // Password benar, tampilkan form edit credit
        passwordSection.style.display = 'none';
        creditEditSection.style.display = 'block';
        editModalFooter.style.display = 'flex';
        
        // Isi form dengan data credit saat ini
        const container = document.getElementById('editCreditContainer');
        container.innerHTML = '';
        
        for (const [category, data] of Object.entries(creditData)) {
            const div = document.createElement('div');
            div.className = 'form-group';
            
            div.innerHTML = `
                <label for="edit-${category}">${category} Credit</label>
                <input type="number" id="edit-${category}" class="form-input" 
                       value="${data.credit}" min="0">
            `;
            
            container.appendChild(div);
        }
    } else {
        // Password salah, tampilkan pesan error
        passwordError.style.display = 'block';
        passwordInput.style.borderColor = 'var(--danger)';
        
        // Reset input setelah 2 detik
        setTimeout(() => {
            passwordInput.value = '';
            passwordInput.focus();
        }, 2000);
    }
}

// Fungsi untuk reset modal ketika ditutup
function resetEditModal() {
    const passwordInput = document.getElementById('adminPassword');
    const passwordError = document.getElementById('passwordError');
    const passwordSection = document.getElementById('passwordSection');
    const creditEditSection = document.getElementById('creditEditSection');
    const editModalFooter = document.getElementById('editModalFooter');
    
    passwordInput.value = '';
    passwordError.style.display = 'none';
    passwordInput.style.borderColor = '';
    passwordSection.style.display = 'block';
    creditEditSection.style.display = 'none';
    editModalFooter.style.display = 'none';
}

// Modifikasi fungsi showEditCreditModal
function showEditCreditModal() {
    const modal = document.getElementById('editCreditModal');
    resetEditModal(); // Reset modal setiap kali dibuka
    modal.classList.add('active');
}

// Tambahkan event listener untuk mereset modal ketika ditutup
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('editCreditModal');
    const closeButton = modal.querySelector('.modal-close');
    
    closeButton.addEventListener('click', resetEditModal);
    
    // Juga reset ketika mengklik latar belakang modal
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            resetEditModal();
        }
    });
});
function showToast(message, type = 'info', duration = 3000) {
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('hide');
    }, duration);

    toast.addEventListener('animationend', () => {
        if (toast.classList.contains('hide')) {
            toast.remove();
        }
    });
}

// Fungsi untuk melakukan pencarian
function handleSearch() {
    const searchTerm = document.getElementById('dashboardSearch').value.toLowerCase().trim();
    
    // Cari di kedua tabel (regular dan masteragent)
    searchInTable('historyTableBody', searchTerm);
    searchInTable('masteragentHistoryTableBody', searchTerm);
}

// Fungsi untuk mencari dalam tabel tertentu
function searchInTable(tableId, searchTerm) {
    const tableBody = document.getElementById(tableId);
    if (!tableBody) return;
    
    const rows = tableBody.getElementsByTagName('tr');
    let hasMatch = false;
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const rowText = row.textContent.toLowerCase();
        
        if (rowText.includes(searchTerm)) {
            row.style.display = '';
            hasMatch = true;
        } else {
            row.style.display = 'none';
        }
    }
    
    // Tampilkan pesan jika tidak ada hasil
    const noHistoryElement = tableId === 'historyTableBody' 
        ? document.getElementById('noHistory') 
        : document.getElementById('noMasteragentHistory');
    
    if (noHistoryElement) {
        if (!hasMatch && searchTerm !== '') {
            noHistoryElement.style.display = 'block';
            noHistoryElement.innerHTML = `
                <i class="fas fa-search"></i>
                <h3>Tidak Ada Hasil Pencarian</h3>
                <p>Tidak ditemukan hasil untuk "${searchTerm}"</p>
            `;
        } else {
            noHistoryElement.style.display = 'none';
        }
    }
}

// Fungsi untuk mereset pencarian
function resetSearch() {
    const searchInput = document.getElementById('dashboardSearch');
    searchInput.value = '';
    
    // Tampilkan semua baris kembali
    const tables = ['historyTableBody', 'masteragentHistoryTableBody'];
    tables.forEach(tableId => {
        const tableBody = document.getElementById(tableId);
        if (tableBody) {
            const rows = tableBody.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                rows[i].style.display = '';
            }
        }
    });
    
    // Sembunyikan pesan tidak ada hasil
    const noHistoryElements = ['noHistory', 'noMasteragentHistory'];
    noHistoryElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) {
            element.style.display = 'none';
        }
    });
    
    // Kembalikan ke tampilan normal jika tidak ada data
    updateHistoryTable();
    updateMasteragentHistoryTable();
}

// Event listener untuk input pencarian
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('dashboardSearch');
    
    // Pencarian saat mengetik
    searchInput.addEventListener('input', function() {
        handleSearch();
    });
    
    // Pencarian saat menekan Enter
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleSearch();
        }
    });
    
    // Tambahkan tombol clear di search bar
    const searchBar = document.querySelector('.search-bar');
    if (searchBar) {
        const clearButton = document.createElement('button');
        clearButton.type = 'button';
        clearButton.className = 'clear-search';
        clearButton.innerHTML = '<i class="fas fa-times"></i>';
        clearButton.style.background = 'none';
        clearButton.style.border = 'none';
        clearButton.style.cursor = 'pointer';
        clearButton.style.color = 'var(--text-secondary)';
        clearButton.style.marginLeft = '5px';
        clearButton.style.display = 'none';
        
        clearButton.addEventListener('click', function() {
            resetSearch();
            this.style.display = 'none';
        });
        
        searchBar.appendChild(clearButton);
        
        // Tampilkan tombol clear ketika ada input
        searchInput.addEventListener('input', function() {
            if (this.value.trim() !== '') {
                clearButton.style.display = 'block';
            } else {
                clearButton.style.display = 'none';
                resetSearch();
            }
        });
    }
});

// Modifikasi fungsi updateHistoryTable dan updateMasteragentHistoryTable
// untuk menyembunyikan pesan "Tidak Ada Riwayat" saat melakukan pencarian
function updateHistoryTable() {
    const historyTableBody = document.getElementById('historyTableBody');
    const noHistory = document.getElementById('noHistory');
    const searchTerm = document.getElementById('dashboardSearch').value.toLowerCase().trim();
    
    if (topupHistory.length === 0 && searchTerm === '') {
        if (noHistory) noHistory.style.display = 'block';
        if (historyTableBody) historyTableBody.innerHTML = '';
        return;
    }
    
    if (noHistory) noHistory.style.display = 'none';
    
    // Render history table
    if (historyTableBody) {
        historyTableBody.innerHTML = topupHistory.map(history => `
            <tr>
                <td>${history.date || 'N/A'}</td>
                <td>${history.brand || 'N/A'}</td>
                <td>${formatNumber(history.amount)}</td>
                <td>${formatNumber(history.before)}</td>
                <td>${formatNumber(history.after)}</td>
            </tr>
        `).join('');
        
        // Jika sedang dalam mode pencarian, filter hasil
        if (searchTerm !== '') {
            handleSearch();
        }
    }
}

function updateMasteragentHistoryTable() {
    const historyTableBody = document.getElementById('masteragentHistoryTableBody');
    const noHistory = document.getElementById('noMasteragentHistory');
    const searchTerm = document.getElementById('dashboardSearch').value.toLowerCase().trim();
    
    if (masteragentHistory.length === 0 && searchTerm === '') {
        if (noHistory) noHistory.style.display = 'block';
        if (historyTableBody) historyTableBody.innerHTML = '';
        return;
    }
    
    if (noHistory) noHistory.style.display = 'none';
    
    // Render history table
    if (historyTableBody) {
        historyTableBody.innerHTML = masteragentHistory.map(history => `
            <tr>
                <td>${history.date || 'N/A'}</td>
                <td>${history.category || 'N/A'}</td>
                <td>${formatNumber(history.amount)}</td>
                <td>${formatNumber(history.before)}</td>
                <td>${formatNumber(history.after)}</td>
            </tr>
        `).join('');
        
        // Jika sedang dalam mode pencarian, filter hasil
        if (searchTerm !== '') {
            handleSearch();
        }
    }
}
// Variabel untuk pagination
const itemsPerPage = 15;
let currentRegularPage = 1;
let currentMasteragentPage = 1;
let filteredRegularHistory = [];
let filteredMasteragentHistory = [];

// Fungsi untuk menerapkan pagination pada tabel
function applyPagination(tableType, page) {
    let tableBody, historyData, filteredData, pageInfo, paginationControls;
    let currentPage, totalPages;
    
    if (tableType === 'regular') {
        tableBody = document.getElementById('historyTableBody');
        historyData = topupHistory;
        filteredData = filteredRegularHistory.length > 0 ? filteredRegularHistory : historyData;
        pageInfo = document.getElementById('regularPageInfo');
        paginationControls = document.getElementById('regularPagination');
        currentPage = currentRegularPage = page;
        totalPages = Math.ceil(filteredData.length / itemsPerPage);
    } else {
        tableBody = document.getElementById('masteragentHistoryTableBody');
        historyData = masteragentHistory;
        filteredData = filteredMasteragentHistory.length > 0 ? filteredMasteragentHistory : historyData;
        pageInfo = document.getElementById('masteragentPageInfo');
        paginationControls = document.getElementById('masteragentPagination');
        currentPage = currentMasteragentPage = page;
        totalPages = Math.ceil(filteredData.length / itemsPerPage);
    }
    
    // Tampilkan atau sembunyikan pagination controls
    if (filteredData.length > itemsPerPage) {
        paginationControls.style.display = 'flex';
    } else {
        paginationControls.style.display = 'none';
    }
    
    // Update info halaman
    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    
    // Hitung item yang akan ditampilkan
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
    const paginatedData = filteredData.slice(startIndex, endIndex);
    
    // Render tabel
    if (tableBody) {
        tableBody.innerHTML = paginatedData.map(history => {
            if (tableType === 'regular') {
                return `
                    <tr>
                        <td>${history.date || 'N/A'}</td>
                        <td>${history.brand || 'N/A'}</td>
                        <td>${formatNumber(history.amount)}</td>
                        <td>${formatNumber(history.before)}</td>
                        <td>${formatNumber(history.after)}</td>
                    </tr>
                `;
            } else {
                return `
                    <tr>
                        <td>${history.date || 'N/A'}</td>
                        <td>${history.category || 'N/A'}</td>
                        <td>${formatNumber(history.amount)}</td>
                        <td>${formatNumber(history.before)}</td>
                        <td>${formatNumber(history.after)}</td>
                    </tr>
                `;
            }
        }).join('');
    }
    
    // Enable/disable tombol previous dan next
    const prevButton = document.getElementById(tableType === 'regular' ? 'prevRegularPage' : 'prevMasteragentPage');
    const nextButton = document.getElementById(tableType === 'regular' ? 'nextRegularPage' : 'nextMasteragentPage');
    
    if (prevButton) prevButton.disabled = currentPage === 1;
    if (nextButton) nextButton.disabled = currentPage === totalPages;
}

// Event listeners untuk tombol pagination
document.getElementById('prevRegularPage')?.addEventListener('click', function() {
    if (currentRegularPage > 1) {
        applyPagination('regular', currentRegularPage - 1);
    }
});

document.getElementById('nextRegularPage')?.addEventListener('click', function() {
    const historyData = filteredRegularHistory.length > 0 ? filteredRegularHistory : topupHistory;
    const totalPages = Math.ceil(historyData.length / itemsPerPage);
    
    if (currentRegularPage < totalPages) {
        applyPagination('regular', currentRegularPage + 1);
    }
});

document.getElementById('prevMasteragentPage')?.addEventListener('click', function() {
    if (currentMasteragentPage > 1) {
        applyPagination('masteragent', currentMasteragentPage - 1);
    }
});

document.getElementById('nextMasteragentPage')?.addEventListener('click', function() {
    const historyData = filteredMasteragentHistory.length > 0 ? filteredMasteragentHistory : masteragentHistory;
    const totalPages = Math.ceil(historyData.length / itemsPerPage);
    
    if (currentMasteragentPage < totalPages) {
        applyPagination('masteragent', currentMasteragentPage + 1);
    }
});

// Modifikasi fungsi updateHistoryTable
function updateHistoryTable() {
    const noHistory = document.getElementById('noHistory');
    const searchTerm = document.getElementById('dashboardSearch').value.toLowerCase().trim();
    
    // Reset filtered data
    filteredRegularHistory = [];
    
    if (topupHistory.length === 0 && searchTerm === '') {
        if (noHistory) noHistory.style.display = 'block';
        document.getElementById('regularPagination').style.display = 'none';
        return;
    }
    
    if (noHistory) noHistory.style.display = 'none';
    
    // Filter data berdasarkan pencarian
    if (searchTerm !== '') {
        filteredRegularHistory = topupHistory.filter(history => {
            return Object.values(history).some(value => 
                value && value.toString().toLowerCase().includes(searchTerm)
            );
        });
    }
    
    // Reset ke halaman 1
    currentRegularPage = 1;
    applyPagination('regular', 1);
}

// Modifikasi fungsi updateMasteragentHistoryTable
function updateMasteragentHistoryTable() {
    const noHistory = document.getElementById('noMasteragentHistory');
    const searchTerm = document.getElementById('dashboardSearch').value.toLowerCase().trim();
    
    // Reset filtered data
    filteredMasteragentHistory = [];
    
    if (masteragentHistory.length === 0 && searchTerm === '') {
        if (noHistory) noHistory.style.display = 'block';
        document.getElementById('masteragentPagination').style.display = 'none';
        return;
    }
    
    if (noHistory) noHistory.style.display = 'none';
    
    // Filter data berdasarkan pencarian
    if (searchTerm !== '') {
        filteredMasteragentHistory = masteragentHistory.filter(history => {
            return Object.values(history).some(value => 
                value && value.toString().toLowerCase().includes(searchTerm)
            );
        });
    }
    
    // Reset ke halaman 1
    currentMasteragentPage = 1;
    applyPagination('masteragent', 1);
}

// Modifikasi fungsi resetSearch untuk mereset pagination juga
function resetSearch() {
    const searchInput = document.getElementById('dashboardSearch');
    searchInput.value = '';
    
    // Reset filtered data
    filteredRegularHistory = [];
    filteredMasteragentHistory = [];
    
    // Reset ke halaman 1
    currentRegularPage = 1;
    currentMasteragentPage = 1;
    
    // Update tabel
    updateHistoryTable();
    updateMasteragentHistoryTable();
}
</script>
</body>
</html>
